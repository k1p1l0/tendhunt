---
phase: 02-content
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - landing/package.json
  - landing/astro.config.mjs
  - landing/wrangler.jsonc
  - landing/schema.sql
  - landing/src/components/sections/PricingSection.astro
  - landing/src/components/sections/FAQSection.astro
  - landing/src/components/sections/WaitlistSection.astro
  - landing/src/components/ui/PricingCard.astro
  - landing/src/components/ui/WaitlistForm.astro
  - landing/src/pages/api/waitlist.ts
  - landing/src/pages/index.astro
  - landing/.dev.vars
autonomous: true

user_setup:
  - service: cloudflare-turnstile
    why: "Spam protection for waitlist form"
    env_vars:
      - name: TURNSTILE_SITE_KEY
        source: "Cloudflare Dashboard → Turnstile → Create Widget → Copy Site Key"
      - name: TURNSTILE_SECRET_KEY
        source: "Cloudflare Dashboard → Turnstile → Create Widget → Copy Secret Key"
    dashboard_config:
      - task: "Create Turnstile widget"
        location: "Cloudflare Dashboard → Turnstile → Add Site"
        details: "Widget type: Managed (Invisible), Domain: tendhunt.com"
  - service: cloudflare-d1
    why: "SQLite database for waitlist submissions"
    env_vars:
      - name: DB (binding)
        source: "wrangler d1 create tendhunt-waitlist → Copy database_id to wrangler.jsonc"
    dashboard_config:
      - task: "Create D1 database"
        location: "wrangler d1 create tendhunt-waitlist (via CLI)"
        details: "Apply schema.sql with: wrangler d1 execute tendhunt-waitlist --file=schema.sql --local"

must_haves:
  truths:
    - "User sees 3 pricing tiers (Scout, Hunter, Enterprise) with feature lists and 'Join Waitlist' CTAs"
    - "User sees 5-8 FAQ items that expand on click to reveal answers"
    - "User can submit waitlist form with email, company name, and role"
    - "Form submission triggers Turnstile verification and stores data in D1 database"
    - "User sees inline success message after form submission without page refresh"
  artifacts:
    - path: "landing/src/components/sections/PricingSection.astro"
      provides: "3 pricing tier cards"
      min_lines: 60
    - path: "landing/src/components/sections/FAQSection.astro"
      provides: "5-8 FAQ items using details/summary"
      min_lines: 80
    - path: "landing/src/components/sections/WaitlistSection.astro"
      provides: "Waitlist form section with Turnstile"
      min_lines: 40
    - path: "landing/src/pages/api/waitlist.ts"
      provides: "Form submission handler with Turnstile verification and D1 insert"
      exports: ["POST"]
      min_lines: 60
    - path: "landing/schema.sql"
      provides: "D1 database schema"
      contains: "CREATE TABLE IF NOT EXISTS waitlist"
  key_links:
    - from: "landing/src/components/ui/WaitlistForm.astro"
      to: "landing/src/pages/api/waitlist.ts"
      via: "fetch POST request with JSON body"
      pattern: "fetch.*api/waitlist.*POST"
    - from: "landing/src/pages/api/waitlist.ts"
      to: "env.DB.prepare"
      via: "D1 database binding via locals.runtime.env"
      pattern: "locals\\.runtime\\.env\\.DB"
    - from: "landing/src/pages/api/waitlist.ts"
      to: "https://challenges.cloudflare.com/turnstile/v0/siteverify"
      via: "Server-side Turnstile token verification"
      pattern: "fetch.*turnstile.*siteverify"
---

<objective>
Build the Pricing, FAQ, and Waitlist sections with a fully functional waitlist form backed by Cloudflare D1 database and Turnstile spam protection, requiring Astro hybrid rendering setup.

Purpose: Complete the landing page conversion funnel with pricing tiers (waitlist CTAs, no prices shown), FAQ accordion for objection handling, and a working waitlist form that stores submissions in a database — delivering the final sections needed for launch.

Output: Three complete landing page sections, a server-side API route for form handling, D1 database schema, and Cloudflare adapter configuration — all ready for deployment.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@./landing/.planning/PROJECT.md
@./landing/.planning/ROADMAP.md
@./landing/.planning/phases/02-content/02-CONTEXT.md
@./landing/.planning/phases/02-content/02-RESEARCH.md
@./landing/.planning/phases/01-foundation/01-01-SUMMARY.md
@./landing/src/pages/index.astro
@./landing/astro.config.mjs
@./landing/wrangler.jsonc
@./landing/src/styles/global.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Cloudflare Adapter and Configure Hybrid Rendering</name>
  <files>
landing/package.json
landing/astro.config.mjs
  </files>
  <action>
Install the Cloudflare adapter and configure Astro for hybrid rendering (static pages + SSR API routes).

**Install @astrojs/cloudflare:**
```bash
cd landing && npx astro add cloudflare
```

This will:
- Add @astrojs/cloudflare to package.json dependencies
- Update astro.config.mjs to import and use the adapter
- Set output mode (we'll verify it's 'static' below)

**Verify astro.config.mjs after installation:**
Ensure the config looks like this:
```typescript
import { defineConfig } from 'astro/config';
import sitemap from '@astrojs/sitemap';
import cloudflare from '@astrojs/cloudflare';

export default defineConfig({
  site: 'https://tendhunt.com',
  output: 'static',  // Keep static for all pages by default
  adapter: cloudflare(),  // Required for hybrid rendering
  integrations: [sitemap()],
  vite: {
    plugins: [tailwindcss()],
  },
});
```

**Key points:**
- `output: 'static'` means all pages are prerendered by default
- `adapter: cloudflare()` enables SSR for specific routes via `export const prerender = false`
- This is hybrid rendering: static pages + dynamic API routes

If `npx astro add cloudflare` changes output to 'server', manually change it back to 'static' — we want static site with one dynamic API route, not full SSR.
  </action>
  <verify>
Check package.json includes @astrojs/cloudflare in dependencies
Check astro.config.mjs imports cloudflare and includes adapter: cloudflare()
Verify output: 'static' in config (NOT 'server')
Build still succeeds: `npm run build`
  </verify>
  <done>
@astrojs/cloudflare installed
astro.config.mjs configured with adapter: cloudflare() and output: 'static'
Build produces dist/ with _worker.js for API routes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create D1 Schema and Waitlist API Route</name>
  <files>
landing/schema.sql
landing/wrangler.jsonc
landing/src/pages/api/waitlist.ts
landing/.dev.vars
  </files>
  <action>
Create the D1 database schema, configure wrangler bindings, and build the server-side API route for waitlist form submissions.

**schema.sql (D1 database schema):**
```sql
CREATE TABLE IF NOT EXISTS waitlist (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email TEXT NOT NULL UNIQUE,
  company TEXT NOT NULL,
  role TEXT NOT NULL,
  created_at TEXT NOT NULL,
  metadata TEXT
);

CREATE INDEX idx_email ON waitlist(email);
CREATE INDEX idx_created_at ON waitlist(created_at);
```

**wrangler.jsonc updates:**
Add D1 database binding to existing config:
```jsonc
{
  "name": "tendhunt-landing",
  "compatibility_date": "2024-01-01",
  "pages_build_output_dir": "./dist",
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "tendhunt-waitlist",
      "database_id": "PLACEHOLDER-REPLACE-AFTER-CREATION"
    }
  ]
}
```

Note: `database_id` will be a placeholder until user creates the D1 database via `wrangler d1 create tendhunt-waitlist`. This is expected.

**landing/.dev.vars (for local dev environment variables):**
Create file with Turnstile keys (user will fill these after Turnstile widget creation):
```
TURNSTILE_SECRET_KEY=PLACEHOLDER-REPLACE-WITH-ACTUAL-SECRET
```

Site key will go in WaitlistForm.astro as public variable (not secret).

**src/pages/api/waitlist.ts (SSR API route):**
```typescript
export const prerender = false;  // CRITICAL: Opt out of prerendering for SSR

import type { APIRoute } from 'astro';

export const POST: APIRoute = async ({ request, locals }) => {
  try {
    // Parse form data
    const data = await request.json();
    const { email, company, role, 'cf-turnstile-response': turnstileToken } = data;

    // Validate required fields
    if (!email || !company || !role || !turnstileToken) {
      return new Response(
        JSON.stringify({ error: 'Missing required fields' }),
        { status: 400, headers: { 'Content-Type': 'application/json' } }
      );
    }

    // Get Cloudflare runtime and D1 binding
    const { env } = locals.runtime;

    // Verify Turnstile token server-side
    const TURNSTILE_SECRET = env.TURNSTILE_SECRET_KEY;
    const verifyResponse = await fetch(
      'https://challenges.cloudflare.com/turnstile/v0/siteverify',
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          secret: TURNSTILE_SECRET,
          response: turnstileToken,
        }),
      }
    );

    const outcome = await verifyResponse.json();
    if (!outcome.success) {
      return new Response(
        JSON.stringify({ error: 'Bot verification failed' }),
        { status: 403, headers: { 'Content-Type': 'application/json' } }
      );
    }

    // Insert into D1 database
    const db = env.DB;
    const result = await db
      .prepare(
        'INSERT INTO waitlist (email, company, role, created_at) VALUES (?, ?, ?, ?)'
      )
      .bind(email, company, role, new Date().toISOString())
      .run();

    return new Response(
      JSON.stringify({
        success: true,
        message: "You're on the list! We'll email you when TendHunt launches."
      }),
      { status: 201, headers: { 'Content-Type': 'application/json' } }
    );
  } catch (error: any) {
    // Handle unique constraint violation (duplicate email)
    if (error.message?.includes('UNIQUE constraint failed')) {
      return new Response(
        JSON.stringify({ error: 'Email already registered' }),
        { status: 409, headers: { 'Content-Type': 'application/json' } }
      );
    }

    console.error('Waitlist API error:', error);
    return new Response(
      JSON.stringify({ error: 'Internal server error' }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    );
  }
};
```

**Critical pitfall avoidance:**
- `export const prerender = false;` at the top is MANDATORY — without it, API route prerenders to static HTML
- Access D1 via `locals.runtime.env.DB` (Cloudflare adapter runtime pattern)
- Always verify Turnstile token server-side (client-side widget alone is bypassable)
  </action>
  <verify>
schema.sql exists with waitlist table definition
wrangler.jsonc includes d1_databases binding
src/pages/api/waitlist.ts includes `export const prerender = false;`
API route exports POST function
API route verifies Turnstile and inserts to D1
.dev.vars exists with TURNSTILE_SECRET_KEY placeholder
  </verify>
  <done>
D1 schema defined with email, company, role, created_at fields
wrangler.jsonc configured with D1 binding
API route at /api/waitlist handles POST requests
Turnstile verification happens server-side
Duplicate email returns 409 error
  </done>
</task>

<task type="auto">
  <name>Task 3: Build Pricing, FAQ, and Waitlist Sections</name>
  <files>
landing/src/components/sections/PricingSection.astro
landing/src/components/sections/FAQSection.astro
landing/src/components/sections/WaitlistSection.astro
landing/src/components/ui/PricingCard.astro
landing/src/components/ui/WaitlistForm.astro
  </files>
  <action>
Create the final 3 landing page sections with responsive layouts and working form.

**PricingSection.astro:**
- Full-width section with bg-bg-secondary background
- Container: max-w-[80rem] px-6 py-24
- Section heading: "Pricing" with subtitle "Join the waitlist for launch pricing"
- 3 pricing cards in grid (grid-cols-1 md:grid-cols-3 gap-8)
- Import PricingCard component for each tier

**PricingCard.astro props:**
- `tier` (string): Tier name
- `features` (string[]): Array of feature strings
- `highlight` (boolean, optional): Not used per CONTEXT.md — all tiers presented equally

**Tier content (per CONTEXT.md):**
1. **Scout** - "For individual business developers", Features: ["10 credits/month", "Search 200K+ contracts", "Basic filters", "Email alerts"]
2. **Hunter** - "For growing sales teams", Features: ["50 credits/month", "Everything in Scout", "Advanced filters & AI scoring", "Buyer intelligence", "Priority support"]
3. **Enterprise** - "For large organizations", Features: ["Custom credits", "Everything in Hunter", "API access", "Dedicated account manager", "SSO & team management"]

Each card includes:
- Tier name (h3, font-heading)
- Description (p, text-text-secondary)
- Feature list (ul with checkmark icons)
- "Join Waitlist for Pricing" button (href="#waitlist", variant="primary")

No prices shown, no "Most Popular" badges, no monthly/annual toggle per user decisions.

**FAQSection.astro:**
- Full-width section with bg-bg-primary background
- Container: max-w-[80rem] px-6 py-24
- Section heading: "Frequently Asked Questions"
- 5-8 FAQ items using native `<details>` and `<summary>` HTML elements (no JavaScript needed)
- Styled with CSS: custom arrow indicator (+ → × rotation on open), border-bottom separators
- Questions wrapped in max-w-3xl for readability

**FAQ content (procurement-specific):**
1. Q: "What procurement data sources does TendHunt use?" A: "TendHunt aggregates contracts from Find a Tender (UK's official portal for high-value opportunities) and Contracts Finder (below-threshold notices). We normalize and enrich data from both sources into a unified search experience."
2. Q: "How does the Vibe Scanner AI scoring work?" A: "Upload your company profile (past bids, capability statements, certifications). Our AI analyzes your strengths and scores every contract 1-10 based on fit. You see your best opportunities first, not just keyword matches."
3. Q: "Where do buyer contact details come from?" A: "We source contacts from public records: GOV.UK appointments, council websites, NHS board lists, and LinkedIn. Every contact is verified and includes name, job title, email, and public profile links."
4. Q: "What's a credit and how do they work?" A: "1 credit = reveal 1 buyer contact. Scout tier includes 10 credits/month, Hunter 50, Enterprise custom. Unused credits roll over. No hidden fees."
5. Q: "Is TendHunt compliant with UK data protection laws?" A: "Yes. We're GDPR and UK GDPR compliant. All data is sourced from public records. We use Cloudflare infrastructure for security and data residency."
6. Q: "Can I cancel anytime?" A: "Yes. Cancel anytime from your account settings. No long-term contracts, no cancellation fees."
7. Q: "Do you offer a free trial?" A: "New users get 10 free credits on signup. Search, filter, and score contracts for free. Spend credits only when you want to reveal buyer contacts."

**WaitlistSection.astro:**
- Full-width section with bg-bg-secondary background
- Container: max-w-[80rem] px-6 py-24
- Section heading: "Join the Waitlist" with subtitle
- Center-aligned content (text-center)
- Import WaitlistForm component

**WaitlistForm.astro:**
- Form with 3 fields: email (required), company (required), role (required)
- Turnstile widget: `<div class="cf-turnstile" data-sitekey="PLACEHOLDER-SITE-KEY"></div>`
- Turnstile script: `<script is:inline src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>`
- Submit button: "Join Waitlist" (variant="primary", full width on mobile)
- Client-side script for form submission:
  - Prevent default form submit
  - Get Turnstile response token from FormData
  - POST to /api/waitlist with JSON body { email, company, role, 'cf-turnstile-response': token }
  - On success: replace form innerHTML with success message "You're on the list! We'll email you when TendHunt launches."
  - On error: show error message below form (red text)
- Accessible labels, input focus states, validation attributes (required, type="email")

**PLACEHOLDER-SITE-KEY note:**
This will be a placeholder string until user creates Turnstile widget. Add TODO comment: "Replace with actual Turnstile site key from Cloudflare Dashboard".

**Mobile responsiveness:**
- Pricing: single column on mobile, 3 columns on md+
- FAQ: full width on mobile, max-w-3xl on desktop
- Waitlist form: full width inputs on mobile, max-w-md container on desktop
  </action>
  <verify>
Build succeeds: `npm run build`
Check dist/index.html contains all 3 sections
Verify PricingSection has 3 tier cards with correct feature lists
Verify FAQSection has 5-8 details/summary elements
Verify WaitlistForm includes Turnstile div and script tag
Check API route NOT in dist/ (it's SSR, should be in _worker.js)
  </verify>
  <done>
Pricing section displays 3 tiers (Scout, Hunter, Enterprise) with feature lists
No prices shown, "Join Waitlist for Pricing" CTAs present
FAQ section has 5-8 accordion items using details/summary
Waitlist form includes email, company, role fields
Turnstile widget placeholder present in form
Form submission script POSTs to /api/waitlist
Success message replaces form on successful submission
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate Final Sections and Add Mid-Page CTA</name>
  <files>
landing/src/pages/index.astro
  </files>
  <action>
Complete the landing page by integrating Pricing, FAQ, and Waitlist sections, and adding a mid-page CTA banner.

**index.astro updates:**
Import new sections:
```typescript
import PricingSection from '../components/sections/PricingSection.astro';
import FAQSection from '../components/sections/FAQSection.astro';
import WaitlistSection from '../components/sections/WaitlistSection.astro';
```

**Section order (final):**
1. Hero (existing)
2. SignalFeed (existing)
3. FeaturesSection (from Plan 01)
4. HowItWorksSection (from Plan 01)
5. **Mid-Page CTA Banner** (new - insert here)
6. SocialProofSection (from Plan 01)
7. PricingSection (new)
8. FAQSection (new)
9. WaitlistSection (new)

**Mid-Page CTA Banner:**
Insert a simple CTA section between HowItWorks and SocialProof:
```astro
<section class="relative bg-accent py-16">
  <div class="mx-auto max-w-[80rem] px-6 text-center">
    <h2 class="font-heading text-3xl md:text-4xl font-bold text-bg-primary mb-6">
      Ready to find your next contract?
    </h2>
    <p class="text-bg-primary/80 text-lg mb-8 max-w-2xl mx-auto">
      Join hundreds of suppliers already on the waitlist for early access to TendHunt.
    </p>
    <Button href="#waitlist" variant="secondary" size="lg">
      Get Early Access
    </Button>
  </div>
</section>
```

This is a full-width lime accent banner (contrasts with dark sections) with CTA linking to #waitlist anchor.

**Add id anchors:**
- Add `id="waitlist"` to WaitlistSection wrapper for anchor links
- Add `id="pricing"` to PricingSection wrapper

**Update existing anchor links:**
- Hero "Get Early Access" → href="#waitlist"
- Hero "See How It Works" → href="#how-it-works" (already correct from Plan 01)

**Final page structure:**
All 9 sections rendered in correct order with alternating backgrounds and 3 total CTAs (hero, mid-page banner, final waitlist).
  </action>
  <verify>
Build succeeds: `npm run build`
Check dist/index.html contains all 9 sections in correct order
Verify mid-page CTA banner exists with lime accent background
Check #waitlist and #pricing id anchors exist
Verify Hero CTAs link to #waitlist and #how-it-works
  </verify>
  <done>
All sections integrated into index.astro in correct order
Mid-page CTA banner present with lime accent background
Anchor links work: #waitlist, #how-it-works, #pricing
Landing page complete with all content sections
Build produces static HTML with one SSR API route (_worker.js)
  </done>
</task>

</tasks>

<verification>
**Build verification:**
```bash
cd landing && npm run build
```
- Build completes with zero errors
- dist/ contains static pages (index.html)
- dist/_worker.js contains API route handler
- No prerendered api/waitlist/index.html (proves SSR worked)

**API route verification:**
```bash
grep "export const prerender = false" landing/src/pages/api/waitlist.ts
grep "locals.runtime.env.DB" landing/src/pages/api/waitlist.ts
```
- Prerender disabled for API route
- D1 binding accessed via locals.runtime.env

**D1 schema verification:**
```bash
cat landing/schema.sql | grep "CREATE TABLE"
```
- waitlist table defined with correct columns

**Form verification:**
```bash
grep "cf-turnstile" landing/src/components/ui/WaitlistForm.astro
grep "api/waitlist" landing/src/components/ui/WaitlistForm.astro
```
- Turnstile widget present in form
- Form POSTs to /api/waitlist

**Section integration verification:**
- Open dist/index.html in browser
- Scroll through all sections
- Verify order: Hero → SignalFeed → Features → HowItWorks → MidCTA → SocialProof → Pricing → FAQ → Waitlist
- Check 3 pricing cards visible
- Check FAQ items expand/collapse on click
</verification>

<success_criteria>
1. Cloudflare adapter installed and hybrid rendering configured
2. D1 database schema created with waitlist table
3. API route at /api/waitlist handles POST with Turnstile verification
4. Pricing section displays 3 tiers with feature lists and waitlist CTAs
5. FAQ section displays 5-8 accordion items using details/summary
6. Waitlist form captures email, company, role with Turnstile widget
7. Form submission POSTs to API, verifies token, inserts to D1
8. Success message displays inline after submission
9. Mid-page CTA banner present with lime accent background
10. All 9 sections integrated into landing page in correct order
11. Build produces static HTML + _worker.js (no API route HTML file)
12. No build errors, no TypeScript errors, no Astro errors
</success_criteria>

<output>
After completion, create `landing/.planning/phases/02-content/02-02-SUMMARY.md` following the standard SUMMARY template with:
- Frontmatter: phase, plan, subsystem: infrastructure, tags: [cloudflare-adapter, hybrid-rendering, d1-database, turnstile, details-summary-accordion]
- Tech tracking: added: ["@astrojs/cloudflare"], patterns: [hybrid-rendering-static-plus-ssr, turnstile-server-side-verification, d1-sqlite-binding]
- Key files: all 11 created/modified files listed
- Key decisions: hybrid rendering over full SSR, D1 over KV for relational data, native details/summary for FAQ
- User setup: Turnstile widget creation steps, D1 database creation commands
- Duration and completion timestamp
</output>
