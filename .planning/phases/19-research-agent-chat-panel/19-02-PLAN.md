---
phase: 19-research-agent-chat-panel
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/components/agent/agent-provider.tsx
  - apps/web/src/stores/agent-store.ts
  - apps/web/src/components/agent/agent-panel.tsx
  - apps/web/src/components/agent/agent-panel-header.tsx
  - apps/web/src/components/agent/agent-message-list.tsx
  - apps/web/src/components/agent/agent-message.tsx
  - apps/web/src/components/agent/agent-input.tsx
  - apps/web/src/components/agent/suggested-actions.tsx
  - apps/web/src/components/agent/tool-call-indicator.tsx
  - apps/web/src/components/layout/header.tsx
  - apps/web/src/app/(dashboard)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "A trigger button in the global header opens the agent panel on all dashboard pages"
    - "The agent panel slides in from the right as a Sheet overlay with backdrop"
    - "User can type messages in a textarea and see them appear in the conversation area"
    - "Agent messages render with markdown support"
    - "Panel can be closed via X button, backdrop click, or Escape key"
    - "Suggested action buttons appear in empty conversation state"
  artifacts:
    - path: "apps/web/src/components/agent/agent-provider.tsx"
      provides: "React context for agent panel state and page context"
      exports: ["AgentProvider", "useAgentContext"]
    - path: "apps/web/src/stores/agent-store.ts"
      provides: "Zustand store for agent conversations and panel state"
      exports: ["useAgentStore"]
    - path: "apps/web/src/components/agent/agent-panel.tsx"
      provides: "Sheet-based slide-out panel component"
    - path: "apps/web/src/components/agent/agent-input.tsx"
      provides: "Chat textarea with send button"
    - path: "apps/web/src/components/agent/agent-message-list.tsx"
      provides: "Scrollable message area"
    - path: "apps/web/src/components/layout/header.tsx"
      provides: "Updated header with agent trigger button"
  key_links:
    - from: "apps/web/src/app/(dashboard)/layout.tsx"
      to: "apps/web/src/components/agent/agent-provider.tsx"
      via: "AgentProvider wrapping children"
      pattern: "AgentProvider"
    - from: "apps/web/src/components/layout/header.tsx"
      to: "apps/web/src/stores/agent-store.ts"
      via: "useAgentStore to toggle panel"
      pattern: "useAgentStore"
    - from: "apps/web/src/components/agent/agent-panel.tsx"
      to: "apps/web/src/components/ui/sheet.tsx"
      via: "Sheet component import"
      pattern: "Sheet"
---

<objective>
Build the complete frontend UI shell for the Research Agent: context provider, Zustand store, Sheet panel, message components, input area, suggested actions, and trigger button in the header.

Purpose: Creates all UI components ready to be wired to the backend SSE stream (Plan 03). The panel opens/closes, messages render, and the visual structure is complete.
Output: Functional agent panel UI with placeholder message sending (no actual API calls yet -- that comes in Plan 03).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/output.md — UI/UX specs (sections 7.1-7.5), animation requirements, component hierarchy
@.planning/phases/19-research-agent-chat-panel/19-RESEARCH.md — BreadcrumbProvider pattern, Sheet usage, Zustand pattern

Key existing files to reference:
@apps/web/src/components/layout/breadcrumb-context.tsx — Context provider pattern to follow
@apps/web/src/components/layout/header.tsx — Current header to add trigger button
@apps/web/src/app/(dashboard)/layout.tsx — Dashboard layout to wrap with AgentProvider
@apps/web/src/stores/scanner-store.ts — Zustand store pattern to follow
@apps/web/src/components/ui/sheet.tsx — Sheet component primitives
@apps/web/src/components/scanners/entity-detail-sheet.tsx — Sheet usage pattern (right side)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agent context provider, Zustand store, layout integration, and header trigger</name>
  <files>
    apps/web/src/components/agent/agent-provider.tsx
    apps/web/src/stores/agent-store.ts
    apps/web/src/app/(dashboard)/layout.tsx
    apps/web/src/components/layout/header.tsx
  </files>
  <action>
    **Zustand store (`apps/web/src/stores/agent-store.ts`):**
    Create a Zustand store following the scanner-store.ts pattern. State:
    - `panelOpen`: boolean (default false)
    - `conversations`: Array of `{ id: string; title: string; messages: AgentMessage[]; lastMessageAt: Date }`
    - `activeConversationId`: string | null
    - `isStreaming`: boolean (default false)

    Interface `AgentMessage`:
    ```typescript
    interface AgentMessage {
      id: string;
      role: "user" | "assistant";
      content: string;
      toolCalls?: Array<{
        toolName: string;
        args: Record<string, unknown>;
        result?: string;
        summary?: string;
        isLoading?: boolean;
      }>;
      timestamp: Date;
    }
    ```

    Actions:
    - `setPanelOpen(open: boolean)` — toggle panel
    - `addMessage(conversationId: string, message: AgentMessage)` — append message to conversation
    - `updateMessage(conversationId: string, messageId: string, updates: Partial<AgentMessage>)` — update message content (for streaming appends)
    - `createConversation(id: string, title?: string): void` — create new conversation
    - `setActiveConversation(id: string | null)` — switch active conversation
    - `setIsStreaming(streaming: boolean)` — set streaming state
    - `clearConversation(conversationId: string)` — remove a conversation
    - `getActiveMessages()` — computed: returns messages for activeConversationId

    **Agent context provider (`apps/web/src/components/agent/agent-provider.tsx`):**
    Follow the BreadcrumbProvider pattern exactly. "use client" directive.

    Define `AgentPageContext` interface (same shape as in system-prompt.ts):
    ```typescript
    interface AgentPageContext {
      page: "dashboard" | "scanner" | "buyer_detail" | "contract_detail" | "contracts" | "buyers";
      scannerId?: string;
      scannerType?: string;
      scannerName?: string;
      scannerQuery?: string;
      buyerId?: string;
      buyerName?: string;
      buyerSector?: string;
      buyerRegion?: string;
      contractId?: string;
      contractTitle?: string;
      contractBuyerName?: string;
      selectedRow?: Record<string, unknown>;
    }
    ```

    Context provides:
    - `context: AgentPageContext` (current page context)
    - `setContext: (ctx: AgentPageContext) => void`

    Export `AgentProvider` component and `useAgentContext()` hook.

    **Layout integration (`apps/web/src/app/(dashboard)/layout.tsx`):**
    Wrap children inside BreadcrumbProvider with AgentProvider:
    ```tsx
    <BreadcrumbProvider>
      <AgentProvider>
        <Header />
        <main className="flex-1 p-6">{children}</main>
        <AgentPanel />
      </AgentProvider>
    </BreadcrumbProvider>
    ```
    Import AgentProvider from `@/components/agent/agent-provider`.
    Import AgentPanel from `@/components/agent/agent-panel`.

    **Header trigger button (`apps/web/src/components/layout/header.tsx`):**
    Add a trigger button after the flex-1 breadcrumb div:
    ```tsx
    <Button
      variant="ghost"
      size="icon"
      className="h-8 w-8 shrink-0"
      onClick={() => useAgentStore.getState().setPanelOpen(true)}
      aria-label="Open research agent"
    >
      <Sparkles className="h-4 w-4" />
    </Button>
    ```
    Import `Sparkles` from lucide-react, `Button` from `@/components/ui/button`, `useAgentStore` from `@/stores/agent-store`.
    The button goes AFTER the flex-1 breadcrumb area, BEFORE the closing `</header>`.
  </action>
  <verify>
    - `pnpm typecheck` passes
    - Layout wraps with AgentProvider
    - Header has a Sparkles button that calls setPanelOpen(true)
    - Zustand store exports useAgentStore with all actions
  </verify>
  <done>
    Agent provider wraps dashboard layout. Header shows sparkle trigger button. Zustand store manages panel state and conversations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Agent panel UI components — Sheet, header, message list, messages, input, suggested actions, tool indicator</name>
  <files>
    apps/web/src/components/agent/agent-panel.tsx
    apps/web/src/components/agent/agent-panel-header.tsx
    apps/web/src/components/agent/agent-message-list.tsx
    apps/web/src/components/agent/agent-message.tsx
    apps/web/src/components/agent/agent-input.tsx
    apps/web/src/components/agent/suggested-actions.tsx
    apps/web/src/components/agent/tool-call-indicator.tsx
  </files>
  <action>
    **AgentPanel (`apps/web/src/components/agent/agent-panel.tsx`):**
    "use client". Uses shadcn Sheet from `@/components/ui/sheet`.
    ```tsx
    <Sheet open={panelOpen} onOpenChange={(open) => setPanelOpen(open)}>
      <SheetContent side="right" className="w-full sm:w-[480px] sm:max-w-[480px] p-0 flex flex-col">
        <AgentPanelHeader />
        <AgentMessageList />
        <AgentInput />
      </SheetContent>
    </Sheet>
    ```
    Read `panelOpen` from `useAgentStore(s => s.panelOpen)`.
    Read `setPanelOpen` from `useAgentStore(s => s.setPanelOpen)`.
    The panel has no padding (p-0) -- each child manages its own padding.
    The panel is a flex column taking full height.

    **AgentPanelHeader (`apps/web/src/components/agent/agent-panel-header.tsx`):**
    "use client". Renders inside the Sheet:
    - Left: Sparkles icon + "Research Agent" title (font-semibold)
    - Below title: context pill showing current context (e.g., "Viewing: Birmingham City Council") as a small Badge component. Read from `useAgentContext().context`. Show page type. If buyerName exists show it; if contractTitle exists show it; if scannerName exists show it. If just dashboard, show "Dashboard".
    - Right: "New Chat" button (RefreshCw icon from lucide-react, variant="ghost", size="icon") + hidden close button (SheetClose handles X via Sheet defaults)
    - "New Chat" onClick: create a new conversation with `nanoid()` as ID, set as active, using agent store.
    - Styling: `px-4 py-3 border-b flex items-center gap-2`

    **AgentMessageList (`apps/web/src/components/agent/agent-message-list.tsx`):**
    "use client". Scrollable message area.
    - Uses `useAgentStore` to get messages for active conversation.
    - If no messages, show `<SuggestedActions />`.
    - If messages exist, render each as `<AgentMessage key={msg.id} message={msg} />`.
    - Auto-scroll to bottom on new messages using a `useRef` + `useEffect` pattern:
      ```tsx
      const endRef = useRef<HTMLDivElement>(null);
      useEffect(() => { endRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);
      ```
    - Styling: `flex-1 overflow-y-auto px-4 py-4 space-y-4`
    - Wrap messages with `<AnimatePresence>` from motion for enter/exit animations.

    **AgentMessage (`apps/web/src/components/agent/agent-message.tsx`):**
    "use client". Renders a single message.
    - Wrap in `motion.div` with `initial={{ opacity: 0, y: 8 }}`, `animate={{ opacity: 1, y: 0 }}`, `transition={{ duration: 0.2 }}`.
    - User messages: right-aligned, `bg-primary text-primary-foreground rounded-2xl px-4 py-2.5 max-w-[85%] ml-auto`.
    - Assistant messages: left-aligned, `bg-muted rounded-2xl px-4 py-2.5 max-w-[85%]`.
    - For assistant messages, render content as markdown using `marked.parse()` and `dangerouslySetInnerHTML`.
    - Add prose styling: `prose prose-sm dark:prose-invert max-w-none` on the content div.
    - If message has `toolCalls`, render `<ToolCallIndicator />` for each before the text content.

    **ToolCallIndicator (`apps/web/src/components/agent/tool-call-indicator.tsx`):**
    "use client". Renders a single tool call.
    - Collapsible card using a clickable header.
    - When loading: show `<Loader2 className="h-3.5 w-3.5 animate-spin" />` + tool name (humanized, e.g., "query_buyers" -> "Searching buyers...")
    - When complete: show `<Check className="h-3.5 w-3.5 text-green-500" />` + summary text (e.g., "Found 47 buyers")
    - Styling: `flex items-center gap-2 text-xs text-muted-foreground bg-background/50 rounded-lg px-3 py-2 mb-2 border`
    - Collapsible body (hidden by default): show raw args as JSON. Toggle via local state.
    - Animate height with `motion.div` and `AnimatePresence`.

    **SuggestedActions (`apps/web/src/components/agent/suggested-actions.tsx`):**
    "use client". Empty conversation state.
    - Show a centered area with Sparkles icon, "How can I help?" heading, and 3-4 suggested prompts.
    - Prompts are context-aware. Read `useAgentContext().context` and generate prompts:
      - buyer_detail: "What are the recent buying signals for {buyerName}?", "Who are the key decision-makers?", "What has {buyerName} spent recently?", "Find similar buyers"
      - scanner (rfps): "Which contracts have the highest value?", "Find contracts with upcoming deadlines", "Summarize the top opportunities"
      - scanner (buyers): "Which buyers have the most procurement signals?", "Find NHS trusts with recent board meetings", "Compare spending patterns"
      - contract_detail: "Tell me about {contractBuyerName}", "Are there similar contracts?", "What signals suggest active procurement?"
      - dashboard/default: "Find NHS trusts with high enrichment scores", "What are the latest procurement signals?", "Show me contracts expiring this month", "Which buyers have the highest budgets?"
    - Each prompt rendered as a ghost Button with border, full-width, left-aligned text.
    - `onClick`: calls a provided `onSend(promptText)` callback (passed from parent).
    - Stagger-in animation: `motion.div` with staggered `transition={{ delay: index * 0.05 }}`.

    **AgentInput (`apps/web/src/components/agent/agent-input.tsx`):**
    "use client". Chat input area at the bottom of the panel.
    - Textarea (native HTML, NOT shadcn Textarea -- need auto-resize) with auto-grow (max 4 lines).
    - Auto-resize pattern:
      ```tsx
      const textareaRef = useRef<HTMLTextAreaElement>(null);
      const handleInput = () => {
        const el = textareaRef.current;
        if (el) { el.style.height = "auto"; el.style.height = Math.min(el.scrollHeight, 96) + "px"; }
      };
      ```
    - Send button: `ArrowUp` icon from lucide-react, inside a circular button.
      - Enabled (primary background) when input is non-empty AND not streaming.
      - Disabled (muted) when empty or streaming.
    - `onKeyDown`: Enter sends (calls `onSend`), Shift+Enter inserts newline.
    - When streaming (from store), show a stop button (Square icon) instead of send, which calls `onStop` callback.
    - Placeholder text is context-dependent:
      - buyer_detail: "Ask about {buyerName}..."
      - scanner: "Ask about your {scannerName} scanner..."
      - default: "Research UK public sector buyers..."
    - Styling: `px-4 py-3 border-t` on the container, textarea has `resize-none bg-transparent w-full outline-none text-sm`.
    - `onSend` and `onStop` are callback props. For now, `onSend` just adds a user message to the store (Plan 03 will wire to API).
  </action>
  <verify>
    - `pnpm typecheck` passes
    - All 7 component files exist under apps/web/src/components/agent/
    - Panel opens when clicking the header Sparkles button
    - Suggested actions show for empty conversations
    - User can type in the textarea and see auto-resize
    - Messages render with user/assistant styling distinction
  </verify>
  <done>
    Complete agent panel UI: Sheet opens from right, header shows context + new chat button, message list with auto-scroll, user/assistant messages with markdown, tool call indicators, suggested prompts with stagger animation, input with auto-resize and Enter/Shift+Enter.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with no errors related to agent components
2. AgentProvider wraps dashboard layout and is accessible from all pages
3. Header shows sparkle trigger button that opens the panel
4. Panel slides in from right with Sheet overlay
5. Empty state shows suggested actions
6. Typing in input and pressing Enter adds a user message to the conversation
7. Messages appear with correct alignment (user=right, assistant=left)
8. "New Chat" button creates a new conversation
</verification>

<success_criteria>
- Agent panel opens/closes from any dashboard page via header trigger button
- Panel renders all sub-components: header, message list, input
- Zustand store manages conversations and panel state
- Context provider tracks current page
- UI components ready for API wiring in Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/19-research-agent-chat-panel/19-02-SUMMARY.md`
</output>
