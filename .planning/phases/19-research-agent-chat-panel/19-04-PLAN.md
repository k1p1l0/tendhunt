---
phase: 19-research-agent-chat-panel
plan: 04
type: execute
wave: 3
depends_on: ["19-03"]
files_modified:
  - apps/web/src/components/agent/agent-panel.tsx
  - apps/web/src/components/agent/agent-input.tsx
  - apps/web/src/components/agent/agent-message.tsx
  - apps/web/src/components/agent/agent-message-list.tsx
  - apps/web/src/components/agent/tool-call-indicator.tsx
  - apps/web/src/components/agent/agent-panel-header.tsx
  - apps/web/src/hooks/use-agent.ts
autonomous: true

must_haves:
  truths:
    - "Cmd+K (macOS) / Ctrl+K (Windows) toggles the agent panel open/closed"
    - "Panel open/close animates smoothly (slide-in from right, 300ms)"
    - "New messages animate in with fade + slide-up"
    - "Error states show a retry button"
    - "Markdown renders safely (no XSS from HTML injection)"
    - "Typing indicator (three dots) shows during streaming before first text arrives"
    - "Animations respect prefers-reduced-motion"
  artifacts:
    - path: "apps/web/src/components/agent/agent-panel.tsx"
      provides: "Polished panel with keyboard shortcut, error handling, animations"
    - path: "apps/web/src/components/agent/agent-message.tsx"
      provides: "Messages with safe markdown rendering and typing indicator"
  key_links:
    - from: "apps/web/src/components/agent/agent-panel.tsx"
      to: "global keyboard event"
      via: "useEffect keydown listener for Cmd+K"
      pattern: "addEventListener.*keydown"
---

<objective>
Polish the agent panel with keyboard shortcuts, animations, error handling, safe markdown rendering, typing indicator, and accessibility.

Purpose: Brings the agent from functional to polished -- the final touches for investor demo quality.
Output: Production-ready agent panel with smooth animations, keyboard shortcuts, proper error handling, and safe markdown rendering.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/output.md — Animation requirements (section 7.5), error handling (FR-06), keyboard shortcuts (FR-01d)
@.planning/phases/19-research-agent-chat-panel/19-01-SUMMARY.md
@.planning/phases/19-research-agent-chat-panel/19-02-SUMMARY.md
@.planning/phases/19-research-agent-chat-panel/19-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Keyboard shortcut, animations, typing indicator, and prefers-reduced-motion</name>
  <files>
    apps/web/src/components/agent/agent-panel.tsx
    apps/web/src/components/agent/agent-message.tsx
    apps/web/src/components/agent/agent-message-list.tsx
    apps/web/src/components/agent/agent-input.tsx
    apps/web/src/components/agent/suggested-actions.tsx
    apps/web/src/components/agent/agent-panel-header.tsx
  </files>
  <action>
    **Keyboard shortcut (Cmd+K / Ctrl+K):**
    In `agent-panel.tsx`, add a global keydown listener:
    ```tsx
    useEffect(() => {
      const handler = (e: KeyboardEvent) => {
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
          e.preventDefault();
          setPanelOpen(!panelOpen);
        }
      };
      window.addEventListener("keydown", handler);
      return () => window.removeEventListener("keydown", handler);
    }, [panelOpen, setPanelOpen]);
    ```

    **Typing indicator:**
    In `agent-message-list.tsx`, when `isStreaming` is true and the latest assistant message has empty content (no text_delta received yet), show a typing indicator:
    ```tsx
    {isStreaming && lastMessage?.role === "assistant" && !lastMessage.content && (
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        className="flex items-center gap-1.5 px-4 py-2"
      >
        <span className="w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce [animation-delay:0ms]" />
        <span className="w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce [animation-delay:150ms]" />
        <span className="w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce [animation-delay:300ms]" />
      </motion.div>
    )}
    ```

    **Message animations:**
    Ensure all `AgentMessage` components use `motion.div` with:
    ```tsx
    <motion.div
      initial={{ opacity: 0, y: 8 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.2, ease: "easeOut" }}
    >
    ```

    **Suggested actions stagger:**
    Ensure `SuggestedActions` uses stagger:
    ```tsx
    {prompts.map((prompt, i) => (
      <motion.div
        key={prompt}
        initial={{ opacity: 0, y: 4 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.15, delay: i * 0.05, ease: "easeOut" }}
      >
        <Button ...>{prompt}</Button>
      </motion.div>
    ))}
    ```

    **Send button animation:**
    In `agent-input.tsx`, add scale pulse on the send button:
    ```tsx
    <motion.button
      whileTap={{ scale: 0.95 }}
      transition={{ duration: 0.1 }}
    >
    ```

    **Prefers-reduced-motion:**
    Create a `useReducedMotion` check:
    ```tsx
    const prefersReducedMotion = typeof window !== "undefined"
      ? window.matchMedia("(prefers-reduced-motion: reduce)").matches
      : false;
    ```
    Use it to conditionally set `initial` and `animate` props to `{}` when reduced motion is preferred. Apply to all `motion.div` wrappers in messages, suggested actions, and tool indicators.

    Alternatively, use `motion`'s built-in `useReducedMotion()` hook from `motion/react` (it's already installed).

    **Tool call indicator animation:**
    Update `tool-call-indicator.tsx`: animate height on expand/collapse:
    ```tsx
    <AnimatePresence>
      {expanded && (
        <motion.div
          initial={{ height: 0, opacity: 0 }}
          animate={{ height: "auto", opacity: 1 }}
          exit={{ height: 0, opacity: 0 }}
          transition={{ duration: 0.2 }}
          className="overflow-hidden"
        >
          <pre className="text-xs text-muted-foreground mt-1 overflow-x-auto">
            {JSON.stringify(args, null, 2)}
          </pre>
        </motion.div>
      )}
    </AnimatePresence>
    ```
  </action>
  <verify>
    - `pnpm typecheck` passes
    - Pressing Cmd+K toggles the panel
    - Typing indicator shows during streaming before first text arrives
    - Messages animate in smoothly
    - Suggested actions stagger in
    - Tool call expand/collapse animates
    - Reduced motion respected (test by enabling in system preferences)
  </verify>
  <done>
    All animations working: panel open/close, message enter, typing indicator, tool call expand, send button pulse, suggested actions stagger. Keyboard shortcut Cmd+K functional. Reduced motion respected.
  </done>
</task>

<task type="auto">
  <name>Task 2: Error handling, safe markdown rendering, retry button, and final polish</name>
  <files>
    apps/web/src/components/agent/agent-message.tsx
    apps/web/src/components/agent/agent-message-list.tsx
    apps/web/src/hooks/use-agent.ts
    apps/web/src/components/agent/agent-panel.tsx
  </files>
  <action>
    **Safe markdown rendering:**
    Install DOMPurify: `pnpm add dompurify` and `pnpm add -D @types/dompurify` (run in apps/web/).

    In `agent-message.tsx`, sanitize markdown output:
    ```tsx
    import DOMPurify from "dompurify";
    import { marked } from "marked";

    // Configure marked for safe defaults
    marked.setOptions({
      breaks: true, // \n → <br>
      gfm: true,    // GitHub-flavored markdown (tables, strikethrough)
    });

    function renderMarkdown(content: string): string {
      const html = marked.parse(content) as string;
      return DOMPurify.sanitize(html, {
        ALLOWED_TAGS: ["p", "br", "strong", "em", "ul", "ol", "li", "a", "code", "pre", "h1", "h2", "h3", "h4", "table", "thead", "tbody", "tr", "th", "td", "blockquote"],
        ALLOWED_ATTR: ["href", "target", "rel"],
      });
    }
    ```
    Set `target="_blank"` and `rel="noopener noreferrer"` on links via DOMPurify hook or marked renderer override.

    Add prose styles for rendered markdown:
    ```tsx
    <div
      className="prose prose-sm dark:prose-invert max-w-none
        prose-p:my-1 prose-ul:my-1 prose-ol:my-1 prose-li:my-0.5
        prose-headings:my-2 prose-pre:my-2 prose-table:my-2
        prose-a:text-primary prose-a:underline"
      dangerouslySetInnerHTML={{ __html: renderMarkdown(message.content) }}
    />
    ```

    **Error handling and retry:**
    In `agent-message-list.tsx`, detect error messages (assistant messages that start with common error patterns or have an `error` flag). Show an error card:
    ```tsx
    {message.isError && (
      <div className="flex items-center gap-2 mt-2">
        <AlertCircle className="h-4 w-4 text-destructive" />
        <span className="text-sm text-destructive">Something went wrong</span>
        <Button variant="ghost" size="sm" onClick={() => onRetry(message)}>
          <RefreshCw className="h-3.5 w-3.5 mr-1" />
          Retry
        </Button>
      </div>
    )}
    ```

    Add `isError?: boolean` field to `AgentMessage` interface in the agent store.

    Update `useAgent` hook's error handling:
    - On API error (non-200 response or network error), mark the assistant message with `isError: true`.
    - Add a `retryLastMessage` function that:
      1. Removes the error assistant message
      2. Re-sends the last user message
      3. Creates a new assistant placeholder

    **Network error banner:**
    In `agent-panel.tsx`, add a connection status check:
    ```tsx
    {!navigator.onLine && (
      <div className="bg-destructive/10 text-destructive text-sm px-4 py-2 flex items-center gap-2 border-b">
        <WifiOff className="h-4 w-4" />
        Connection lost. Messages will be sent when you reconnect.
      </div>
    )}
    ```

    **Accessibility final pass:**
    - Ensure all interactive elements have `aria-label`:
      - Send button: "Send message"
      - Stop button: "Stop generating"
      - New Chat: "Start new conversation"
      - Close panel: handled by Sheet defaults
      - Trigger button: "Open research agent" (already set in Plan 02)
    - Ensure textarea has `aria-label="Message input"`
    - Ensure tool call indicator has `role="status"` and `aria-live="polite"`
    - Ensure minimum 44px tap targets on mobile for send/stop buttons and suggested action buttons

    **Input disabled state styling:**
    When `isStreaming`, the textarea should show `opacity-50 cursor-not-allowed` and be `disabled`.

    **Auto-focus textarea when panel opens:**
    ```tsx
    useEffect(() => {
      if (panelOpen) {
        setTimeout(() => textareaRef.current?.focus(), 300); // After panel animation
      }
    }, [panelOpen]);
    ```
  </action>
  <verify>
    - `pnpm typecheck` passes
    - Markdown renders safely (no raw HTML tags rendered, links open in new tab)
    - Tables render correctly in markdown
    - Error state shows retry button
    - Retry button re-sends the last user message
    - Textarea auto-focuses when panel opens
    - All buttons have aria-labels
    - Input disabled during streaming
  </verify>
  <done>
    Agent panel polished: safe markdown with DOMPurify, error handling with retry, network error banner, full accessibility, auto-focus input, disabled state styling. Production-ready for investor demo.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with no errors
2. Cmd+K toggles panel from any page
3. Markdown renders tables, lists, bold, links correctly
4. Links in markdown open in new tab
5. Error responses show retry button that works
6. Typing indicator shows during initial streaming delay
7. All animations smooth (messages, tool calls, suggested actions)
8. Reduced motion disables animations
9. Textarea auto-focuses when panel opens
10. All interactive elements accessible (aria-labels, keyboard navigable)
</verification>

<success_criteria>
- Keyboard shortcut Cmd+K works globally
- Markdown rendered safely with DOMPurify
- Error handling with retry button
- All animations smooth and respect reduced motion
- Full accessibility (aria-labels, keyboard navigation, tap targets)
- Typing indicator during streaming
- Production-ready quality for investor demo
</success_criteria>

<output>
After completion, create `.planning/phases/19-research-agent-chat-panel/19-04-SUMMARY.md`
</output>
