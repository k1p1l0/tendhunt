---
phase: 09-enhance-onboarding-company-photo-upload-ai-analysis-animations
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/components/onboarding/ai-analysis-progress.tsx
  - src/components/onboarding/onboarding-wizard.tsx
  - src/components/onboarding/company-info-form.tsx
  - src/components/onboarding/profile-review.tsx
  - src/app/onboarding/_actions.ts
autonomous: true

must_haves:
  truths:
    - "User sees animated step-by-step analysis progress instead of a spinner during AI profile generation"
    - "Analysis steps are conditional: only show 'Analyzing documents' if docs uploaded, 'Scanning website' if website provided, 'Reviewing LinkedIn' if LinkedIn URL provided"
    - "Last step stays active (pulsing) until the real API response arrives, then all steps mark complete"
    - "Logo dropzone appears at the top of the company info form in onboarding step 1"
    - "User's uploaded logo appears as a circular avatar at the top of the profile review step"
    - "logoKey is saved to CompanyProfile when onboarding completes"
  artifacts:
    - path: "src/components/onboarding/ai-analysis-progress.tsx"
      provides: "Animated step-by-step AI analysis progress component"
      exports: ["AIAnalysisProgress"]
    - path: "src/components/onboarding/onboarding-wizard.tsx"
      provides: "Wizard with logo state, AI analysis progress, logo threading"
      contains: "logoKey"
    - path: "src/components/onboarding/company-info-form.tsx"
      provides: "Company info form with LogoDropzone at top"
      contains: "LogoDropzone"
    - path: "src/components/onboarding/profile-review.tsx"
      provides: "Profile review with logo Avatar display"
      contains: "logoUrl"
    - path: "src/app/onboarding/_actions.ts"
      provides: "completeOnboarding accepting logoKey"
      contains: "logoKey"
  key_links:
    - from: "src/components/onboarding/onboarding-wizard.tsx"
      to: "src/components/onboarding/ai-analysis-progress.tsx"
      via: "renders AIAnalysisProgress when isGenerating=true"
      pattern: "AIAnalysisProgress"
    - from: "src/components/onboarding/onboarding-wizard.tsx"
      to: "src/components/onboarding/company-info-form.tsx"
      via: "passes logoKey and onLogoKeyChange props"
      pattern: "logoKey.*onLogoKeyChange"
    - from: "src/components/onboarding/onboarding-wizard.tsx"
      to: "src/components/onboarding/profile-review.tsx"
      via: "passes logoPreviewUrl prop for avatar display"
      pattern: "logoPreviewUrl"
    - from: "src/app/onboarding/_actions.ts"
      to: "src/models/company-profile.ts"
      via: "saves logoKey in CompanyProfile upsert"
      pattern: "logoKey"
---

<objective>
Create the AI Analysis Progress component with animated steps and wire everything into the onboarding wizard: logo dropzone in step 1, animated analysis progress in step 2, logo avatar in profile review, and logoKey persistence.

Purpose: Replace the basic Loader2 spinner with a polished, animated step-by-step progress display that gives users confidence the AI is actively working. Thread the logo through the entire onboarding flow from upload to persistence.
Output: 1 new file (AI analysis progress) + 4 modified files (wizard, company info form, profile review, server action)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Plan 01 outputs needed
@src/components/onboarding/logo-dropzone.tsx
@src/lib/upload-with-progress.ts

# Key source files to modify
@src/components/onboarding/onboarding-wizard.tsx
@src/components/onboarding/company-info-form.tsx
@src/components/onboarding/profile-review.tsx
@src/app/onboarding/_actions.ts

# Research reference
@.planning/phases/09-enhance-onboarding-company-photo-upload-ai-analysis-animations/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AIAnalysisProgress component with conditional animated steps</name>
  <files>
    src/components/onboarding/ai-analysis-progress.tsx
  </files>
  <action>
Create `src/components/onboarding/ai-analysis-progress.tsx` -- a "use client" component that displays animated analysis steps during AI profile generation.

**Component interface:**
```typescript
interface AIAnalysisProgressProps {
  isGenerating: boolean;       // Whether the API call is in progress
  hasDocuments: boolean;       // Whether user uploaded documents
  hasWebsite: boolean;         // Whether user provided website URL
  hasLinkedin: boolean;        // Whether user provided LinkedIn URL
  isComplete: boolean;         // Whether API returned successfully (triggers all-complete state)
  error: string | null;        // If API failed, show error on current step
}
```

**Step configuration:**
Build the step list dynamically based on what inputs were provided:
```typescript
interface AnalysisStep {
  label: string;
  icon: LucideIcon;
}

function buildSteps(hasDocuments: boolean, hasWebsite: boolean, hasLinkedin: boolean): AnalysisStep[] {
  return [
    ...(hasDocuments ? [{ label: "Analyzing uploaded documents...", icon: FileText }] : []),
    ...(hasWebsite ? [{ label: "Scanning company website...", icon: Globe }] : []),
    ...(hasLinkedin ? [{ label: "Reviewing LinkedIn profile...", icon: Linkedin }] : []),
    { label: "Extracting industry sectors...", icon: Search },
    { label: "Identifying core capabilities...", icon: Sparkles },
    { label: "Building company profile...", icon: Building2 },
  ];
}
```

Always-present steps: "Extracting industry sectors...", "Identifying core capabilities...", "Building company profile...". The last step ("Building company profile...") is always the catch-all that stays active until the API responds.

**Step status logic:**
Each step has status: `"pending" | "active" | "complete" | "error"`

Use `useState<number>` for `activeStepIndex` starting at 0 when `isGenerating` becomes true.

**Timer mechanism:**
```typescript
useEffect(() => {
  if (!isGenerating || isComplete) return;
  const interval = setInterval(() => {
    setActiveStepIndex(prev => Math.min(prev + 1, steps.length - 1));
  }, 2500);  // Advance every 2.5 seconds
  return () => clearInterval(interval);
}, [isGenerating, isComplete, steps.length]);
```

The last step (`steps.length - 1`) stays active (pulsing) indefinitely until `isComplete` becomes true.

**Completion behavior:**
When `isComplete` changes to true: set `activeStepIndex` to `steps.length` (all complete). Use a `useEffect` watching `isComplete`:
```typescript
useEffect(() => {
  if (isComplete) setActiveStepIndex(steps.length);
}, [isComplete, steps.length]);
```

**Error behavior:**
If `error` is truthy, the currently active step shows an error icon (AlertTriangle in red) instead of the pulsing dot. Steps above it stay complete. Steps below stay pending.

**Animation using tw-animate-css:**
Each step enters with staggered animation when its turn comes. Use CSS classes:
- Container for each step: `animate-in fade-in slide-in-from-bottom-2 duration-300`
- Only render a step's row when `index <= activeStepIndex` (steps appear one by one as the timer advances)
- Complete steps: green `Check` icon (`size-4 text-green-500`) with `animate-in fade-in zoom-in duration-200`
- Active step: pulsing dot (`size-2 animate-pulse rounded-full bg-primary`)
- Pending steps: gray dot (`size-2 rounded-full bg-muted`)
- Active step text: `font-medium text-foreground`
- Complete/pending step text: `text-muted-foreground`

**Render structure:**
```tsx
<div className="flex min-h-[200px] flex-col items-center justify-center gap-2 py-8">
  <div className="w-full max-w-xs space-y-3">
    {steps.map((step, index) => {
      if (index > activeStepIndex) return null;  // Not yet visible
      const status = getStepStatus(index, activeStepIndex, isComplete, error);
      return (
        <div key={step.label} className="animate-in fade-in slide-in-from-bottom-2 duration-300">
          <div className="flex items-center gap-3">
            {/* Status indicator */}
            {/* Icon */}
            {/* Label */}
          </div>
        </div>
      );
    })}
  </div>
  {/* Subtle helper text below */}
  <p className="mt-4 text-xs text-muted-foreground">
    This usually takes 10-20 seconds
  </p>
</div>
```

Import icons from lucide-react: `FileText`, `Globe`, `Linkedin`, `Search`, `Sparkles`, `Building2`, `Check`, `AlertTriangle`.
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Component exports `AIAnalysisProgress`
- Steps are built dynamically based on boolean props
- Timer advances steps every 2.5s, stops at last step
- `isComplete=true` marks all steps as complete
- Uses tw-animate-css classes (animate-in, fade-in, slide-in-from-bottom-2)
  </verify>
  <done>
- AIAnalysisProgress component renders conditional animated steps
- Steps appear one-by-one with staggered animation
- Last step stays active until API returns
- Error state shown on active step when API fails
- No framer-motion used -- pure CSS animations via tw-animate-css
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire logo dropzone and AI analysis progress into onboarding wizard</name>
  <files>
    src/components/onboarding/onboarding-wizard.tsx
    src/components/onboarding/company-info-form.tsx
    src/components/onboarding/profile-review.tsx
    src/app/onboarding/_actions.ts
  </files>
  <action>
**1. Update `src/components/onboarding/onboarding-wizard.tsx`:**

Add state for logo:
```typescript
const [logoKey, setLogoKey] = useState("");
const [logoPreviewUrl, setLogoPreviewUrl] = useState<string | null>(null);
```

Add state for generation completion (needed by AIAnalysisProgress):
```typescript
const [generationComplete, setGenerationComplete] = useState(false);
```

In the `generateProfile` function, after setting `profileData` successfully, also set `setGenerationComplete(true)`. On error, leave it false. Reset it when entering step 2: `setGenerationComplete(false)`.

**Modify Step 1 content:**
Pass logo props to `CompanyInfoForm`:
```tsx
<CompanyInfoForm
  value={companyInfo}
  onChange={setCompanyInfo}
  logoKey={logoKey}
  onLogoKeyChange={setLogoKey}
  onLogoPreviewChange={setLogoPreviewUrl}
/>
```

**Modify Step 2 content:**
Replace the entire `{isGenerating && (...)}` block (lines 297-311, the Loader2 spinner section) with:
```tsx
{isGenerating && (
  <AIAnalysisProgress
    isGenerating={isGenerating}
    hasDocuments={documentKeys.length > 0}
    hasWebsite={!!companyInfo.website.trim()}
    hasLinkedin={!!companyInfo.linkedinUrl.trim()}
    isComplete={generationComplete}
    error={null}
  />
)}
```

Keep the existing error and warning blocks (generationError, generationWarning) unchanged -- they display AFTER isGenerating becomes false.

Also, when `generationError` is set and `!isGenerating`, show the AIAnalysisProgress in error state:
Replace the generationError block with:
```tsx
{generationError && !isGenerating && (
  <div className="space-y-6">
    <AIAnalysisProgress
      isGenerating={false}
      hasDocuments={documentKeys.length > 0}
      hasWebsite={!!companyInfo.website.trim()}
      hasLinkedin={!!companyInfo.linkedinUrl.trim()}
      isComplete={false}
      error={generationError}
    />
    <div className="flex justify-center">
      <Button onClick={handleSkipToReview} variant="outline">
        Continue with empty profile
      </Button>
    </div>
  </div>
)}
```

**Modify Step 3 (Profile Review):**
Pass logo URL to ProfileReview:
```tsx
<ProfileReview
  initialProfile={profileData || EMPTY_PROFILE}
  onSave={handleSave}
  isSaving={isSaving}
  isAIGenerated={isAIGenerated}
  logoPreviewUrl={logoPreviewUrl}
/>
```

**Modify handleSave:**
Include `logoKey` in the data sent to `completeOnboarding`:
```typescript
const result = await completeOnboarding({
  ...data,
  documentKeys,
  isAIGenerated,
  logoKey,
});
```

Add imports:
```typescript
import { AIAnalysisProgress } from "./ai-analysis-progress";
```

**2. Update `src/components/onboarding/company-info-form.tsx`:**

Add logo props to the interface:
```typescript
interface CompanyInfoFormProps {
  value: CompanyInfo;
  onChange: (v: CompanyInfo) => void;
  logoKey?: string;
  onLogoKeyChange?: (key: string) => void;
  onLogoPreviewChange?: (url: string | null) => void;
}
```

Import LogoDropzone:
```typescript
import { LogoDropzone } from "./logo-dropzone";
```

Add the LogoDropzone at the TOP of the form (before the Company Name field), centered:
```tsx
<div className="space-y-4">
  {/* Logo Upload */}
  {onLogoKeyChange && (
    <div className="flex justify-center pb-2">
      <LogoDropzone
        logoKey={logoKey || ""}
        onLogoKeyChange={(key) => {
          onLogoKeyChange(key);
        }}
        onPreviewChange={onLogoPreviewChange}
      />
    </div>
  )}

  {/* Company Name */}
  ...existing fields...
</div>
```

Note: The `onPreviewChange` prop needs to be added to the LogoDropzone component interface from Plan 01. If it does not have it, add it: `onPreviewChange?: (url: string | null) => void`. In the LogoDropzone's handleDrop, call `onPreviewChange?.(preview)` after creating the object URL. This allows the wizard to thread the preview URL down to the profile review step.

**3. Update `src/components/onboarding/profile-review.tsx`:**

Add `logoPreviewUrl` to props:
```typescript
interface ProfileReviewProps {
  initialProfile: ProfileData;
  onSave: (data: ProfileData) => void;
  isSaving: boolean;
  isAIGenerated?: boolean;
  logoPreviewUrl?: string | null;
}
```

Add a logo avatar display at the very top of the profile review, before the AI-generated banner:
```tsx
{logoPreviewUrl && (
  <div className="flex justify-center">
    <div className="size-16 overflow-hidden rounded-full border-2 border-muted">
      <img
        src={logoPreviewUrl}
        alt="Company logo"
        className="size-full object-cover"
      />
    </div>
  </div>
)}
```

Use a plain `<img>` tag, NOT Next.js Image or AvatarImage (presigned URLs change on every render, breaks caching -- per research pitfall 6). The preview URL is a blob URL from step 1, so it works without any server round-trip.

**4. Update `src/app/onboarding/_actions.ts`:**

Add `logoKey` to the ProfileData interface:
```typescript
interface ProfileData {
  // ...existing fields...
  logoKey: string;  // Add this field
}
```

The `completeOnboarding` function already spreads `...profileData` into the upsert, so `logoKey` will be saved automatically to the CompanyProfile document. No other changes needed.
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Onboarding wizard step 1 shows LogoDropzone via CompanyInfoForm
- Onboarding wizard step 2 uses AIAnalysisProgress instead of Loader2
- Profile review step shows logo avatar when logoPreviewUrl is provided
- `completeOnboarding` accepts and saves `logoKey`
- `npm run build` succeeds (Next.js production build)
  </verify>
  <done>
- Logo dropzone appears at top of company info form in step 1
- AI analysis progress replaces Loader2 spinner in step 2
- Steps are conditional based on what the user provided
- Profile review shows uploaded logo as circular avatar
- logoKey is persisted to CompanyProfile on save
- Full onboarding flow works end-to-end with new UI enhancements
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- all TypeScript compiles cleanly
2. Run `npm run build` -- Next.js production build succeeds
3. Manual verification: Step 1 shows circular logo dropzone above company name field
4. Manual verification: Step 2 shows animated step-by-step progress, not a spinner
5. Manual verification: Steps shown match what user provided (conditional)
6. Manual verification: Profile review shows uploaded logo
7. Verify `logoKey` field is saved in MongoDB after completing onboarding
</verification>

<success_criteria>
- Zero TypeScript errors
- Production build succeeds
- Onboarding wizard step 1 has logo upload with circular preview
- Onboarding wizard step 2 has animated AI analysis progress (not Loader2 spinner)
- Analysis steps are conditional based on user inputs
- Logo avatar shown in profile review
- logoKey persisted to CompanyProfile document
</success_criteria>

<output>
After completion, create `.planning/phases/09-enhance-onboarding-company-photo-upload-ai-analysis-animations/09-02-SUMMARY.md`
</output>
