---
phase: 09-enhance-onboarding
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/components/onboarding/ai-analysis-progress.tsx
  - src/components/onboarding/onboarding-wizard.tsx
  - src/components/onboarding/profile-review.tsx
autonomous: false

must_haves:
  truths:
    - "User sees animated step-by-step AI analysis progress instead of a basic spinner during profile generation"
    - "Progress steps are conditional based on user inputs (documents, website, LinkedIn)"
    - "Company logo is displayed in the profile review step when available"
    - "Logo URL is threaded through the wizard and saved with the profile"
    - "Last analysis step stays active (pulsing) until API returns"
  artifacts:
    - path: "src/components/onboarding/ai-analysis-progress.tsx"
      provides: "Animated AI analysis progress component"
      min_lines: 80
    - path: "src/components/onboarding/onboarding-wizard.tsx"
      provides: "Updated wizard with AI progress and logoUrl threading"
      contains: "AiAnalysisProgress"
    - path: "src/components/onboarding/profile-review.tsx"
      provides: "Logo avatar display in profile review"
      contains: "logoUrl"
  key_links:
    - from: "src/components/onboarding/onboarding-wizard.tsx"
      to: "src/components/onboarding/ai-analysis-progress.tsx"
      via: "import and render AiAnalysisProgress"
      pattern: "AiAnalysisProgress"
    - from: "src/components/onboarding/onboarding-wizard.tsx"
      to: "src/components/onboarding/profile-review.tsx"
      via: "passes logoUrl prop"
      pattern: "logoUrl.*=.*logoUrl"
    - from: "src/components/onboarding/onboarding-wizard.tsx"
      to: "/api/profile/generate"
      via: "extracts logoUrl from API response"
      pattern: "data\\.logoUrl"
---

<objective>
Create the animated AI analysis progress component and wire it into the onboarding wizard, replacing the basic Loader2 spinner. Thread the auto-extracted logoUrl through the wizard to the profile review where it's displayed as a company avatar.

Purpose: The investor demo needs polish -- a step-by-step analysis animation shows the AI "thinking" during profile generation, and the auto-extracted logo provides immediate brand recognition in the profile review.

Output: New ai-analysis-progress.tsx component, updated onboarding-wizard.tsx with progress animation and logoUrl state, updated profile-review.tsx with logo avatar.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-enhance-onboarding-company-photo-upload-ai-analysis-animations/09-01-SUMMARY.md
@src/components/onboarding/onboarding-wizard.tsx
@src/components/onboarding/profile-review.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI analysis progress component</name>
  <files>src/components/onboarding/ai-analysis-progress.tsx</files>
  <action>
Create a new "use client" component `AiAnalysisProgress` that shows animated step-by-step AI analysis progress.

**Props interface:**
```typescript
interface AiAnalysisProgressProps {
  hasDocuments: boolean;     // Whether user uploaded documents
  hasWebsite: boolean;       // Whether user provided website URL
  hasLinkedIn: boolean;      // Whether user provided LinkedIn URL
  isComplete: boolean;       // Whether API call finished (success or error)
}
```

**Step definitions (conditional):**
Build the steps array dynamically based on which inputs the user provided. Each step has: `label` (display text), `icon` (Lucide icon component), `duration` (ms to show before moving to next).

Conditional steps:
- If hasDocuments: `{ label: "Extracting text from documents...", icon: FileText, duration: 2500 }`
- If hasWebsite: `{ label: "Analyzing company website...", icon: Globe, duration: 2500 }`
- If hasLinkedIn: `{ label: "Fetching LinkedIn company data...", icon: Linkedin, duration: 2500 }`
- Always: `{ label: "Building your company profile with AI...", icon: Brain, duration: 2500 }`
- Always (last): `{ label: "Finalizing profile...", icon: Sparkles, duration: Infinity }`

The last step has `Infinity` duration because it stays active (pulsing) until `isComplete` becomes true.

Import icons from `lucide-react`: `FileText`, `Globe`, `Linkedin`, `Brain`, `Sparkles`, `Check`.

**Timer mechanism:**
- Use `useState` for `currentStepIndex` (starts at 0).
- Use `useEffect` with `setTimeout` to advance `currentStepIndex` by 1 after the current step's duration elapses.
- When `currentStepIndex` reaches the last step, stop advancing (no more timeouts).
- When `isComplete` prop becomes true, set `currentStepIndex` to `steps.length` (all steps complete).

**Visual design:**
- Vertical list of steps with left-aligned icons.
- Each step shows in one of 3 states:
  - **Completed** (index < currentStepIndex): Green check icon (Check from lucide), text in `text-foreground`, icon in `text-green-500`. Apply `animate-in fade-in slide-in-from-left-2 duration-300` (tw-animate-css class).
  - **Active** (index === currentStepIndex): Step's own icon with `animate-pulse` CSS class, text in `text-foreground font-medium`, icon in `text-primary`.
  - **Pending** (index > currentStepIndex): Step's own icon, text in `text-muted-foreground`, icon in `text-muted-foreground/50`. Opacity 50%.

- Container: `min-h-[200px]` to match existing spinner area, centered vertically.
- Each step row: `flex items-center gap-3 py-2` with the icon (size-5) and label text (text-sm).
- Step transitions: When a step completes (goes from active to completed), the icon switches from the step icon to a green Check with a subtle fade animation.

**NO framer-motion.** Only use tw-animate-css utility classes and Tailwind's built-in `animate-pulse`.

The component does NOT make any API calls. It's purely visual -- the parent (onboarding-wizard) controls `isComplete`.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. The component should compile. Verify it exports `AiAnalysisProgress` and accepts the correct props interface.
  </verify>
  <done>
- AiAnalysisProgress component renders conditional steps based on user inputs
- Steps auto-advance on a 2.5s timer per step
- Last step pulses until isComplete is true
- Completed steps show green checkmark with fade-in animation
- Uses tw-animate-css classes (no framer-motion)
- Purely presentational -- no API calls
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire AI progress and logoUrl into onboarding wizard and profile review</name>
  <files>src/components/onboarding/onboarding-wizard.tsx, src/components/onboarding/profile-review.tsx</files>
  <action>
**onboarding-wizard.tsx changes:**

1. Import `AiAnalysisProgress` from `./ai-analysis-progress`.

2. Add `logoUrl` state:
   ```typescript
   const [logoUrl, setLogoUrl] = useState<string | null>(null);
   ```

3. In the `generateProfile()` async function (inside the useEffect for step 2), after parsing the API response (`const data = await res.json()`):
   - Extract logoUrl: `if (data.logoUrl) { setLogoUrl(data.logoUrl); }`
   - This is in addition to the existing `setProfileData(...)` logic.

4. Replace the Step 2 spinner UI. The current step 2 content when `isGenerating` is:
   ```jsx
   <Loader2 className="size-10 animate-spin text-primary" />
   <div className="text-center">...</div>
   ```
   Replace this entire block with:
   ```jsx
   <AiAnalysisProgress
     hasDocuments={documentKeys.length > 0}
     hasWebsite={!!companyInfo.website.trim()}
     hasLinkedIn={!!companyInfo.linkedinUrl.trim()}
     isComplete={false}
   />
   ```
   Note: `isComplete` is always false while `isGenerating` is true. When `isGenerating` becomes false, the wizard either moves to step 3 (success) or shows error/warning. So the progress component is only rendered during the loading state.

   Actually, a better UX: briefly show "all complete" before transitioning. Add a new state `isGenerationDone` (boolean, default false). Set it to true just BEFORE `setStep(3)` is called. Add a 500ms delay between setting `isGenerationDone=true` and calling `setStep(3)` so the user sees all steps checked:
   ```typescript
   setLogoUrl(data.logoUrl || null);
   // Brief pause to show completion animation
   setIsGenerating(false); // Actually, keep isGenerating until after delay
   ```

   Simpler approach: Use a `generationComplete` state that becomes true when the API returns successfully but before navigating away. Show `AiAnalysisProgress isComplete={generationComplete}` and use a 600ms setTimeout to transition to step 3:
   ```typescript
   if (data.profile) {
     setProfileData({...});
     setIsAIGenerated(true);
     setLogoUrl(data.logoUrl || null);
     setGenerationComplete(true); // triggers "all done" animation
     setTimeout(() => {
       setIsGenerating(false);
       setStep(3);
     }, 600);
     return; // don't run the finally block's setIsGenerating
   }
   ```
   Add `const [generationComplete, setGenerationComplete] = useState(false);` to state declarations. Reset it in the generateProfile start: `setGenerationComplete(false);`.

   Update the step 2 rendering:
   ```jsx
   {isGenerating && (
     <div className="flex min-h-[200px] flex-col items-center justify-center">
       <AiAnalysisProgress
         hasDocuments={documentKeys.length > 0}
         hasWebsite={!!companyInfo.website.trim()}
         hasLinkedIn={!!companyInfo.linkedinUrl.trim()}
         isComplete={generationComplete}
       />
     </div>
   )}
   ```

5. Remove the `Loader2` import if it's no longer used anywhere in this file. Check -- it IS still used if the save button shows a loading state... Actually looking at the code, `Loader2` is imported but only used in step 2's spinner. The save button says "Saving..." as text. So `Loader2` can be removed from imports.

6. Pass `logoUrl` to ProfileReview in step 3:
   ```jsx
   <ProfileReview
     initialProfile={profileData || EMPTY_PROFILE}
     onSave={handleSave}
     isSaving={isSaving}
     isAIGenerated={isAIGenerated}
     logoUrl={logoUrl}
   />
   ```

7. In `handleSave`, include logoUrl in the data passed to `completeOnboarding`:
   ```typescript
   const result = await completeOnboarding({
     ...data,
     documentKeys,
     isAIGenerated,
     logoUrl: logoUrl || undefined,
   });
   ```

**profile-review.tsx changes:**

1. Add `logoUrl?: string | null` to `ProfileReviewProps`.

2. At the top of the ProfileReview component JSX (above the AI-generated banner), add a logo display:
   ```jsx
   {logoUrl && (
     <div className="flex justify-center">
       <div className="relative size-20 overflow-hidden rounded-full border-2 border-primary/20 bg-muted">
         <img
           src={logoUrl}
           alt={`${initialProfile.companyName || "Company"} logo`}
           className="size-full object-cover"
           onError={(e) => { (e.target as HTMLImageElement).style.display = 'none'; }}
         />
       </div>
     </div>
   )}
   ```
   Use a plain `<img>` tag (not Next.js Image) since the URL is an external LinkedIn/website URL that may not be in next.config's remotePatterns. The `onError` handler hides the image gracefully if the URL is broken.

3. The logo avatar should appear between the start of the component's JSX and the "AI-generated profile" banner. It visually anchors the profile with the company's brand.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. Should compile without errors. Visually verify by checking:
1. AiAnalysisProgress is imported and rendered in step 2 of the wizard.
2. logoUrl state is extracted from API response.
3. ProfileReview receives and renders logoUrl.
4. Loader2 spinner is no longer rendered in step 2.
  </verify>
  <done>
- Step 2 shows animated AI analysis progress instead of Loader2 spinner
- Steps are conditional (documents, website, LinkedIn) based on user inputs
- Brief 600ms completion animation before transitioning to step 3
- logoUrl extracted from API response and stored in wizard state
- logoUrl passed to ProfileReview as prop
- ProfileReview shows circular logo avatar when logoUrl is available
- logoUrl included in completeOnboarding call for persistence
- img onError handler gracefully hides broken logo URLs
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify AI analysis animation and logo display</name>
  <action>
  Human verifies the AI analysis progress animation and auto-extracted logo display in the onboarding wizard.

  What was built: AI analysis progress animation replaces spinner in onboarding step 2. Company logo auto-extracted from LinkedIn/website appears in profile review (step 3).

  How to verify:
  1. Go to the onboarding wizard at app.tendhunt.com/onboarding
  2. Enter a company name AND a LinkedIn company page URL (e.g., https://linkedin.com/company/microsoft)
  3. Optionally enter a website URL
  4. Click "Continue" to step 2
  5. Verify: You see step-by-step progress animation (not a spinner)
     - Steps should include "Fetching LinkedIn company data..." and "Building your company profile with AI..."
     - If website was provided, "Analyzing company website..." should also appear
     - Steps auto-advance with green checkmarks
     - Last step pulses until API returns
     - Brief "all done" state before transitioning
  6. On step 3 (Review), verify:
     - Company logo appears as a circular avatar at the top (if LinkedIn returned a logo URL)
     - If no logo was found, no broken image placeholder shown
     - Rest of profile review works as before
  7. Save the profile and verify it completes successfully
  </action>
  <verify>Visual inspection confirms animation works and logo displays correctly</verify>
  <done>User approves the AI analysis animation and logo display in onboarding</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. AiAnalysisProgress component exists and renders conditional steps
3. Onboarding wizard step 2 shows animated progress (not Loader2)
4. logoUrl is extracted from API response and threaded to profile review
5. Profile review shows circular logo avatar when logoUrl is available
6. completeOnboarding receives and persists logoUrl
7. No framer-motion in dependencies -- only tw-animate-css used
</verification>

<success_criteria>
The onboarding wizard shows a polished AI analysis animation during profile generation with conditional steps based on user inputs, and the auto-extracted company logo appears in the profile review. The entire flow works end-to-end: user provides LinkedIn URL, AI generates profile with logo extracted from LinkedIn response (or og:image fallback), user reviews profile with logo avatar visible, saves successfully.
</success_criteria>

<output>
After completion, create `.planning/phases/09-enhance-onboarding-company-photo-upload-ai-analysis-animations/09-02-SUMMARY.md`
</output>
