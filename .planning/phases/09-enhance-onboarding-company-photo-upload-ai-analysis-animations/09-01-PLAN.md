---
phase: 09-enhance-onboarding-company-photo-upload-ai-analysis-animations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/upload-with-progress.ts
  - src/app/api/upload/logo/route.ts
  - src/components/onboarding/logo-dropzone.tsx
  - src/models/company-profile.ts
  - src/components/onboarding/document-dropzone.tsx
autonomous: true

must_haves:
  truths:
    - "Logo presigned URL endpoint returns { url, key } for image MIME types and rejects non-image types"
    - "LogoDropzone component allows single image upload with circular preview via URL.createObjectURL"
    - "Object URLs are revoked on unmount and on file replacement to prevent memory leaks"
    - "CompanyProfile model has a logoKey field for storing the R2 object key"
    - "uploadFileWithProgress is a shared utility used by both DocumentDropzone and LogoDropzone"
  artifacts:
    - path: "src/lib/upload-with-progress.ts"
      provides: "Shared XHR upload with progress callback"
      exports: ["uploadFileWithProgress"]
    - path: "src/app/api/upload/logo/route.ts"
      provides: "Image presigned URL endpoint"
      exports: ["POST"]
    - path: "src/components/onboarding/logo-dropzone.tsx"
      provides: "Single-image dropzone with circular avatar preview"
      exports: ["LogoDropzone"]
    - path: "src/models/company-profile.ts"
      provides: "CompanyProfile model with logoKey field"
      contains: "logoKey"
  key_links:
    - from: "src/components/onboarding/logo-dropzone.tsx"
      to: "/api/upload/logo"
      via: "fetch POST for presigned URL"
      pattern: "fetch.*api/upload/logo"
    - from: "src/components/onboarding/logo-dropzone.tsx"
      to: "src/lib/upload-with-progress.ts"
      via: "import uploadFileWithProgress"
      pattern: "import.*upload-with-progress"
    - from: "src/components/onboarding/document-dropzone.tsx"
      to: "src/lib/upload-with-progress.ts"
      via: "import uploadFileWithProgress (refactored from inline)"
      pattern: "import.*upload-with-progress"
---

<objective>
Create the logo upload infrastructure: shared upload utility, image presigned URL API endpoint, LogoDropzone component with circular avatar preview, and add logoKey to the CompanyProfile model.

Purpose: Provide the building blocks for company logo upload in the onboarding wizard. Plan 02 will wire these into the wizard and add the AI analysis progress component.
Output: 3 new files (shared util, API route, component) + 2 modified files (model, document dropzone refactor)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files to reference
@src/app/api/upload/presigned/route.ts
@src/components/onboarding/document-dropzone.tsx
@src/models/company-profile.ts
@src/lib/r2.ts
@src/components/ui/avatar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract uploadFileWithProgress to shared utility and create image presigned URL endpoint</name>
  <files>
    src/lib/upload-with-progress.ts
    src/app/api/upload/logo/route.ts
    src/components/onboarding/document-dropzone.tsx
    src/models/company-profile.ts
  </files>
  <action>
**1. Create `src/lib/upload-with-progress.ts`:**
Extract the `uploadFileWithProgress` function from `src/components/onboarding/document-dropzone.tsx` (lines 8-36) into this new shared utility file. The function signature:
```typescript
export function uploadFileWithProgress(
  url: string,
  file: File,
  onProgress: (progress: number) => void
): Promise<void>
```
Uses XHR with `upload.onprogress` for tracking (fetch API lacks upload progress events -- existing project decision).

**2. Update `src/components/onboarding/document-dropzone.tsx`:**
Remove the inline `uploadFileWithProgress` function and replace with:
```typescript
import { uploadFileWithProgress } from "@/lib/upload-with-progress";
```
Keep everything else identical. Do NOT change any other logic.

**3. Create `src/app/api/upload/logo/route.ts`:**
Clone the pattern from `src/app/api/upload/presigned/route.ts` with these changes:
- ALLOWED_CONTENT_TYPES: `image/png`, `image/jpeg`, `image/webp`, `image/svg+xml`
- R2 key prefix: `logos/${userId}/${nanoid()}-${filename}` (not `documents/`)
- Same auth check (`await auth()`, 401 if no userId)
- Same presigned URL generation using `getSignedUrl`, `PutObjectCommand`, `r2Client`
- Same response shape: `{ url, key }`
- Import r2Client from `@/lib/r2`, nanoid from `nanoid`, auth from `@clerk/nextjs/server`

**4. Add `logoKey` field to `src/models/company-profile.ts`:**
Add a single field after `documentKeys`:
```typescript
logoKey: { type: String, default: "" },
```
This stores the R2 object key (e.g., `logos/user123/abc-logo.png`), NOT a URL. Consistent naming with `documentKeys`.
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- `src/lib/upload-with-progress.ts` exports `uploadFileWithProgress`
- `src/components/onboarding/document-dropzone.tsx` imports from `@/lib/upload-with-progress`
- `src/app/api/upload/logo/route.ts` exports `POST` function with image MIME whitelist
- `src/models/company-profile.ts` has `logoKey` field in schema
  </verify>
  <done>
- Shared upload utility exists and is imported by document dropzone
- Logo presigned URL endpoint rejects non-image types and returns { url, key } for images
- CompanyProfile model includes logoKey field
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LogoDropzone component with circular avatar preview</name>
  <files>
    src/components/onboarding/logo-dropzone.tsx
  </files>
  <action>
Create `src/components/onboarding/logo-dropzone.tsx` -- a "use client" component for single image upload with circular avatar preview.

**Component interface:**
```typescript
interface LogoDropzoneProps {
  logoKey: string;           // Current R2 key (empty string if none)
  onLogoKeyChange: (key: string) => void;  // Callback when upload completes
}
```

**Implementation details:**

1. **State:**
   - `previewUrl: string | null` -- from `URL.createObjectURL(file)` for instant preview
   - `isUploading: boolean` -- upload in progress
   - `progress: number` -- 0-100 upload progress
   - `error: string | null` -- upload error message

2. **react-dropzone config:**
   ```typescript
   const { getRootProps, getInputProps, isDragActive } = useDropzone({
     accept: { 'image/*': ['.png', '.jpg', '.jpeg', '.webp', '.svg'] },
     maxFiles: 1,
     maxSize: 2 * 1024 * 1024,  // 2MB
     multiple: false,
     onDrop: handleDrop,
   });
   ```

3. **handleDrop logic:**
   - Take first file from accepted files
   - Revoke any existing previewUrl before creating new one
   - Create preview: `URL.createObjectURL(file)`
   - Set `isUploading = true`
   - Fetch presigned URL: `POST /api/upload/logo` with `{ filename: file.name, contentType: file.type }`
   - Upload using `uploadFileWithProgress` from `@/lib/upload-with-progress`
   - On success: call `onLogoKeyChange(key)`, set `isUploading = false`
   - On error: set error message, keep preview visible

4. **Cleanup (CRITICAL for memory leaks):**
   ```typescript
   useEffect(() => {
     return () => {
       if (previewUrl) URL.revokeObjectURL(previewUrl);
     };
   }, [previewUrl]);
   ```

5. **Render layout:**
   - Container: `flex flex-col items-center gap-3`
   - When no preview and no logoKey: Show a dashed-border circular dropzone (size-24 rounded-full border-2 border-dashed) with Camera icon (from lucide-react) centered, plus "Upload logo" text below. Make the entire circle clickable via getRootProps.
   - When preview exists: Show the image in a size-20 rounded-full overflow-hidden container using a plain `<img>` tag (NOT AvatarImage -- per research, avoid Radix fallback complexity for upload preview). Overlay a small edit/camera button at bottom-right of the circle.
   - During upload: Show a subtle progress ring or the progress percentage below the avatar.
   - On error: Show error text in text-destructive below the avatar.
   - The dropzone should also accept click to open file picker (default react-dropzone behavior).

6. **Import `uploadFileWithProgress` from `@/lib/upload-with-progress`**. Import `Camera` from `lucide-react`. Import `useDropzone` from `react-dropzone`.

Do NOT use the Avatar/AvatarImage shadcn components here -- use plain `<img>` inside a rounded container. The Avatar component is reserved for the profile review display (Plan 02).
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Component exports `LogoDropzone`
- Component uses `URL.createObjectURL` for preview
- Component has cleanup `useEffect` that revokes object URL
- Component calls `/api/upload/logo` endpoint
- Component uses `uploadFileWithProgress` from shared utility
  </verify>
  <done>
- LogoDropzone renders a circular dropzone for single image upload
- Instant preview shown via createObjectURL before upload completes
- Upload progress tracked via XHR
- Object URL revoked on unmount and file replacement
- R2 key passed to parent via onLogoKeyChange callback
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- all TypeScript compiles cleanly
2. `uploadFileWithProgress` shared utility exists at `src/lib/upload-with-progress.ts`
3. `document-dropzone.tsx` imports from shared utility (no inline copy)
4. `/api/upload/logo` route exists with image MIME whitelist
5. `LogoDropzone` component handles upload, preview, cleanup
6. `CompanyProfile` model has `logoKey` field
</verification>

<success_criteria>
- Zero TypeScript errors
- Logo upload infrastructure is complete and ready to wire into the onboarding wizard (Plan 02)
- Shared upload utility is used by both document and logo dropzones
- No memory leaks from object URLs (cleanup useEffect present)
</success_criteria>

<output>
After completion, create `.planning/phases/09-enhance-onboarding-company-photo-upload-ai-analysis-animations/09-01-SUMMARY.md`
</output>
