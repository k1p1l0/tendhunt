---
phase: 16-scanner-ux-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/scanner-store.ts
  - src/components/scanners/grid/scanner-data-grid.tsx
  - src/app/(dashboard)/scanners/[id]/page.tsx
  - src/components/scanners/scanner-filter-toolbar.tsx
  - src/components/scanners/threshold-controls.tsx
autonomous: true

must_haves:
  truths:
    - "Threshold slider and hide/dim toggle no longer appear anywhere in scanner UI"
    - "Applied column filters are visible as chip pills in a toolbar between header and grid"
    - "User can remove individual filter chips by clicking X on each chip"
    - "User can clear all filters with a single 'Clear filters' action"
    - "Existing per-column header menu filter checkboxes still work as secondary entry point"
    - "Grid rows still correctly filtered when column filters are active"
  artifacts:
    - path: "src/components/scanners/scanner-filter-toolbar.tsx"
      provides: "Notion-style filter chip toolbar component"
      min_lines: 50
    - path: "src/stores/scanner-store.ts"
      provides: "Scanner store without threshold/hideBelow state"
    - path: "src/app/(dashboard)/scanners/[id]/page.tsx"
      provides: "Scanner page with filter toolbar, no threshold controls"
  key_links:
    - from: "src/components/scanners/scanner-filter-toolbar.tsx"
      to: "src/stores/scanner-store.ts"
      via: "useScannerStore columnFilters + setColumnFilter + clearColumnFilters"
      pattern: "useScannerStore.*columnFilters"
    - from: "src/app/(dashboard)/scanners/[id]/page.tsx"
      to: "src/components/scanners/scanner-filter-toolbar.tsx"
      via: "import and render in toolbar area"
      pattern: "ScannerFilterToolbar"
---

<objective>
Remove threshold/dim controls from scanners and replace them with a Notion-style filter chip toolbar.

Purpose: The threshold slider and hide/dim toggle add complexity without enough user value. Replacing them with visible filter chips makes active filters discoverable and manageable — matching the Notion-style UX the user wants.

Output: Clean scanner page with filter chip toolbar, no threshold controls.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/stores/scanner-store.ts
@src/components/scanners/grid/scanner-data-grid.tsx
@src/app/(dashboard)/scanners/[id]/page.tsx
@src/components/scanners/threshold-controls.tsx
@src/components/scanners/scanner-header.tsx
@src/components/scanners/grid/header-menu.tsx
@src/components/scanners/grid/format-utils.ts
@src/components/scanners/table-columns.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove threshold/dim controls from store, grid, and page</name>
  <files>
    src/stores/scanner-store.ts
    src/components/scanners/grid/scanner-data-grid.tsx
    src/app/(dashboard)/scanners/[id]/page.tsx
    src/components/scanners/threshold-controls.tsx
  </files>
  <action>
    **scanner-store.ts — Remove threshold state:**
    - Delete `threshold: number` (line 36) and `hideBelow: boolean` (line 37) from state interface
    - Delete `setThreshold` (line 53) and `setHideBelow` (line 54) from actions interface
    - Delete initial values `threshold: 5` (line 83) and `hideBelow: false` (line 84)
    - Delete action implementations `setThreshold` (line 111) and `setHideBelow` (line 113)

    **scanner-data-grid.tsx — Remove threshold rendering logic:**
    - Remove store bindings for `threshold` and `hideBelow` (lines 76-77)
    - Simplify `displayRows` computation (lines 184-202): remove the above/below threshold split. `displayRows` should simply be `filteredRows` (no threshold splitting needed anymore)
    - Remove `thresholdBoundary` calculation entirely (lines 204-216)
    - Remove `getRowThemeOverride` callback entirely (lines 225-236) — no more row dimming
    - Remove `getRowThemeOverride` prop from DataEditor component (line 879)

    **page.tsx — Remove threshold import and rendering:**
    - Delete import of `ThresholdControls` (line 10)
    - Delete the entire inline toolbar row that renders `<ThresholdControls>` (lines 1085-1088). Keep the `<div>` wrapper but make it render the new filter toolbar (Task 2 will add this)
    - Delete `primaryColumnId` useMemo (lines 986-990) since it was only used for threshold controls

    **threshold-controls.tsx — Delete the file entirely.** It is no longer used.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors.
    Grep for "threshold" and "hideBelow" in src/stores/scanner-store.ts and src/components/scanners/ — no references remain (except possibly threshold in comments which is fine).
    Grep for "ThresholdControls" — no imports remain.
  </verify>
  <done>
    Threshold slider, hide/dim switch, and row dimming logic are fully removed. The scanner grid shows all rows without dimming. No TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Notion-style filter chip toolbar and wire into scanner page</name>
  <files>
    src/components/scanners/scanner-filter-toolbar.tsx
    src/app/(dashboard)/scanners/[id]/page.tsx
  </files>
  <action>
    **Create `src/components/scanners/scanner-filter-toolbar.tsx`:**

    A "use client" component that reads `columnFilters` from scanner store and renders applied filters as chip pills.

    Props:
    - `columns: ColumnDef[]` — column definitions to resolve column names from column IDs
    - No other props needed; reads filter state directly from `useScannerStore`

    Implementation:
    1. Read `columnFilters`, `setColumnFilter`, `clearColumnFilters` from `useScannerStore`
    2. Compute `activeFilters` — entries of columnFilters where values.length > 0
    3. If no active filters, render nothing (return null) — the toolbar only appears when filters are active
    4. Render a horizontal flex bar with:
       - A `<Filter>` lucide icon + "Filters" label on the left
       - For each active filter entry (columnId, values[]):
         - Resolve the column name from the `columns` prop by matching `col.id === columnId`
         - For each value in values, render a chip pill: `<span>` with the column name + "=" + value, styled as a rounded-full pill with `bg-muted text-sm px-2.5 py-0.5`, plus an X button that calls `setColumnFilter(columnId, values.filter(v => v !== thisValue))`
         - If there are multiple values for one column, show each as a separate chip (e.g., "Sector = Health", "Sector = Defence")
       - A "Clear filters" text button on the right that calls `clearColumnFilters()`
    5. Use Tailwind classes for chip styling: `inline-flex items-center gap-1 rounded-full bg-muted px-2.5 py-0.5 text-xs font-medium` for the chip, and a small `X` icon (lucide X, h-3 w-3) button inside each chip
    6. The toolbar container: `flex flex-wrap items-center gap-2 px-1` — wraps on small screens

    **Wire into page.tsx:**
    - Import `ScannerFilterToolbar` from `@/components/scanners/scanner-filter-toolbar`
    - In the toolbar area where ThresholdControls was removed (the `<div className="flex flex-wrap items-center gap-6">` block), replace it with `<ScannerFilterToolbar columns={columns} />`
    - The component self-hides when no filters are active, so no conditional rendering needed in page.tsx
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors.
    The scanner page loads without errors and no threshold controls appear.
    When column filters are applied via the header menu checkboxes, chip pills appear in the toolbar area.
    Clicking X on a chip removes that specific filter value.
    Clicking "Clear filters" removes all filters.
  </verify>
  <done>
    Filter chip toolbar renders applied filters as Notion-style chips with X-to-remove. Clear filters button works. Toolbar auto-hides when no filters are active. Per-column header menu filters still work as secondary entry point and chips stay in sync.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. No references to ThresholdControls, threshold, hideBelow remain in scanner components
3. Scanner page renders correctly with filter toolbar visible when filters are active
4. Applying filters via header menu shows chips; removing chips removes filters; clearing all works
5. Grid correctly filters rows based on active column filters (existing behavior preserved)
</verification>

<success_criteria>
- Threshold slider and hide/dim toggle completely removed from UI and store
- Filter chip toolbar shows applied filters as pill chips with X to remove
- Clear filters button removes all active filters
- Existing per-column header menu filter checkboxes continue working
- Grid row filtering works correctly (AND across columns, OR within column)
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-scanner-ux-polish/16-01-SUMMARY.md`
</output>
