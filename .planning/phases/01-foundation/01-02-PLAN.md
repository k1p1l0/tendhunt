---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/mongodb.ts
  - src/models/user.ts
  - src/models/contract.ts
  - src/models/buyer.ts
  - src/models/signal.ts
  - src/models/credit.ts
  - src/types/index.ts
  - src/app/api/webhooks/clerk/route.ts
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/dashboard/page.tsx
  - src/app/(dashboard)/contracts/page.tsx
  - src/app/(dashboard)/buyers/page.tsx
  - src/app/(dashboard)/settings/page.tsx
  - src/components/layout/app-sidebar.tsx
  - src/components/layout/header.tsx
autonomous: false
user_setup:
  - service: mongodb-atlas
    why: "Database for contracts, buyers, signals, users, and credits"
    env_vars:
      - name: MONGODB_URI
        source: "MongoDB Atlas Dashboard -> Database -> Connect -> Drivers -> Copy connection string"
    account_setup:
      - "Create a MongoDB Atlas account at mongodb.com/atlas if you don't have one"
      - "Create an M0 (free tier) cluster in AWS eu-west-1 (Ireland) or eu-west-2 (London)"
      - "Create a database user with readWrite permissions"
    dashboard_config:
      - task: "Add 0.0.0.0/0 to Network Access (allow all IPs for development)"
        location: "MongoDB Atlas -> Network Access -> Add IP Address -> Allow Access from Anywhere"
      - task: "Create database named 'tendhunt'"
        location: "MongoDB Atlas -> Database -> Browse Collections -> Create Database"
  - service: clerk-webhook
    why: "Sync Clerk users to MongoDB on signup/update/delete"
    env_vars:
      - name: CLERK_WEBHOOK_SIGNING_SECRET
        source: "Clerk Dashboard -> Webhooks -> Signing Secret"
    dashboard_config:
      - task: "Create webhook endpoint pointing to your-domain/api/webhooks/clerk"
        location: "Clerk Dashboard -> Webhooks -> Add Endpoint"
      - task: "Subscribe to events: user.created, user.updated, user.deleted"
        location: "Clerk Dashboard -> Webhooks -> Your endpoint -> Events"
      - task: "For local testing, use ngrok: run 'ngrok http 3000' and use the ngrok URL as webhook endpoint"
        location: "Terminal"

must_haves:
  truths:
    - "MongoDB Atlas is connected and accepting queries from the Next.js app"
    - "All 5 Mongoose models (User, Contract, Buyer, Signal, Credit) are defined and importable"
    - "When a user signs up via Clerk, a corresponding User document is created in MongoDB"
    - "App shell shows sidebar navigation with links to Dashboard, Contracts, Buyers, and Settings"
    - "App shell shows header with Clerk UserButton (avatar + sign out)"
    - "Placeholder pages render inside the dashboard layout at /dashboard, /contracts, /buyers, /settings"
  artifacts:
    - path: "src/lib/mongodb.ts"
      provides: "Mongoose connection singleton for serverless environments"
      contains: "mongoose.connect"
    - path: "src/models/user.ts"
      provides: "User model synced from Clerk (clerkId, email, name, imageUrl)"
      contains: "clerkId"
    - path: "src/models/contract.ts"
      provides: "Unified contract schema (Find a Tender + Contracts Finder)"
      contains: "FIND_A_TENDER"
    - path: "src/models/buyer.ts"
      provides: "Buyer organization model"
      contains: "model.*Buyer"
    - path: "src/models/signal.ts"
      provides: "Buying signal model (board minutes)"
      contains: "PROCUREMENT"
    - path: "src/models/credit.ts"
      provides: "Credit account and transaction models"
      contains: "CreditAccount"
    - path: "src/app/api/webhooks/clerk/route.ts"
      provides: "Clerk webhook handler for user sync to MongoDB"
      contains: "verifyWebhook"
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Dashboard shell with sidebar and header"
      contains: "SidebarProvider"
    - path: "src/components/layout/app-sidebar.tsx"
      provides: "Sidebar navigation component"
      contains: "Dashboard|Contracts|Buyers"
    - path: "src/components/layout/header.tsx"
      provides: "Header with UserButton"
      contains: "UserButton"
  key_links:
    - from: "src/app/api/webhooks/clerk/route.ts"
      to: "src/models/user.ts"
      via: "Creates User document on Clerk user.created event"
      pattern: "User\\.create|User\\.findOneAndUpdate"
    - from: "src/app/api/webhooks/clerk/route.ts"
      to: "src/lib/mongodb.ts"
      via: "Calls dbConnect() before database operations"
      pattern: "dbConnect"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/components/layout/app-sidebar.tsx"
      via: "Renders AppSidebar inside SidebarProvider"
      pattern: "AppSidebar"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "@clerk/nextjs/server"
      via: "Calls auth() to check authentication, redirects if not signed in"
      pattern: "auth\\(\\)|redirect.*sign-in"
    - from: "src/components/layout/header.tsx"
      to: "@clerk/nextjs"
      via: "Renders UserButton for user avatar and sign-out"
      pattern: "UserButton"
---

<objective>
Connect MongoDB Atlas with Mongoose schemas for all 5 collections, implement Clerk webhook user sync, and build the authenticated app shell with sidebar/header navigation and placeholder pages.

Purpose: This plan completes the Phase 1 foundation -- after this, every subsequent phase has a database to store data, authentication to protect routes, and a dashboard shell to render features into.
Output: MongoDB connection singleton, 5 Mongoose models, Clerk webhook handler, dashboard layout with sidebar/header, and 4 placeholder pages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: MongoDB connection singleton, all 5 Mongoose models, and Clerk webhook handler</name>
  <files>
    src/lib/mongodb.ts
    src/models/user.ts
    src/models/contract.ts
    src/models/buyer.ts
    src/models/signal.ts
    src/models/credit.ts
    src/types/index.ts
    src/app/api/webhooks/clerk/route.ts
  </files>
  <action>
1. Create `src/lib/mongodb.ts` with the Mongoose connection singleton pattern from RESEARCH.md:
   - Import mongoose
   - Read MONGODB_URI from process.env (throw if missing)
   - Export `dbConnect()` function that calls `mongoose.connect(MONGODB_URI)` -- this is a no-op when already connected
   - Do NOT use the global caching pattern with `global.mongoose` -- Mongoose 9.x handles connection reuse internally via `mongoose.connect()` being a no-op

2. Create `src/models/user.ts`:
   - Fields: `clerkId` (String, required, unique, indexed), `email` (String, required), `firstName` (String), `lastName` (String), `imageUrl` (String), `createdAt` (Date, default Date.now), `updatedAt` (Date, default Date.now)
   - Use hot-reload-safe pattern: `mongoose.models.User || mongoose.model('User', userSchema)`

3. Create `src/models/contract.ts` -- the unified contract schema from RESEARCH.md:
   - Source fields: `ocid` (String, sparse), `noticeId` (String, required), `source` (enum: FIND_A_TENDER, CONTRACTS_FINDER, required), `sourceUrl` (String)
   - Core fields: `title` (String, required, text index), `description` (String, text index), `status` (enum: OPEN, CLOSED, AWARDED, CANCELLED, default OPEN, indexed), `stage` (enum: PLANNING, TENDER, AWARD, default TENDER)
   - Buyer fields: `buyerName` (String, required, indexed), `buyerOrg` (String), `buyerRegion` (String, indexed)
   - Classification: `cpvCodes` ([String]), `sector` (String, indexed)
   - Value: `valueMin` (Number), `valueMax` (Number), `currency` (String, default GBP)
   - Dates: `publishedDate` (Date, indexed), `deadlineDate` (Date, indexed)
   - AI scoring (Phase 5 placeholder): `vibeScore` (Number, min 0, max 10), `vibeReasoning` (String)
   - Raw data: `rawData` (Mixed)
   - Schema options: `{ timestamps: true }`
   - Compound indexes: `{ source: 1, noticeId: 1 }` unique, `{ status: 1, publishedDate: -1 }`, `{ sector: 1, status: 1 }`

4. Create `src/models/buyer.ts`:
   - Fields: `name` (String, required, indexed), `orgId` (String, unique, sparse), `sector` (String, indexed), `region` (String, indexed), `website` (String), `description` (String), `contractCount` (Number, default 0), `contacts` (array of embedded docs: `name` String, `title` String, `email` String, `linkedIn` String, `isRevealed` Boolean default false), `vibeScore` (Number, min 0, max 10), `vibeReasoning` (String)
   - Schema options: `{ timestamps: true }`

5. Create `src/models/signal.ts`:
   - Fields: `organizationName` (String, required, indexed), `buyerId` (ObjectId, ref Buyer, optional), `signalType` (enum: PROCUREMENT, STAFFING, STRATEGY, FINANCIAL, PROJECTS, REGULATORY, required, indexed), `title` (String, required), `insight` (String, required), `source` (String -- URL or document name), `sourceDate` (Date, indexed), `sector` (String, indexed), `confidence` (Number, min 0, max 1, default 0.8)
   - Schema options: `{ timestamps: true }`

6. Create `src/models/credit.ts` -- define TWO models in one file:
   - **CreditAccount** schema: `userId` (String, required, unique -- Clerk user ID), `balance` (Number, required, default 10, min 0), `totalEarned` (Number, default 10), `totalSpent` (Number, default 0)
   - Schema options: `{ timestamps: true }`
   - **CreditTransaction** schema: `userId` (String, required, indexed), `type` (enum: SIGNUP_BONUS, CONTACT_REVEAL, PURCHASE, REFUND, required), `amount` (Number, required -- positive for credits in, negative for credits out), `description` (String), `contactId` (String, optional -- reference to revealed contact), `balanceAfter` (Number, required)
   - Schema options: `{ timestamps: true }`
   - Export both: `CreditAccount` and `CreditTransaction`

7. Create `src/types/index.ts`:
   - Export TypeScript interfaces for the nav items used in sidebar: `NavItem { title: string; href: string; icon: string; badge?: string }`
   - Export any shared types that components will use

8. Create `src/app/api/webhooks/clerk/route.ts`:
   - Import `verifyWebhook` from `@clerk/nextjs/webhooks` (NOT svix)
   - Import `NextRequest` from `next/server`
   - Import `dbConnect` from `@/lib/mongodb`
   - Import `User` from `@/models/user`
   - Export async `POST` handler:
     - Call `verifyWebhook(req)` to verify the webhook signature
     - On `user.created`: call `dbConnect()`, create User document with clerkId, email (from email_addresses[0].email_address), firstName (first_name), lastName (last_name), imageUrl (image_url)
     - On `user.updated`: call `dbConnect()`, findOneAndUpdate by clerkId with updated fields + `updatedAt: new Date()`
     - On `user.deleted`: call `dbConnect()`, findOneAndDelete by clerkId
     - Return `new Response('Webhook received', { status: 200 })` on success
     - Catch errors and return `new Response('Error verifying webhook', { status: 400 })`

IMPORTANT: Use `verifyWebhook` from `@clerk/nextjs/webhooks` -- NOT the old svix pattern. No svix dependency needed.
IMPORTANT: Every model file MUST use the `mongoose.models.X || mongoose.model('X', schema)` pattern to prevent hot-reload errors.
IMPORTANT: Do NOT import Mongoose models in client components -- they are server-only.
  </action>
  <verify>
    Run `npm run build` and confirm no errors. Verify all 5 model files exist in `src/models/`. Verify the webhook route exists at `src/app/api/webhooks/clerk/route.ts`. Verify `src/lib/mongodb.ts` exports `dbConnect`.
  </verify>
  <done>
    MongoDB connection singleton is configured. All 5 Mongoose models (User, Contract, Buyer, Signal, CreditAccount + CreditTransaction) are defined with proper indexes, validation, and hot-reload-safe registration. Clerk webhook handler syncs users to MongoDB on signup/update/delete using verifyWebhook().
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard app shell with sidebar navigation, header, and placeholder pages</name>
  <files>
    src/app/(dashboard)/layout.tsx
    src/app/(dashboard)/dashboard/page.tsx
    src/app/(dashboard)/contracts/page.tsx
    src/app/(dashboard)/buyers/page.tsx
    src/app/(dashboard)/settings/page.tsx
    src/components/layout/app-sidebar.tsx
    src/components/layout/header.tsx
  </files>
  <action>
1. Create `src/components/layout/app-sidebar.tsx`:
   - Use shadcn/ui Sidebar components: `Sidebar`, `SidebarContent`, `SidebarGroup`, `SidebarGroupLabel`, `SidebarGroupContent`, `SidebarMenu`, `SidebarMenuButton`, `SidebarMenuItem`, `SidebarHeader`, `SidebarFooter`
   - This is a client component (`"use client"`) since SidebarMenuButton handles click interactions
   - SidebarHeader: Display TendHunt logo/text ("TendHunt" in bold with a small radar/target icon if available, or just text)
   - SidebarContent: Navigation group with label "Platform" containing these menu items:
     - Dashboard (icon: LayoutDashboard from lucide-react, href: /dashboard)
     - Contracts (icon: FileText from lucide-react, href: /contracts)
     - Buyers (icon: Building2 from lucide-react, href: /buyers)
     - Settings (icon: Settings from lucide-react, href: /settings)
   - Use `usePathname()` from `next/navigation` to highlight the active nav item (check if pathname starts with item.href)
   - SidebarFooter: Can be empty for now (will add credit balance here in Phase 6)
   - Install lucide-react if not already installed: `npm install lucide-react`

2. Create `src/components/layout/header.tsx`:
   - Use shadcn/ui components and Clerk's `UserButton`
   - Layout: flex row, justify-between, items-center, border-b, p-4, bg-background
   - Left side: `SidebarTrigger` from shadcn/ui (hamburger menu toggle for mobile), then a `Separator` (vertical), then breadcrumb or page title (can be static "Dashboard" text for now)
   - Right side: Clerk `UserButton` component (shows user avatar, click to sign out)
   - This needs to be a mix -- `UserButton` is a client component, but the header can be a server component that imports it. Or make the whole header a client component for simplicity.

3. Create `src/app/(dashboard)/layout.tsx`:
   - This is a Server Component (async function)
   - Import `auth` from `@clerk/nextjs/server`
   - Call `const { userId } = await auth()` -- if no userId, `redirect('/sign-in')`
   - Import and use shadcn/ui `SidebarProvider` and `SidebarInset`
   - Render structure:
     ```
     <SidebarProvider>
       <AppSidebar />
       <SidebarInset>
         <Header />
         <main className="flex-1 p-6">{children}</main>
       </SidebarInset>
     </SidebarProvider>
     ```

4. Create `src/app/(dashboard)/dashboard/page.tsx`:
   - Placeholder page with title "Dashboard" in h1
   - Show a welcome message: "Welcome to TendHunt. Your procurement intelligence platform."
   - Add 3-4 placeholder cards using shadcn/ui Card component:
     - "Active Contracts" with value "0" and description "Matching your profile"
     - "Buyer Organizations" with value "0" and description "In your sectors"
     - "Buying Signals" with value "0" and description "Pre-tender opportunities"
     - "Credits Remaining" with value "10" and description "Free tier"
   - Use CSS grid: 1 col on mobile, 2 cols on md, 4 cols on lg
   - Below the cards, a section titled "Recent Contracts" with text "No contracts ingested yet. Data pipeline coming in Phase 2."

5. Create `src/app/(dashboard)/contracts/page.tsx`:
   - Placeholder with h1 "Contracts"
   - Description: "Contract feed with search and filters. Coming in Phase 4."
   - Empty state card

6. Create `src/app/(dashboard)/buyers/page.tsx`:
   - Placeholder with h1 "Buyers"
   - Description: "Buyer organization profiles and contacts. Coming in Phase 6."
   - Empty state card

7. Create `src/app/(dashboard)/settings/page.tsx`:
   - Placeholder with h1 "Settings"
   - Description: "Account settings and company profile. Coming in Phase 3."
   - Empty state card

IMPORTANT: The dashboard layout MUST use `await auth()` (async) -- Next.js 16 requires all dynamic APIs to be awaited.
IMPORTANT: Do NOT import Mongoose models in any of these components -- they are for display only. Database access happens in API routes and Server Actions.
  </action>
  <verify>
    Run `npm run build` and confirm no errors. Verify all 4 page files exist in `src/app/(dashboard)/`. Verify layout.tsx, app-sidebar.tsx, and header.tsx exist. Check that the sidebar component imports lucide-react icons.
  </verify>
  <done>
    Dashboard app shell is complete: sidebar shows navigation links (Dashboard, Contracts, Buyers, Settings) with active state highlighting, header displays SidebarTrigger and Clerk UserButton, and 4 placeholder pages render inside the shell layout. Authenticated users see the full app shell at /dashboard.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 1 foundation</name>
  <what-built>Complete Phase 1 foundation: MongoDB Atlas connection with 5 Mongoose schemas, Clerk webhook for user sync, and the full app shell with sidebar navigation, header with UserButton, and 4 placeholder pages (Dashboard, Contracts, Buyers, Settings).</what-built>
  <how-to-verify>
    Before testing, configure real credentials:
    1. Replace MONGODB_URI in `.env.local` with your real MongoDB Atlas connection string
    2. Set up Clerk webhook:
       a. Run `ngrok http 3000` in a separate terminal
       b. Copy the ngrok URL (e.g., https://abc123.ngrok.io)
       c. In Clerk Dashboard -> Webhooks -> Add Endpoint: URL = {ngrok-url}/api/webhooks/clerk
       d. Subscribe to events: user.created, user.updated, user.deleted
       e. Copy the Signing Secret to CLERK_WEBHOOK_SIGNING_SECRET in .env.local
    3. Start the dev server: `npm run dev`
    4. Visit http://localhost:3000/dashboard -- you should see the dashboard with sidebar and header
    5. Verify sidebar shows: Dashboard, Contracts, Buyers, Settings with icons
    6. Click each sidebar link -- each should show its placeholder page
    7. Verify the header shows the Clerk UserButton (your avatar) in the top right
    8. Verify the dashboard shows 4 summary cards (Active Contracts, Buyer Organizations, Buying Signals, Credits Remaining)
    9. Test user sync: Create a new test user via sign-up. Check MongoDB Atlas -> tendhunt -> users collection for the new document
    10. Test session persistence: Refresh the page -- you should remain signed in
  </how-to-verify>
  <resume-signal>Type "approved" if the app shell, auth, and MongoDB connection all work. Describe any issues you see.</resume-signal>
</task>

</tasks>

<verification>
Phase 1 Plan 02 verification checklist:
1. `npm run build` succeeds without errors
2. `src/lib/mongodb.ts` exports `dbConnect()` with singleton pattern
3. All 5 model files exist: user.ts, contract.ts, buyer.ts, signal.ts, credit.ts
4. `src/app/api/webhooks/clerk/route.ts` uses `verifyWebhook` (not svix)
5. `src/app/(dashboard)/layout.tsx` uses `await auth()` and SidebarProvider
6. `src/components/layout/app-sidebar.tsx` has 4 nav items with lucide-react icons
7. `src/components/layout/header.tsx` shows UserButton and SidebarTrigger
8. All 4 placeholder pages render inside the dashboard layout
9. Active nav item is highlighted in sidebar based on current pathname
</verification>

<success_criteria>
- MongoDB connection singleton works without connection storms in dev mode
- All 5 Mongoose models are defined with proper indexes and validation
- Clerk webhook creates User documents in MongoDB on signup
- Dashboard shell renders with sidebar (4 nav items), header (UserButton), and content area
- Placeholder pages render at /dashboard, /contracts, /buyers, /settings
- Session persists across page refresh (Clerk handles this)
- `npm run build` passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
