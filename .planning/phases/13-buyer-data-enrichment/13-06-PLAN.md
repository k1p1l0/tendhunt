---
phase: 13-buyer-data-enrichment
plan: 06
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/lib/buyers.ts
  - src/components/buyers/buyer-header.tsx
  - src/components/buyers/buyer-detail-client.tsx
  - src/components/buyers/buyer-tabs.tsx
  - src/components/buyers/board-documents-tab.tsx
  - src/components/buyers/key-personnel-tab.tsx
  - src/components/buyers/enrichment-badge.tsx
  - src/app/(dashboard)/buyers/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "Buyer profile header shows enrichment score badge (circular progress indicator 0-100)"
    - "Buyer profile header shows orgType badge, staff count, annual budget when available"
    - "Board Documents tab shows list of meeting documents with dates and links"
    - "Key Personnel tab shows grid of personnel cards with name, title, role, confidence"
    - "Empty enrichment data shows 'No data yet' states (not hidden tabs)"
    - "Existing buyer profile functionality (Contracts, Contacts, Signals, Attributes tabs) unchanged"
  artifacts:
    - path: "src/components/buyers/enrichment-badge.tsx"
      provides: "Circular enrichment score badge component (0-100)"
      min_lines: 20
    - path: "src/components/buyers/board-documents-tab.tsx"
      provides: "List of board documents with date, committee, type, and source URL link"
      min_lines: 30
    - path: "src/components/buyers/key-personnel-tab.tsx"
      provides: "Grid of key personnel cards with name, title, role, confidence bar"
      min_lines: 40
    - path: "src/lib/buyers.ts"
      provides: "Extended fetchBuyerById to include boardDocuments and keyPersonnel"
      contains: "boardDocuments"
    - path: "src/components/buyers/buyer-header.tsx"
      provides: "Extended header with enrichment score, orgType, staff count"
      contains: "enrichmentScore"
  key_links:
    - from: "src/app/(dashboard)/buyers/[id]/page.tsx"
      to: "src/lib/buyers.ts"
      via: "fetchBuyerById returns enrichment data"
      pattern: "boardDocuments|keyPersonnel"
    - from: "src/components/buyers/buyer-tabs.tsx"
      to: "src/components/buyers/board-documents-tab.tsx"
      via: "import and render as tab"
      pattern: "BoardDocumentsTab"
    - from: "src/components/buyers/buyer-tabs.tsx"
      to: "src/components/buyers/key-personnel-tab.tsx"
      via: "import and render as tab"
      pattern: "KeyPersonnelTab"
    - from: "src/components/buyers/buyer-header.tsx"
      to: "src/components/buyers/enrichment-badge.tsx"
      via: "import and render in header"
      pattern: "EnrichmentBadge"
---

<objective>
Enhance the buyer profile UI with enrichment data display: enrichment score badge in header, Board Documents tab, Key Personnel tab, and extended header metadata (orgType, staff count, annual budget).

Purpose: Users can see the depth of intelligence available for each buyer organization, browse board meeting documents, and discover key procurement-relevant personnel -- the core value proposition of the enrichment pipeline.

Output: 3 new UI components, extended buyer header and tabs, and updated data fetching layer.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-buyer-data-enrichment/13-RESEARCH.md
@.planning/phases/13-buyer-data-enrichment/13-01-SUMMARY.md

# Existing buyer UI to extend
@src/components/buyers/buyer-header.tsx
@src/components/buyers/buyer-tabs.tsx
@src/components/buyers/buyer-detail-client.tsx
@src/app/(dashboard)/buyers/[id]/page.tsx
@src/lib/buyers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend data layer and create enrichment UI components</name>
  <files>
src/lib/buyers.ts
src/components/buyers/enrichment-badge.tsx
src/components/buyers/board-documents-tab.tsx
src/components/buyers/key-personnel-tab.tsx
  </files>
  <action>
**src/lib/buyers.ts -- Extend fetchBuyerById:**
After the existing Promise.all that fetches contracts, signals, and reveal:
1. Import BoardDocument and KeyPersonnel models from @/models/board-document and @/models/key-personnel
2. Add two more parallel fetches to the existing Promise.all:
   - BoardDocument.find({ buyerId: buyer._id }).sort({ meetingDate: -1 }).limit(20).lean()
   - KeyPersonnel.find({ buyerId: buyer._id }).sort({ confidence: -1 }).lean()
3. Return boardDocuments and keyPersonnel alongside existing data
4. Also return enrichment fields from buyer: enrichmentScore, enrichmentSources, orgType, orgSubType, staffCount, annualBudget, democracyPortalUrl, lastEnrichedAt

**src/components/buyers/enrichment-badge.tsx:**
Create a circular enrichment score badge component:
```tsx
interface EnrichmentBadgeProps {
  score: number; // 0-100
  size?: "sm" | "md"; // sm=32px, md=48px
}
```
- Render as SVG circle with stroke-dasharray for the filled arc
- Color: green (>=70), yellow (>=40), red (<40)
- Score number centered inside
- Tooltip on hover showing "Enrichment Score: X/100" and last enriched date if provided
- If score is 0 or undefined, show gray dashed circle with "--"

**src/components/buyers/board-documents-tab.tsx:**
```tsx
interface BoardDocumentData {
  _id: string;
  title: string;
  meetingDate?: string | null;
  committeeName?: string;
  documentType?: string;
  sourceUrl: string;
  extractionStatus?: string;
}

interface BoardDocumentsTabProps {
  documents: BoardDocumentData[];
}
```
- Render as a list (Card per document group or simple table)
- Each document shows:
  - Title (link to sourceUrl, opens in new tab)
  - Meeting date (formatted: "12 Jan 2026")
  - Committee name if available
  - Document type badge (minutes, agenda, report, board_pack)
  - Extraction status indicator (green check for extracted, yellow clock for pending, red X for failed)
- Empty state: "No board documents found. Documents will appear as the enrichment pipeline processes this organization."
- Use FileText icon from lucide-react

**src/components/buyers/key-personnel-tab.tsx:**
```tsx
interface KeyPersonnelData {
  _id: string;
  name: string;
  title?: string;
  role?: string;
  department?: string;
  email?: string;
  confidence?: number;
  extractionMethod?: string;
}

interface KeyPersonnelTabProps {
  personnel: KeyPersonnelData[];
}
```
- Render as a grid of cards (2 columns on lg, 1 on mobile)
- Each card shows:
  - Avatar (initials circle, like buyer header uses)
  - Name (bold)
  - Title/job description
  - Role badge (colored pill: chief_executive=purple, director=blue, procurement_lead=green, finance_director=orange, board_member=gray, chair=indigo, councillor=slate)
  - Department if available
  - Email (mailto link, partially obscured unless buyer is unlocked -- use the same blur pattern from contacts)
  - Confidence bar: thin progress bar at bottom, green/yellow/red based on confidence score
  - Extraction method small text (e.g., "via ModernGov API" or "via AI extraction")
- Empty state: "No key personnel found. Personnel will be extracted as the enrichment pipeline processes this organization."
- Use Users icon from lucide-react
  </action>
  <verify>
```bash
npx tsc --noEmit
```
Verify new components exist:
```bash
ls src/components/buyers/enrichment-badge.tsx src/components/buyers/board-documents-tab.tsx src/components/buyers/key-personnel-tab.tsx
```
  </verify>
  <done>
- fetchBuyerById returns boardDocuments and keyPersonnel alongside existing data
- EnrichmentBadge component renders circular SVG score indicator (0-100)
- BoardDocumentsTab displays meeting documents with dates, committees, and source links
- KeyPersonnelTab shows personnel grid with role badges and confidence indicators
- All components have proper empty states
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire enrichment data into buyer header, tabs, and detail page</name>
  <files>
src/components/buyers/buyer-header.tsx
src/components/buyers/buyer-tabs.tsx
src/components/buyers/buyer-detail-client.tsx
src/app/(dashboard)/buyers/[id]/page.tsx
  </files>
  <action>
**src/app/(dashboard)/buyers/[id]/page.tsx:**
1. Serialize the new data from fetchBuyerById:
   - boardDocuments: map to { _id, title, meetingDate, committeeName, documentType, sourceUrl, extractionStatus }
   - keyPersonnel: map to { _id, name, title, role, department, email, confidence, extractionMethod }
   - enrichment fields: enrichmentScore, enrichmentSources, orgType, staffCount, annualBudget, democracyPortalUrl, lastEnrichedAt
2. Pass new props to BuyerDetailClient

**src/components/buyers/buyer-detail-client.tsx:**
1. Update BuyerData interface to include:
   - boardDocuments: BoardDocumentData[]
   - keyPersonnel: KeyPersonnelData[]
   - enrichmentScore?: number
   - enrichmentSources?: string[]
   - orgType?: string
   - staffCount?: number
   - annualBudget?: number
   - democracyPortalUrl?: string
   - lastEnrichedAt?: string
2. Pass enrichment data to BuyerHeader and BuyerTabs

**src/components/buyers/buyer-header.tsx:**
1. Extend BuyerHeaderProps.buyer interface with: enrichmentScore?, orgType?, staffCount?, annualBudget?, democracyPortalUrl?
2. Add EnrichmentBadge to the right side of the header (next to Unlocked badge):
   - Import EnrichmentBadge from ./enrichment-badge
   - Render only if enrichmentScore is defined and > 0
   - Size "md" (48px)
3. Add orgType badge to metadata row (below name):
   - Format orgType for display: "local_council_london" -> "London Borough", "nhs_trust_acute" -> "NHS Trust (Acute)", etc.
   - Use a helper function orgTypeLabel(orgType: string): string
4. Add staff count to metadata row: icon Users + "{X} staff" (only if staffCount set)
5. Add annual budget to metadata row: icon PoundSterling + "Budget: {formatted}" (only if annualBudget set, format with Intl.NumberFormat GBP compact)
6. Add governance portal link: if democracyPortalUrl set, show link icon + "Governance Portal" (opens in new tab)

**src/components/buyers/buyer-tabs.tsx:**
1. Extend BuyerTabsProps with:
   - boardDocuments: BoardDocumentData[]
   - keyPersonnel: KeyPersonnelData[]
2. Add two new tabs AFTER "Buying Signals" and BEFORE "Buyer Attributes":
   - "Board Documents ({count})" -> TabsContent with BoardDocumentsTab
   - "Key Personnel ({count})" -> TabsContent with KeyPersonnelTab
3. Import BoardDocumentsTab from ./board-documents-tab and KeyPersonnelTab from ./key-personnel-tab
4. Show tabs even when count is 0 (empty states handle this)

Ensure all existing functionality (4 original tabs, unlock mechanism, etc.) is completely preserved. The new tabs are additive only.
  </action>
  <verify>
```bash
npx tsc --noEmit
```

Then run the app and visit a buyer profile page:
```bash
# Verify the page loads without errors
# Verify 6 tabs are visible (Contracts, Contacts, Signals, Board Documents, Key Personnel, Attributes)
# Verify enrichment badge appears in header for enriched buyers
# Verify empty state shows for non-enriched buyers
```
  </verify>
  <done>
- Buyer profile header shows enrichment score badge, orgType, staff count, annual budget, governance portal link
- BuyerTabs has 6 tabs: Contracts, Contacts, Signals, Board Documents, Key Personnel, Attributes
- Board Documents and Key Personnel tabs display enrichment data when available
- Empty states shown for buyers without enrichment data
- All existing buyer profile functionality preserved (contacts, signals, unlock mechanism)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify buyer profile enrichment UI</name>
  <what-built>Extended buyer profile with enrichment score badge, Board Documents tab, Key Personnel tab, and enriched header metadata (orgType, staff count, budget, governance link)</what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Navigate to app.tendhunt.com/buyers (or localhost:3000/buyers)
3. Click on any buyer to view their profile
4. Verify 6 tabs visible: Contracts, Key Contacts, Buying Signals, Board Documents, Key Personnel, Buyer Attributes
5. If buyer has enrichment data: verify score badge in header, orgType badge, governance portal link
6. If buyer has no enrichment data: verify empty states in Board Documents and Key Personnel tabs ("No data yet" messages)
7. Verify existing tabs still work (Contracts list, Contacts with blur/unlock, Signals)
8. Check responsive layout on mobile viewport
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. fetchBuyerById returns boardDocuments and keyPersonnel
3. BuyerHeader shows enrichment badge, orgType, staff, budget
4. BuyerTabs shows 6 tabs (4 existing + 2 new)
5. BoardDocumentsTab and KeyPersonnelTab render with proper empty states
6. Existing buyer functionality unchanged (contacts, signals, unlock)
7. All new components are client components where needed (badge is pure, tabs are client)
</verification>

<success_criteria>
- Enrichment score badge visible in buyer header for enriched buyers
- Board Documents tab shows meeting documents with metadata
- Key Personnel tab shows personnel cards with role badges and confidence
- orgType, staff count, annual budget displayed in header when available
- Empty states for non-enriched buyers (not broken/hidden tabs)
- All existing buyer profile features work unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/13-buyer-data-enrichment/13-06-SUMMARY.md` documenting:
- New UI components created (3: enrichment badge, board docs tab, key personnel tab)
- Extended components (header, tabs, detail client, page)
- Data layer changes (fetchBuyerById)
- Screenshot or description of final buyer profile layout
</output>
