---
phase: 13-buyer-data-enrichment
plan: 03
type: execute
wave: 3
depends_on: ["13-02"]
files_modified:
  - workers/enrichment/src/stages/02-governance-urls.ts
  - workers/enrichment/src/stages/03-moderngov.ts
  - workers/enrichment/src/api-clients/moderngov-client.ts
  - workers/enrichment/src/db/board-documents.ts
  - workers/enrichment/src/enrichment-engine.ts
autonomous: true

must_haves:
  truths:
    - "Stage 2 copies governance portal URLs from matched DataSource to Buyer documents"
    - "Stage 3 calls ModernGov SOAP API for councils with platform=ModernGov"
    - "ModernGov GetMeetings response parsed correctly with double XML parse"
    - "BoardDocument records created for each meeting found via ModernGov API"
    - "Non-ModernGov councils (CMIS, Custom, Jadu) are skipped by Stage 3"
  artifacts:
    - path: "workers/enrichment/src/stages/02-governance-urls.ts"
      provides: "Stage 2: copy governance URLs from DataSource to Buyer"
      min_lines: 30
    - path: "workers/enrichment/src/stages/03-moderngov.ts"
      provides: "Stage 3: ModernGov SOAP API calls for meeting discovery"
      min_lines: 60
    - path: "workers/enrichment/src/api-clients/moderngov-client.ts"
      provides: "SOAP request builder + fast-xml-parser response handler"
      min_lines: 60
    - path: "workers/enrichment/src/db/board-documents.ts"
      provides: "BoardDocument upsert operations"
      min_lines: 20
  key_links:
    - from: "workers/enrichment/src/stages/03-moderngov.ts"
      to: "workers/enrichment/src/api-clients/moderngov-client.ts"
      via: "import getMeetings"
      pattern: "getMeetings"
    - from: "workers/enrichment/src/api-clients/moderngov-client.ts"
      to: "fast-xml-parser"
      via: "XMLParser import"
      pattern: "XMLParser"
    - from: "workers/enrichment/src/stages/03-moderngov.ts"
      to: "workers/enrichment/src/db/board-documents.ts"
      via: "upsertBoardDocuments call"
      pattern: "upsertBoardDocuments"
---

<objective>
Implement Stage 2 (governance URL propagation from DataSource to Buyer) and Stage 3 (ModernGov SOAP API client for council meeting/minutes discovery), storing board documents in the BoardDocument collection.

Purpose: After classification in Stage 1 identifies which buyers are councils with ModernGov portals, Stage 2 enriches buyers with their governance URLs and Stage 3 fetches actual meeting data from the ModernGov SOAP API to populate the BoardDocument collection.

Output: Two enrichment stages, a ModernGov SOAP client, and BoardDocument DB operations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-buyer-data-enrichment/13-RESEARCH.md
@.planning/phases/13-buyer-data-enrichment/13-02-SUMMARY.md

# Worker patterns
@workers/enrichment/src/enrichment-engine.ts
@workers/enrichment/src/stages/01-classify.ts
@workers/enrichment/src/api-clients/rate-limiter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Stage 2 (governance URLs) and BoardDocument DB operations</name>
  <files>
workers/enrichment/src/stages/02-governance-urls.ts
workers/enrichment/src/db/board-documents.ts
workers/enrichment/src/enrichment-engine.ts
  </files>
  <action>
**workers/enrichment/src/stages/02-governance-urls.ts:**
Stage 2 propagates governance data from matched DataSource entries to Buyer documents.

```typescript
export async function mapGovernanceUrls(
  db: Db, env: Env, job: EnrichmentJobDoc, maxItems: number
): Promise<{ processed: number; errors: number; done: boolean }>
```

Logic:
1. Process buyers in batches of 100 (cursor-based):
   - Filter: buyers with dataSourceId set (matched in Stage 1) AND democracyPortalUrl not yet set
   - For each buyer: look up their linked DataSource document
   - Copy to Buyer: democracyPortalUrl, democracyPlatform (from DataSource.platform), boardPapersUrl, website (if buyer lacks one)
   - Also add "data_source" to Buyer.enrichmentSources array (using $addToSet)
   - Bulk update batch
2. Save cursor after each batch
3. Return processed/errors/done

**workers/enrichment/src/db/board-documents.ts:**
- upsertBoardDocuments(db, docs: Array<Partial<BoardDocumentDoc>>): Bulk upsert using compound key { buyerId, sourceUrl }
- getBoardDocumentCount(db, buyerId): Count documents for a buyer
- getBoardDocuments(db, buyerId, limit): Fetch board documents for a buyer, sorted by meetingDate desc

**workers/enrichment/src/enrichment-engine.ts:**
Wire Stage 2 into the enrichment engine's stage map. Add import for mapGovernanceUrls and register it as the handler for "governance_urls" stage.
  </action>
  <verify>
```bash
cd workers/enrichment && npx tsc --noEmit
```
Verify Stage 2 function signature matches the StageFn type.
  </verify>
  <done>
- Stage 2 copies governance URLs from DataSource to matched Buyer documents
- Buyer.enrichmentSources updated with "data_source" via $addToSet
- BoardDocument DB operations support bulk upsert with dedup on { buyerId, sourceUrl }
- Stage 2 wired into enrichment engine
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement ModernGov SOAP client and Stage 3 (meeting discovery)</name>
  <files>
workers/enrichment/src/api-clients/moderngov-client.ts
workers/enrichment/src/stages/03-moderngov.ts
workers/enrichment/src/enrichment-engine.ts
  </files>
  <action>
**workers/enrichment/src/api-clients/moderngov-client.ts:**
Create a SOAP client for the ModernGov CMIS API using raw HTTP POST and fast-xml-parser.

```typescript
import { XMLParser } from "fast-xml-parser";

const parser = new XMLParser({
  ignoreAttributes: false,
  removeNSPrefix: true,     // Strips soap:, mg: prefixes
  attributeNamePrefix: "@_",
});
```

Implement these functions:

1. `getMeetings(baseUrl: string, startDate: string, endDate: string): Promise<ModernGovMeeting[]>`
   - POST to `${baseUrl}/mgWebService.asmx`
   - SOAPAction header: "http://tempuri.org/GetMeetings"
   - SOAP body with sStartDate and sEndDate params
   - Parse response: double-parse (outer SOAP envelope, then inner XML string from GetMeetingsResult)
   - Handle empty results, malformed XML, and 404/500 errors gracefully (return empty array, log error)
   - Return array of { id, committeeId, committeeName, date, title, location }

2. `getCommittees(baseUrl: string): Promise<ModernGovCommittee[]>`
   - SOAPAction: "http://tempuri.org/GetCommitteesByUser"
   - Returns array of { id, name, type }

3. `testConnection(baseUrl: string): Promise<boolean>`
   - Quick health check: call GetServerDiagnostics or a lightweight method
   - Returns true if SOAP API responds, false otherwise
   - Use 5-second timeout

Export interfaces: ModernGovMeeting, ModernGovCommittee.

**CRITICAL:** Handle these edge cases per research pitfalls:
- SOAP API returns XML-in-XML (inner result is a string that needs re-parsing)
- Some councils may have SOAP API disabled (return empty, don't throw)
- SOAPAction header is REQUIRED or requests silently fail
- Response may have no meetings (return empty array)

**workers/enrichment/src/stages/03-moderngov.ts:**

```typescript
export async function fetchModernGovData(
  db: Db, env: Env, job: EnrichmentJobDoc, maxItems: number
): Promise<{ processed: number; errors: number; done: boolean }>
```

Logic:
1. Process buyers in batches of 20 (smaller batches -- each buyer requires HTTP calls):
   - Filter: buyers WHERE democracyPlatform = "ModernGov" AND democracyPortalUrl is set AND enrichmentSources does NOT contain "moderngov"
   - For each buyer:
     a. Test connection to their ModernGov URL first (quick health check)
     b. If connection fails, log and skip this buyer (errors++)
     c. Call getMeetings with date range: last 12 months (new Date() - 365 days to now)
     d. For each meeting found, create a BoardDocument record:
        - buyerId, dataSourceName: buyer.name, title: meeting.title
        - meetingDate: parsed from meeting.date
        - committeeId: String(meeting.id), committeeName: meeting.committeeName
        - documentType: "minutes"
        - sourceUrl: `${baseUrl}/mgConvert2PDF.aspx?ID=${meeting.id}` (standard ModernGov PDF URL)
        - extractionStatus: "pending"
     e. Upsert BoardDocument records
     f. Add "moderngov" to buyer.enrichmentSources
     g. Update buyer.lastEnrichedAt
2. Use fetchWithDomainDelay for rate limiting between council domains
3. Save cursor after each batch

**workers/enrichment/src/enrichment-engine.ts:**
Wire Stage 3: add import for fetchModernGovData and register as handler for "moderngov" stage.
  </action>
  <verify>
```bash
cd workers/enrichment && npx tsc --noEmit
```

Verify SOAP client structure:
```bash
grep "SOAPAction" workers/enrichment/src/api-clients/moderngov-client.ts
grep "removeNSPrefix" workers/enrichment/src/api-clients/moderngov-client.ts
grep "fetchModernGovData" workers/enrichment/src/enrichment-engine.ts
```
  </verify>
  <done>
- ModernGov SOAP client sends proper XML requests with SOAPAction headers
- SOAP responses parsed with double-parse pattern (envelope then inner XML)
- Stage 3 processes only ModernGov-platform buyers, skips CMIS/Custom/Jadu
- BoardDocument records created for each meeting discovered (last 12 months)
- Connection failures handled gracefully (skip buyer, log error, continue)
- Per-domain rate limiting applied between council API calls
- Stage 3 wired into enrichment engine
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd workers/enrichment && npx tsc --noEmit`
2. Stage 2 function registered in enrichment engine
3. Stage 3 function registered in enrichment engine
4. ModernGov client uses proper SOAPAction headers
5. XMLParser configured with removeNSPrefix for namespace stripping
6. Stage 3 filters to democracyPlatform = "ModernGov" only
7. BoardDocument upserts use compound key { buyerId, sourceUrl }
8. Per-domain rate limiting applied in Stage 3
</verification>

<success_criteria>
- Stage 2 enriches buyers with governance URLs from their matched DataSource
- Stage 3 discovers meetings via ModernGov SOAP API for ~85-90% of councils
- BoardDocument collection populated with meeting metadata from ModernGov
- Both stages use cursor-based resumability across Worker invocations
- Errors are logged but don't stop the pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/13-buyer-data-enrichment/13-03-SUMMARY.md` documenting:
- Stage 2 governance URL propagation logic
- Stage 3 ModernGov SOAP client implementation details
- BoardDocument creation flow
- Rate limiting configuration
- Files created
</output>
