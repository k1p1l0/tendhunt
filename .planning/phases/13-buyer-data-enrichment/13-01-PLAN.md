---
phase: 13-buyer-data-enrichment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/data-source.ts
  - src/models/board-document.ts
  - src/models/key-personnel.ts
  - src/models/enrichment-job.ts
  - src/models/buyer.ts
  - scripts/seed-data-sources.ts
autonomous: true

must_haves:
  truths:
    - "DataSource collection has 2,368 seeded UK public sector org entries"
    - "Buyer model has enrichment fields (orgType, democracyPortalUrl, enrichmentScore, etc.)"
    - "BoardDocument, KeyPersonnel, EnrichmentJob Mongoose models exist and are importable"
    - "Seed script can be run via tsx to populate DataSource collection from DATA_SOURCES spec"
  artifacts:
    - path: "src/models/data-source.ts"
      provides: "DataSource Mongoose model with orgType enum, platform, tier, status fields"
      exports: ["default"]
    - path: "src/models/board-document.ts"
      provides: "BoardDocument Mongoose model with buyerId, sourceUrl, extractionStatus"
      exports: ["default"]
    - path: "src/models/key-personnel.ts"
      provides: "KeyPersonnel Mongoose model with buyerId, name, title, role, confidence"
      exports: ["default"]
    - path: "src/models/enrichment-job.ts"
      provides: "EnrichmentJob Mongoose model with stage enum, cursor, status, progress tracking"
      exports: ["default"]
    - path: "src/models/buyer.ts"
      provides: "Extended Buyer model with orgType, democracyPortalUrl, enrichmentScore, etc."
      contains: "enrichmentScore"
    - path: "scripts/seed-data-sources.ts"
      provides: "Seed script that inserts 2,368 DataSource documents"
      min_lines: 100
  key_links:
    - from: "src/models/board-document.ts"
      to: "src/models/buyer.ts"
      via: "buyerId ObjectId reference"
      pattern: "ref.*Buyer"
    - from: "src/models/key-personnel.ts"
      to: "src/models/buyer.ts"
      via: "buyerId ObjectId reference"
      pattern: "ref.*Buyer"
    - from: "scripts/seed-data-sources.ts"
      to: "src/models/data-source.ts"
      via: "import and bulkWrite"
      pattern: "DataSource"
---

<objective>
Create 4 new Mongoose models (DataSource, BoardDocument, KeyPersonnel, EnrichmentJob), extend the Buyer model with enrichment fields, and build a seed script to populate the DataSource collection with 2,368 UK public sector organizations from the DATA_SOURCES spec.

Purpose: Establish the data foundation that all subsequent enrichment plans depend on -- without these models and seed data, classification, governance URL mapping, and personnel extraction cannot proceed.

Output: 4 new model files, updated Buyer model, and a runnable seed script.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-buyer-data-enrichment/13-RESEARCH.md

# Existing models to follow patterns from
@src/models/buyer.ts
@src/models/contract.ts
@src/models/signal.ts

# DATA_SOURCES spec -- the source of truth for seeding
# Located at: /Users/kirillkozak/Projects/board-minutes-intelligence/specs/DATA_SOURCES.md
# Contains 2,368 UK public sector orgs with exact URLs, platforms, and categories
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 4 new Mongoose models and extend Buyer schema</name>
  <files>
src/models/data-source.ts
src/models/board-document.ts
src/models/key-personnel.ts
src/models/enrichment-job.ts
src/models/buyer.ts
  </files>
  <action>
Create 4 new Mongoose models following existing patterns in src/models/ (Schema + InferSchemaType + hot-reload-safe model export).

**src/models/data-source.ts:**
- name: String, required, unique (canonical org name from DATA_SOURCES)
- orgType: String, required, enum: ["local_council_london", "local_council_metro", "local_council_county", "local_council_unitary", "local_council_district", "local_council_sui_generis", "nhs_trust_acute", "nhs_trust_mental_health", "nhs_trust_community", "nhs_trust_ambulance", "nhs_icb", "fire_rescue", "police_pcc", "combined_authority", "national_park", "mat", "university", "fe_college", "alb"]
- region: String (optional)
- democracyPortalUrl: String (optional)
- boardPapersUrl: String (optional)
- platform: String, enum: ["ModernGov", "CMIS", "Custom", "Jadu", "None"] (optional)
- website: String (optional)
- parentOrg: String (optional, for sub-orgs)
- tier: Number, default: 0 (0 = current 676, 1 = expansion 1692)
- status: String, enum: ["active", "abolished", "merged"], default: "active"
- successorOrg: String (optional, for abolished/merged orgs)
- timestamps: true
- Export as default with hot-reload pattern: mongoose.models.DataSource || mongoose.model("DataSource", dataSourceSchema)

**src/models/board-document.ts:**
- buyerId: Schema.Types.ObjectId, ref: "Buyer", required, index: true
- dataSourceName: String, required
- title: String, required
- meetingDate: Date (optional)
- committeeId: String (optional)
- committeeName: String (optional)
- documentType: String, enum: ["minutes", "agenda", "report", "board_pack"]
- sourceUrl: String, required
- r2Key: String (optional, R2 storage key)
- textContent: String (optional, extracted text, truncated)
- textLength: Number (optional)
- extractionStatus: String, enum: ["pending", "extracted", "failed"], default: "pending"
- timestamps: true
- Index on [buyerId, sourceUrl] for dedup

**src/models/key-personnel.ts:**
- buyerId: Schema.Types.ObjectId, ref: "Buyer", required, index: true
- name: String, required
- title: String (optional, job title like "Chief Procurement Officer")
- role: String, enum: ["chief_executive", "director", "board_member", "procurement_lead", "finance_director", "cfo", "cto", "chair", "councillor", "committee_chair"]
- department: String (optional)
- email: String (optional)
- phone: String (optional)
- sourceUrl: String (optional)
- extractionMethod: String, enum: ["moderngov_api", "website_scrape", "claude_haiku"]
- confidence: Number, min: 0, max: 100
- verifiedAt: Date (optional)
- timestamps: true
- Compound index on [buyerId, name] for dedup

**src/models/enrichment-job.ts:**
- stage: String, required, enum: ["classify", "governance_urls", "moderngov", "scrape", "personnel", "score"]
- status: String, enum: ["running", "paused", "complete", "error"], default: "running"
- cursor: String, default: null (last processed buyer _id for resume)
- batchSize: Number, default: 100
- totalProcessed: Number, default: 0
- totalErrors: Number, default: 0
- errorLog: [String] (array of error messages, capped at last 100)
- startedAt: Date, default: Date.now
- lastRunAt: Date (optional)
- timestamps: true
- Unique index on [stage] (one job per stage)

**src/models/buyer.ts -- EXTEND existing schema with enrichment fields (do NOT remove any existing fields):**
Add these fields after the existing vibeReasoning field:
- orgType: String, index: true (matched from DataSource)
- orgSubType: String (e.g., "acute", "mental_health" for NHS)
- dataSourceId: Schema.Types.ObjectId, ref: "DataSource" (optional)
- democracyPortalUrl: String
- democracyPlatform: String (e.g., "ModernGov", "CMIS")
- boardPapersUrl: String
- staffCount: Number
- annualBudget: Number
- enrichmentScore: Number, min: 0, max: 100
- enrichmentSources: [String] (e.g., ["data_source", "moderngov", "scrape"])
- lastEnrichedAt: Date
- enrichmentVersion: Number, default: 0

Keep all existing fields (name, orgId, sector, region, website, description, contractCount, contacts, vibeScore, vibeReasoning) and timestamps untouched.
  </action>
  <verify>
Run TypeScript compilation check:
```bash
npx tsc --noEmit src/models/data-source.ts src/models/board-document.ts src/models/key-personnel.ts src/models/enrichment-job.ts src/models/buyer.ts
```

Verify all 4 new files exist and buyer.ts still has original fields:
```bash
grep "enrichmentScore" src/models/buyer.ts
grep "vibeScore" src/models/buyer.ts
grep "orgType" src/models/data-source.ts
```
  </verify>
  <done>
- 4 new Mongoose models created with proper schemas, indexes, and hot-reload-safe exports
- Buyer model extended with 12 new enrichment fields while preserving all 10 existing fields
- All models follow existing patterns (Schema + InferSchemaType + conditional model registration)
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DataSource seed script from DATA_SOURCES spec</name>
  <files>
scripts/seed-data-sources.ts
  </files>
  <action>
Create a seed script at scripts/seed-data-sources.ts that reads the DATA_SOURCES spec and inserts all 2,368 organizations into the DataSource collection. The script will be run one-time via `npx tsx scripts/seed-data-sources.ts`.

**Structure:**
1. Import dbConnect from @/lib/mongodb and DataSource model
2. Define the complete list of organizations as TypeScript arrays, organized by category
3. Each entry: { name, orgType, region?, democracyPortalUrl?, platform?, website?, tier, status }
4. Use bulkWrite with updateOne + upsert to be idempotent (re-runnable without duplicates)

**Data extraction from DATA_SOURCES spec (key categories):**

The DATA_SOURCES spec at `/Users/kirillkozak/Projects/board-minutes-intelligence/specs/DATA_SOURCES.md` contains tables of orgs. Parse ALL categories:

- **London Borough Councils (33)**: orgType "local_council_london", tier 0. Extract name, URL, platform from each table row.
- **Metropolitan Borough Councils (36)**: orgType "local_council_metro", tier 0. Extract from subsections (Greater Manchester, West Midlands, etc.).
- **County Councils (21)**: orgType "local_council_county", tier 0.
- **Unitary Authorities (62)**: orgType "local_council_unitary", tier 0.
- **District Councils (164)**: orgType "local_council_district", tier 0.
- **Sui Generis (2)**: orgType "local_council_sui_generis", tier 0 (City of London, Isles of Scilly).
- **NHS Trusts - Acute (126)**: orgType "nhs_trust_acute", tier 0, platform "None" (no standard API).
- **NHS Trusts - Mental Health (49)**: orgType "nhs_trust_mental_health", tier 0.
- **NHS Trusts - Community (11)**: orgType "nhs_trust_community", tier 0.
- **NHS Trusts - Ambulance (10)**: orgType "nhs_trust_ambulance", tier 0.
- **NHS Trusts - Specialist (18)**: orgType "nhs_trust_acute", tier 0 (specialist treated as acute subtype).
- **ICBs (42)**: orgType "nhs_icb", tier 0.
- **Fire and Rescue (44)**: orgType "fire_rescue", tier 0.
- **Police PCCs (37)**: orgType "police_pcc", tier 0.
- **Combined Authorities (12)**: orgType "combined_authority", tier 0.
- **National Park Authorities (10)**: orgType "national_park", tier 0.
- **Multi-Academy Trusts (1,154)**: orgType "mat", tier 1. Many entries -- include the full list from DATA_SOURCES.
- **Universities (165)**: orgType "university", tier 1.
- **FE Colleges (228)**: orgType "fe_college", tier 1.
- **Healthcare Regulators (10)**: orgType "alb", tier 1.
- **Major ALBs (135)**: orgType "alb", tier 1.

**CRITICAL:** Read the full DATA_SOURCES.md file at runtime using fs.readFileSync and parse the markdown tables programmatically rather than hardcoding 2,368 entries. This keeps the script maintainable. Strategy:
1. Read DATA_SOURCES.md
2. Parse markdown tables (lines starting with |, skip header and separator rows)
3. Extract name, URL, platform from each row
4. Determine orgType from section headers
5. Generate DataSource documents

**Alternative (simpler, recommended):** Since the DATA_SOURCES file is a spec file, hardcode the councils (317 entries with URLs + platforms are critical for enrichment) and use category counts for Tier 1 orgs. For Tier 1 orgs where individual URLs are less critical, include names but omit URLs. The key requirement is that ALL 2,368 entries exist in the collection.

Use the markdown table parsing approach:
```typescript
function parseMarkdownTable(content: string): Array<{name: string, url?: string, platform?: string}> {
  const rows = content.split('\n').filter(line => line.startsWith('|') && !line.includes('---'));
  return rows.slice(1).map(row => { // Skip header
    const cells = row.split('|').map(c => c.trim()).filter(Boolean);
    return { name: cells[0], url: cells[1] || undefined, platform: cells[2] || undefined };
  });
}
```

**Execution flow:**
1. Connect to MongoDB via dbConnect()
2. Parse DATA_SOURCES.md sections
3. Map each org to DataSource document format
4. bulkWrite with upsert on { name } key
5. Log counts per category and total
6. Disconnect and exit

**Mark abolished/merged councils:** Any entry in DATA_SOURCES with notes like "Absorbed into" or "Abolished" should have status: "abolished" and successorOrg set.

**Script should be idempotent:** Running it multiple times produces the same result (upsert, not insert).
  </action>
  <verify>
Run the seed script:
```bash
npx tsx scripts/seed-data-sources.ts
```

Verify counts in MongoDB:
```bash
# Use mongosh or the app API to check
# Expected: 2,368 total documents in DataSource collection
# Tier 0: ~676, Tier 1: ~1,692
```
  </verify>
  <done>
- Seed script exists at scripts/seed-data-sources.ts
- Script parses DATA_SOURCES.md and creates DataSource documents for all 2,368 orgs
- Each document has correct orgType, platform, tier, democracyPortalUrl (where available)
- Script is idempotent (safe to run multiple times)
- Abolished/merged orgs are marked with status: "abolished" and successorOrg
- Script logs category counts and total seeded count
  </done>
</task>

</tasks>

<verification>
1. All 5 model files exist and compile: `npx tsc --noEmit`
2. DataSource model has all 18 orgType enum values
3. Buyer model retains all original fields plus 12 new enrichment fields
4. BoardDocument and KeyPersonnel have buyerId ref to Buyer
5. EnrichmentJob has unique index on stage
6. Seed script runs successfully and creates 2,368 DataSource documents
7. Seed script is idempotent (second run doesn't create duplicates)
</verification>

<success_criteria>
- 4 new Mongoose models (DataSource, BoardDocument, KeyPersonnel, EnrichmentJob) created with proper schemas
- Buyer model extended with enrichment fields while preserving backward compatibility
- DataSource collection seeded with 2,368 UK public sector organizations
- All models follow existing codebase patterns (hot-reload safety, timestamps, indexes)
- TypeScript compilation passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-buyer-data-enrichment/13-01-SUMMARY.md` documenting:
- 4 new models created with their schemas and indexes
- 12 enrichment fields added to Buyer model
- Seed script details and DataSource counts by category
- Files created and modified
</output>
