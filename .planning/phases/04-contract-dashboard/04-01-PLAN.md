---
phase: 04-contract-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/contracts.ts
  - src/components/contracts/contract-card.tsx
  - src/components/contracts/contract-search.tsx
  - src/components/contracts/contract-filters.tsx
  - src/components/contracts/pagination.tsx
  - src/components/contracts/contract-count.tsx
  - src/app/(dashboard)/contracts/page.tsx
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "User sees a paginated feed of contract cards at /contracts showing title, buyer, value, dates, and source badge"
    - "User can type a keyword in search and see the feed update after 300ms debounce"
    - "User can filter by sector, region, and value range using dropdowns, with filters combinable"
    - "User can switch sort order between 'Newest First' (publishedDate DESC) and 'AI Score' (vibeScore DESC) via a Sort By dropdown"
    - "User sees total contract count and filtered result count above the feed"
    - "User can navigate between pages of results using Previous/Next buttons"
    - "Changing any filter, search, or sort resets pagination to page 1"
  artifacts:
    - path: "src/lib/contracts.ts"
      provides: "Data access layer for contract queries"
      exports: ["fetchContracts", "ContractFilters"]
    - path: "src/components/contracts/contract-card.tsx"
      provides: "Contract card component rendering title, buyer, value, dates, source, sector"
      contains: "ContractCard"
    - path: "src/components/contracts/contract-search.tsx"
      provides: "Search input with 300ms debounce updating URL params"
      contains: "use client"
    - path: "src/components/contracts/contract-filters.tsx"
      provides: "Sector, region, value range, and sort order dropdowns updating URL params"
      contains: "use client"
    - path: "src/components/contracts/pagination.tsx"
      provides: "Previous/Next page navigation using URL params"
      contains: "use client"
    - path: "src/components/contracts/contract-count.tsx"
      provides: "Total and filtered count display"
      contains: "ContractCount"
    - path: "src/app/(dashboard)/contracts/page.tsx"
      provides: "Server component reading searchParams, querying MongoDB, rendering feed"
      contains: "searchParams"
  key_links:
    - from: "src/app/(dashboard)/contracts/page.tsx"
      to: "src/lib/contracts.ts"
      via: "fetchContracts() call in server component"
      pattern: "fetchContracts"
    - from: "src/components/contracts/contract-search.tsx"
      to: "URL searchParams"
      via: "useRouter().replace() with debounced query param"
      pattern: "replace.*pathname.*params"
    - from: "src/components/contracts/contract-filters.tsx"
      to: "URL searchParams"
      via: "useRouter().replace() with sector/region/value/sort params"
      pattern: "replace.*pathname.*params"
    - from: "src/lib/contracts.ts"
      to: "src/models/contract.ts"
      via: "Mongoose Contract.find() with $text and filter query"
      pattern: "Contract\\.find"
---

<objective>
Build the contract feed page with data access layer, card-based feed, keyword search, combinable filters (sector, region, value range), pagination, and count display.

Purpose: This is the core product screen -- the first thing users see after login. It must demonstrate that TendHunt has real UK procurement data that is searchable and filterable.

Output: A fully functional `/contracts` page replacing the current placeholder, with 6 new components and a data access layer querying 809 real contracts from MongoDB.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-contract-dashboard/04-RESEARCH.md

@src/models/contract.ts
@src/lib/mongodb.ts
@src/types/index.ts
@src/app/(dashboard)/contracts/page.tsx
@src/components/ui/card.tsx
@src/components/ui/badge.tsx
@src/components/ui/input.tsx
@src/components/ui/select.tsx
@src/components/ui/button.tsx
@src/components/ui/skeleton.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Data access layer and contract card component</name>
  <files>
    src/lib/contracts.ts
    src/components/contracts/contract-card.tsx
    src/components/contracts/contract-count.tsx
    package.json
    package-lock.json
  </files>
  <action>
**Install dependency:**
```bash
npm install use-debounce
```

**Create `src/lib/contracts.ts`** -- Data access layer with two exports:

1. `ContractFilters` interface:
   - `query?: string` (keyword search)
   - `sector?: string` (exact match)
   - `region?: string` (NUTS1 prefix match)
   - `minValue?: number` (valueMax >= minValue for overlap)
   - `maxValue?: number` (valueMin <= maxValue for overlap)
   - `sort?: 'date' | 'score'` (default 'date' — controls feed sort order)
   - `page?: number` (default 1)
   - `pageSize?: number` (default 20)

2. `fetchContracts(filters: ContractFilters)` async function:
   - Call `dbConnect()` first
   - Build MongoDB query object:
     - If `filters.query`: add `{ $text: { $search: filters.query } }`
     - If `filters.sector`: add `{ sector: filters.sector }`
     - If `filters.region` and region !== "UNSPECIFIED": add `{ buyerRegion: { $regex: new RegExp('^' + filters.region, 'i') } }` (NUTS1 prefix match)
     - If `filters.region` === "UNSPECIFIED": add `{ $or: [{ buyerRegion: null }, { buyerRegion: { $exists: false } }] }`
     - If `filters.minValue`: add `{ valueMax: { $gte: filters.minValue } }`
     - If `filters.maxValue`: add `{ valueMin: { $lte: filters.maxValue } }`
   - Determine sort order from `filters.sort`:
     - If `filters.sort === 'score'`: use `{ vibeScore: -1, publishedDate: -1 }` (score DESC, date DESC as tiebreaker). NOTE: Currently all vibeScores are null (Phase 5 populates them), so `sort=score` will return the same order as `sort=date` until scores exist.
     - Otherwise (default `'date'`): use `{ publishedDate: -1 }`
   - Execute three queries in parallel with `Promise.all`:
     - `Contract.find(query).sort(sortOrder).skip((page - 1) * pageSize).limit(pageSize).select('-rawData').lean()`
     - `Contract.countDocuments(query)` for filtered count
     - `Contract.estimatedDocumentCount()` for total count
   - Return `{ contracts, filteredCount, totalCount }`
   - NOTE: When `$text` is combined with other filters, MongoDB uses the text index for the `$text` part and applies the other conditions as post-filters. The explicit `.sort(...)` overrides text score sorting, which is the desired behavior.

**Create `src/components/contracts/contract-card.tsx`** -- Server component (no 'use client'):
   - Props: `contract` object with fields from lean() Contract query (use a `ContractCardData` type defined locally or import IContract)
   - Use `Card`, `CardContent`, `CardHeader`, `CardTitle` from shadcn/ui
   - Use `Badge` from shadcn/ui
   - Wrap entire card in `<Link href={/contracts/${contract._id}}>` from next/link
   - Card content:
     - Title: `line-clamp-2` for long titles
     - Buyer name in muted text
     - Value: format with `Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 })` -- show valueMax if exists, fallback to valueMin
     - Published date: format with `Intl.DateTimeFormat('en-GB', { dateStyle: 'medium' })`
     - Deadline date: show if exists, with "Deadline: " prefix
     - Sector: `Badge` with `variant="outline"`
     - Source: `Badge` with `variant="secondary"` -- show "FaT" for FIND_A_TENDER, "CF" for CONTRACTS_FINDER
     - If `vibeScore` exists (not null/undefined): show score badge with color coding:
       - >= 7: `bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200`
       - >= 4: `bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200`
       - < 4: `bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200`
     - If vibeScore is null: show nothing (no empty badge placeholder)
   - Add `hover:shadow-md transition-shadow` to Card for hover effect

**Create `src/components/contracts/contract-count.tsx`** -- Server component:
   - Props: `total: number`, `filtered: number`
   - Show: "Showing {filtered} of {total} contracts" (or just "{total} contracts" when filtered === total)
   - Use `text-sm text-muted-foreground` styling
  </action>
  <verify>
    - `npm run build` succeeds
    - `src/lib/contracts.ts` exports fetchContracts and ContractFilters
    - `src/components/contracts/contract-card.tsx` exists and imports Card, Badge, Link
    - `use-debounce` is in package.json dependencies
  </verify>
  <done>
    Data access layer queries MongoDB with text search + filters + pagination. Contract card renders all required fields (title, buyer, value, dates, source, sector, conditional score badge). Count component shows total/filtered. use-debounce installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Search, filters, pagination, and contracts page assembly</name>
  <files>
    src/components/contracts/contract-search.tsx
    src/components/contracts/contract-filters.tsx
    src/components/contracts/pagination.tsx
    src/app/(dashboard)/contracts/page.tsx
  </files>
  <action>
**Create `src/components/contracts/contract-search.tsx`** -- Client component ('use client'):
   - Import `useSearchParams`, `usePathname`, `useRouter` from 'next/navigation'
   - Import `useDebouncedCallback` from 'use-debounce'
   - Import `Input` from '@/components/ui/input'
   - Import `Search` icon from 'lucide-react'
   - `handleSearch` with 300ms debounce:
     - Create new `URLSearchParams` from current searchParams
     - Set `page` to `1` (reset pagination on new search)
     - If term: `params.set('query', term)`, else: `params.delete('query')`
     - Call `replace(pathname + '?' + params.toString())`
   - Render: Search icon + Input with `placeholder="Search contracts..."` and `defaultValue={searchParams.get('query')?.toString()}`
   - Wrap input and icon in a relative div for icon positioning

**Create `src/components/contracts/contract-filters.tsx`** -- Client component ('use client'):
   - Import `useSearchParams`, `usePathname`, `useRouter` from 'next/navigation'
   - Import `Select`, `SelectContent`, `SelectItem`, `SelectTrigger`, `SelectValue` from '@/components/ui/select'

   - Define SECTORS array (from research -- top sectors by frequency):
     ```
     'Health & Social', 'Construction', 'Business Services', 'Transport',
     'IT Services', 'Software', 'Architecture & Engineering', 'Education & Training',
     'Research & Development', 'Defence', 'Environmental Services', 'Utilities',
     'Legal Services', 'Financial Services', 'Facilities Management',
     'Food & Catering', 'Telecommunications', 'Publishing & Printing',
     'Industrial Equipment', 'Medical Equipment'
     ```

   - Define REGIONS map (NUTS1 codes to names):
     ```
     UKC: 'North East England', UKD: 'North West England',
     UKE: 'Yorkshire and The Humber', UKF: 'East Midlands',
     UKG: 'West Midlands', UKH: 'East of England',
     UKI: 'London', UKJ: 'South East England',
     UKK: 'South West England', UKL: 'Wales',
     UKM: 'Scotland', UKN: 'Northern Ireland',
     UK: 'UK-wide', UNSPECIFIED: 'Nationwide / Unspecified'
     ```

   - Define VALUE_RANGES array of predefined brackets:
     ```
     { label: 'Under 100K', min: 0, max: 100000 },
     { label: '100K - 500K', min: 100000, max: 500000 },
     { label: '500K - 1M', min: 500000, max: 1000000 },
     { label: '1M - 10M', min: 1000000, max: 10000000 },
     { label: '10M - 100M', min: 10000000, max: 100000000 },
     { label: 'Over 100M', min: 100000000, max: undefined },
     ```
     Encode as `{min}-{max}` in URL params, e.g., `value=100000-500000`. Use `value=100000000-` for "Over 100M".

   - `updateFilter(key: string, value: string)` helper:
     - Create new URLSearchParams from current
     - Set `page` to `1`
     - If value and value !== 'all': `params.set(key, value)`, else: `params.delete(key)`
     - Special handling for `value` filter: parse the composite `min-max` format and set `minValue` + `maxValue` params separately. If value is 'all', delete both.
     - Call `replace(pathname + '?' + params.toString())`

   - Render four Select dropdowns in a flex row with gap-2 flex-wrap:
     1. **Sector:** "All Sectors" default, list SECTORS
     2. **Region:** "All Regions" default, list REGIONS entries
     3. **Value Range:** "Any Value" default, list VALUE_RANGES
     4. **Sort By:** Select with two options — "Newest First" (value: `date`, default) and "AI Score" (value: `score`). Sets `sort` URL param via `updateFilter('sort', value)`. NOTE: Until Phase 5 populates vibeScore, "AI Score" sort returns the same order as "Newest First".

   - Each Select reads its current value from searchParams

**Create `src/components/contracts/pagination.tsx`** -- Client component ('use client'):
   - Props: `totalPages: number`, `currentPage: number`
   - Import `useSearchParams`, `usePathname` from 'next/navigation'
   - Import `Button` from '@/components/ui/button'
   - Import `ChevronLeft`, `ChevronRight` from 'lucide-react'
   - `createPageURL(page: number)`: clone searchParams, set page, return pathname + params
   - Render Previous/Next buttons as `<Link>` (use `Button asChild`):
     - Previous disabled when `currentPage <= 1`
     - Next disabled when `currentPage >= totalPages`
     - Show "Page {current} of {total}" text between buttons
   - Do NOT render pagination at all if totalPages <= 1

**Replace `src/app/(dashboard)/contracts/page.tsx`** -- Server component:
   - Import `Suspense` from 'react'
   - searchParams is a `Promise` in Next.js 16 -- `await searchParams` before destructuring
   - Destructure: `query`, `sector`, `region`, `minValue`, `maxValue`, `page`, `sort` (all string | undefined)
   - Parse page to number (default 1), minValue/maxValue to number if present
   - Validate sort: cast to `'date' | 'score'` (default `'date'` if absent or invalid)
   - Call `fetchContracts({ query, sector, region, minValue, maxValue, sort, page, pageSize: 20 })`
   - Render:
     - Page header: "Contracts" h1 + "Browse {totalCount} UK procurement opportunities" subtitle
     - `ContractSearch` component
     - `ContractFilters` component
     - `ContractCount total={totalCount} filtered={filteredCount}`
     - Grid of `ContractCard` components: `grid gap-4 md:grid-cols-2 lg:grid-cols-3`
     - Empty state: If no contracts match, show "No contracts found. Try adjusting your search or filters."
     - `Pagination currentPage={currentPage} totalPages={Math.ceil(filteredCount / 20)}`
   - Wrap the grid in `<Suspense>` with a `key` based on all search params for loading states. Use a skeleton fallback with 6 card skeletons.
   - NOTE: The page function signature must be:
     ```typescript
     export default async function ContractsPage({
       searchParams,
     }: {
       searchParams: Promise<{ [key: string]: string | string[] | undefined }>
     })
     ```
  </action>
  <verify>
    - `npm run build` succeeds with no TypeScript errors
    - The /contracts page renders with search, filters, pagination, and card grid
    - All 4 client components have 'use client' directive
    - searchParams is awaited (Next.js 16 requirement)
  </verify>
  <done>
    Contracts page shows a searchable, filterable, sortable, paginated feed of contract cards. Search debounces at 300ms. Filters for sector (20 options), region (14 options including UK-wide and Unspecified), value range (6 predefined brackets), and sort order (date/score). Sort by score uses { vibeScore: -1, publishedDate: -1 }. Pagination with Previous/Next. Count display shows total and filtered. All URL-param driven for shareability and back/forward navigation. Empty state handled.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with zero errors
2. `/contracts` page loads and shows real contract data from MongoDB (809 contracts)
3. Typing "waste" in search box filters contracts after 300ms
4. Selecting "Health & Social" sector shows only health contracts
5. Selecting "Scotland" region shows only UKM-prefixed contracts
6. Selecting "Under 100K" value range filters by value
7. Combining multiple filters works (e.g., sector + region)
8. "Showing X of 809 contracts" updates correctly with filters
9. Pagination Previous/Next buttons navigate between pages
10. Contract cards show title, buyer, value, date, source badge, sector badge
11. Cards link to /contracts/{id} (detail page built in Plan 02)
</verification>

<success_criteria>
- Contract feed with 20 contracts per page loads at /contracts
- Keyword search updates results after 300ms debounce
- 4 filter/sort dropdowns (sector, region, value, sort) are combinable
- Sort by "AI Score" uses { vibeScore: -1, publishedDate: -1 }; sort by "Newest First" uses { publishedDate: -1 } (default)
- sort=score currently returns same order as sort=date since all vibeScores are null until Phase 5
- Total and filtered count displayed
- Pagination works for 809 contracts (41 pages at 20/page)
- Each card shows title, buyer name, value (GBP formatted), published date, source badge, sector badge
- Cards are clickable links to /contracts/{id}
- vibeScore badge conditionally shown (null = no badge)
- No TypeScript errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-contract-dashboard/04-01-SUMMARY.md`
</output>
