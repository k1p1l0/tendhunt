---
phase: 04-contract-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/contracts.ts
  - src/app/(dashboard)/contracts/[id]/page.tsx
  - src/app/(dashboard)/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can click a contract card and see full details including title, buyer, value, dates, CPV codes, description, and source URL"
    - "User sees a 404 page when navigating to a non-existent contract ID"
    - "Dashboard page shows real stats (active contracts count, buyer count, signal count) from MongoDB"
    - "Dashboard page shows 5 most recent contracts as preview cards linking to /contracts"
  artifacts:
    - path: "src/app/(dashboard)/contracts/[id]/page.tsx"
      provides: "Contract detail page with all fields"
      contains: "notFound"
    - path: "src/app/(dashboard)/dashboard/page.tsx"
      provides: "Dashboard with real MongoDB stats and recent contracts"
      contains: "dbConnect"
    - path: "src/lib/contracts.ts"
      provides: "fetchContractById and getContractStats functions"
      exports: ["fetchContractById", "getContractStats"]
  key_links:
    - from: "src/app/(dashboard)/contracts/[id]/page.tsx"
      to: "src/lib/contracts.ts"
      via: "fetchContractById() with params.id"
      pattern: "fetchContractById"
    - from: "src/app/(dashboard)/dashboard/page.tsx"
      to: "src/lib/contracts.ts"
      via: "getContractStats() and fetchContracts() for recent"
      pattern: "getContractStats|fetchContracts"
    - from: "src/components/contracts/contract-card.tsx"
      to: "src/app/(dashboard)/contracts/[id]/page.tsx"
      via: "Link href=/contracts/${id}"
      pattern: "href.*contracts/"
---

<objective>
Build the contract detail page and update the dashboard with real data from MongoDB.

Purpose: Complete the contract browsing experience by letting users drill into full contract details, and make the dashboard landing page show real stats instead of placeholder zeros.

Output: A contract detail page at `/contracts/[id]` showing all contract fields, and an updated dashboard with live stats and 5 recent contract cards.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-contract-dashboard/04-RESEARCH.md
@.planning/phases/04-contract-dashboard/04-01-SUMMARY.md

@src/models/contract.ts
@src/models/buyer.ts
@src/models/signal.ts
@src/lib/mongodb.ts
@src/lib/contracts.ts
@src/components/contracts/contract-card.tsx
@src/app/(dashboard)/dashboard/page.tsx
@src/app/(dashboard)/contracts/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Contract detail page and data access extensions</name>
  <files>
    src/lib/contracts.ts
    src/app/(dashboard)/contracts/[id]/page.tsx
  </files>
  <action>
**Extend `src/lib/contracts.ts`** -- Add two new functions:

1. `fetchContractById(id: string)`:
   - Call `dbConnect()`
   - Validate `id` is a valid MongoDB ObjectId using `mongoose.isValidObjectId(id)` -- return `null` if invalid (prevents CastError)
   - `Contract.findById(id).select('-rawData').lean()`
   - Return the contract document or `null`

2. `getContractStats()`:
   - Call `dbConnect()`
   - Execute in parallel with `Promise.all`:
     - `Contract.estimatedDocumentCount()` for total contracts
     - `Buyer.estimatedDocumentCount()` for total buyers (import Buyer model)
     - `Signal.estimatedDocumentCount()` for total signals (import Signal model)
   - Return `{ contractCount, buyerCount, signalCount }`
   - Import Buyer from '@/models/buyer' and Signal from '@/models/signal'

**Create `src/app/(dashboard)/contracts/[id]/page.tsx`** -- Server component:
   - `params` is a `Promise` in Next.js 16 -- must `await params` before using `id`
   - Function signature:
     ```typescript
     export default async function ContractDetailPage({
       params,
     }: {
       params: Promise<{ id: string }>
     })
     ```
   - Call `fetchContractById(id)`, if null call `notFound()` from 'next/navigation'
   - Layout using `Card` components:
     - **Header section:**
       - Back link: `<Link href="/contracts">` with ArrowLeft icon and "Back to contracts"
       - Title: `text-2xl font-bold`
       - Status badge: color-coded (OPEN = green, CLOSED = gray, AWARDED = blue, CANCELLED = red)
       - If vibeScore exists: large score badge with color coding and reasoning text
     - **Details grid** (2-column on lg, 1-column on mobile):
       - **Left column (Contract Info):**
         - Buyer: buyerName (bold) + buyerOrg if different
         - Region: buyerRegion or "Not specified"
         - Sector: sector or "Not classified"
         - Stage: stage badge
         - Published: formatted publishedDate
         - Deadline: formatted deadlineDate or "No deadline"
       - **Right column (Value & Classification):**
         - Value: If both valueMin and valueMax and they differ, show range "X - Y". If only one, show that. If neither, show "Not specified". Format with `Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 })`
         - Currency: contract.currency
         - CPV Codes: render as list of badges (cpvCodes array). If empty, show "None"
         - Source: "Find a Tender" or "Contracts Finder" with source URL as external link (open in new tab with rel="noopener noreferrer")
     - **Description section** (full width below grid):
       - Render contract.description in a prose-styled container
       - If no description: "No description available"
     - **Source link:** Button linking to sourceUrl if it exists: "View on {source name}" with ExternalLink icon

   - Use lucide-react icons: ArrowLeft, ExternalLink, Calendar, MapPin, Building2, Tag, Coins
   - All dates formatted with `Intl.DateTimeFormat('en-GB', { dateStyle: 'long' })`
  </action>
  <verify>
    - `npm run build` succeeds
    - `src/app/(dashboard)/contracts/[id]/page.tsx` exists
    - `src/lib/contracts.ts` exports fetchContractById and getContractStats
    - params is awaited in the detail page (Next.js 16)
  </verify>
  <done>
    Contract detail page renders all fields: title, status, buyer (name/org/region), sector, value (range or single), dates (published/deadline), CPV codes, description, source attribution with external link. Invalid/missing IDs return 404. vibeScore badge conditionally shown.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard page with real stats and recent contracts</name>
  <files>
    src/app/(dashboard)/dashboard/page.tsx
  </files>
  <action>
**Replace `src/app/(dashboard)/dashboard/page.tsx`** -- Convert from static to server component with real data:

1. **Make it async** -- add `async` to the default export function
2. **Fetch real data:**
   - Import `getContractStats` and `fetchContracts` from '@/lib/contracts'
   - Import `ContractCard` from '@/components/contracts/contract-card'
   - Call `getContractStats()` for stat cards
   - Call `fetchContracts({ page: 1, pageSize: 5 })` for 5 most recent contracts

3. **Update stat cards** to use real values:
   - "Active Contracts": `stats.contractCount` (formatted with toLocaleString)
   - "Buyer Organizations": `stats.buyerCount`
   - "Buying Signals": `stats.signalCount`
   - "Credits Remaining": Keep as "10" for now (credit balance is per-user, requires auth context -- Phase 6 concern)

4. **Update Recent Contracts section:**
   - Replace empty state with a grid of `ContractCard` components (responsive: 1 col mobile, 2 cols md, 3 cols lg)
   - Show the 5 most recent contracts
   - Below the cards: a "View all contracts" link (`<Link href="/contracts">`) styled as a button variant="outline"
   - If no contracts exist (edge case): keep the "No contracts ingested yet" message

5. **Keep existing layout structure** -- stat cards grid at top, recent contracts below

6. **Add a "Quick Filters" section** between stats and recent contracts:
   - Three inline links styled as badges/buttons: "Open Tenders", "Recently Published", "High Value (>1M)"
   - Each links to `/contracts` with pre-set URL params:
     - "Open Tenders": `/contracts?status=OPEN` (note: this param won't filter yet since status filter isn't in Plan 01, but the link structure is future-proof)
     - "Recently Published": `/contracts` (default sort is by publishedDate)
     - "High Value (>1M)": `/contracts?minValue=1000000`
  </action>
  <verify>
    - `npm run build` succeeds
    - Dashboard page is async and calls dbConnect via getContractStats/fetchContracts
    - Stat cards show real numbers (not zeros)
    - Recent contracts section shows 5 ContractCard components
    - "View all contracts" link exists pointing to /contracts
  </verify>
  <done>
    Dashboard shows real stats from MongoDB (contract count, buyer count, signal count). Recent contracts section displays 5 most recent contract cards. Quick filter links provide shortcuts to common contract views. "View all contracts" button links to the full feed.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with zero errors
2. Clicking a contract card on /contracts navigates to /contracts/{id} detail page
3. Detail page shows: title, status badge, buyer info, region, sector, value, dates, CPV codes, description, source link
4. Navigating to /contracts/invalid-id shows 404
5. Dashboard stat cards show real numbers from MongoDB (e.g., 809 contracts, 75 buyers, 75 signals)
6. Dashboard recent contracts section shows 5 contract cards
7. "View all contracts" link navigates to /contracts
8. All dates are properly formatted in en-GB locale
9. All currency values are properly formatted in GBP
</verification>

<success_criteria>
- Contract detail page shows all required fields (DASH-04): title, buyer, value, dates, CPV codes, description, source URL
- 404 handling for invalid contract IDs
- Dashboard displays real stats from MongoDB (DASH-05 partial: total count on dashboard)
- Dashboard shows 5 recent contracts with links to detail pages
- vibeScore badge conditionally renders (null = hidden, ready for Phase 5)
- DASH-06 score badge color coding implemented (green >= 7, yellow >= 4, red < 4) -- currently no contracts have scores
- No TypeScript errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-contract-dashboard/04-02-SUMMARY.md`
</output>
