---
phase: 14-buyer-explorer-filters-data-visibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/buyers.ts
  - src/app/api/buyers/route.ts
  - src/app/api/buyers/filters/route.ts
autonomous: true

must_haves:
  truths:
    - "Buyers API accepts sector, orgType, and region query parameters and returns filtered results"
    - "A new /api/buyers/filters endpoint returns distinct sector, orgType, and region values from the database"
    - "fetchBuyers no longer queries ContactReveal or returns isUnlocked status"
    - "Filtered count is returned alongside total count for UI display"
  artifacts:
    - path: "src/lib/buyers.ts"
      provides: "Server-side filtering with sector, orgType, region params + filtered count"
      contains: "sector.*orgType.*region"
    - path: "src/app/api/buyers/filters/route.ts"
      provides: "Distinct filter values endpoint for dropdowns"
      exports: ["GET"]
    - path: "src/app/api/buyers/route.ts"
      provides: "Updated API route passing filter params"
  key_links:
    - from: "src/app/api/buyers/route.ts"
      to: "src/lib/buyers.ts"
      via: "fetchBuyers call with filter params"
      pattern: "fetchBuyers.*sector.*orgType.*region"
---

<objective>
Add server-side filtering to the buyers data layer and API. Extend BuyerFilters with sector, orgType, and region fields. Update fetchBuyers to build MongoDB query conditions from these filters and return both filtered count and total count. Remove ContactReveal query and isUnlocked logic from fetchBuyers (credit gating removal). Create a new /api/buyers/filters endpoint that returns distinct values for each filterable field.

Purpose: Backend foundation for buyer explorer filter dropdowns and free data access.
Output: Updated buyers.ts, buyers API route, new filters API route.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/buyers.ts
@src/lib/contracts.ts (reference pattern for server-side filtering)
@src/app/api/buyers/route.ts
@src/models/buyer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend fetchBuyers with server-side filtering and remove credit gating</name>
  <files>src/lib/buyers.ts</files>
  <action>
  Update `BuyerFilters` interface to add optional fields: `sector?: string`, `orgType?: string`, `region?: string`.

  In `fetchBuyers()`:
  1. Remove the `userId` parameter entirely (no longer needed since credit gating is removed).
  2. Build a MongoDB query conditions array (same pattern as `fetchContracts` in `src/lib/contracts.ts`):
     - If `filters.sector` is set, add `{ sector: filters.sector }` condition
     - If `filters.orgType` is set, add `{ orgType: filters.orgType }` condition
     - If `filters.region` is set, add `{ region: filters.region }` condition
     - Combine with `$and` if any conditions exist, otherwise use `{}`
  3. Use the built query in `Buyer.find(query)` instead of `Buyer.find({})`
  4. Remove the `ContactReveal.find({ userId })` from Promise.all
  5. Remove the `revealedIds` Set and `isUnlocked` mapping
  6. Add `Buyer.countDocuments(query)` to the Promise.all to get filtered count (separate from `estimatedDocumentCount` which gives total)
  7. Add `enrichmentScore`, `orgType`, and `website` to the returned buyer fields in the map (they come from lean() already via spread, but ensure they're explicitly available)
  8. Return `{ buyers, total, filteredCount }` where `total` is estimatedDocumentCount and `filteredCount` is countDocuments with the query

  Also add `sort` options for new sortable fields: add `orgType` and `enrichmentScore` to the sortField map:
  - `"orgType"` maps to field `"orgType"`
  - `"enrichmentScore"` maps to field `"enrichmentScore"`

  Update the SortColumn type union in BuyerFilters to include the new sort options.

  Remove imports for `ContactReveal` (no longer used in this file).

  Keep `fetchBuyerById` function as-is (it still uses userId for the detail page, but we'll simplify it in Plan 02).
  </action>
  <verify>Run `npx tsc --noEmit` from project root to verify no type errors in buyers.ts</verify>
  <done>BuyerFilters accepts sector/orgType/region, fetchBuyers builds MongoDB query from filters, returns filteredCount, no longer references ContactReveal or userId</done>
</task>

<task type="auto">
  <name>Task 2: Update buyers API route and create filters endpoint</name>
  <files>src/app/api/buyers/route.ts, src/app/api/buyers/filters/route.ts</files>
  <action>
  **Update `src/app/api/buyers/route.ts`:**
  1. Parse additional search params: `sector`, `orgType`, `region` from the URL
  2. Pass them to `fetchBuyers` in the filters object
  3. Remove `userId` from the `fetchBuyers` call (function no longer accepts it)
  4. Return `{ buyers, total, filteredCount }` in the response (add filteredCount)
  5. Keep auth check (still need authenticated users to access buyers)

  **Create `src/app/api/buyers/filters/route.ts`:**
  A new GET endpoint that returns distinct values for filter dropdowns. Implementation:
  1. Auth check (same pattern as buyers route)
  2. `await dbConnect()`
  3. Use `Promise.all` to fetch three distinct value arrays in parallel:
     - `Buyer.distinct("sector")` -- filter out null/empty, sort alphabetically
     - `Buyer.distinct("orgType")` -- filter out null/empty, sort alphabetically
     - `Buyer.distinct("region")` -- filter out null/empty, sort alphabetically
  4. Return `{ sectors, orgTypes, regions }` as JSON
  5. This endpoint is called once on page load to populate filter dropdowns with actual data values
  </action>
  <verify>Run `npx tsc --noEmit` from project root to verify no type errors. The filters endpoint returns arrays of distinct strings.</verify>
  <done>Buyers API route passes filter params to fetchBuyers. New /api/buyers/filters endpoint returns distinct values for sector, orgType, and region.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- BuyerFilters type includes sector, orgType, region fields
- fetchBuyers builds MongoDB $and query when filters are present
- fetchBuyers returns filteredCount alongside total
- No references to ContactReveal in buyers.ts
- /api/buyers/filters route file exists and exports GET
</verification>

<success_criteria>
Server-side buyer filtering works: passing sector/orgType/region params to fetchBuyers returns a filtered subset of buyers with correct filteredCount. The filters API endpoint returns the distinct values available in the database for each filterable field.
</success_criteria>

<output>
After completion, create `.planning/phases/14-buyer-explorer-filters-data-visibility/14-01-SUMMARY.md`
</output>
