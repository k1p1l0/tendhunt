---
phase: 14-buyer-explorer-filters-data-visibility
plan: 03
type: execute
wave: 2
depends_on: ["14-01", "14-02"]
files_modified:
  - src/components/buyers/buyer-filters.tsx
  - src/app/(dashboard)/buyers/page.tsx
  - src/lib/buyers.ts
autonomous: true

must_haves:
  truths:
    - "Filter dropdowns for Sector, Org Type, and Region appear above the buyer table"
    - "Selecting a filter updates URL params and shows filtered results"
    - "Filtered count shown alongside total count (e.g., 'Showing 42 of 14,605 buyer organizations')"
    - "Page description updated to reflect free data access (no 'unlock contacts' language)"
    - "New table columns receive data: orgType, enrichmentScore, website serialized from server"
  artifacts:
    - path: "src/components/buyers/buyer-filters.tsx"
      provides: "Three filter dropdowns (Sector, Org Type, Region) using URL search params"
    - path: "src/app/(dashboard)/buyers/page.tsx"
      provides: "Server component parsing filter params, passing to fetchBuyers, serializing enrichment fields"
  key_links:
    - from: "src/components/buyers/buyer-filters.tsx"
      to: "URL searchParams"
      via: "useSearchParams + router.replace"
      pattern: "useSearchParams.*updateFilter"
    - from: "src/app/(dashboard)/buyers/page.tsx"
      to: "src/lib/buyers.ts"
      via: "fetchBuyers with filter params"
      pattern: "fetchBuyers.*sector.*orgType.*region"
    - from: "src/app/(dashboard)/buyers/page.tsx"
      to: "src/components/buyers/buyer-table.tsx"
      via: "serializedBuyers with orgType, enrichmentScore, website"
      pattern: "orgType.*enrichmentScore.*website"
---

<objective>
Create the buyer filter dropdowns component and wire everything together in the buyers page. Build BuyerFilters component (following the existing ContractFilters pattern) with three Select dropdowns for Sector, Org Type, and Region. Update the buyers page to parse filter params from URL, pass them to fetchBuyers, and serialize the new enrichment fields for the updated BuyerTable. Show filtered vs total count.

Purpose: Complete the filter-to-table pipeline so users can explore buyers by sector, org type, and region.
Output: New buyer-filters.tsx component, updated buyers page.tsx with full filter wiring.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-buyer-explorer-filters-data-visibility/14-01-SUMMARY.md
@.planning/phases/14-buyer-explorer-filters-data-visibility/14-02-SUMMARY.md
@src/components/contracts/contract-filters.tsx (reference pattern for filter dropdowns)
@src/app/(dashboard)/buyers/page.tsx
@src/components/buyers/buyer-table.tsx
@src/lib/buyers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BuyerFilters dropdown component</name>
  <files>src/components/buyers/buyer-filters.tsx</files>
  <action>
  Create a new client component `src/components/buyers/buyer-filters.tsx` following the exact pattern of `src/components/contracts/contract-filters.tsx`.

  The component receives filter options as props (from server-side fetch of /api/buyers/filters) to avoid hardcoding values:

  ```typescript
  interface BuyerFiltersProps {
    sectors: string[];
    orgTypes: string[];
    regions: string[];
  }
  ```

  Implementation:
  1. Use `"use client"` directive
  2. Import `useSearchParams`, `usePathname`, `useRouter` from next/navigation
  3. Import Select components from `@/components/ui/select`
  4. Create `updateFilter(key: string, value: string)` function that:
     - Creates new URLSearchParams from current
     - Sets page to "1" (reset pagination on filter change)
     - Sets or deletes the filter param (delete if value is "all")
     - Calls `router.replace(pathname + "?" + params.toString())`
  5. Render three Select dropdowns side by side in a flex-wrap row:
     - **Sector**: value from `searchParams.get("sector") ?? "all"`, items from `sectors` prop. Label "All Sectors" for default.
     - **Org Type**: value from `searchParams.get("orgType") ?? "all"`, items from `orgTypes` prop. Display human-readable labels using an `orgTypeLabel()` function (same mapping as buyer-header.tsx). Label "All Org Types" for default.
     - **Region**: value from `searchParams.get("region") ?? "all"`, items from `regions` prop. Label "All Regions" for default.
  6. Each SelectTrigger should have a reasonable width: sector 180px, orgType 200px, region 200px

  Copy the `orgTypeLabel` function from buyer-header.tsx into this file (or extract to a shared util if preferred -- inline is fine for a single reuse).
  </action>
  <verify>Run `npx tsc --noEmit` to verify no type errors. File exports BuyerFilters component.</verify>
  <done>BuyerFilters component renders 3 filter dropdowns that update URL search params on selection.</done>
</task>

<task type="auto">
  <name>Task 2: Wire filters and enrichment data into buyers page</name>
  <files>src/app/(dashboard)/buyers/page.tsx, src/lib/buyers.ts</files>
  <action>
  **Update `src/app/(dashboard)/buyers/page.tsx`:**

  1. Import `BuyerFilters` from `@/components/buyers/buyer-filters`
  2. Parse new search params in BuyersPage: `sector`, `orgType`, `region` (same string extraction as existing sort/order/page)
  3. Pass these to BuyerFeed as additional props
  4. In BuyerFeed:
     a. Call the /api/buyers/filters endpoint OR use a direct server-side query to get filter options. Since this is a server component, do a direct DB query: import Buyer model and call `Buyer.distinct("sector")`, `Buyer.distinct("orgType")`, `Buyer.distinct("region")` in a Promise.all. Filter out null/empty values and sort alphabetically.
     b. Pass `sector`, `orgType`, `region` to `fetchBuyers()` in the filters object
     c. Destructure `filteredCount` from the fetchBuyers return value
     d. Update `totalPages` to use `filteredCount` (not `total`) for pagination
  5. Update `serializedBuyers` mapping to include new fields:
     - `orgType: b.orgType ?? undefined`
     - `enrichmentScore: b.enrichmentScore ?? undefined`
     - `website: b.website ?? undefined`
  6. Remove `isUnlocked` from serializedBuyers (removed in Plan 02)
  7. Remove `contactCount` from serializedBuyers (column removed in Plan 02)
  8. Remove `userId` from BuyerFeed props and from the fetchBuyers call (Plan 01 removed it)
  9. Render `<BuyerFilters sectors={sectors} orgTypes={orgTypes} regions={regions} />` above the table
  10. Show a count line: "Showing {filteredCount} of {total} buyer organizations" -- either update BuyerTable's footer or add a separate count component above/below the table
  11. Update the page heading subtitle from "Explore buyer organizations and unlock contacts" to "Explore buyer organizations and enrichment data"
  12. Include filter params in the `suspenseKey` so Suspense re-renders on filter change

  **Minor update to `src/lib/buyers.ts` if needed:**
  If fetchBuyerById still references userId for ContactReveal, simplify it: remove the ContactReveal query and isUnlocked from the return. The detail page no longer needs it (Plan 02 removed isUnlocked from all components).
  </action>
  <verify>Run `npx tsc --noEmit` to verify no type errors. Run `npm run build` to verify the full build passes. Visually confirm the page.tsx renders BuyerFilters above BuyerTable with correct data flow.</verify>
  <done>Buyers page shows filter dropdowns populated with real data, filters flow through URL params to server-side query, table receives enrichment fields, pagination uses filtered count, description updated.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `npm run build` succeeds
- BuyerFilters component exists and renders 3 Select dropdowns
- Buyers page parses sector/orgType/region from URL and passes to fetchBuyers
- serializedBuyers includes orgType, enrichmentScore, website
- serializedBuyers does NOT include isUnlocked or contactCount
- filteredCount used for pagination
- suspenseKey includes filter params
- Page subtitle updated (no "unlock" language)
</verification>

<success_criteria>
Complete filter-to-table pipeline works: selecting a filter dropdown updates URL, triggers server re-fetch with filter params, returns filtered buyers with enrichment data, table renders new columns, pagination reflects filtered count. All three dropdowns populated with real database values.
</success_criteria>

<output>
After completion, create `.planning/phases/14-buyer-explorer-filters-data-visibility/14-03-SUMMARY.md`
</output>
