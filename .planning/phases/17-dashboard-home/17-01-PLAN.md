---
phase: 17-dashboard-home
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/dashboard.ts
  - src/components/dashboard/account-manager-card.tsx
  - src/components/dashboard/quick-actions.tsx
  - src/app/(dashboard)/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a personalized greeting with their first name on the dashboard"
    - "User sees an account manager card with Matt's name, email, and a Book a meeting button"
    - "Clicking Book a meeting opens a Calendly popup scheduler"
    - "User sees quick action link cards for Contracts, Scanners, and Buyers pages"
    - "Dashboard loads without errors for users with zero scanners (empty state)"
  artifacts:
    - path: "src/lib/dashboard.ts"
      provides: "Data fetching functions and account manager config constant"
      exports: ["getUserScanners", "getTopScores", "ACCOUNT_MANAGER"]
    - path: "src/components/dashboard/account-manager-card.tsx"
      provides: "Client component with Calendly popup integration"
      contains: "use client"
    - path: "src/components/dashboard/quick-actions.tsx"
      provides: "Static quick action link cards"
      contains: "QuickActions"
    - path: "src/app/(dashboard)/dashboard/page.tsx"
      provides: "Server component dashboard page with two-column layout"
      contains: "Promise.all"
  key_links:
    - from: "src/app/(dashboard)/dashboard/page.tsx"
      to: "src/lib/dashboard.ts"
      via: "import getUserScanners, getTopScores"
      pattern: "import.*from.*@/lib/dashboard"
    - from: "src/components/dashboard/account-manager-card.tsx"
      to: "Calendly widget.js"
      via: "next/script + window.Calendly.initPopupWidget"
      pattern: "Calendly.*initPopupWidget"
    - from: "src/app/(dashboard)/dashboard/page.tsx"
      to: "@clerk/nextjs/server"
      via: "auth() + currentUser() for userId and greeting"
      pattern: "currentUser"
---

<objective>
Create the dashboard data layer, account manager card with Calendly integration, quick action links, and the new two-column page shell replacing the generic stats dashboard.

Purpose: Replace the generic stat cards + recent contracts dashboard with a personalized home hub. This plan builds the foundation (data fetching, page layout, AM card, quick actions) that Plan 02 will fill with scanner and signal content sections.
Output: Working dashboard page with greeting, account manager card, quick actions, and placeholder areas for scanner/signal sections.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-dashboard-home/17-RESEARCH.md
@src/app/(dashboard)/dashboard/page.tsx
@src/app/(dashboard)/layout.tsx
@src/models/scanner.ts
@src/models/contract.ts
@src/models/signal.ts
@src/models/buyer.ts
@src/components/scanners/scanner-list.tsx
@src/lib/contracts.ts
@src/lib/mongodb.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard data layer and account manager config</name>
  <files>src/lib/dashboard.ts</files>
  <action>
Create `src/lib/dashboard.ts` with three exports:

1. **`ACCOUNT_MANAGER` constant** -- centralized config object:
   ```typescript
   export const ACCOUNT_MANAGER = {
     name: "Matt",
     email: "matt@tendhunt.com",
     calendlyUrl: "https://calendly.com/matt-tendhunt/30min",
     greeting: "Hi! I'm Matt, your dedicated account manager. I'm here to help you get the most out of TendHunt.",
   } as const;
   ```

2. **`getUserScanners(userId: string)`** -- returns user's scanners as summary objects:
   - Import `dbConnect` from `@/lib/mongodb` and `Scanner` from `@/models/scanner`
   - Query `Scanner.find({ userId }).sort({ updatedAt: -1 }).select("name type description lastScoredAt updatedAt scores").lean()`
   - Map results to `ScannerSummary` interface: `{ _id: string, name: string, type: "rfps" | "meetings" | "buyers", description: string, lastScoredAt: Date | null, updatedAt: Date, totalEntries: number }`
   - `totalEntries` = count unique entityIds in scores array using `new Set(scores.map(s => String(s.entityId))).size`
   - Return the array (empty array for users with no scanners)

3. **`getTopScores(userId: string, limit = 10)`** -- aggregates top-scoring entries across user's scanners:
   - Query all scanners for user, select "name type scores aiColumns"
   - Iterate scanners, build a columnMap from `aiColumns` (columnId -> name)
   - Collect all score entries where `score != null && score >= 7` into a flat array with shape: `{ scannerId, scannerName, scannerType, entityId, columnId, columnName, score, reasoning }`
   - Sort descending by score, slice to `limit`
   - Group entityIds by scannerType (rfps -> Contract, meetings -> Signal, buyers -> Buyer)
   - Batch-resolve entity names using `Collection.find({ _id: { $in: ids } }).select("title buyerName organizationName name").lean()` -- 3 queries max (one per collection type)
   - Build a Map of entityId -> entityName (use `title` for contracts, `title` for signals, `name` for buyers)
   - Return array with `entityName` added to each entry (fallback: "Unknown")
   - Export the return type as `TopScore`

Important: Always convert ObjectIds to strings with `String()` when using as Map keys. Import Contract, Signal, Buyer models for batch resolution.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors in dashboard.ts. Verify the file exports ACCOUNT_MANAGER, getUserScanners, getTopScores.</verify>
  <done>Data layer file exists with typed exports, handles empty scanner case, batch-resolves entity names without N+1 queries.</done>
</task>

<task type="auto">
  <name>Task 2: Create AM card, quick actions, and rewrite dashboard page</name>
  <files>
    src/components/dashboard/account-manager-card.tsx
    src/components/dashboard/quick-actions.tsx
    src/app/(dashboard)/dashboard/page.tsx
  </files>
  <action>
**account-manager-card.tsx** -- "use client" component:
- Import `Script` from `next/script`, `Button` from `@/components/ui/button`, `Card`/`CardContent`/`CardHeader` from `@/components/ui/card`, `Avatar`/`AvatarFallback` from `@/components/ui/avatar`, `Calendar` and `Mail` from `lucide-react`
- Declare global `Window.Calendly` interface with `initPopupWidget({ url: string })`
- Props: `{ name: string, email: string, calendlyUrl: string, greeting: string }`
- Render a Card with:
  - Avatar with AvatarFallback showing first letter of name (e.g., "M")
  - Name as CardTitle, greeting as description
  - Email displayed with Mail icon (as a `mailto:` link)
  - "Book a meeting" Button that calls `window.Calendly?.initPopupWidget({ url: calendlyUrl })` on click
  - Load Calendly widget.js via `<Script src="https://assets.calendly.com/assets/external/widget.js" strategy="lazyOnload" />`
  - Also include `<link href="https://assets.calendly.com/assets/external/widget.css" rel="stylesheet" />` for popup styles

**quick-actions.tsx** -- pure server component (no "use client"):
- Import `Card`/`CardContent` from `@/components/ui/card`, `Link` from `next/link`, icons from `lucide-react` (FileText, Radar, Building2, ArrowRight)
- Define 3 action items array: Contracts (/contracts, FileText), Scanners (/scanners, Radar), Buyers (/buyers, Building2) -- each with title, description, href, icon
- Render a grid of link cards (grid-cols-1 sm:grid-cols-3) where each card is an `<Link>` wrapping a Card with hover effect (hover:border-primary/50 transition-colors), icon, title, description, and ArrowRight indicator
- Export as `QuickActions`

**page.tsx** -- complete rewrite as server component:
- Remove ALL old imports (getContractStats, fetchContracts, ContractCard, Filter, Radio, Coins, etc.)
- Import `auth`, `currentUser` from `@clerk/nextjs/server`, `redirect` from `next/navigation`
- Import `getUserScanners`, `getTopScores`, `ACCOUNT_MANAGER` from `@/lib/dashboard`
- Import `AccountManagerCard` from `@/components/dashboard/account-manager-card`
- Import `QuickActions` from `@/components/dashboard/quick-actions`
- Auth check: `const { userId } = await auth(); if (!userId) redirect("/sign-in");`
- Parallel fetch: `const [user, scanners, topScores] = await Promise.all([currentUser(), getUserScanners(userId), getTopScores(userId)])`
- Render two-column responsive layout: `<div className="grid gap-6 lg:grid-cols-[1fr_320px]">`
  - Left column (`<div className="space-y-6">`):
    - Greeting: `<h1>Welcome back, {user?.firstName || "there"}</h1>` with `<p>` subtitle "Your procurement intelligence hub"
    - `<AccountManagerCard {...ACCOUNT_MANAGER} />`
    - Placeholder comment `{/* SavedScannersSection - Plan 02 */}` and `{/* FreshSignalsFeed - Plan 02 */}` -- these will be empty divs for now showing "Scanners section coming" and "Signals section coming" as muted text, wrapped in Cards
  - Right column (`<div className="space-y-6">`):
    - `<QuickActions />`

The page must NOT import anything from `@/lib/contracts` anymore. The old stat cards, quick filter badges, and recent contracts sections are fully replaced.
  </action>
  <verify>Run `npx next build` (or `npx tsc --noEmit` if build is heavy) to confirm no type errors. Verify page renders by checking the build output has no errors for the dashboard route.</verify>
  <done>Dashboard page shows personalized greeting, account manager card with Calendly button, and quick action links. Old generic stats dashboard is fully replaced. Placeholder areas exist for Plan 02 content.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `src/lib/dashboard.ts` exports `ACCOUNT_MANAGER`, `getUserScanners`, `getTopScores`
- `src/components/dashboard/account-manager-card.tsx` has "use client" directive and Calendly integration
- `src/app/(dashboard)/dashboard/page.tsx` is an async server component with `auth()` + `currentUser()` + `Promise.all`
- Old imports from `@/lib/contracts` and `@/components/contracts/contract-card` are removed from dashboard page
</verification>

<success_criteria>
- Dashboard page is a server component with personalized greeting using Clerk currentUser firstName
- Account manager card displays Matt's name, email, greeting, and Book a meeting button
- Calendly widget.js loaded via next/script, popup triggered on button click
- Quick action cards link to /contracts, /scanners, /buyers
- Two-column responsive layout (stacks on mobile)
- No old dashboard content remains (no stat cards, no quick filters, no recent contracts)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-dashboard-home/17-01-SUMMARY.md`
</output>
