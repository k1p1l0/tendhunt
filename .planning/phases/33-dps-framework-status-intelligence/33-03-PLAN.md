---
phase: 33-dps-framework-status-intelligence
plan: 03
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - apps/web/src/components/contracts/contract-detail-view.tsx
  - apps/web/src/lib/agent/system-prompt.ts
autonomous: true

must_haves:
  truths:
    - "Contract detail page shows a Procurement Mechanism section explaining DPS/Framework when applicable"
    - "Apply CTA button adapts its text based on the mechanism type and contract status"
    - "Sculptor AI correctly explains DPS reopening windows and Framework call-off patterns"
  artifacts:
    - path: "apps/web/src/components/contracts/contract-detail-view.tsx"
      provides: "DPS/Framework procurement mechanism section and adaptive CTA"
      contains: "contractMechanism"
    - path: "apps/web/src/lib/agent/system-prompt.ts"
      provides: "DPS/Framework awareness in Sculptor system prompt"
      contains: "Dynamic Purchasing System"
  key_links:
    - from: "apps/web/src/components/contracts/contract-detail-view.tsx"
      to: "apps/web/src/models/contract.ts"
      via: "contractMechanism field drives conditional rendering"
      pattern: "contractMechanism"
---

<objective>
Add DPS/Framework intelligence to the contract detail page and update Sculptor AI's system prompt with procurement mechanism awareness.

Purpose: Suppliers viewing a DPS/Framework contract understand the mechanism, see the correct action to take, and get accurate AI advice about reopening windows. The current misleading "CLOSED = dead" interpretation is eliminated.
Output: Contract detail page with procurement mechanism section and adaptive CTA, Sculptor AI with DPS/Framework knowledge.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-dps-framework-status-intelligence/33-RESEARCH.md
@.planning/phases/33-dps-framework-status-intelligence/33-01-SUMMARY.md
@apps/web/src/components/contracts/contract-detail-view.tsx
@apps/web/src/lib/agent/system-prompt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add procurement mechanism section and adaptive CTA to contract detail page</name>
  <files>apps/web/src/components/contracts/contract-detail-view.tsx</files>
  <action>
1. Add `contractMechanism` to the `ContractDetailData` interface:
   ```typescript
   contractMechanism?: "standard" | "dps" | "framework" | "call_off_dps" | "call_off_framework" | null;
   ```

2. Update the status badge in the header section to show DPS-aware status (same logic as contracts-table.tsx):
   - If mechanism is DPS/Framework and status is CLOSED and contractEndDate is in the future: show amber "Window Closed" badge
   - Add mechanism type badge next to the status badge (purple for DPS, indigo for Framework, matching contracts-table colors)

3. Create a `ProcurementMechanismSection` component (defined outside the main component per CI lint rules -- define as a standalone function, NOT inside the render body). This section appears between the Description section and the Timeline section (or wherever contextually appropriate). It renders ONLY for non-standard mechanisms. Structure:

   **For DPS (`"dps"`):**
   - Section title: "Dynamic Purchasing System (DPS)"
   - Icon: use `RefreshCw` from lucide-react
   - Explanation text: "This is a Dynamic Purchasing System -- a multi-year procurement framework that periodically reopens for new suppliers to join. Unlike a standard tender, a DPS runs for its full contract period and reopens application windows at intervals."
   - If status is CLOSED and contractEndDate is in the future: show a highlighted callout box (amber-tinted border) saying: "The current application window is closed, but this DPS runs until {contractEndDate}. It will reopen for new applications -- monitor the buyer for the next window."
   - If status is OPEN: "The application window is currently open. New suppliers can apply to join this DPS."

   **For Framework (`"framework"`):**
   - Section title: "Framework Agreement"
   - Icon: use `Layers` from lucide-react
   - Explanation text: "This is a Framework Agreement -- a pre-established arrangement between the buyer and a set of qualified suppliers. Individual contracts (call-offs) are awarded to framework members throughout the agreement period."
   - If status is CLOSED and contractEndDate future: "This framework agreement runs until {contractEndDate}. While new suppliers cannot join mid-term, monitoring the buyer may reveal when the framework is re-tendered."

   **For call-offs (`"call_off_dps"`, `"call_off_framework"`):**
   - Section title: "Call-off Contract" with "(from DPS)" or "(from Framework Agreement)" suffix
   - Icon: use `ArrowRight` from lucide-react
   - Explanation text: "This is a call-off contract awarded under a {DPS/Framework Agreement}. The parent {DPS/Framework} may still be accepting new suppliers."

   Styling: Use a card-like container with `border rounded-lg p-4` and a subtle background `bg-muted/30`. Icon + title in a flex row, explanation text below. Use `motion.div` with `initial={{ opacity: 0, y: 8 }} animate={{ opacity: 1, y: 0 }}` for smooth entrance.

4. Create an adaptive CTA function (standalone, not inside render):
   ```typescript
   function getActionCTA(
     mechanism: string | null | undefined,
     status: string,
     contractEndDate?: string | Date | null,
     sourceUrl?: string | null
   ): { label: string; variant: "default" | "secondary" | "outline"; disabled: boolean }
   ```

   Return values:
   - Standard OPEN: `{ label: "Apply for this tender", variant: "default", disabled: false }`
   - Standard CLOSED/AWARDED/CANCELLED: `{ label: "View on source", variant: "outline", disabled: false }`
   - DPS, OPEN: `{ label: "Apply to join this DPS", variant: "default", disabled: false }`
   - DPS, CLOSED + future end date: `{ label: "Monitor for next reopening", variant: "secondary", disabled: false }`
   - DPS, CLOSED + past end date: `{ label: "DPS expired", variant: "outline", disabled: true }`
   - Framework, OPEN: `{ label: "View framework details", variant: "default", disabled: false }`
   - Framework, CLOSED + future end: `{ label: "Framework active -- monitor buyer", variant: "secondary", disabled: false }`
   - Call-off (any): `{ label: "Framework members only", variant: "outline", disabled: true }`

   Replace the existing "Apply for this tender" / "View on source" CTA button in the header/actions area with this adaptive CTA. The button still links to `sourceUrl` when not disabled.

5. Ensure `motion` is imported from `motion/react` (consistent with existing codebase usage).
  </action>
  <verify>Run `pnpm typecheck`. Check that the contract detail page for a DPS contract shows the mechanism section and correct CTA.</verify>
  <done>
- Non-standard contracts show a Procurement Mechanism section with contextual explanation
- DPS contracts with CLOSED status and future end dates show amber callout about reopening windows
- CTA button text adapts: "Apply to join this DPS", "Monitor for next reopening", "Framework members only", etc.
- Standard contracts are unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Sculptor AI system prompt with DPS/Framework awareness</name>
  <files>apps/web/src/lib/agent/system-prompt.ts</files>
  <action>
1. Add a new section to the system prompt in `buildSystemPrompt`, inserted BEFORE the Guidelines section (section 6). Add it as section 5.5 (between entity references and guidelines):

   ```typescript
   sections.push(`## UK Procurement Mechanisms

You must understand three procurement mechanisms in UK public sector:

**Standard Tenders** -- Open once, close, award to winner. Linear lifecycle. Most contracts are this type.

**Dynamic Purchasing Systems (DPS)** -- Multi-year procurement frameworks that **periodically reopen** for new suppliers. Key facts:
- A DPS runs for its full contract period (often 4-8 years)
- Application windows open and close multiple times during the DPS lifetime
- "Closed" status means the **current window** is closed, NOT that the DPS is finished
- If contractEndDate is in the future, the DPS is still active and will reopen
- Suppliers should **monitor the buyer** for the next reopening window
- ~500 contracts in the database are DPS type

**Framework Agreements** -- Pre-qualified supplier panels with periodic call-offs. Key facts:
- Frameworks pre-qualify a set of suppliers, then award individual call-offs to panel members
- New suppliers cannot join an existing framework mid-term
- When a framework expires, it is typically re-tendered
- Call-off contracts are only available to existing framework members
- ~2,400 contracts are framework call-offs

**When discussing contract status:**
- NEVER say a DPS is "expired" or "finished" if its contractEndDate is in the future
- For CLOSED DPS with future end dates: explain it will reopen and advise monitoring
- For framework call-offs: note they are only available to framework members
- Always check the \`contractMechanism\` field: standard, dps, framework, call_off_dps, call_off_framework`);
   ```

2. In the contract_detail context case (around line 130-141), add the contract mechanism to the context if available. The `AgentPageContext` interface needs a new optional field:
   ```typescript
   contractMechanism?: string;
   ```

   Then in the switch case for `contract_detail`, add:
   ```typescript
   if (context.contractMechanism && context.contractMechanism !== "standard")
     contextLines.push(`**Procurement Mechanism:** ${context.contractMechanism}`);
   ```

3. Update the context setter on the contract detail page to pass the mechanism. Check `apps/web/src/app/(dashboard)/contracts/[id]/page.tsx` for where `AgentContextSetter` is used and add `contractMechanism={contract.contractMechanism}` to the page context.
  </action>
  <verify>Run `pnpm typecheck`. Review the system prompt output by checking `buildSystemPrompt()` includes the UK Procurement Mechanisms section.</verify>
  <done>
- Sculptor AI system prompt includes comprehensive DPS/Framework knowledge
- Contract detail page passes contractMechanism to Sculptor context
- Sculptor can correctly explain reopening windows, framework membership, and call-off availability
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- Contract detail page for DPS contracts shows Procurement Mechanism section
- CTA button adapts based on mechanism + status + end date
- Sculptor AI system prompt includes UK Procurement Mechanisms section
- Contract mechanism is passed to Sculptor context on detail pages
</verification>

<success_criteria>
- DPS/Framework contracts have explanatory context on their detail page
- CTA guides suppliers to correct action (apply, monitor, framework-only)
- Sculptor AI accurately explains DPS reopening windows when asked
</success_criteria>

<output>
After completion, create `.planning/phases/33-dps-framework-status-intelligence/33-03-SUMMARY.md`
</output>
