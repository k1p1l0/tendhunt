---
phase: 33-dps-framework-status-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - apps/web/src/components/contracts/contracts-table.tsx
  - apps/web/src/components/contracts/contracts-toolbar.tsx
  - apps/web/src/lib/contracts.ts
autonomous: true

must_haves:
  truths:
    - "Contract list shows DPS/Framework mechanism badge next to the status badge"
    - "CLOSED DPS/Framework contracts with future contractEndDate show amber 'Window Closed' status instead of default CLOSED styling"
    - "User can filter contracts by mechanism type via a new filter chip in the toolbar"
  artifacts:
    - path: "apps/web/src/components/contracts/contracts-table.tsx"
      provides: "Mechanism badge and DPS-aware status colors"
      contains: "contractMechanism"
    - path: "apps/web/src/components/contracts/contracts-toolbar.tsx"
      provides: "Mechanism filter chip"
      contains: "mechanism"
    - path: "apps/web/src/lib/contracts.ts"
      provides: "Mechanism filter condition in fetchContracts"
      contains: "mechanism"
  key_links:
    - from: "apps/web/src/components/contracts/contracts-toolbar.tsx"
      to: "apps/web/src/lib/contracts.ts"
      via: "mechanism URL param -> ContractFilters.mechanism -> MongoDB query"
      pattern: "mechanism"
    - from: "apps/web/src/lib/contracts.ts"
      to: "apps/web/src/models/contract.ts"
      via: "contractMechanism field query"
      pattern: "contractMechanism"
---

<objective>
Add DPS/Framework awareness to the contract list page: mechanism badges, DPS-aware status colors, and a mechanism filter dropdown.

Purpose: Suppliers scanning the contracts list can immediately identify DPS and Framework opportunities and filter to find them. CLOSED DPS contracts no longer appear misleadingly "dead".
Output: Updated contracts table with mechanism badges, amber status for active DPS/Framework, mechanism filter chip.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-dps-framework-status-intelligence/33-RESEARCH.md
@.planning/phases/33-dps-framework-status-intelligence/33-01-SUMMARY.md
@apps/web/src/components/contracts/contracts-table.tsx
@apps/web/src/components/contracts/contracts-toolbar.tsx
@apps/web/src/lib/contracts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mechanism filter to data layer and toolbar</name>
  <files>apps/web/src/lib/contracts.ts, apps/web/src/components/contracts/contracts-toolbar.tsx</files>
  <action>
1. In `apps/web/src/lib/contracts.ts`:
   - Add `mechanism?: string` to the `ContractFilters` interface
   - In `fetchContracts`, add a filter condition: if `filters.mechanism` is set, add `{ contractMechanism: filters.mechanism }` to conditions
   - Also add `contractMechanism` and `contractEndDate` to the select projection in `fetchContracts` base query (currently uses `select("-rawData")` which includes everything except rawData, so this is already covered -- but verify the `ContractRow` interface in the table component gets the new fields)

2. In `apps/web/src/components/contracts/contracts-toolbar.tsx`:
   - Add a `MECHANISMS` constant array:
     ```typescript
     const MECHANISMS = [
       { value: "standard", label: "Standard Tender" },
       { value: "dps", label: "DPS (Dynamic Purchasing)" },
       { value: "framework", label: "Framework Agreement" },
       { value: "call_off_dps", label: "DPS Call-off" },
       { value: "call_off_framework", label: "Framework Call-off" },
     ] as const;
     ```
   - Add state tracking for the mechanism filter: read `searchParams.get("mechanism")` into `currentMechanism`
   - Add a new `FilterChip` for "Mechanism" after the Value filter chip:
     ```tsx
     <FilterChip
       label="Type"
       value={currentMechanism}
       displayValue={MECHANISMS.find(m => m.value === currentMechanism)?.label}
       onSelect={(v) => updateFilter("mechanism", v)}
       onClear={() => updateFilter("mechanism", null)}
       options={MECHANISMS.map(m => ({ value: m.value, label: m.label }))}
     />
     ```

3. Wire the `mechanism` param through the contracts page. Check `apps/web/src/app/(dashboard)/contracts/page.tsx` -- add `mechanism: searchParams.mechanism` to the filters object passed to `fetchContracts()`.
  </action>
  <verify>Run `pnpm typecheck` -- should pass. Navigate to /contracts and verify the "Type" filter chip appears in the toolbar.</verify>
  <done>Contracts can be filtered by mechanism type via URL param `?mechanism=dps`. The filter chip appears in the toolbar alongside Sector, Region, and Value.</done>
</task>

<task type="auto">
  <name>Task 2: Add mechanism badge and DPS-aware status colors to contracts table</name>
  <files>apps/web/src/components/contracts/contracts-table.tsx</files>
  <action>
1. Update the `ContractRow` interface to include:
   ```typescript
   contractMechanism?: "standard" | "dps" | "framework" | "call_off_dps" | "call_off_framework" | null;
   contractEndDate?: string | Date | null;
   ```

2. Add a helper function `mechanismBadge` that returns a small badge for non-standard mechanisms:
   - `"dps"` -> purple badge text "DPS"
   - `"framework"` -> indigo badge text "Framework"
   - `"call_off_dps"` -> purple/lighter badge text "DPS Call-off"
   - `"call_off_framework"` -> indigo/lighter badge text "FW Call-off"
   - `"standard"` or null -> no badge (return null)

   Badge styling (similar to existing Badge component with variant="outline"):
   - DPS variants: `bg-purple-500/15 text-purple-400 border-purple-500/20`
   - Framework variants: `bg-indigo-500/15 text-indigo-400 border-indigo-500/20`
   - Use `text-[10px] px-1.5 py-0` to match existing status badge sizing

3. Modify the `statusClassName` function to handle DPS-aware status:
   - Add a new helper `isDpsFrameworkActive(mechanism, status, contractEndDate)` that returns true when:
     - `mechanism` is "dps", "framework", "call_off_dps", or "call_off_framework"
     - AND `status` is "CLOSED"
     - AND `contractEndDate` is in the future (or not null and > Date.now())
   - When this condition is true, use amber status styling: `bg-amber-500/15 text-amber-500 border-amber-500/20`
   - Display text: "Window Closed" instead of "CLOSED"

4. In the table row JSX, update the Status column to:
   - Show the mechanism badge BEFORE the status badge (in a flex row with gap-1.5)
   - Use the DPS-aware status text and color
   - Expand the Status column from `col-span-1` to `col-span-2` and reduce the Sector column from `col-span-2` to `col-span-1` to accommodate the extra badge. Or alternatively, stack the mechanism badge above the status badge vertically (try horizontal first, fall back to vertical if too cramped).

5. Update the table header to reflect any column width changes.
  </action>
  <verify>Run `pnpm typecheck`. Navigate to /contracts -- DPS/Framework contracts should show a purple/indigo mechanism badge. CLOSED DPS contracts with future end dates should show amber "Window Closed" status.</verify>
  <done>
- Non-standard contracts show a colored mechanism type badge (DPS = purple, Framework = indigo)
- CLOSED DPS/Framework contracts with future contractEndDate show amber "Window Closed" instead of plain "CLOSED"
- Standard contracts look unchanged
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- Contract list shows mechanism badges for DPS/Framework contracts
- CLOSED DPS with future end dates show amber "Window Closed"
- Mechanism filter chip works and filters the list correctly
- Standard contracts are unaffected visually
</verification>

<success_criteria>
- DPS/Framework contracts are visually distinguishable in the list via mechanism badge
- CLOSED-but-active DPS/Framework contracts show amber status, not misleading red/default
- Users can filter by mechanism type
</success_criteria>

<output>
After completion, create `.planning/phases/33-dps-framework-status-intelligence/33-02-SUMMARY.md`
</output>
