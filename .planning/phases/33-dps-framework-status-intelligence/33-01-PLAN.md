---
phase: 33-dps-framework-status-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/models/contract.ts
  - apps/workers/data-sync/src/types.ts
  - apps/workers/data-sync/src/mappers/ocds-mapper.ts
  - apps/web/scripts/backfill-contract-mechanism.ts
autonomous: true

must_haves:
  truths:
    - "Every new contract ingested via data-sync has a contractMechanism field derived from OCDS data"
    - "Existing ~60k contracts can be classified by running the backfill script"
    - "contractMechanism values correctly distinguish standard, dps, framework, call_off_dps, and call_off_framework"
  artifacts:
    - path: "apps/web/src/models/contract.ts"
      provides: "contractMechanism enum field on Contract schema"
      contains: "contractMechanism"
    - path: "apps/workers/data-sync/src/mappers/ocds-mapper.ts"
      provides: "classifyContractMechanism function"
      contains: "classifyContractMechanism"
    - path: "apps/workers/data-sync/src/types.ts"
      provides: "contractMechanism field on MappedContract interface"
      contains: "contractMechanism"
    - path: "apps/web/scripts/backfill-contract-mechanism.ts"
      provides: "One-time backfill script for existing contracts"
      contains: "backfill"
  key_links:
    - from: "apps/workers/data-sync/src/mappers/ocds-mapper.ts"
      to: "apps/web/src/models/contract.ts"
      via: "contractMechanism field populated during mapping"
      pattern: "contractMechanism.*classifyContractMechanism"
---

<objective>
Add `contractMechanism` enum field to the Contract data model and classify contracts during OCDS ingestion. Build a backfill script for existing contracts.

Purpose: The foundation for all DPS/Framework UI intelligence -- without this field, no downstream plan can distinguish procurement mechanism types.
Output: Contract schema with new field, OCDS mapper with classification logic, backfill script.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-dps-framework-status-intelligence/33-RESEARCH.md
@apps/web/src/models/contract.ts
@apps/workers/data-sync/src/types.ts
@apps/workers/data-sync/src/mappers/ocds-mapper.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add contractMechanism field to Contract schema and MappedContract type</name>
  <files>apps/web/src/models/contract.ts, apps/workers/data-sync/src/types.ts</files>
  <action>
1. In `apps/web/src/models/contract.ts`, add a new field after `procurementMethodDetails`:
   ```
   contractMechanism: {
     type: String,
     enum: ["standard", "dps", "framework", "call_off_dps", "call_off_framework"],
     default: "standard",
     index: true,
   }
   ```

2. In `apps/workers/data-sync/src/types.ts`, add `contractMechanism` to the `MappedContract` interface:
   ```
   contractMechanism: "standard" | "dps" | "framework" | "call_off_dps" | "call_off_framework";
   ```
   Place it after `procurementMethodDetails`.
  </action>
  <verify>Run `pnpm typecheck` -- should pass with the new field available.</verify>
  <done>Contract schema has `contractMechanism` enum field indexed, MappedContract interface includes the field.</done>
</task>

<task type="auto">
  <name>Task 2: Add classification logic to OCDS mapper and build backfill script</name>
  <files>apps/workers/data-sync/src/mappers/ocds-mapper.ts, apps/web/scripts/backfill-contract-mechanism.ts</files>
  <action>
1. In `apps/workers/data-sync/src/mappers/ocds-mapper.ts`, add a `classifyContractMechanism` function BEFORE the main `mapOcdsToContract` function. The classification logic uses two signals in priority order:

   **Signal 1: `procurementMethodDetails` (most reliable)**
   - Contains "Call-off from a dynamic purchasing system" (case-insensitive) -> `"call_off_dps"`
   - Contains "Call-off from a framework agreement" (case-insensitive) -> `"call_off_framework"`

   **Signal 2: Title pattern matching (broader detection)**
   - Title contains "Dynamic Purchasing System" or " DPS " or starts with "DPS " or ends with " DPS" (case-insensitive) -> `"dps"`
   - Title contains "Framework Agreement" or "Framework" (case-insensitive, but NOT if already classified as call_off) -> `"framework"`

   **Default:** `"standard"`

   Function signature:
   ```typescript
   export function classifyContractMechanism(
     procurementMethodDetails: string | null | undefined,
     title: string
   ): "standard" | "dps" | "framework" | "call_off_dps" | "call_off_framework"
   ```

   Title matching for "DPS" must use word boundaries to avoid false positives (e.g. "ADPS" should not match). Use regex: `/\bDPS\b/i` for DPS and `/\bDynamic Purchasing System\b/i` for the full phrase. For "Framework", use `/\bFramework\s+Agreement\b/i` first (more specific), then `/\bFramework\b/i` as fallback.

2. In `mapOcdsToContract`, call `classifyContractMechanism` and include the result in the returned object:
   ```typescript
   contractMechanism: classifyContractMechanism(
     release.tender?.procurementMethodDetails,
     release.tender?.title ?? "Untitled"
   ),
   ```

3. Create `apps/web/scripts/backfill-contract-mechanism.ts` following the pattern of existing backfill scripts (e.g. `backfill-parent-buyers.ts`):
   - Connect to MongoDB via `DOTENV_CONFIG_PATH=apps/web/.env.local`
   - Import mongoose, connect, then use Contract model
   - Find all contracts (or those with `contractMechanism: null` or `contractMechanism: { $exists: false }`)
   - For each contract, classify using `procurementMethodDetails` and `title` with the same logic as `classifyContractMechanism` (duplicate the logic inline since the mapper is in a different package)
   - Use bulkWrite with updateOne operations for efficiency (batch size 1000)
   - Support `--dry-run` (default) and `--write` flags
   - Print summary: total processed, counts per mechanism type
   - Run command: `DOTENV_CONFIG_PATH=apps/web/.env.local npx tsx --require dotenv/config apps/web/scripts/backfill-contract-mechanism.ts [--write]`
  </action>
  <verify>
1. `pnpm typecheck` passes
2. Dry-run the backfill: `DOTENV_CONFIG_PATH=apps/web/.env.local npx tsx --require dotenv/config apps/web/scripts/backfill-contract-mechanism.ts` -- should show classification counts without writing
  </verify>
  <done>
- `classifyContractMechanism()` correctly classifies: procurementMethodDetails "Call-off from a dynamic purchasing system" -> call_off_dps, "Call-off from a framework agreement" -> call_off_framework, title "DPS for ..." -> dps, title "Framework Agreement for ..." -> framework, everything else -> standard
- Backfill script runs in dry-run mode showing expected classification distribution (~2,980 call-offs via procurementMethodDetails + additional title-based matches)
- New contracts ingested by data-sync worker will have contractMechanism populated
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes across all apps
- Contract schema has `contractMechanism` field with enum validation and index
- OCDS mapper produces contractMechanism for every mapped contract
- Backfill script dry-run shows reasonable distribution (majority "standard", ~500 DPS, ~2400 framework call-offs)
</verification>

<success_criteria>
- Contract model has `contractMechanism` enum field indexed
- Data-sync mapper classifies every new contract by mechanism
- Backfill script can classify all existing contracts
- All type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/33-dps-framework-status-intelligence/33-01-SUMMARY.md`
</output>
