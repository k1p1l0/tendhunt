---
phase: 11-invoice-spend-data-intelligence
plan: 07
type: execute
wave: 4
depends_on: ["11-04", "11-05"]
files_modified:
  - web/src/models/spend-summary.ts
  - web/src/lib/spend-analytics.ts
  - web/src/components/buyers/spend-vendor-mix.tsx
  - web/src/components/buyers/spend-vendor-churn.tsx
  - web/src/components/buyers/spending-tab.tsx
  - web/src/components/buyers/spend-opportunities.tsx
  - web/src/app/api/buyers/[id]/spending/route.ts
  - workers/spend-ingest/src/stages/04-aggregate.ts
autonomous: true

must_haves:
  truths:
    - "SpendSummary stores vendorSizeBreakdown (sme vs large) and yearlyVendorSets for churn analysis"
    - "Vendor size classification uses a heuristic based on transaction frequency and amounts — NOT external API"
    - "SME vs Large vendor mix is shown as a donut/bar chart on the buyer Spending tab"
    - "Vendor churn analysis shows new/retained/lost vendors year-over-year"
    - "Spend opportunities include two new signals: SME Openness score and Vendor Stability score"
  artifacts:
    - path: "web/src/components/buyers/spend-vendor-mix.tsx"
      provides: "SME vs Large vendor mix visualization"
      contains: "SpendVendorMix"
    - path: "web/src/components/buyers/spend-vendor-churn.tsx"
      provides: "Year-over-year vendor change visualization"
      contains: "SpendVendorChurn"
    - path: "web/src/lib/spend-analytics.ts"
      provides: "SME openness + vendor stability computations"
      contains: "computeVendorMixAnalysis"
  key_links:
    - from: "web/src/lib/spend-analytics.ts"
      to: "web/src/models/spend-summary.ts"
      via: "vendorSizeBreakdown and yearlyVendorSets fields"
      pattern: "computeVendorMixAnalysis"
    - from: "web/src/components/buyers/spending-tab.tsx"
      to: "web/src/components/buyers/spend-vendor-mix.tsx"
      via: "vendorMix prop from API response"
      pattern: "SpendVendorMix"
---

<objective>
Add SME vs Large vendor mix analysis and year-over-year vendor churn tracking to the buyer Spending tab.

Purpose: Matt's Tussle interview revealed that suppliers use invoicing data to assess whether a buyer is "SME-friendly" or "locked in" with large vendors. Vendor churn (providers changing year-to-year) signals openness to new suppliers. These are two powerful sales intelligence signals we can build from existing spend transaction data.

Output:
1. Vendor size classification (SME vs Large) based on spend patterns per buyer
2. Donut chart showing SME/Large spend mix on the Spending tab
3. Year-over-year vendor churn visualization (new/retained/lost vendors)
4. Two new opportunity signals: "SME Openness" score and "Vendor Stability" score
</objective>

<execution_context>
Matt's key insight from Tussle interview:
- If a local authority works with lots of SMEs → signal they're open to small businesses
- If they only work with 1-2 large orgs → signal they're "locked in"
- If vendors change regularly year-to-year → they're open to bringing in new suppliers
- If same vendors every year → harder to break in

We already have:
- SpendTransaction with vendor, vendorNormalized, amount, date per buyer
- SpendSummary with vendorBreakdown (top 50 vendors by total spend)
- SpendSummary with monthlyTotals (year/month/total)
- Existing opportunity cards (profile match, recurring, concentration, growth)

We do NOT have:
- External vendor size data (no Companies House API)
- Vendor master table

Approach: Heuristic vendor size classification using spend patterns (total spend amount + transaction frequency). Not perfect but useful:
- Large vendor: Total spend > £500k OR > 50 transactions (likely a major contractor)
- SME vendor: Everything else

This heuristic works because UK transparency data is £25k+ or £500+ payments — a vendor receiving many large payments is likely a large org.
</execution_context>

<tasks>

<task id="1" title="Extend SpendSummary schema with vendor mix + churn fields">
<description>
Add two new computed fields to the SpendSummary model.

In `apps/web/src/models/spend-summary.ts`:
1. Add `vendorSizeBreakdown` field:
   ```
   vendorSizeBreakdown: {
     sme: { totalSpend: Number, vendorCount: Number, transactionCount: Number },
     large: { totalSpend: Number, vendorCount: Number, transactionCount: Number }
   }
   ```
2. Add `yearlyVendorSets` field (for churn analysis):
   ```
   yearlyVendorSets: [{
     year: Number,
     vendors: [String],  // vendorNormalized names active that year
     totalSpend: Number
   }]
   ```
3. Add `smeOpennessScore` field: `Number` (0-100, computed)
4. Add `vendorStabilityScore` field: `Number` (0-100, computed)
</description>
<file>web/src/models/spend-summary.ts</file>
</task>

<task id="2" title="Extend aggregation stage to compute vendor mix + yearly sets">
<description>
Update Stage 4 (aggregate.ts) in the spend-ingest worker to compute the new fields during aggregation.

In `apps/workers/spend-ingest/src/stages/04-aggregate.ts`:

1. Add a new `$facet` pipeline branch `byVendorSize`:
   - Group by vendorNormalized → compute totalSpend + count per vendor
   - Classify each vendor: large if totalSpend > 500000 OR count > 50, else sme
   - Re-aggregate into two buckets (sme/large) with totals

2. Add a new `$facet` pipeline branch `byYearVendor`:
   - Group by { year: { $year: "$date" }, vendor: "$vendorNormalized" }
   - Then group by year → push unique vendor names + sum spend
   - Sort by year ascending
   - This gives us per-year vendor sets for churn detection

3. Compute `smeOpennessScore`:
   - Based on SME spend percentage: (smeSpend / totalSpend) * 100
   - Bonus: if > 20 unique SME vendors → boost score
   - Cap at 100

4. Compute `vendorStabilityScore`:
   - Compare consecutive year vendor sets
   - High retention (same vendors) = high stability
   - Formula: avg(retained / total) across year pairs * 100
   - Score 0-100 where 100 = completely stable (same vendors every year)

5. Store all new fields in the SpendSummary upsert alongside existing fields.
</description>
<file>workers/spend-ingest/src/stages/04-aggregate.ts</file>
</task>

<task id="3" title="Add vendor mix + churn analytics computation">
<description>
Extend `apps/web/src/lib/spend-analytics.ts` with functions that derive display data from the new SpendSummary fields.

1. `computeVendorMixAnalysis(summary)`:
   - Returns: `{ sme: { spend, count, percentage }, large: { spend, count, percentage } }`
   - Input: SpendSummary.vendorSizeBreakdown

2. `computeVendorChurnAnalysis(summary)`:
   - Input: SpendSummary.yearlyVendorSets
   - For each consecutive year pair, compute:
     - `newVendors`: in current year but not previous
     - `retainedVendors`: in both years
     - `lostVendors`: in previous year but not current
     - `churnRate`: (new + lost) / total unique across both years
   - Returns array of `{ year, newCount, retainedCount, lostCount, churnRate, newVendors: string[], lostVendors: string[] }`

3. Add both to `computeSpendOpportunities` return type:
   - `smeOpenness: { score, smeSpendPct, smeVendorCount, totalVendorCount, signal }`
     - signal: "SME-friendly" (>50%), "Mixed" (20-50%), "Large-org dominated" (<20%)
   - `vendorStability: { score, avgChurnRate, signal }`
     - signal: "High turnover — open to new suppliers" (<60 stability), "Moderate stability" (60-80), "Very stable — hard to break in" (>80)
</description>
<file>web/src/lib/spend-analytics.ts</file>
</task>

<task id="4" title="Create SpendVendorMix chart component">
<description>
New client component showing the SME vs Large vendor breakdown.

Create `apps/web/src/components/buyers/spend-vendor-mix.tsx`:

1. Donut/ring chart (recharts PieChart) with two segments:
   - SME slice (green-ish): % of total spend going to SMEs
   - Large slice (blue-ish): % of total spend going to large orgs
   - Center text: SME Openness score (0-100)

2. Below the donut, show stats row:
   - "X SME vendors (£Yk)" | "Z Large vendors (£Wk)"

3. Signal badge below stats:
   - Green: "SME-friendly" (>50% SME spend)
   - Yellow: "Mixed supplier base" (20-50%)
   - Red: "Large-org dominated" (<20%)

4. Use motion.div for animated entrance.
5. Handle empty state: if no vendorSizeBreakdown, show "Insufficient data" message.
</description>
<file>web/src/components/buyers/spend-vendor-mix.tsx</file>
</task>

<task id="5" title="Create SpendVendorChurn visualization component">
<description>
New client component showing year-over-year vendor change analysis.

Create `apps/web/src/components/buyers/spend-vendor-churn.tsx`:

1. Stacked bar chart (recharts BarChart) per year:
   - Green bar: retained vendors
   - Blue bar: new vendors (entered this year)
   - Red bar: lost vendors (left from previous year)
   - X-axis: years, Y-axis: vendor count

2. Below the chart, a summary row:
   - "Vendor stability: X/100" badge
   - Signal text: "High turnover — open to new suppliers" / "Very stable"

3. Expandable detail section (collapsible):
   - For most recent year transition:
     - "New vendors this year: [list top 5 names]"
     - "No longer used: [list top 5 names]"
   - Each vendor name as a text badge

4. Handle edge cases:
   - < 2 years of data → show "Need 2+ years of data for churn analysis"
   - Only 1 year → show vendor count for that year, no churn metrics

5. Use motion.div for animated entrance.
</description>
<file>web/src/components/buyers/spend-vendor-churn.tsx</file>
</task>

<task id="6" title="Wire new components into SpendingTab and opportunities">
<description>
Integrate the new vendor mix and churn components into the existing spending UI.

1. In `apps/web/src/app/api/buyers/[id]/spending/route.ts`:
   - Add `vendorMix` and `vendorChurn` to the API response (from SpendSummary fields)
   - Add `smeOpenness` and `vendorStability` to the opportunities response

2. In `apps/web/src/components/buyers/spending-tab.tsx`:
   - Add a new row BELOW the existing 3-column chart grid (categories, timeline, recurring)
   - New 2-column row: SpendVendorMix (left) | SpendVendorChurn (right)
   - Pass vendorMix + vendorChurn data from API response

3. In `apps/web/src/components/buyers/spend-opportunities.tsx`:
   - Add two new opportunity cards:
     - "SME Openness" card (teal color): Score badge + signal text + SME spend %
     - "Vendor Stability" card (orange color): Score badge + signal text + avg churn rate
   - Place after existing 4 cards (profile match, recurring, concentration, growth)
</description>
<file>web/src/components/buyers/spending-tab.tsx</file>
<file>web/src/components/buyers/spend-opportunities.tsx</file>
<file>web/src/app/api/buyers/[id]/spending/route.ts</file>
</task>

</tasks>

<verification>
1. TypeScript: `pnpm typecheck` passes (all apps)
2. Lint: `cd apps/web && bun run lint` — 0 errors
3. Spend API includes new fields: `vendorMix`, `vendorChurn`, `smeOpenness`, `vendorStability`
4. Buyer with spend data shows:
   - SME vs Large donut chart with signal badge
   - Year-over-year vendor churn bar chart (if 2+ years of data)
   - Two new opportunity cards in the opportunities section
5. Buyer without spend data shows graceful empty states (no crashes)
6. Worker typecheck: `cd apps/workers/spend-ingest && npx tsc --noEmit` passes
</verification>
