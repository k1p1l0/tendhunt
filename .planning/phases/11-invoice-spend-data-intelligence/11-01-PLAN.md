---
phase: 11-invoice-spend-data-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/spend-transaction.ts
  - src/models/spend-summary.ts
  - workers/spend-ingest/package.json
  - workers/spend-ingest/tsconfig.json
  - workers/spend-ingest/wrangler.toml
  - workers/spend-ingest/src/types.ts
  - workers/spend-ingest/src/index.ts
  - workers/spend-ingest/src/spend-engine.ts
  - workers/spend-ingest/src/db/client.ts
  - workers/spend-ingest/src/db/spend-jobs.ts
  - workers/spend-ingest/src/db/spend-data.ts
  - workers/spend-ingest/src/db/buyers.ts
  - workers/spend-ingest/src/api-clients/rate-limiter.ts
  - workers/spend-ingest/src/stages/01-discover.ts
  - workers/spend-ingest/src/stages/02-extract-links.ts
  - workers/spend-ingest/src/stages/03-download-parse.ts
  - workers/spend-ingest/src/stages/04-aggregate.ts
autonomous: true

must_haves:
  truths:
    - "SpendTransaction model exists with buyerId, date, amount, vendor, vendorNormalized, category, subcategory, department, reference, sourceFile fields and compound indexes"
    - "SpendSummary model exists with buyerId (unique), totalTransactions, totalSpend, dateRange, categoryBreakdown, vendorBreakdown, monthlyTotals, csvFilesProcessed"
    - "Spend ingest Worker project compiles and responds to /health endpoint"
    - "Pipeline engine finds current stage and delegates to stage functions with cursor-based resume"
  artifacts:
    - path: "src/models/spend-transaction.ts"
      provides: "Mongoose model for individual spend records"
      contains: "spendTransactionSchema"
    - path: "src/models/spend-summary.ts"
      provides: "Mongoose model for pre-computed per-buyer aggregates"
      contains: "spendSummarySchema"
    - path: "workers/spend-ingest/src/types.ts"
      provides: "SpendIngestStage, SpendJobDoc, Env types"
      contains: "STAGE_ORDER"
    - path: "workers/spend-ingest/src/spend-engine.ts"
      provides: "Pipeline orchestrator"
      contains: "processSpendPipeline"
    - path: "workers/spend-ingest/src/index.ts"
      provides: "Worker entry point with cron + /run + /health"
      exports: ["default"]
  key_links:
    - from: "workers/spend-ingest/src/spend-engine.ts"
      to: "workers/spend-ingest/src/db/spend-jobs.ts"
      via: "getOrCreateJob, markJobComplete"
      pattern: "getOrCreateJob.*markJobComplete"
    - from: "workers/spend-ingest/src/index.ts"
      to: "workers/spend-ingest/src/spend-engine.ts"
      via: "processSpendPipeline call"
      pattern: "processSpendPipeline"
---

<objective>
Create the foundational data models for spend intelligence and scaffold the Cloudflare Worker project for spend data ingestion, following the exact architectural pattern of the existing enrichment Worker.

Purpose: Establishes the database schema and Worker infrastructure that all subsequent plans build upon. Without these models and the Worker shell, no spend data can be ingested or displayed.

Output: Two Mongoose models (SpendTransaction, SpendSummary), a new `workers/spend-ingest/` Cloudflare Worker project with 4-stage pipeline engine, DB operations, and rate limiter.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@workers/enrichment/src/types.ts
@workers/enrichment/src/enrichment-engine.ts
@workers/enrichment/src/index.ts
@workers/enrichment/src/db/client.ts
@workers/enrichment/src/db/enrichment-jobs.ts
@workers/enrichment/wrangler.toml
@workers/enrichment/package.json
@src/models/buyer.ts
@src/models/board-document.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SpendTransaction and SpendSummary Mongoose models</name>
  <files>
    src/models/spend-transaction.ts
    src/models/spend-summary.ts
  </files>
  <action>
    Create `src/models/spend-transaction.ts` following the exact pattern from `src/models/board-document.ts`:
    - Schema fields: buyerId (ObjectId ref "Buyer", required, indexed), date (Date, required, indexed), amount (Number, required), vendor (String, required), vendorNormalized (String, required, indexed), category (String, required, indexed), subcategory (String, optional), department (String, optional), reference (String, optional), sourceFile (String, optional)
    - Enable timestamps: true
    - Add compound indexes: { buyerId: 1, date: -1 }, { buyerId: 1, category: 1 }, { buyerId: 1, vendorNormalized: 1 }
    - Export type ISpendTransaction via InferSchemaType
    - Use mongoose.models.SpendTransaction || mongoose.model() pattern

    Create `src/models/spend-summary.ts`:
    - Schema fields: buyerId (ObjectId ref "Buyer", required, unique: true), totalTransactions (Number, default 0), totalSpend (Number, default 0), dateRange (embedded: earliest Date, latest Date), categoryBreakdown (array of { category: String, total: Number, count: Number } with _id: false), vendorBreakdown (array of { vendor: String, total: Number, count: Number } with _id: false), monthlyTotals (array of { year: Number, month: Number, total: Number } with _id: false), csvFilesProcessed ([String]), lastComputedAt (Date)
    - Enable timestamps: true
    - Export type ISpendSummary via InferSchemaType
    - Use mongoose.models.SpendSummary || mongoose.model() pattern
  </action>
  <verify>Run `npx tsc --noEmit` from the project root and confirm no type errors in the new model files.</verify>
  <done>Both models compile cleanly and follow existing codebase patterns (mongoose.models check, InferSchemaType export, proper indexes).</done>
</task>

<task type="auto">
  <name>Task 2: Scaffold spend-ingest Cloudflare Worker with pipeline engine</name>
  <files>
    workers/spend-ingest/package.json
    workers/spend-ingest/tsconfig.json
    workers/spend-ingest/wrangler.toml
    workers/spend-ingest/src/types.ts
    workers/spend-ingest/src/index.ts
    workers/spend-ingest/src/spend-engine.ts
    workers/spend-ingest/src/db/client.ts
    workers/spend-ingest/src/db/spend-jobs.ts
    workers/spend-ingest/src/db/spend-data.ts
    workers/spend-ingest/src/db/buyers.ts
    workers/spend-ingest/src/api-clients/rate-limiter.ts
  </files>
  <action>
    Create the full `workers/spend-ingest/` project by copying patterns from `workers/enrichment/`:

    **package.json**: Name "tendhunt-spend-ingest". Dependencies: mongodb ^6.16.0, papaparse ^5.5.0, @anthropic-ai/sdk ^0.39.0, p-limit ^6.2.0, fuse.js ^7.1.0. DevDependencies: @cloudflare/workers-types ^4.20250312.0, @types/papaparse (latest), @types/node ^22.0.0, typescript ^5.8.0, wrangler ^4.12.0.

    **tsconfig.json**: Copy from workers/enrichment/ (target ESNext, module ESNext, moduleResolution Bundler, strict true, skipLibCheck true, outDir dist, rootDir src, types ["@cloudflare/workers-types"]).

    **wrangler.toml**: name "tendhunt-spend-ingest", main "src/index.ts", compatibility_date "2025-03-20", compatibility_flags ["nodejs_compat_v2"]. Cron trigger: `0 3 * * 1` (weekly, Mondays at 3 AM). Secrets comment: MONGODB_URI, ANTHROPIC_API_KEY.

    **types.ts**: Define SpendIngestStage = "discover" | "extract_links" | "download_parse" | "aggregate". STAGE_ORDER array. Env interface (MONGODB_URI, ANTHROPIC_API_KEY). SpendJobDoc interface (mirrors EnrichmentJobDoc: _id, stage, status, cursor, batchSize, totalProcessed, totalErrors, errorLog, startedAt, lastRunAt, updatedAt). StageFn type signature matching enrichment pattern. SpendTransactionDoc and SpendSummaryDoc interfaces matching the Mongoose schemas.

    **db/client.ts**: Copy exactly from workers/enrichment/src/db/client.ts (MongoClient singleton with maxPoolSize 1, MongoClientOptions cast).

    **db/spend-jobs.ts**: Copy the pattern from workers/enrichment/src/db/enrichment-jobs.ts but use collection name "spendingestjobs" and SpendIngestStage/SpendJobDoc types. Include getOrCreateJob, updateJobProgress, markJobComplete, markJobError.

    **db/spend-data.ts**: CRUD operations for spend data:
    - `bulkUpsertTransactions(db, transactions[])`: bulkWrite with updateOne/upsert on compound key { buyerId, date, vendor, amount, reference } to prevent duplicates
    - `upsertSpendSummary(db, buyerId, summary)`: updateOne with upsert on { buyerId }
    - `getSpendSummary(db, buyerId)`: findOne
    - `getTransactions(db, buyerId, opts: { skip, limit, category?, vendor?, dateFrom?, dateTo? })`: find with filters and pagination

    **db/buyers.ts**: Copy pattern from workers/enrichment/src/db/buyers.ts:
    - `getBuyerBatch(db, cursor, limit)`: Find buyers with website (not null/empty), sorted by _id, cursor-based pagination using $gt on _id
    - `updateBuyerSpendFields(db, buyerId, fields)`: Update buyer with transparencyPageUrl, spendDataAvailable, lastSpendIngestAt

    **api-clients/rate-limiter.ts**: Copy exactly from workers/enrichment/src/api-clients/rate-limiter.ts.

    **Stage stub files**: Create 4 stub files that export functions matching StageFn signature:
    - `stages/01-discover.ts`: Export `discoverTransparencyPages` — logs "Stage discover: not yet implemented", returns { processed: 0, errors: 0, done: true }
    - `stages/02-extract-links.ts`: Export `extractCsvLinks` — same stub pattern
    - `stages/03-download-parse.ts`: Export `downloadAndParseCsvs` — same stub pattern
    - `stages/04-aggregate.ts`: Export `aggregateSpendData` — same stub pattern

    **spend-engine.ts**: Follow workers/enrichment/src/enrichment-engine.ts pattern exactly:
    - Import STAGE_ORDER from types
    - Import stage functions from their files: discoverTransparencyPages from "./stages/01-discover", extractCsvLinks from "./stages/02-extract-links", downloadAndParseCsvs from "./stages/03-download-parse", aggregateSpendData from "./stages/04-aggregate"
    - STAGE_FUNCTIONS record mapping stage names to imported functions (NOT inline placeholders — real imports from stage files)
    - processSpendPipeline(db, env, maxItemsPerRun = 200) function: find first incomplete stage via getOrCreateJob loop, execute stage function, mark complete on done, mark error on throw
    - findCurrentStage helper

    This pattern means Plans 02 and 03 only need to modify the stage files, NOT spend-engine.ts, enabling parallel execution.

    **index.ts**: Follow workers/enrichment/src/index.ts pattern:
    - runPipeline(env, maxItems) helper
    - fetch handler: /run (manual trigger with ?max= param), /health (status JSON), /debug (collection stats)
    - scheduled handler: calls runPipeline
    - Export as `satisfies ExportedHandler<Env>`
  </action>
  <verify>Run `cd workers/spend-ingest && npm install && npx tsc --noEmit` to confirm the Worker project compiles.</verify>
  <done>Worker project initializes, compiles, has all 4 placeholder stages, pipeline engine runs through stages in order, and /health endpoint responds. All DB helper functions are typed and follow enrichment Worker patterns.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in project root (models compile)
2. `cd workers/spend-ingest && npm install && npx tsc --noEmit` passes (Worker compiles)
3. SpendTransaction model has all required fields and 3 compound indexes
4. SpendSummary model has unique buyerId constraint and all aggregate fields
5. spend-engine.ts has STAGE_FUNCTIONS record with all 4 stages
6. spend-jobs.ts has getOrCreateJob, updateJobProgress, markJobComplete, markJobError
</verification>

<success_criteria>
Both Mongoose models exist and compile. The spend-ingest Worker project compiles, has a working pipeline engine with 4 placeholder stages, and follows the exact patterns from the enrichment Worker (types, engine, DB ops, rate limiter).
</success_criteria>

<output>
After completion, create `.planning/phases/11-invoice-spend-data-intelligence/11-01-SUMMARY.md`
</output>
