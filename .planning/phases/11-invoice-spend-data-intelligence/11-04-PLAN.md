---
phase: 11-invoice-spend-data-intelligence
plan: 04
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/app/api/buyers/[id]/spending/route.ts
  - src/lib/spend-analytics.ts
  - src/components/buyers/spending-tab.tsx
  - src/components/buyers/spending-hero.tsx
  - src/components/buyers/spend-categories-chart.tsx
  - src/components/buyers/spend-timeline-chart.tsx
  - src/components/ui/chart.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Recharts 3.x and shadcn/ui chart component are installed and working"
    - "API route GET /api/buyers/[id]/spending returns spend summary + opportunity insights for a buyer"
    - "SpendTimelineChart renders a line chart of monthly spend over time with GBP formatting"
    - "SpendCategoriesChart renders a horizontal bar chart of top spend categories"
    - "SpendingHero shows profile match score and key spend metrics at the top of the tab"
    - "SpendingTab shell component orchestrates the charts, hero, and loading states"
    - "Charts are interactive with hover tooltips"
  artifacts:
    - path: "src/app/api/buyers/[id]/spending/route.ts"
      provides: "API endpoint for spend data + analytics"
      exports: ["GET"]
    - path: "src/lib/spend-analytics.ts"
      provides: "On-the-fly opportunity computation functions"
      contains: "computeSpendOpportunities"
    - path: "src/components/buyers/spending-tab.tsx"
      provides: "Main spending tab container component"
      contains: "SpendingTab"
    - path: "src/components/buyers/spend-categories-chart.tsx"
      provides: "Bar chart of top spend categories"
      contains: "SpendCategoriesChart"
    - path: "src/components/buyers/spend-timeline-chart.tsx"
      provides: "Line chart of spend over time"
      contains: "SpendTimelineChart"
    - path: "src/components/buyers/spending-hero.tsx"
      provides: "Profile match hero section"
      contains: "SpendingHero"
  key_links:
    - from: "src/components/buyers/spending-tab.tsx"
      to: "/api/buyers/[id]/spending"
      via: "fetch in useEffect on mount"
      pattern: "fetch.*api/buyers.*spending"
    - from: "src/app/api/buyers/[id]/spending/route.ts"
      to: "src/lib/spend-analytics.ts"
      via: "computeSpendOpportunities call"
      pattern: "computeSpendOpportunities"
    - from: "src/app/api/buyers/[id]/spending/route.ts"
      to: "src/models/spend-summary.ts"
      via: "SpendSummary.findOne query"
      pattern: "SpendSummary.findOne"
---

<objective>
Install Recharts and shadcn/ui chart components, create the Spending tab API route with on-the-fly opportunity computation, and build the chart components (categories bar chart, timeline line chart) plus the hero section.

Purpose: This delivers the visual spend intelligence layer -- the charts and metrics that make spend data actionable. The API route computes profile matches and opportunity insights on-the-fly when a user views a buyer's Spending tab.

Output: Working API endpoint returning spend data + opportunities, two interactive chart components, a hero section with profile match, and the spending tab shell.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-invoice-spend-data-intelligence/11-01-SUMMARY.md
@.planning/phases/11-invoice-spend-data-intelligence/11-RESEARCH.md
@src/components/buyers/buyer-tabs.tsx
@src/components/buyers/buyer-detail-client.tsx
@src/lib/buyers.ts
@src/app/api/buyers/[id]/spending/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts, create chart component, build spending API route with analytics engine</name>
  <files>
    package.json
    src/components/ui/chart.tsx
    src/app/api/buyers/[id]/spending/route.ts
    src/lib/spend-analytics.ts
  </files>
  <action>
    **Install dependencies:**
    1. Run `npm install recharts` in project root
    2. Run `npx shadcn@latest add chart` to add the shadcn/ui chart wrapper component (creates src/components/ui/chart.tsx with ChartContainer, ChartTooltip, ChartTooltipContent, ChartLegend, ChartLegendContent)

    **spend-analytics.ts** — On-the-fly opportunity computation:

    Export `computeSpendOpportunities(summary: ISpendSummary, userProfile: ICompanyProfile | null)`:
    Returns an object with all four opportunity types:

    1. **profileMatch**: Compare user's company sectors/capabilities against buyer's top spend categories. For each user sector, check if any spend category matches (case-insensitive substring/keyword). Calculate: matchedCategories, totalMatchedSpend, matchPercentage (matched spend / total spend * 100). Return null if no user profile.

    2. **recurringPatterns**: Analyze monthlyTotals for repeating vendor+category combinations. Look for vendors appearing in 3+ consecutive months in the same category. Return array of { vendor, category, frequency: "monthly"|"quarterly", averageAmount }. Do NOT predict timing (per user decision).

    3. **vendorConcentration**: From vendorBreakdown, check if top 1-3 vendors account for >60% of total spend in any category. Return array of { category, topVendor, concentrationPercent, totalCategorySpend }. This signals diversification opportunity.

    4. **spendGrowthSignals**: Compare most recent 12 months of categoryBreakdown totals against prior 12 months. Flag categories with >20% YoY growth. Return array of { category, currentYearSpend, priorYearSpend, growthPercent }.

    Export helper: `computeSpendMetrics(summary: ISpendSummary)`:
    Returns { totalSpend, avgMonthlySpend, topCategory, topVendor, transactionCount, dateRange, uniqueVendors, uniqueCategories }.

    **API route** — `src/app/api/buyers/[id]/spending/route.ts`:

    GET handler:
    1. `await auth()` — verify authenticated
    2. Parse buyerId from params, validate with mongoose.isValidObjectId
    3. `await dbConnect()`
    4. Parallel fetch: SpendSummary.findOne({ buyerId }), CompanyProfile.findOne({ userId })
    5. If no SpendSummary, return { hasSpendData: false } with 200
    6. Call computeSpendOpportunities(summary, userProfile)
    7. Call computeSpendMetrics(summary)
    8. Return JSON: { hasSpendData: true, summary (serialized), metrics, opportunities }

    Serialize dates in summary to ISO strings. Serialize ObjectIds to strings.
  </action>
  <verify>Run `npx tsc --noEmit` to verify compilation. Verify recharts is in package.json dependencies. Verify src/components/ui/chart.tsx exists after shadcn add.</verify>
  <done>Recharts installed, shadcn chart component added, spend analytics engine computes all 4 opportunity types, API route returns spend data + metrics + opportunities for authenticated users.</done>
</task>

<task type="auto">
  <name>Task 2: Build chart components and spending tab shell</name>
  <files>
    src/components/buyers/spend-categories-chart.tsx
    src/components/buyers/spend-timeline-chart.tsx
    src/components/buyers/spending-hero.tsx
    src/components/buyers/spending-tab.tsx
  </files>
  <action>
    **spend-categories-chart.tsx** — "use client":
    - Props: `data: Array<{ category: string; total: number; count: number }>`
    - Horizontal BarChart using Recharts + ChartContainer from shadcn/ui
    - chartConfig with single "total" series using `var(--chart-1)` color
    - XAxis shows category names (truncated to 20 chars), YAxis shows GBP amounts formatted with Intl.NumberFormat("en-GB", { style: "currency", currency: "GBP", notation: "compact" })
    - ChartTooltip with ChartTooltipContent showing exact amount and transaction count
    - Show top 10 categories max (prop data assumed pre-sorted by total desc)
    - Bar onClick callback prop: `onCategoryClick?: (category: string) => void` for filtering the breakdown table (wired in Plan 05)
    - min-h-[350px] container, responsive
    - Card wrapper with CardHeader "Top Spend Categories" and CardContent containing the chart

    **spend-timeline-chart.tsx** — "use client":
    - Props: `data: Array<{ year: number; month: number; total: number }>`
    - Transform data: map to `{ month: "YYYY-MM", total: number }` format for X axis labels
    - LineChart using Recharts + ChartContainer
    - chartConfig with "total" series using `var(--chart-2)` color
    - XAxis shows month labels (format: "MMM YY"), YAxis shows GBP compact
    - ChartTooltip showing exact monthly total
    - Line with type="monotone", strokeWidth 2, dot false (too many points)
    - CartesianGrid with strokeDasharray="3 3"
    - Card wrapper with CardHeader "Spend Over Time" and CardContent
    - min-h-[300px] container

    **spending-hero.tsx** — "use client":
    - Props: `metrics: SpendMetrics, profileMatch: ProfileMatch | null`
    - Layout: Full-width card with gradient background (subtle blue-to-transparent)
    - Left section: Key metrics in a grid (4 items):
      - Total Spend (GBP formatted, large text)
      - Avg Monthly Spend (GBP formatted)
      - Unique Vendors (count)
      - Date Range ("MMM YYYY - MMM YYYY")
    - Right section (only if profileMatch is not null):
      - "Profile Match" card with colored left border (blue)
      - Large percentage number (matchPercentage)
      - Text: "GBP X spent in your sectors"
      - List of matched categories (max 3, with "and N more" overflow)
    - If no profileMatch, right section shows "Complete your company profile to see spend match" with link to /settings

    **spending-tab.tsx** — "use client":
    - Props: `buyerId: string, buyerName: string`
    - State: `spendData` (null | API response), `loading` (boolean), `error` (string | null)
    - useEffect on mount: fetch `/api/buyers/${buyerId}/spending`, set state
    - Loading state: Skeleton loaders matching chart shapes (rect skeletons for charts, metric cards)
    - No data state: Card with message "No spending data available for {buyerName}. Spend data is sourced from UK transparency reports and may not be available for all organisations." with info icon.
    - Data state: SpendingHero at top, then two-column grid (lg) with SpendCategoriesChart and SpendTimelineChart side by side
    - Below charts: placeholder div for vendors table and breakdown table (Plan 05 adds these)
    - Export SpendingTab component
  </action>
  <verify>Run `npx tsc --noEmit` to verify all components compile. Check that chart components import from "@/components/ui/chart" (shadcn wrapper).</verify>
  <done>Four components created: SpendingHero (metrics + profile match), SpendCategoriesChart (horizontal bar), SpendTimelineChart (line), SpendingTab (orchestrator with fetch, loading states, empty state). All use shadcn Card wrappers and Recharts via shadcn chart component. Interactive tooltips on charts.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `recharts` in package.json dependencies
3. `src/components/ui/chart.tsx` exists (from shadcn add)
4. API route authenticates, fetches SpendSummary, computes opportunities, returns JSON
5. SpendCategoriesChart renders top 10 categories as horizontal bars
6. SpendTimelineChart renders monthly line chart
7. SpendingHero shows 4 key metrics + optional profile match
8. SpendingTab fetches data, handles loading/empty/data states
</verification>

<success_criteria>
Complete chart layer: Recharts installed, API returns spend data + 4 opportunity types, two interactive charts render with GBP formatting and tooltips, hero shows metrics and profile match, tab shell orchestrates everything with proper loading and empty states.
</success_criteria>

<output>
After completion, create `.planning/phases/11-invoice-spend-data-intelligence/11-04-SUMMARY.md`
</output>
