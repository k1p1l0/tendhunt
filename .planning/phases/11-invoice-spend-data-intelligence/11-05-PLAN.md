---
phase: 11-invoice-spend-data-intelligence
plan: 05
type: execute
wave: 3
depends_on: ["11-04"]
files_modified:
  - src/components/buyers/spend-vendors-table.tsx
  - src/components/buyers/spend-breakdown-table.tsx
  - src/components/buyers/spend-filters.tsx
  - src/components/buyers/spend-opportunities.tsx
  - src/components/buyers/spending-tab.tsx
  - src/components/buyers/buyer-tabs.tsx
  - src/components/buyers/buyer-detail-client.tsx
  - src/app/(dashboard)/buyers/[id]/page.tsx
  - src/app/api/buyers/[id]/spending/transactions/route.ts
autonomous: true

must_haves:
  truths:
    - "Top vendors table shows vendor name, total spend, transaction count, and percentage of total"
    - "Spend breakdown table shows individual transactions with date, vendor, amount, category, department, filterable and paginated"
    - "Filter chips let users filter by category, amount range, date range, and vendor"
    - "Opportunity cards display all four types: recurring spend, category match, vendor concentration, spend growth"
    - "Spending tab is added to buyer-tabs.tsx as a new tab with transaction count badge"
    - "Buyer detail page passes spend data availability flag to enable/disable the tab"
    - "Clicking a chart category filters the breakdown table below"
  artifacts:
    - path: "src/components/buyers/spend-vendors-table.tsx"
      provides: "Top vendors ranked table"
      contains: "SpendVendorsTable"
    - path: "src/components/buyers/spend-breakdown-table.tsx"
      provides: "Filterable transaction table with pagination"
      contains: "SpendBreakdownTable"
    - path: "src/components/buyers/spend-filters.tsx"
      provides: "Filter chips for spend data"
      contains: "SpendFilters"
    - path: "src/components/buyers/spend-opportunities.tsx"
      provides: "Opportunity cards for all 4 types"
      contains: "SpendOpportunities"
    - path: "src/app/api/buyers/[id]/spending/transactions/route.ts"
      provides: "Paginated transaction endpoint"
      exports: ["GET"]
  key_links:
    - from: "src/components/buyers/buyer-tabs.tsx"
      to: "src/components/buyers/spending-tab.tsx"
      via: "SpendingTab component in new Spending TabsContent"
      pattern: "SpendingTab"
    - from: "src/components/buyers/spend-breakdown-table.tsx"
      to: "/api/buyers/[id]/spending/transactions"
      via: "fetch with filter query params"
      pattern: "fetch.*transactions"
    - from: "src/components/buyers/spending-tab.tsx"
      to: "src/components/buyers/spend-opportunities.tsx"
      via: "SpendOpportunities receives computed opportunities"
      pattern: "SpendOpportunities"
---

<objective>
Build the remaining spend tab UI components (vendors table, breakdown table, filters, opportunity cards) and wire the complete Spending tab into the buyer profile page.

Purpose: Completes the spend intelligence UI by adding the data tables, filter controls, and opportunity cards, then integrating everything into the existing buyer profile tab system. After this plan, users can see complete spend intelligence for any buyer with available data.

Output: Four new UI components (vendors table, breakdown table, filters, opportunity cards), a transactions API endpoint, and full integration into buyer-tabs.tsx and the buyer detail page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-invoice-spend-data-intelligence/11-04-SUMMARY.md
@src/components/buyers/buyer-tabs.tsx
@src/components/buyers/buyer-detail-client.tsx
@src/app/(dashboard)/buyers/[id]/page.tsx
@src/components/buyers/buyer-filters.tsx
@src/components/buyers/spending-tab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vendors table, breakdown table with pagination, filters, and transactions API</name>
  <files>
    src/components/buyers/spend-vendors-table.tsx
    src/components/buyers/spend-breakdown-table.tsx
    src/components/buyers/spend-filters.tsx
    src/app/api/buyers/[id]/spending/transactions/route.ts
  </files>
  <action>
    **Transactions API — route.ts**:
    GET handler at `/api/buyers/[id]/spending/transactions`:
    1. Auth check with `await auth()`
    2. Parse buyerId from params, validate ObjectId
    3. Parse query params: page (default 1), pageSize (default 50), category (optional), vendor (optional), dateFrom (optional ISO), dateTo (optional ISO), amountMin (optional number), amountMax (optional number), sort (default "date"), order (default "desc")
    4. Build MongoDB query: { buyerId } + optional filters ($regex for vendor, exact match for category, $gte/$lte for date and amount ranges)
    5. Parallel: SpendTransaction.find(query).sort().skip().limit().lean(), SpendTransaction.countDocuments(query)
    6. Return: { transactions (serialized), total, page, pageSize }

    **spend-filters.tsx** — "use client":
    - Props: `categories: string[], vendors: string[], filters: SpendFilterState, onChange: (filters: SpendFilterState) => void`
    - SpendFilterState: { category?: string; vendor?: string; dateFrom?: string; dateTo?: string; amountMin?: number; amountMax?: number; }
    - Layout: horizontal flex-wrap row of filter controls, similar pattern to `src/components/buyers/buyer-filters.tsx`
    - Filter controls:
      - Category: Select dropdown populated from categories prop (top 20)
      - Vendor: Select dropdown populated from vendors prop (top 30)
      - Date range: Two Input[type="date"] fields (From / To)
      - Amount range: Two Input[type="number"] fields (Min GBP / Max GBP)
      - Clear All button: resets all filters
    - Each filter change calls onChange immediately
    - Active filters shown as Badge chips below the controls, each with X to remove

    **spend-vendors-table.tsx** — "use client":
    - Props: `data: Array<{ vendor: string; total: number; count: number }>, totalSpend: number`
    - shadcn Table component showing top 20 vendors
    - Columns: Rank (#), Vendor Name, Total Spend (GBP formatted), Transactions (count), Share (% of total spend as progress bar + percentage text)
    - Sort by total desc (data assumed pre-sorted)
    - Card wrapper with CardHeader "Top Vendors" and CardContent
    - Row hover effect for interactivity

    **spend-breakdown-table.tsx** — "use client":
    - Props: `buyerId: string, initialCategory?: string` (initialCategory set when user clicks a chart category)
    - State: transactions array, loading, total, page, filters (SpendFilterState)
    - Fetches from `/api/buyers/${buyerId}/spending/transactions?${params}` on mount and when filters/page change
    - SpendFilters component above the table
    - shadcn Table with columns: Date (formatted DD MMM YYYY), Vendor, Amount (GBP, colored red if negative), Category (Badge), Department, Reference
    - Pagination: Previous/Next buttons with "Showing X-Y of Z" text
    - Loading: Skeleton rows
    - Empty: "No transactions match your filters" message
    - If initialCategory prop changes, update filters.category and refetch
    - Card wrapper with CardHeader "Transaction Breakdown" and CardContent
  </action>
  <verify>Run `npx tsc --noEmit` to confirm compilation. Verify API route returns paginated results with filter params.</verify>
  <done>Transactions API endpoint with filtering and pagination. SpendFilters component with category, vendor, date range, amount range controls. SpendVendorsTable showing ranked vendors with share percentages. SpendBreakdownTable with server-side pagination, all filters wired, and loading/empty states.</done>
</task>

<task type="auto">
  <name>Task 2: Create opportunity cards and integrate Spending tab into buyer profile</name>
  <files>
    src/components/buyers/spend-opportunities.tsx
    src/components/buyers/spending-tab.tsx
    src/components/buyers/buyer-tabs.tsx
    src/components/buyers/buyer-detail-client.tsx
    src/app/(dashboard)/buyers/[id]/page.tsx
  </files>
  <action>
    **spend-opportunities.tsx** — "use client":
    - Props: `opportunities: { profileMatch, recurringPatterns, vendorConcentration, spendGrowthSignals }`
    - Layout: Grid of Card components, one per opportunity type that has data
    - Each card has a colored left border (4px) indicating type:
      - Profile Match: blue border (`border-l-blue-500`), shows match percentage as large number, "GBP X spent in your sectors" subtitle, top 3 matched categories as Badges
      - Recurring Spend: green border (`border-l-green-500`), shows count of patterns found, list of top 3 patterns with vendor name, category, frequency, average amount
      - Vendor Concentration: amber border (`border-l-amber-500`), shows count of concentrated categories, list of top 3 with category, dominant vendor, concentration percentage
      - Spend Growth: purple border (`border-l-purple-500`), shows count of growing categories, list of top 3 with category name, growth percentage, direction arrow icon
    - Cards only rendered if their data array is non-empty (or profileMatch is non-null)
    - If all opportunity arrays are empty, show a subtle "No opportunity insights available yet" message
    - Each card uses shadcn Card with CardHeader (icon + title) and CardContent (metrics + list)

    **Update spending-tab.tsx**:
    - Add state for `selectedCategory` (string | null) — set when user clicks a bar in SpendCategoriesChart
    - Wire SpendCategoriesChart onCategoryClick to set selectedCategory
    - Below the two-column chart grid, add:
      - SpendOpportunities component, passing opportunities from API response
      - Two-column grid (lg): SpendVendorsTable on left, SpendBreakdownTable on right (full width on mobile)
    - Pass selectedCategory as initialCategory to SpendBreakdownTable
    - Layout order top-to-bottom: SpendingHero -> Charts (2-col) -> Opportunities -> Vendors + Breakdown (2-col)

    **Update buyer-tabs.tsx**:
    - Import SpendingTab from "./spending-tab"
    - Add a new "Spending" TabsTrigger between "Buying Signals" and "Board Documents"
    - Badge count: show totalTransactions from spend data (pass as prop), or empty if no spend data
    - Add TabsContent for "spending" value containing `<SpendingTab buyerId={buyerId} buyerName={buyerName} />`
    - Update BuyerTabsProps interface to include: `hasSpendData?: boolean, spendTransactionCount?: number`

    **Update buyer-detail-client.tsx**:
    - Add `hasSpendData` and `spendTransactionCount` to the buyer prop interface
    - Pass these through to BuyerTabs

    **Update page.tsx** (buyers/[id]/page.tsx):
    - After existing parallel fetches, also check if SpendSummary exists for this buyer: `SpendSummary.findOne({ buyerId: buyer._id }).lean()`
    - Pass `hasSpendData: !!spendSummary` and `spendTransactionCount: spendSummary?.totalTransactions ?? 0` to BuyerDetailClient
    - Import SpendSummary model at top
  </action>
  <verify>Run `npx tsc --noEmit` to confirm everything compiles. Verify buyer-tabs.tsx has 7 tabs total (Contracts, Key Contacts, Buying Signals, Spending, Board Documents, Key Personnel, Buyer Attributes). Verify the Spending tab only shows SpendingTab component which fetches its own data client-side.</verify>
  <done>Opportunity cards render all 4 insight types with colored borders and metrics. Spending tab fully integrated into buyer profile with chart->table click-through. Buyer tabs show Spending tab with transaction count. Buyer detail page checks for spend data availability. Complete spend intelligence UI is functional end-to-end.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. buyer-tabs.tsx has 7 tabs including "Spending" tab
3. Transactions API supports all filter params (category, vendor, date range, amount range)
4. SpendBreakdownTable paginates and filters correctly
5. SpendVendorsTable shows top 20 vendors with share percentages
6. SpendOpportunities renders 4 card types with correct border colors
7. Clicking a category in the bar chart updates the breakdown table filter
8. Buyer detail page.tsx imports SpendSummary and passes hasSpendData prop
9. SpendingTab layout: Hero -> Charts -> Opportunities -> Tables
</verification>

<success_criteria>
Complete Spending tab with all four views (categories chart, timeline chart, top vendors table, transaction breakdown table), interactive filters, opportunity cards, profile match hero, and full integration into the buyer profile page. Users can view spend intelligence for any buyer with available data, filter transactions, and see opportunity insights.
</success_criteria>

<output>
After completion, create `.planning/phases/11-invoice-spend-data-intelligence/11-05-SUMMARY.md`
</output>
