---
phase: 15-buyer-dedup-linkedin-data-detail-page
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/lib/contracts.ts
  - src/lib/buyers.ts
  - src/app/(dashboard)/contracts/[id]/page.tsx
  - src/app/(dashboard)/contracts/page.tsx
  - src/components/contracts/contract-card.tsx
  - src/components/contracts/contract-filters.tsx
  - src/components/buyers/buyer-filters.tsx
  - src/components/buyers/buyer-header.tsx
autonomous: true

must_haves:
  truths:
    - "Contract detail page shows buyer card with logo, org type, enrichment score, and link to buyer profile"
    - "Contract detail page region displays human-readable name instead of raw NUTS code"
    - "Contract cards on contracts list page link buyer name to /buyers/{buyerId} when buyerId exists"
    - "Contract filter region dropdown shows human-readable names (not raw codes)"
    - "Buyer filter region dropdown shows human-readable names (not raw codes)"
    - "Buyer header region displays human-readable name (not raw code)"
    - "Buyer detail page fetches contracts by buyerId instead of buyerName string match"
    - "fetchContractById returns buyer data alongside contract data"
  artifacts:
    - path: "src/lib/contracts.ts"
      provides: "fetchContractById enhanced with buyer data join via buyerId/nameLower fallback"
      exports: ["fetchContractById", "fetchContracts"]
    - path: "src/lib/buyers.ts"
      provides: "fetchBuyerById using buyerId for contract query instead of buyerName"
      exports: ["fetchBuyerById", "fetchBuyers"]
    - path: "src/app/(dashboard)/contracts/[id]/page.tsx"
      provides: "Contract detail page with buyer intelligence section and humanized region"
    - path: "src/components/contracts/contract-filters.tsx"
      provides: "Region dropdown with human-readable names from NUTS_REGIONS"
    - path: "src/components/buyers/buyer-filters.tsx"
      provides: "Region dropdown with human-readable names via resolveRegionName"
    - path: "src/components/buyers/buyer-header.tsx"
      provides: "Buyer header with humanized region display"
  key_links:
    - from: "src/lib/contracts.ts"
      to: "src/models/buyer.ts"
      via: "Buyer.findById(contract.buyerId) in fetchContractById"
      pattern: "Buyer\\.findById"
    - from: "src/app/(dashboard)/contracts/[id]/page.tsx"
      to: "src/lib/nuts-regions.ts"
      via: "resolveRegionName for region display"
      pattern: "resolveRegionName"
    - from: "src/lib/buyers.ts"
      to: "src/models/contract.ts"
      via: "Contract.find({ buyerId }) instead of Contract.find({ buyerName })"
      pattern: "buyerId.*buyer\\._id"
    - from: "src/components/contracts/contract-filters.tsx"
      to: "src/lib/nuts-regions.ts"
      via: "import NUTS_REGIONS for region dropdown labels"
      pattern: "NUTS_REGIONS"
    - from: "src/app/(dashboard)/contracts/page.tsx"
      to: "src/components/contracts/contract-card.tsx"
      via: "passes buyerId prop from contract data to ContractCard"
      pattern: "buyerId"
---

<objective>
Integrate buyerId and NUTS region humanization into all display layers: enhance fetchContractById to join buyer data, add buyer intelligence section to contract detail page, humanize region codes across all filter dropdowns and display points, switch buyer detail contract queries from buyerName to buyerId.

Purpose: Completes the user-facing experience -- contracts link to buyer profiles, region codes show human-readable names, and the contract detail page becomes a gateway to buyer intelligence.

Output: Enhanced contract detail page with buyer card, humanized regions across all UI, buyerId-based contract queries on buyer detail page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-buyer-dedup-linkedin-data-detail-page/15-RESEARCH.md
@.planning/phases/15-buyer-dedup-linkedin-data-detail-page/15-01-SUMMARY.md
@src/lib/nuts-regions.ts
@src/models/contract.ts
@src/models/buyer.ts
@src/lib/contracts.ts
@src/lib/buyers.ts
@src/app/(dashboard)/contracts/[id]/page.tsx
@src/app/(dashboard)/contracts/page.tsx
@src/components/contracts/contract-card.tsx
@src/components/contracts/contract-filters.tsx
@src/components/buyers/buyer-filters.tsx
@src/components/buyers/buyer-header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Data layer enhancements -- fetchContractById buyer join + fetchBuyerById buyerId query + contracts page buyerId passthrough</name>
  <files>src/lib/contracts.ts, src/lib/buyers.ts, src/app/(dashboard)/contracts/page.tsx</files>
  <action>
1. Modify `src/lib/contracts.ts` -- enhance `fetchContractById` to return buyer data:
   - Import Buyer model: `import Buyer from "@/models/buyer";`
   - After fetching the contract, resolve the buyer:
     ```
     let buyer = null;
     if (contract.buyerId) {
       buyer = await Buyer.findById(contract.buyerId)
         .select("name sector region orgType website logoUrl enrichmentScore linkedinUrl contractCount description")
         .lean();
     }
     // Fallback to name match for contracts without buyerId (pre-backfill)
     if (!buyer && contract.buyerName) {
       buyer = await Buyer.findOne({ nameLower: contract.buyerName.toLowerCase().trim() })
         .select("name sector region orgType website logoUrl enrichmentScore linkedinUrl contractCount description")
         .lean();
     }
     ```
   - Return contract with buyer: `return { ...contract, buyer }`
   - The buyer object is returned alongside contract data for the detail page to render

2. Modify `src/lib/buyers.ts` -- switch `fetchBuyerById` contract query from buyerName to buyerId:
   - In the contracts query inside `fetchBuyerById`, change:
     - From: `Contract.find({ buyerName: buyer.name })`
     - To: `Contract.find({ buyerId: buyer._id })`
   - Keep the same sort/limit/select as before
   - This is more robust (no case sensitivity issues) and uses the new index on buyerId

3. Modify `src/app/(dashboard)/contracts/page.tsx` -- pass buyerId to ContractCard:
   - In the `ContractFeed` component where `ContractCard` is rendered, add `buyerId` to the contract prop:
     ```
     buyerId: contract.buyerId ? String(contract.buyerId) : undefined,
     ```
   - This enables the existing buyerId-aware link in ContractCard (which already checks `contract.buyerId` and renders a Link to `/buyers/{buyerId}` when present)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `fetchContractById` returns object with `buyer` property
    - `fetchBuyerById` queries contracts by `buyerId` not `buyerName`
    - ContractsPage passes `buyerId` to ContractCard
  </verify>
  <done>
    - fetchContractById joins buyer data via buyerId (with nameLower fallback)
    - fetchBuyerById queries contracts by buyerId ObjectId (not buyerName string)
    - Contracts list page passes buyerId to ContractCard enabling buyer profile links
  </done>
</task>

<task type="auto">
  <name>Task 2: Region humanization across all display points + contract detail buyer section</name>
  <files>src/app/(dashboard)/contracts/[id]/page.tsx, src/components/contracts/contract-card.tsx, src/components/contracts/contract-filters.tsx, src/components/buyers/buyer-filters.tsx, src/components/buyers/buyer-header.tsx</files>
  <action>
1. Modify `src/app/(dashboard)/contracts/[id]/page.tsx` -- add buyer intelligence section + humanize region:
   - Import `resolveRegionName` from `@/lib/nuts-regions`
   - Import `Link` (already imported) and additional icons: `Users`, `Globe` from lucide-react
   - The `fetchContractById` now returns `contract.buyer` (from Task 1). Type the contract appropriately.
   - Replace the plain text region display (line ~148-151) with `resolveRegionName(contract.buyerRegion)`
   - Add a "Buyer Intelligence" card section ABOVE the existing "Details grid" (between the header and the grid):
     - Only render when `contract.buyer` exists
     - Use a Card with CardHeader + CardContent following the existing buyer-header.tsx design patterns:
       - Left: Logo (img if buyer.logoUrl, else initial-circle with Building2 icon fallback, similar to buyer-header.tsx)
       - Center: Buyer name as a Link to `/buyers/${contract.buyer._id}` with hover:underline, org type Badge, humanized region (using resolveRegionName on contract.buyerRegion), contract count
       - Right: EnrichmentBadge if buyer.enrichmentScore exists (import from `@/components/buyers/enrichment-badge`)
     - Below the header row: a flex row with website link (show domain only), LinkedIn link, and "View full profile" link aligned right
     - Keep it compact -- this is a summary card, not the full buyer header
   - When `contract.buyer` does NOT exist, keep the existing plain-text buyer name display in the contract info card (the Building2 icon section)
   - In the existing buyer name section (Building2 icon, line ~131-142), when buyer exists, make the buyer name a Link to the buyer profile instead of plain text

2. Modify `src/components/contracts/contract-filters.tsx` -- humanize region dropdown:
   - Import `resolveRegionName` from `@/lib/nuts-regions`
   - Replace the hardcoded `REGIONS` constant with the existing constant BUT use `resolveRegionName` for display. Actually, keep the REGIONS constant as-is since it already maps codes to human names and drives the filter values. The contract filter uses NUTS Level 1 codes which the REGIONS constant already handles correctly.
   - ACTUALLY -- the REGIONS constant already has human-readable names. No change needed here. The region filter sends NUTS codes as values (for the regex query) but displays human names. This is already correct. SKIP this file.

3. Modify `src/components/buyers/buyer-filters.tsx` -- humanize region dropdown:
   - Import `resolveRegionName` from `@/lib/nuts-regions`
   - The buyer filter region dropdown currently shows raw region values from `Buyer.distinct('region')` passed as the `regions` prop
   - In the region SelectItem, display `resolveRegionName(region)` instead of raw `region`:
     ```
     {regions.map((region) => (
       <SelectItem key={region} value={region}>
         {resolveRegionName(region)}
       </SelectItem>
     ))}
     ```
   - The value stays as the raw code (for MongoDB query matching), only the display label changes

4. Modify `src/components/buyers/buyer-header.tsx` -- humanize region:
   - Import `resolveRegionName` from `@/lib/nuts-regions`
   - Where `buyer.region` is displayed (line ~170-174), replace:
     ```
     {buyer.region}
     ```
     with:
     ```
     {resolveRegionName(buyer.region)}
     ```

5. Modify `src/components/contracts/contract-card.tsx` -- add buyerRegion humanization:
   - Import `resolveRegionName` from `@/lib/nuts-regions`
   - Add `buyerRegion?: string | null` to the `ContractCardData` interface
   - Display humanized region in the card metadata: after the published/deadline dates, add:
     ```
     {contract.buyerRegion && (
       <span>{resolveRegionName(contract.buyerRegion)}</span>
     )}
     ```
   - NOTE: The contracts page must also pass `buyerRegion` to ContractCard. In `src/app/(dashboard)/contracts/page.tsx`, add `buyerRegion: contract.buyerRegion` to the contract prop object.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds (Next.js build validates server/client boundaries)
    - Contract detail page renders buyer card with logo, name link, org type, enrichment score when buyer exists
    - Contract detail page shows "Glasgow City" not "UKM82" for region
    - Buyer filter dropdown shows "London" not "UKI" for region values
    - Buyer header shows "Greater Manchester" not "UKD3" for region
  </verify>
  <done>
    - Contract detail page has a buyer intelligence section with logo, linked name, org type badge, enrichment score, website link, LinkedIn link, and "View full profile" link
    - Region codes are humanized everywhere: contract detail, contract cards, buyer filters, buyer header
    - All NUTS codes (level 0-3) resolve to human-readable names via hierarchical fallback
    - Contract card shows buyerRegion as human-readable text
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Next.js builds: `npm run build`
3. Contract detail page: buyer section visible with logo/name/orgType/enrichmentScore/links
4. Contract detail page: region shows "Glasgow City" / "Greater Manchester" / "London" (not UKM82 / UKD3 / UKI)
5. Contract cards: buyer name links to buyer profile when buyerId exists
6. Contract cards: region shown as human-readable text
7. Buyer filters: region dropdown shows human-readable names
8. Buyer header: region shows human-readable name
9. Buyer detail: contracts tab loads contracts by buyerId (not buyerName)
</verification>

<success_criteria>
- Contract detail page shows buyer intelligence card (with link to buyer profile) when buyer data exists
- All NUTS region codes display as human-readable names across the entire platform
- Contract cards link to buyer profiles via buyerId
- Buyer detail page uses buyerId for contract queries (robust, indexed)
- Next.js build passes (server/client boundaries correct)
</success_criteria>

<output>
After completion, create `.planning/phases/15-buyer-dedup-linkedin-data-detail-page/15-02-SUMMARY.md`
</output>
