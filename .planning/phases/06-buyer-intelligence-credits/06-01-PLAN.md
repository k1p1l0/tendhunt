---
phase: 06-buyer-intelligence-credits
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/buyer.ts
  - src/models/contact-reveal.ts
  - src/lib/buyers.ts
  - src/app/api/buyers/route.ts
  - src/app/api/buyers/[id]/route.ts
  - src/app/api/credits/route.ts
  - src/app/api/credits/history/route.ts
  - src/stores/credit-store.ts
  - src/components/credits/credit-balance.tsx
  - src/components/layout/app-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Credit balance is visible in the sidebar on every authenticated page"
    - "Buyers API returns list with sort, pagination, and per-user unlock status"
    - "Single buyer API returns profile with contracts, signals, and unlock status"
    - "Credit balance API returns current balance for authenticated user"
    - "Credit transaction history API returns paginated transactions"
  artifacts:
    - path: "src/models/contact-reveal.ts"
      provides: "Per-user buyer unlock tracking model"
      contains: "contactRevealSchema"
    - path: "src/lib/buyers.ts"
      provides: "Server-side buyer data fetching with filters and unlock status"
      exports: ["fetchBuyers", "fetchBuyerById"]
    - path: "src/stores/credit-store.ts"
      provides: "Zustand credit balance reactive store"
      exports: ["useCreditStore"]
    - path: "src/app/api/credits/route.ts"
      provides: "GET credit balance endpoint"
      exports: ["GET"]
    - path: "src/app/api/credits/history/route.ts"
      provides: "GET transaction history endpoint"
      exports: ["GET"]
    - path: "src/components/credits/credit-balance.tsx"
      provides: "Sidebar credit balance with animated counter and transaction popover"
  key_links:
    - from: "src/components/credits/credit-balance.tsx"
      to: "src/stores/credit-store.ts"
      via: "useCreditStore hook"
      pattern: "useCreditStore"
    - from: "src/components/credits/credit-balance.tsx"
      to: "/api/credits"
      via: "fetch on mount for initial balance"
      pattern: "fetch.*api/credits"
    - from: "src/components/layout/app-sidebar.tsx"
      to: "src/components/credits/credit-balance.tsx"
      via: "CreditBalance component in SidebarFooter"
      pattern: "CreditBalance"
    - from: "src/lib/buyers.ts"
      to: "src/models/contact-reveal.ts"
      via: "ContactReveal.find to get per-user unlock set"
      pattern: "ContactReveal\\.find"
---

<objective>
Backend foundation for buyer intelligence and credit system: ContactReveal model, enhanced buyer APIs (list with sort/pagination/unlock status, single buyer with contracts/signals), credit APIs (balance, transaction history), Zustand credit store, and sidebar credit balance display with animated counter and transaction popover.

Purpose: Establish all data access, APIs, and reactive state management that the buyer profile UI and contact reveal flow depend on.
Output: Working APIs, credit store, and always-visible sidebar credit balance.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-buyer-intelligence-credits/06-RESEARCH.md
@src/models/buyer.ts
@src/models/credit.ts
@src/models/signal.ts
@src/lib/contracts.ts
@src/lib/mongodb.ts
@src/stores/scanner-store.ts
@src/components/layout/app-sidebar.tsx
@src/app/(dashboard)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: ContactReveal model, buyer schema update, data access layer, and all API routes</name>
  <files>
    src/models/contact-reveal.ts
    src/models/buyer.ts
    src/lib/buyers.ts
    src/app/api/buyers/route.ts
    src/app/api/buyers/[id]/route.ts
    src/app/api/credits/route.ts
    src/app/api/credits/history/route.ts
  </files>
  <action>
    1. **Create ContactReveal model** at `src/models/contact-reveal.ts`:
       - Fields: `userId` (String, required, indexed), `buyerId` (ObjectId, ref "Buyer", required), `revealedAt` (Date, default Date.now)
       - Compound unique index: `{ userId: 1, buyerId: 1 }`
       - Use `timestamps: true`
       - Export type `IContactReveal` via InferSchemaType
       - Use `mongoose.models.ContactReveal || mongoose.model()` pattern

    2. **Update Buyer model** at `src/models/buyer.ts`:
       - Add `phone` field to the `contactSchema` subdocument: `phone: { type: String }` (between email and linkedIn)
       - This matches the Starbridge reference which shows phone + email on contact cards per locked decision
       - Do NOT change anything else -- keep the existing `isRevealed` field (it will be ignored in favor of ContactReveal)

    3. **Create `src/lib/buyers.ts`** data access layer (follow `src/lib/contracts.ts` pattern exactly):
       - `fetchBuyers(userId: string, filters: BuyerFilters)`: Returns paginated buyers list with per-user unlock status
         - BuyerFilters interface: `sort?: "name" | "contracts" | "sector" | "region"`, `order?: "asc" | "desc"`, `page?: number`, `pageSize?: number`
         - Parallel fetch: `Buyer.find()` with sort/skip/limit, `Buyer.estimatedDocumentCount()`, `ContactReveal.find({ userId }).select("buyerId").lean()`
         - Map buyers to include `contactCount` (contacts array length), `isUnlocked` (check Set of revealed buyerIds)
         - Use `Record<string, 1 | -1>` type for sort object (same as contracts.ts pattern)
         - Default sort: `name: 1`, default pageSize: 25
       - `fetchBuyerById(buyerId: string, userId: string)`: Returns single buyer profile with associated data
         - Validate with `mongoose.isValidObjectId()`
         - Parallel fetch: buyer document, `Contract.find({ buyerName: buyer.name }).sort({ publishedDate: -1 }).limit(20).select("-rawData").lean()`, `Signal.find({ organizationName: buyer.name }).sort({ sourceDate: -1 }).lean()`, `ContactReveal.findOne({ userId, buyerId })`
         - Return spread buyer + `contracts`, `signals`, `isUnlocked: !!reveal`

    4. **Enhance existing `src/app/api/buyers/route.ts`**:
       - Accept query params: `sort`, `order`, `page`, `pageSize`
       - Call `fetchBuyers(userId, filters)` instead of inline Buyer.find()
       - Return `{ buyers, total }` (matching existing response shape but with `total` added and `isUnlocked` per buyer)

    5. **Create `src/app/api/buyers/[id]/route.ts`**:
       - GET handler: `auth()` check, `await params` for id (Next.js 16 pattern), call `fetchBuyerById(id, userId)`
       - Return 404 if null, otherwise return buyer object with contracts, signals, isUnlocked

    6. **Create `src/app/api/credits/route.ts`**:
       - GET handler: `auth()` check, `dbConnect()`, `CreditAccount.findOne({ userId }).lean()`
       - Return `{ balance: account?.balance ?? 0 }`

    7. **Create `src/app/api/credits/history/route.ts`**:
       - GET handler: `auth()` check, `dbConnect()`
       - Accept `page` and `pageSize` query params (default page=1, pageSize=10)
       - `CreditTransaction.find({ userId }).sort({ createdAt: -1 }).skip().limit().lean()`
       - Return `{ transactions, total }` (total from countDocuments)
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify the ContactReveal model compiles with correct compound index. Verify all API route files export the expected HTTP method handlers.
  </verify>
  <done>
    ContactReveal model exists with compound unique index on {userId, buyerId}. Buyer contact subdocument has phone field. lib/buyers.ts exports fetchBuyers and fetchBuyerById with per-user unlock status. All 4 API routes (buyers list, buyer detail, credit balance, credit history) return correct response shapes with auth protection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install shadcn components, Zustand credit store, and sidebar credit balance with popover</name>
  <files>
    src/components/ui/tabs.tsx
    src/components/ui/popover.tsx
    src/stores/credit-store.ts
    src/components/credits/credit-balance.tsx
    src/components/layout/app-sidebar.tsx
  </files>
  <action>
    1. **Install shadcn Tabs and Popover**:
       ```bash
       npx shadcn@latest add tabs popover --yes
       ```
       This creates `src/components/ui/tabs.tsx` and `src/components/ui/popover.tsx`.

    2. **Create Zustand credit store** at `src/stores/credit-store.ts`:
       - Follow `scanner-store.ts` pattern (import create from "zustand")
       - Interface CreditStore: `balance: number`, `isLoaded: boolean`, `isAnimating: boolean`
       - Actions: `setBalance(balance: number)` (sets balance + isLoaded=true), `deductCredit()` (decrements by 1, sets isAnimating=true), `setIsAnimating(animating: boolean)`
       - `deductCredit` uses `Math.max(0, state.balance - 1)` to prevent negative client-side

    3. **Create CreditBalance component** at `src/components/credits/credit-balance.tsx`:
       - Mark "use client"
       - Import and use `useCreditStore` for reactive balance
       - On mount, `fetch("/api/credits")` and call `setBalance(data.balance)` to hydrate
       - Layout per locked decision: sidebar bottom, always visible, not prominent
       - Main button: flex row with Sparkles icon (h-4 w-4 text-primary), "Credits" label, balance number on right side (`font-mono tabular-nums font-medium`)
       - **Animated counter**: When `isAnimating` is true, add `text-red-500 transition-colors duration-300` to the balance number. Use `useEffect` to reset `setIsAnimating(false)` after 600ms timeout.
       - **Popover** (triggered by clicking the credit balance button):
         - Fetch `/api/credits/history?pageSize=5` on open
         - Show recent 5 transactions: each row has type icon (Sparkles for SIGNUP_BONUS, Unlock for CONTACT_REVEAL), description, amount (+10 or -1 styled green/red), time ago
         - At bottom: "View all transactions" link (placeholder href="/settings" for now -- no dedicated page needed for hackathon)
         - Empty state: "No transactions yet"
       - No framer-motion per project decision -- CSS transitions only

    4. **Update `src/components/layout/app-sidebar.tsx`**:
       - Import CreditBalance component
       - Replace the `{/* Credit balance will be added here in Phase 6 */}` comment in SidebarFooter with `<CreditBalance />`
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify tabs.tsx and popover.tsx exist in components/ui/. Verify CreditBalance renders in AppSidebar SidebarFooter. Run `npm run build` to confirm the app builds without errors.
  </verify>
  <done>
    shadcn Tabs and Popover installed. Credit store provides reactive balance state. CreditBalance component shows credit count in sidebar footer with animated counter on deduction. Clicking balance opens popover with recent 5 transactions. AppSidebar renders CreditBalance in SidebarFooter.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm run build` completes successfully
- ContactReveal model file exists at src/models/contact-reveal.ts
- src/lib/buyers.ts exports fetchBuyers and fetchBuyerById
- All 4 API routes exist and export GET/POST handlers
- Credit store exports useCreditStore
- CreditBalance component renders in sidebar
- Tabs and Popover shadcn components installed
</verification>

<success_criteria>
1. ContactReveal model tracks per-user buyer unlocks with compound unique index
2. Buyer API returns list with sort, pagination, contactCount, and per-user isUnlocked
3. Buyer detail API returns buyer with contracts, signals, and isUnlocked
4. Credit balance API returns current balance
5. Credit history API returns paginated transactions
6. Credit store provides reactive balance updates across pages
7. Sidebar shows credit balance with animated counter and transaction popover
8. All new code compiles and builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-buyer-intelligence-credits/06-01-SUMMARY.md`
</output>
