---
phase: 20-board-minutes-signals
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/models/signal.ts
  - apps/web/src/models/board-document.ts
  - apps/web/src/lib/buyers.ts
  - apps/workers/enrichment/src/index.ts
  - apps/workers/enrichment/src/types.ts
  - apps/workers/enrichment/wrangler.toml
autonomous: true

must_haves:
  truths:
    - "Signal model has boardDocumentId, quote, and entities fields"
    - "BoardDocument model has signalExtractionStatus field"
    - "Enrichment worker chains to board-minutes worker after all_complete and after single-buyer enrichment"
    - "Buyer profile page queries signals by buyerId (not just organizationName)"
  artifacts:
    - path: "apps/web/src/models/signal.ts"
      provides: "Signal Mongoose schema with boardDocumentId, quote, entities"
      contains: "boardDocumentId"
    - path: "apps/web/src/models/board-document.ts"
      provides: "BoardDocument schema with signalExtractionStatus"
      contains: "signalExtractionStatus"
    - path: "apps/workers/enrichment/wrangler.toml"
      provides: "BOARD_MINUTES_WORKER_URL env var"
      contains: "BOARD_MINUTES_WORKER_URL"
  key_links:
    - from: "apps/workers/enrichment/src/index.ts"
      to: "board-minutes worker /run"
      via: "fetch(env.BOARD_MINUTES_WORKER_URL/run)"
      pattern: "BOARD_MINUTES_WORKER_URL"
    - from: "apps/web/src/lib/buyers.ts"
      to: "Signal.find"
      via: "buyerId query"
      pattern: "buyerId.*buyer\\._id"
---

<objective>
Extend the Signal and BoardDocument models with new fields needed by the board-minutes worker, update the enrichment worker to chain to the new worker, and fix signal queries to use buyerId instead of organizationName string matching.

Purpose: Prepare the data layer and worker chaining so the extraction stage (Plan 03) and frontend (Plan 04) have the right schema and data flow.
Output: Updated Mongoose models, enrichment worker chaining, fixed signal queries.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/src/models/signal.ts
@apps/web/src/models/board-document.ts
@apps/web/src/lib/buyers.ts
@apps/workers/enrichment/src/index.ts
@apps/workers/enrichment/src/types.ts
@apps/workers/enrichment/wrangler.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Signal and BoardDocument Mongoose models</name>
  <files>
    apps/web/src/models/signal.ts
    apps/web/src/models/board-document.ts
  </files>
  <action>
    **Signal model (`apps/web/src/models/signal.ts`):**
    Add three new fields to the signalSchema:
    - `boardDocumentId`: `{ type: Schema.Types.ObjectId, ref: "BoardDocument", index: true }` -- links signal to its source document
    - `quote`: `{ type: String }` -- verbatim quote from source text (max 200 chars, but schema doesn't enforce -- truncation happens at extraction time)
    - `entities`: subdocument with `{ companies: [String], amounts: [String], dates: [String], people: [String] }` -- no `_id` on subdoc (`_id: false`)

    Also add `buyerId` index if not already indexed (it has no `index: true` currently -- add it).

    **BoardDocument model (`apps/web/src/models/board-document.ts`):**
    Add one new field:
    - `signalExtractionStatus`: `{ type: String, enum: ["pending", "extracted", "failed"], default: "pending" }` -- tracks whether this document has been processed for signal extraction

    This is separate from the existing `extractionStatus` which tracks text content extraction. `signalExtractionStatus` tracks whether the board-minutes worker has processed it.
  </action>
  <verify>
    Run `cd apps/web && pnpm typecheck` to verify models compile. Check that the schema fields are present in the file.
  </verify>
  <done>
    Signal model has boardDocumentId (indexed ObjectId), quote (String), and entities (subdocument with companies/amounts/dates/people arrays). BoardDocument model has signalExtractionStatus field with pending/extracted/failed enum. Both models type-check.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add enrichment worker chaining and fix signal buyerId query</name>
  <files>
    apps/workers/enrichment/src/index.ts
    apps/workers/enrichment/src/types.ts
    apps/workers/enrichment/wrangler.toml
    apps/web/src/lib/buyers.ts
  </files>
  <action>
    **enrichment/wrangler.toml:**
    Add to `[vars]` section:
    ```toml
    BOARD_MINUTES_WORKER_URL = "https://tendhunt-board-minutes.kozak-74d.workers.dev"
    ```

    **enrichment/types.ts:**
    Add `BOARD_MINUTES_WORKER_URL: string` to the `Env` interface.

    **enrichment/index.ts:**
    1. In `runPipeline()`, after the existing spend-ingest trigger block (line ~41-49), add an identical block that triggers the board-minutes worker:
    ```typescript
    // Also trigger board-minutes signal extraction
    try {
      const bmRes = await fetch(`${env.BOARD_MINUTES_WORKER_URL}/run`);
      const bmResult = await bmRes.json();
      console.log("Board-minutes signal extraction result:", JSON.stringify(bmResult));
    } catch (err) {
      console.error("Board-minutes trigger failed:", err);
    }
    ```
    2. In `runSingleBuyerEnrichment()` return block (around line 106), AFTER the spend-ingest chain, add a board-minutes chain:
    ```typescript
    let boardMinutesResults = {};
    try {
      const bmRes = await fetch(`${env.BOARD_MINUTES_WORKER_URL}/run-buyer?id=${buyerId}`);
      boardMinutesResults = await bmRes.json();
    } catch (err) {
      boardMinutesResults = { error: err instanceof Error ? err.message : String(err) };
    }
    ```
    And include `boardMinutes: boardMinutesResults` in the Response.json return object.

    **buyers.ts (`apps/web/src/lib/buyers.ts`):**
    Change the signal query in `fetchBuyerById()` from:
    ```typescript
    Signal.find({ organizationName: buyer.name })
    ```
    to:
    ```typescript
    Signal.find({ $or: [{ buyerId: buyer._id }, { organizationName: buyer.name }] })
    ```
    This queries by both buyerId (new, reliable) and organizationName (backward compat with existing seeded signals), deduplicating via the $or. New signals from the board-minutes worker will have buyerId set, old seeded signals only have organizationName.
  </action>
  <verify>
    Run `cd apps/web && pnpm typecheck` to verify buyers.ts compiles.
    Run `cd apps/workers/enrichment && npx tsc --noEmit` to verify enrichment worker compiles with new env var.
    Check wrangler.toml contains BOARD_MINUTES_WORKER_URL.
  </verify>
  <done>
    Enrichment worker chains to board-minutes worker after all_complete (batch) and after single-buyer enrichment. Signal query uses $or with buyerId + organizationName for both new and legacy signals. All type-checks pass.
  </done>
</task>

</tasks>

<verification>
1. `cd apps/web && pnpm typecheck` -- no errors
2. `cd apps/workers/enrichment && npx tsc --noEmit` -- no errors
3. Signal model has boardDocumentId, quote, entities fields
4. BoardDocument model has signalExtractionStatus field
5. Enrichment wrangler.toml has BOARD_MINUTES_WORKER_URL
6. Enrichment index.ts triggers board-minutes worker in both batch and single-buyer flows
7. buyers.ts queries signals by buyerId OR organizationName
</verification>

<success_criteria>
All schema extensions are in place, enrichment worker chains to board-minutes worker, and signal queries use buyerId. Both web app and enrichment worker type-check cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/20-board-minutes-signals/20-02-SUMMARY.md`
</output>
