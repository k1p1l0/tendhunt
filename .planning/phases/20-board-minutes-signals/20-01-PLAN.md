---
phase: 20-board-minutes-signals
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/workers/board-minutes/package.json
  - apps/workers/board-minutes/tsconfig.json
  - apps/workers/board-minutes/wrangler.toml
  - apps/workers/board-minutes/src/index.ts
  - apps/workers/board-minutes/src/signal-engine.ts
  - apps/workers/board-minutes/src/types.ts
  - apps/workers/board-minutes/src/db/client.ts
  - apps/workers/board-minutes/src/db/signal-jobs.ts
autonomous: true

must_haves:
  truths:
    - "Board-minutes worker project builds and type-checks with wrangler"
    - "Worker exposes /run, /run-buyer, /debug, /health HTTP routes"
    - "Worker has a scheduled cron handler that invokes the pipeline engine"
    - "Pipeline engine finds current stage, runs it, and marks complete/error"
    - "Job tracker creates, updates cursor, and marks complete/error in signalingestjobs collection"
  artifacts:
    - path: "apps/workers/board-minutes/src/index.ts"
      provides: "Worker entry point with fetch + scheduled handlers"
      min_lines: 80
    - path: "apps/workers/board-minutes/src/signal-engine.ts"
      provides: "Pipeline orchestrator (findCurrentStage, processSignalPipeline)"
      min_lines: 50
    - path: "apps/workers/board-minutes/src/types.ts"
      provides: "Env, SignalIngestStage, SignalJobDoc, StageFn type definitions"
      min_lines: 40
    - path: "apps/workers/board-minutes/src/db/client.ts"
      provides: "MongoDB client singleton for Workers"
      min_lines: 15
    - path: "apps/workers/board-minutes/src/db/signal-jobs.ts"
      provides: "Job CRUD (getOrCreateJob, updateJobProgress, markJobComplete, markJobError)"
      min_lines: 60
  key_links:
    - from: "apps/workers/board-minutes/src/index.ts"
      to: "apps/workers/board-minutes/src/signal-engine.ts"
      via: "processSignalPipeline(db, env, maxItems)"
      pattern: "processSignalPipeline"
    - from: "apps/workers/board-minutes/src/signal-engine.ts"
      to: "apps/workers/board-minutes/src/db/signal-jobs.ts"
      via: "getOrCreateJob(db, stage)"
      pattern: "getOrCreateJob"
---

<objective>
Create the board-minutes Cloudflare Worker scaffold with pipeline engine, types, DB helpers, and HTTP routes -- all boilerplate cloned from the proven enrichment/spend-ingest worker pattern.

Purpose: Establish the worker project structure so the extraction stage (Plan 03) can be slotted in.
Output: Buildable worker project at `apps/workers/board-minutes/` with placeholder stages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/workers/enrichment/src/index.ts
@apps/workers/enrichment/src/enrichment-engine.ts
@apps/workers/enrichment/src/types.ts
@apps/workers/enrichment/src/db/client.ts
@apps/workers/enrichment/src/db/enrichment-jobs.ts
@apps/workers/enrichment/wrangler.toml
@apps/workers/spend-ingest/src/index.ts
@apps/workers/spend-ingest/src/types.ts
@apps/workers/spend-ingest/wrangler.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create worker project configuration and type definitions</name>
  <files>
    apps/workers/board-minutes/package.json
    apps/workers/board-minutes/tsconfig.json
    apps/workers/board-minutes/wrangler.toml
    apps/workers/board-minutes/src/types.ts
    apps/workers/board-minutes/src/db/client.ts
  </files>
  <action>
    Create the board-minutes worker project structure, cloning patterns from enrichment and spend-ingest workers.

    **package.json:** Name `@tendhunt/worker-board-minutes`. Dependencies: `mongodb@^6.16.0`, `@anthropic-ai/sdk@^0.39.0`, `p-limit@^6.2.0`. DevDependencies: `@cloudflare/workers-types@^4.20250312.0`, `@types/node@^22.0.0`, `typescript@^5.8.0`, `wrangler@^4.12.0`. Scripts: `dev`, `deploy`, `cf-typegen` matching enrichment worker pattern.

    **tsconfig.json:** Clone from enrichment worker. Target ES2022, module ESNext, lib `["ES2022"]`, moduleResolution Bundler.

    **wrangler.toml:**
    - name: `tendhunt-board-minutes`
    - main: `src/index.ts`
    - compatibility_date: `2025-03-20`
    - compatibility_flags: `["nodejs_compat_v2"]`
    - crons: `["30 * * * *"]` (every hour at :30, offset from enrichment at :00)
    - Secrets comment: MONGODB_URI, ANTHROPIC_API_KEY
    - NO R2 bucket binding (this worker doesn't store files)
    - NO [vars] section (no downstream worker to chain to)

    **types.ts:**
    - `Env` interface: `MONGODB_URI: string`, `ANTHROPIC_API_KEY: string`
    - `SignalIngestStage` type: `"extract_signals" | "deduplicate"`
    - `STAGE_ORDER: SignalIngestStage[]` = `["extract_signals", "deduplicate"]`
    - `SignalJobDoc` interface: identical to EnrichmentJobDoc but with `stage: SignalIngestStage`
    - `StageFn` type: `(db, env, job, maxItems) => Promise<{ processed; errors; done }>`
    - `BoardDocumentDoc` interface (copy from enrichment types.ts, add `signalExtractionStatus?: "pending" | "extracted" | "failed"`)
    - `SignalDoc` interface: `buyerId: ObjectId`, `boardDocumentId?: ObjectId`, `organizationName: string`, `signalType` (6 types), `title: string`, `insight: string`, `source?: string`, `sourceDate?: Date`, `sector?: string`, `confidence: number`, `quote?: string`, `entities?: { companies: string[]; amounts: string[]; dates: string[]; people: string[] }`, `createdAt: Date`, `updatedAt: Date`

    **db/client.ts:** Direct copy from enrichment `db/client.ts` -- MongoClient singleton with maxPoolSize: 1, getDb/closeDb exports.
  </action>
  <verify>
    Run `cd apps/workers/board-minutes && bun install` to verify package.json is valid and dependencies install.
    Run `ls apps/workers/board-minutes/src/` to verify file structure.
  </verify>
  <done>
    Worker project has valid package.json, tsconfig.json, wrangler.toml, types.ts, and db/client.ts. Dependencies installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pipeline engine, job tracker, and worker entry point</name>
  <files>
    apps/workers/board-minutes/src/db/signal-jobs.ts
    apps/workers/board-minutes/src/signal-engine.ts
    apps/workers/board-minutes/src/index.ts
  </files>
  <action>
    **db/signal-jobs.ts:** Clone from enrichment `db/enrichment-jobs.ts`, adapting types:
    - Collection name: `"signalingestjobs"`
    - Use `SignalJobDoc` and `SignalIngestStage` types
    - Same 4 functions: `getOrCreateJob`, `updateJobProgress`, `markJobComplete`, `markJobError`
    - Default batchSize: 50 (smaller than enrichment's 100 since each buyer triggers Claude API calls)

    **signal-engine.ts:** Clone from enrichment `enrichment-engine.ts`, adapting:
    - Import `SignalIngestStage`, `STAGE_ORDER`, `StageFn` from types
    - Import job helpers from `./db/signal-jobs`
    - `STAGE_FUNCTIONS` record: map stages to placeholder functions for now. Create TWO inline placeholder stage functions that return `{ processed: 0, errors: 0, done: true }` with a console.log saying "Stage X not yet implemented". These will be replaced by Plan 03.
    - Export `processSignalPipeline(db, env, maxItemsPerRun)` -- exact same logic as processEnrichmentPipeline
    - Helper `findCurrentStage(db)` -- same logic

    **index.ts:** Clone from spend-ingest `index.ts`, adapting for board-minutes:
    - `runPipeline(env, maxItems = 100)` -- default 100 buyers per cron (smaller budget than enrichment since Claude calls are heavier per buyer)
    - HTTP routes:
      - `/run-buyer?id=X` — single-buyer signal extraction. Validate ObjectId, find buyer, check buyer exists, run all stages via `runSingleBuyerSignals(db, env, oid)`. Do NOT chain to another worker (board-minutes is the end of the chain).
      - `/run?max=100` — batch processing
      - `/debug` — collection stats: total buyers, signals count, boarddocuments count, signalingestjobs list
      - `/health` — `{ status: "ok", worker: "tendhunt-board-minutes" }`
      - Default: `"tendhunt-board-minutes worker"`
    - `scheduled()` handler calls `runPipeline(env)`
    - `runSingleBuyerSignals()` — same pattern as spend-ingest's `runSingleBuyerSpend()`: fake job with batchSize: 1, iterate STAGE_ORDER, catch per-stage errors. Use `enrichmentPriority: 10` boost same as other workers.
  </action>
  <verify>
    Run `cd apps/workers/board-minutes && npx tsc --noEmit` to verify TypeScript compiles.
  </verify>
  <done>
    Worker entry point handles all 4 HTTP routes and cron trigger. Pipeline engine finds current stage and runs placeholder stages. Job tracker persists to signalingestjobs collection. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `cd apps/workers/board-minutes && bun install && npx tsc --noEmit` -- no errors
2. Worker project structure matches enrichment/spend-ingest pattern (index.ts, engine, types, db/)
3. All 4 HTTP routes exist: /run-buyer, /run, /debug, /health
4. Cron handler invokes pipeline engine
5. Placeholder stages return done:true so the pipeline can complete a full cycle
</verification>

<success_criteria>
Board-minutes worker project builds, has all HTTP routes and cron handler wired up, and placeholder stages complete without error. Ready for Plan 03 to replace placeholders with real extraction logic.
</success_criteria>

<output>
After completion, create `.planning/phases/20-board-minutes-signals/20-01-SUMMARY.md`
</output>
