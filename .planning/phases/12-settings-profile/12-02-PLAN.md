---
phase: 12-settings-profile
plan: 02
type: execute
wave: 2
depends_on: [12-01]
files_modified:
  - src/app/(dashboard)/settings/page.tsx
  - src/components/ui/tag-input.tsx
  - src/components/settings/logo-upload.tsx
  - src/components/settings/documents-section.tsx
autonomous: true

must_haves:
  truths:
    - "User sees their complete company profile on Settings page"
    - "User can edit any text field (name, website, address, LinkedIn, summary, ideal contract) and changes auto-save on blur"
    - "User can edit array fields (sectors, capabilities, keywords, certifications, regions) with tag-style inputs"
    - "User sees toast notification after each successful save"
    - "User can upload new logo by clicking/hovering over current logo"
    - "User can click Re-extract logo button to fetch logo from website/LinkedIn"
    - "User sees list of uploaded documents with delete buttons"
    - "User can upload more documents via dropzone in Documents section"
  artifacts:
    - path: "src/app/(dashboard)/settings/page.tsx"
      provides: "Settings page with auto-save profile form"
      min_lines: 150
    - path: "src/components/ui/tag-input.tsx"
      provides: "Reusable tag input component extracted from ProfileReview"
      exports: ["TagInput"]
    - path: "src/components/settings/logo-upload.tsx"
      provides: "Logo display with hover overlay and upload functionality"
      exports: ["LogoUpload"]
    - path: "src/components/settings/documents-section.tsx"
      provides: "Document list with delete buttons and upload dropzone"
      exports: ["DocumentsSection"]
  key_links:
    - from: "src/app/(dashboard)/settings/page.tsx"
      to: "/api/profile"
      via: "fetch GET and PATCH"
      pattern: "fetch.*api/profile.*PATCH"
    - from: "src/components/settings/logo-upload.tsx"
      to: "/api/profile/logo"
      via: "fetch POST for presigned URL"
      pattern: "fetch.*api/profile/logo.*POST"
    - from: "src/components/settings/documents-section.tsx"
      to: "/api/profile/documents"
      via: "fetch DELETE"
      pattern: "fetch.*api/profile/documents.*DELETE"
---

<objective>
Build the Settings page with auto-save form, logo upload, and document management

Purpose: Replace the Settings placeholder with a fully functional company profile editor. Users can view and edit all profile fields with Notion-style auto-save on blur, manage their logo, and add/remove documents. This is the primary UX for profile management after onboarding.

Output: Complete Settings page with 3 sections (Company Info, AI Profile, Documents), auto-save on blur for all fields, logo upload with re-extract option, and document management with upload/delete.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-settings-profile/12-CONTEXT.md
@.planning/phases/12-settings-profile/12-RESEARCH.md
@.planning/phases/12-settings-profile/12-01-SUMMARY.md

# Existing patterns to reuse
@src/components/onboarding/profile-review.tsx
@src/components/onboarding/document-dropzone.tsx
@src/components/contracts/contract-search.tsx
@src/models/company-profile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract TagInput to shared component, create Settings page with auto-save form</name>
  <files>
src/components/ui/tag-input.tsx
src/app/(dashboard)/settings/page.tsx
  </files>
  <action>
**Extract TagInput component:**

Create src/components/ui/tag-input.tsx by copying the TagInput function from src/components/onboarding/profile-review.tsx (lines 43-110). Make it a standalone exported component.

Interface:
```typescript
interface TagInputProps {
  label: string;
  tags: string[];
  onChange: (tags: string[]) => void;
  onBlur?: () => void;
  placeholder?: string;
}
```

Add onBlur prop support: call onBlur() when user clicks out of input field or removes a tag (useful for auto-save trigger).

**Create Settings page:**

Replace src/app/(dashboard)/settings/page.tsx placeholder with a server-rendered page that:

1. Fetches initial profile data server-side using Clerk auth() and CompanyProfile.findOne({ userId })
2. Renders page shell with header: large logo (80px, rounded-lg) + company name as h1
3. Passes initial data to SettingsForm client component

**SettingsForm client component** (inline in same file or extract if >100 lines):

State management:
- useState for all profile fields (companyName, website, address, linkedinUrl, summary, sectors, capabilities, keywords, certifications, idealContractDescription, companySize, regions)
- Initialize from initialProfile prop

Auto-save with useDebouncedCallback (import from use-debounce):
```typescript
const saveField = useDebouncedCallback(async (field: string, value: any) => {
  try {
    const res = await fetch("/api/profile", {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ [field]: value }),
    });
    if (!res.ok) throw new Error("Failed to save");
    toast("Profile updated");
  } catch (error) {
    toast.error("Failed to save changes");
  }
}, 300);
```

Layout (single scrollable page with 3 sections):

**Section 1: Company Info**
- Visual divider: h2 with border-b, mb-6
- Fields: companyName (Input), website (Input with type="url"), address (Textarea), linkedinUrl (Input with type="url")
- Each field: onChange updates local state, onBlur calls saveField(fieldName, value)

**Section 2: AI Profile**
- Visual divider: h2 with border-b, mb-6
- summary (Textarea, 4 rows, plain field)
- sectors (TagInput with onBlur)
- capabilities (TagInput with onBlur)
- keywords (TagInput with onBlur)
- certifications (TagInput with onBlur)
- idealContractDescription (Textarea, 4 rows, plain field)
- companySize (Select with options: "1-10", "11-50", "51-200", "201-1000", "1000+")
- regions (TagInput with onBlur)

**Section 3: Documents**
- Visual divider: h2 with border-b, mb-6
- Render DocumentsSection component (Task 2)

Comparison check before save:
- Before calling saveField, check if value !== initialValue to avoid unnecessary API calls
- For array fields, use JSON.stringify comparison

Import toast from "sonner". Import shadcn components: Input, Textarea, Select, Label, Button.

Pattern reference: src/components/contracts/contract-search.tsx for useDebouncedCallback usage.
  </action>
  <verify>
1. Navigate to http://localhost:3000/settings while authenticated
2. Verify all profile fields display current values (or empty if no profile)
3. Edit companyName field, click out → should see "Profile updated" toast within 300ms
4. Edit sectors TagInput (add/remove tags), click out → should auto-save and show toast
5. Edit summary textarea, click out → should auto-save
6. Refresh page → all changes should persist (fetched from DB)
7. Open Network tab, verify PATCH requests only fire on blur (not on every keystroke)
8. Check MongoDB CompanyProfile document → lastEditedAt should update on each save
  </verify>
  <done>
- TagInput component extracted to src/components/ui/tag-input.tsx with onBlur support
- Settings page renders server-side with initial profile data
- SettingsForm client component manages local state for all profile fields
- Auto-save implemented with 300ms debounce on blur events
- Company Info section has 4 text/url fields with auto-save
- AI Profile section has 2 textareas, 5 TagInput fields, 1 Select with auto-save
- Toast notifications appear on successful save and errors
- Changes only saved if value differs from initial (no duplicate PATCHs)
- Page refreshes show persisted changes from database
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LogoUpload and DocumentsSection components</name>
  <files>
src/components/settings/logo-upload.tsx
src/components/settings/documents-section.tsx
  </files>
  <action>
**Create src/components/settings/logo-upload.tsx:**

Client component accepting props:
```typescript
interface LogoUploadProps {
  logoUrl: string | null;
  companyName: string;
  onLogoUpdated: (newLogoUrl: string) => void;
}
```

Render:
- Container div with relative positioning, size-20 (80px), rounded-lg overflow-hidden
- If logoUrl exists: img tag with src={logoUrl}, alt="Company logo", className="size-full object-cover", onError handler to hide broken images
- If no logoUrl: Avatar with initials fallback (first 2 chars of companyName)
- Absolute-positioned hover overlay (opacity-0 group-hover:opacity-100 transition-opacity):
  - bg-black/50 covering full area
  - Upload icon (lucide-react) centered
  - Hidden file input (type="file", accept="image/*", sr-only class)
  - Label wrapping overlay for click handler

File upload flow:
1. User selects file via input onChange
2. Call POST /api/profile/logo with { filename, contentType } → get { url, key }
3. Upload file to presigned URL with PUT (XHR or fetch, content-type header)
4. Call PATCH /api/profile with { logoUrl: key } → update profile
5. Call onLogoUpdated(key) to update parent state
6. Show toast.success("Logo updated") or toast.error on failure

Re-extract button:
- Render Button below logo: "Re-extract from website", variant="outline", size="sm"
- onClick: confirm with window.confirm("Replace current logo?") if logoUrl exists
- If confirmed, call POST /api/profile/logo-extract → get { logoUrl } or 404
- Update parent state with onLogoUpdated(logoUrl)
- Show toast.success("Logo extracted") or toast.error("No logo found")

Loading states: useState for isUploading and isExtracting, show Loader2 icon and disable button during operations.

**Create src/components/settings/documents-section.tsx:**

Client component accepting props:
```typescript
interface DocumentsSectionProps {
  documentKeys: string[];
  onDocumentsUpdated: (newKeys: string[]) => void;
}
```

Render two parts:

**Part 1: Document list**
- Map over documentKeys array
- Each item: Card with filename (extract from key after last /), file size placeholder (or fetch from R2 if needed), delete Button
- Delete button onClick:
  1. Confirm with window.confirm("Delete this document?")
  2. Call DELETE /api/profile/documents with { key }
  3. Remove from local state: onDocumentsUpdated(documentKeys.filter(k => k !== key))
  4. Show toast.success("Document deleted")
- If documentKeys is empty, show empty state: "No documents uploaded yet"

**Part 2: Upload dropzone**
- Reuse DocumentDropzone from src/components/onboarding/document-dropzone.tsx BUT modify to:
  - Skip the onComplete prop (no wizard navigation)
  - On successful upload, call onDocumentsUpdated([...documentKeys, newKey])
  - Show toast.success("Document uploaded")
- OR simplify: create a basic dropzone with react-dropzone accepting .pdf/.docx/.doc/.txt, uploading to presigned URL from /api/upload/presigned, then updating state

Use existing presigned URL pattern from onboarding (reuse /api/upload/presigned endpoint created in Phase 3).

Import toast from sonner, Button, Card from shadcn/ui, Loader2, Upload, Trash2 from lucide-react.
  </action>
  <verify>
Logo upload:
1. Navigate to Settings page
2. Hover over logo → overlay should appear with upload icon
3. Click overlay, select image file → should upload and update logo display
4. Check Network tab: POST /api/profile/logo, PUT to R2, PATCH /api/profile
5. Refresh page → new logo should persist
6. Click "Re-extract from website" → should fetch logo from profile.website or linkedinUrl
7. Check that broken logo URLs hide gracefully (no broken image icon)

Documents section:
1. Scroll to Documents section on Settings page
2. If documents exist, see list with filenames and delete buttons
3. Click delete → confirm dialog → document removed from list and R2
4. Drag/drop PDF into upload dropzone → file uploads, appears in list
5. Check MongoDB: documentKeys array should match displayed list
6. Refresh page → documents list should persist

Toast notifications:
- "Logo updated" after successful upload
- "Logo extracted" after successful re-extract
- "Document deleted" after deletion
- "Document uploaded" after upload
- Error toasts on any failures
  </verify>
  <done>
- LogoUpload component displays current logo or initials fallback
- Hover overlay appears with upload icon on mouse over
- File selection triggers presigned URL upload flow, updates profile logoUrl
- Re-extract button fetches logo from website/LinkedIn with confirmation dialog
- DocumentsSection displays list of uploaded documents with delete buttons
- Delete button removes document from R2 and MongoDB after confirmation
- Upload dropzone allows adding more documents, updates profile documentKeys array
- All operations show toast notifications for success/error feedback
- Loading states prevent duplicate operations during uploads/deletes
- Broken logo URLs handled gracefully with fallback to initials
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire LogoUpload and DocumentsSection into Settings page, add header layout</name>
  <files>
src/app/(dashboard)/settings/page.tsx
  </files>
  <action>
Update Settings page to integrate logo and documents components:

**Page header (before form sections):**
- Flex container with items-center gap-4
- LogoUpload component on left (pass logoUrl, companyName, onLogoUpdated callback)
- Right side: h1 with company name, p with muted last edited timestamp
- onLogoUpdated callback: update local logoUrl state, trigger PATCH if needed (or just optimistic update since LogoUpload already PATCHes)

**Wire into form:**
- Add logoUrl and documentKeys to state (initialized from server props)
- In Company Info section header, render LogoUpload with callbacks
- In Documents section, render DocumentsSection with documentKeys and onDocumentsUpdated callback
- onDocumentsUpdated: update local documentKeys state (no need to PATCH, DocumentsSection handles DB updates)

**State management pattern:**
```typescript
const [logoUrl, setLogoUrl] = useState(initialProfile.logoUrl);
const [documentKeys, setDocumentKeys] = useState(initialProfile.documentKeys);

const handleLogoUpdated = (newUrl: string) => {
  setLogoUrl(newUrl);
  // Optionally dispatch custom event for sidebar refresh (Plan 03 handles listening)
  window.dispatchEvent(new CustomEvent("profile-updated", { detail: { logoUrl: newUrl } }));
};

const handleDocumentsUpdated = (newKeys: string[]) => {
  setDocumentKeys(newKeys);
};
```

**Layout refinements:**
- Add max-w-4xl container for form (centered)
- Increase spacing between sections (space-y-8)
- Section headers: text-xl font-semibold with border-b pb-2 mb-4
- Form fields in 2-column grid on large screens (grid-cols-2 gap-4) where appropriate
- Textareas and TagInputs full width (col-span-2)

Use existing shadcn/ui patterns for spacing and layout. Import all components at top of file.

Pattern reference: src/app/(dashboard)/buyers/[id]/page.tsx for header layout with avatar.
  </action>
  <verify>
Full Settings page test:

1. Navigate to /settings while authenticated
2. Page header shows logo (or initials) + company name + last edited timestamp
3. Click logo → file picker → upload → logo updates in header
4. Click "Re-extract" → logo updates if found
5. Scroll through 3 sections: Company Info, AI Profile, Documents
6. Edit fields in each section → auto-save on blur with toasts
7. Documents section shows existing docs, delete works, upload adds new
8. Refresh page → all changes persist (logo, text fields, array fields, documents)
9. Check responsive layout: form fields stack on mobile, 2-column on desktop where appropriate
10. Check MongoDB: CompanyProfile document has all latest changes with updated lastEditedAt

Edge cases:
- New user with no profile → empty form with placeholders
- User with profile but no logo → shows initials avatar
- User with profile but no documents → shows "No documents" empty state
- Broken logo URL → fallback to initials (no broken image icon)
  </verify>
  <done>
- Settings page header displays large logo with company name and last edited info
- LogoUpload integrated with callbacks updating page state and dispatching custom event
- DocumentsSection integrated with state management for adding/removing documents
- 3-section layout with clear visual dividers and proper spacing
- Form fields arranged in responsive grid (2 columns on large, 1 on mobile)
- All profile data editable with auto-save: text fields, textareas, selects, tag inputs
- Logo upload and re-extract functional with toast feedback
- Document list with delete buttons and upload dropzone functional
- Page handles edge cases: no profile, no logo, no documents, broken URLs
- Custom event dispatched on logo update for sidebar refresh (consumed in Plan 03)
  </done>
</task>

</tasks>

<verification>
Complete Settings page verification:

**Functionality:**
1. All profile fields display correctly from database
2. Text fields auto-save on blur with 300ms debounce
3. Array fields (TagInput) auto-save when tags change
4. Toast notifications appear for all save operations
5. Logo upload works: file picker → R2 upload → profile update → display refresh
6. Logo re-extract works: fetches from website/LinkedIn → updates display
7. Documents list displays uploaded files from documentKeys array
8. Document delete removes from R2 and MongoDB
9. Document upload adds to presigned URL and updates documentKeys
10. Page refresh shows all persisted changes

**UX:**
- Single scrollable page (not tabs) per user decision
- Visual section dividers with h2 headers
- Responsive layout: stacks on mobile, 2-column grid on desktop
- Toast notifications bottom-right, non-intrusive
- Loading states during uploads/operations
- Confirmation dialogs for destructive actions (delete, re-extract)

**Edge cases:**
- No profile: empty form, no errors
- No logo: initials avatar fallback
- No documents: empty state message
- Broken logo URL: graceful fallback
- Network errors: error toasts, no data corruption

**Performance:**
- Auto-save only fires on blur (not every keystroke)
- Debounce prevents duplicate API calls when tabbing quickly
- Presigned URLs for all file operations (no serverless memory issues)
</verification>

<success_criteria>
- Settings page replaced: no more "Coming in Phase 3" placeholder
- Complete company profile editor with 3 sections (Company Info, AI Profile, Documents)
- All 14 CompanyProfile fields editable with appropriate input types
- Auto-save on blur for all fields with toast notifications
- Logo displayed at 80px with hover upload overlay
- Logo upload via presigned URL flow works end-to-end
- Logo re-extract button fetches from website/LinkedIn
- Documents section shows list with delete buttons
- Document upload dropzone adds new files to profile
- Document delete removes from R2 and MongoDB atomically
- Page handles all edge cases gracefully (no profile, no logo, no docs)
- Responsive layout works on mobile and desktop
- Custom event dispatched on logo update for sidebar integration
</success_criteria>

<output>
After completion, create `.planning/phases/12-settings-profile/12-02-SUMMARY.md` documenting:
- Settings page transformation from placeholder to full editor
- Auto-save pattern with useDebouncedCallback (300ms on blur)
- TagInput extraction to shared component
- LogoUpload and DocumentsSection components created
- 3-section layout with visual dividers
- File operations via presigned URLs (upload, delete)
- Custom event pattern for cross-component state sync
- Edge cases handled (no profile, no logo, no documents, broken URLs)
- User experience improvements (toasts, confirmations, loading states)
</output>
