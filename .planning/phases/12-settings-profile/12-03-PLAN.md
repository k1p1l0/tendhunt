---
phase: 12-settings-profile
plan: 03
type: execute
wave: 2
depends_on: [12-01]
files_modified:
  - src/components/layout/app-sidebar.tsx
  - src/components/layout/sidebar-company-header.tsx
  - src/components/layout/sidebar-footer.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar header shows company logo and name at the top"
    - "Clicking sidebar header navigates to Settings page"
    - "Sidebar footer shows CreditBalance first, then TendHunt branding below"
    - "If no profile exists, sidebar header shows Clerk user name with avatar"
    - "Logo updates in sidebar when uploaded on Settings page (event-driven)"
  artifacts:
    - path: "src/components/layout/sidebar-company-header.tsx"
      provides: "Company header with logo/name, links to Settings"
      exports: ["SidebarCompanyHeader"]
    - path: "src/components/layout/sidebar-footer.tsx"
      provides: "Footer with credits and TendHunt branding"
      exports: ["SidebarFooter"]
    - path: "src/components/layout/app-sidebar.tsx"
      provides: "Restructured sidebar with company header and footer"
      contains: "<SidebarCompanyHeader"
  key_links:
    - from: "src/components/layout/sidebar-company-header.tsx"
      to: "/api/profile"
      via: "fetch in useEffect"
      pattern: "fetch.*api/profile"
    - from: "src/components/layout/sidebar-company-header.tsx"
      to: "/settings"
      via: "Link component"
      pattern: "<Link href=\"/settings\""
    - from: "src/components/layout/sidebar-company-header.tsx"
      to: "window.addEventListener"
      via: "profile-updated event listener"
      pattern: "addEventListener.*profile-updated"
---

<objective>
Restructure sidebar to show company identity at top and TendHunt branding at bottom

Purpose: Transform the sidebar from TendHunt-centric to user-centric. The company's logo and name move to the header (Slack-style workspace switcher), making it feel like "their" app. TendHunt branding becomes subtle footer text, and clicking the company header opens Settings. This improves information hierarchy and user sense of ownership.

Output: Sidebar with company header (logo + name, clickable) at top, nav items in middle, footer with CreditBalance then TendHunt branding at bottom. Event-driven refresh when logo changes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-settings-profile/12-CONTEXT.md
@.planning/phases/12-settings-profile/12-RESEARCH.md
@.planning/phases/12-settings-profile/12-01-SUMMARY.md

# Existing sidebar structure
@src/components/layout/app-sidebar.tsx
@src/components/credits/credit-balance.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SidebarCompanyHeader component with profile fetch and event listener</name>
  <files>
src/components/layout/sidebar-company-header.tsx
  </files>
  <action>
Create a client component at src/components/layout/sidebar-company-header.tsx:

**Purpose:** Display company logo + name at sidebar top, fallback to Clerk user if no profile, refresh on logo update events.

**Implementation:**

State management:
```typescript
const { user } = useUser(); // from @clerk/nextjs
const [profile, setProfile] = useState<{ logoUrl: string; companyName: string } | null>(null);
const [isLoading, setIsLoading] = useState(true);
```

Fetch profile on mount:
```typescript
useEffect(() => {
  fetch("/api/profile")
    .then(res => res.ok ? res.json() : null)
    .then(data => {
      setProfile(data?.profile || null);
      setIsLoading(false);
    })
    .catch(() => {
      setProfile(null);
      setIsLoading(false);
    });
}, []);
```

Listen for profile updates (dispatched from Settings page in Plan 02):
```typescript
useEffect(() => {
  const handleProfileUpdate = (event: CustomEvent) => {
    if (event.detail?.logoUrl) {
      setProfile(prev => prev ? { ...prev, logoUrl: event.detail.logoUrl } : prev);
    }
  };

  window.addEventListener("profile-updated", handleProfileUpdate as EventListener);
  return () => window.removeEventListener("profile-updated", handleProfileUpdate as EventListener);
}, []);
```

Render logic:

**If loading:** Show skeleton (Skeleton from shadcn/ui, size-8 rounded-md + skeleton text)

**If profile exists:**
```tsx
<Link href="/settings" className="flex items-center gap-3 p-3 hover:bg-sidebar-accent rounded-md transition-colors">
  <Avatar className="size-8 rounded-md">
    <AvatarImage src={profile.logoUrl || ""} />
    <AvatarFallback className="rounded-md bg-primary/10 text-xs font-semibold">
      {profile.companyName?.slice(0, 2).toUpperCase() || "CO"}
    </AvatarFallback>
  </Avatar>
  <span className="font-medium text-sm truncate">{profile.companyName}</span>
</Link>
```

**If no profile but Clerk user exists (fallback):**
```tsx
<Link href="/settings" className="flex items-center gap-3 p-3 hover:bg-sidebar-accent rounded-md transition-colors">
  <Avatar className="size-8">
    <AvatarImage src={user?.imageUrl} />
    <AvatarFallback className="text-xs">
      {user?.firstName?.[0]}{user?.lastName?.[0]}
    </AvatarFallback>
  </Avatar>
  <span className="font-medium text-sm truncate">
    {user?.firstName} {user?.lastName}
  </span>
</Link>
```

**Styling notes:**
- Logo: size-8 (32px), rounded-md (matches Slack workspace icon style per user decision)
- Hover state: bg-sidebar-accent for visual feedback
- Text: truncate to handle long company names
- Fallback avatar: rounded (circle) for user avatar vs rounded-md (square) for company logo

Import Avatar, AvatarImage, AvatarFallback from @/components/ui/avatar. Import Link from next/link. Import useUser from @clerk/nextjs. Import Skeleton from @/components/ui/skeleton (if not installed, add via shadcn CLI).

Pattern reference: Sidebar header should feel clickable like Slack's workspace switcher.
  </action>
  <verify>
1. Navigate to any dashboard page (/dashboard, /contracts, /buyers, /scanners)
2. Check sidebar header:
   - If profile exists: shows company logo (rounded square) + company name
   - If no profile: shows Clerk user avatar (circle) + user name
   - Hover: background color changes
3. Click sidebar header → navigates to /settings
4. On Settings page, upload new logo → return to dashboard → sidebar logo should update without refresh
5. Check that broken logo URLs fall back to company initials (not broken image icon)
6. Verify loading state shows skeleton during initial fetch

Test with different states:
- New user with no profile → Clerk fallback works
- Existing user with profile → company header works
- User with profile but broken logoUrl → fallback to initials works
  </verify>
  <done>
- SidebarCompanyHeader component created at src/components/layout/sidebar-company-header.tsx
- Component fetches profile from /api/profile on mount
- Displays company logo (32px, rounded square) + company name if profile exists
- Falls back to Clerk user avatar (circle) + name if no profile
- Listens for profile-updated custom event to refresh logo without reload
- Links to /settings when clicked
- Shows hover state for clickable feedback
- Handles loading state with skeleton
- Handles broken logo URLs with initials fallback
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SidebarFooter component with credits and TendHunt branding</name>
  <files>
src/components/layout/sidebar-footer.tsx
  </files>
  <action>
Create a client component at src/components/layout/sidebar-footer.tsx:

**Purpose:** Show CreditBalance component first, then subtle TendHunt branding below.

**Implementation:**

Simple component structure:
```tsx
"use client";

import { CreditBalance } from "@/components/credits/credit-balance";
import { Crosshair } from "lucide-react";

export function SidebarFooter() {
  return (
    <div className="space-y-3 p-3">
      {/* Credit balance first */}
      <CreditBalance />

      {/* TendHunt branding below */}
      <div className="flex items-center gap-2 text-xs text-muted-foreground">
        <Crosshair className="size-4" />
        <span>TendHunt</span>
      </div>
    </div>
  );
}
```

**Styling notes:**
- CreditBalance already exists and works (no changes needed)
- TendHunt branding: text-xs, text-muted-foreground (subtle, not prominent)
- Crosshair icon: size-4 (16px, smaller than header logo)
- No link/hover state on branding (just informational, not clickable per user decision)
- Vertical spacing: space-y-3 between credits and branding
- Padding: p-3 consistent with sidebar item padding

This is a simple presentational component with no state or logic. Just wraps CreditBalance and adds branding below.

Pattern reference: Footer should feel like attribution, not a call-to-action. Muted and small.
  </action>
  <verify>
1. Check any dashboard page sidebar bottom
2. Verify CreditBalance component renders (credit count + popover)
3. Verify TendHunt branding appears below credits:
   - Small Crosshair icon (16px)
   - "TendHunt" text in muted color
   - Not clickable (no hover state)
4. Check spacing between credits and branding (should have gap)
5. Verify footer doesn't overlap with nav items (proper SidebarFooter positioning)

Visual check:
- Credits: normal contrast, readable
- Branding: muted, subtle, not competing for attention
- Icon + text aligned horizontally
  </verify>
  <done>
- SidebarFooter component created at src/components/layout/sidebar-footer.tsx
- Renders CreditBalance component first
- Renders TendHunt branding below: small Crosshair icon + text in muted color
- No clickable interaction on branding (just informational)
- Proper spacing between credits and branding
- Subtle visual hierarchy: credits prominent, branding muted
  </done>
</task>

<task type="auto">
  <name>Task 3: Restructure AppSidebar to use new header and footer components</name>
  <files>
src/components/layout/app-sidebar.tsx
  </files>
  <action>
Refactor src/components/layout/app-sidebar.tsx to integrate new components:

**Changes:**

1. **Replace SidebarHeader content:**

Current (remove):
```tsx
<SidebarHeader className="p-4">
  <Link href="/dashboard" className="flex items-center gap-2">
    <Crosshair className="h-6 w-6 text-primary" />
    <span className="text-lg font-bold">TendHunt</span>
  </Link>
</SidebarHeader>
```

New:
```tsx
<SidebarHeader className="p-3">
  <SidebarCompanyHeader />
</SidebarHeader>
```

Import SidebarCompanyHeader from "./sidebar-company-header".

2. **Replace SidebarFooter content:**

Current (remove):
```tsx
<SidebarFooter>
  <CreditBalance />
</SidebarFooter>
```

New:
```tsx
<SidebarFooter>
  <SidebarFooter />
</SidebarFooter>
```

Wait, naming conflict. Rename the new component import:
```typescript
import { SidebarFooter as SidebarFooterContent } from "./sidebar-footer";
```

Then:
```tsx
<SidebarFooter>
  <SidebarFooterContent />
</SidebarFooter>
```

3. **Keep SidebarContent unchanged:**

Navigation items (Dashboard, Contracts, Buyers, Scanners, Settings) stay the same. No changes to SidebarContent, SidebarGroup, SidebarMenu, etc.

4. **Update imports:**

Remove direct CreditBalance import (now in SidebarFooterContent). Remove Crosshair import (now in header/footer components). Add new component imports.

**Final structure:**
```tsx
<Sidebar>
  <SidebarHeader>
    <SidebarCompanyHeader />
  </SidebarHeader>

  <SidebarContent>
    {/* Existing nav items unchanged */}
  </SidebarContent>

  <SidebarFooter>
    <SidebarFooterContent />
  </SidebarFooter>
</Sidebar>
```

No other logic changes. Just component composition refactor.

Pattern reference: Keep main AppSidebar lean, delegate header/footer rendering to specialized components for separation of concerns.
  </action>
  <verify>
Full sidebar verification across all dashboard pages:

**Visual structure (top to bottom):**
1. Company header: logo + name, clickable, links to /settings
2. Nav items: Dashboard, Contracts, Buyers, Scanners, Settings (unchanged)
3. Footer: CreditBalance + TendHunt branding

**Functionality:**
- Click company header → navigates to /settings ✓
- Click nav items → navigates to respective pages (unchanged) ✓
- Click credit balance → opens popover with history (unchanged) ✓
- TendHunt branding is not clickable ✓

**Responsive behavior:**
- Sidebar collapses/expands work (if implemented) ✓
- All components remain visible in collapsed state (icons, logos) ✓

**State sync:**
- Upload logo on Settings page → return to another page → sidebar logo updates ✓
- No full page refresh required for logo update ✓

**Edge cases:**
- New user with no profile → shows Clerk user fallback ✓
- User with profile → shows company header ✓
- Broken logo URL → shows initials fallback ✓
- Loading state → shows skeleton briefly ✓

Compare before/after:
- Before: TendHunt logo at top, CreditBalance at bottom
- After: Company logo at top, TendHunt text at bottom (muted)
  </verify>
  <done>
- AppSidebar restructured to use SidebarCompanyHeader and SidebarFooterContent
- SidebarHeader shows company identity (logo + name) instead of TendHunt branding
- SidebarFooter shows CreditBalance first, then TendHunt branding below
- Company header links to /settings when clicked
- TendHunt branding moved from header to footer, made subtle and muted
- Navigation items (SidebarContent) unchanged and functional
- Event-driven logo refresh works without page reload
- Sidebar structure matches user decision: company at top, branding at bottom
- All existing functionality preserved (nav, credits, active states)
  </done>
</task>

</tasks>

<verification>
Complete sidebar restructure verification:

**Visual hierarchy (top to bottom):**
1. Company logo (32px, rounded square) + company name → clickable, links to Settings
2. Navigation items (Dashboard, Contracts, Buyers, Scanners, Settings) → unchanged
3. Credit balance with popover → unchanged
4. TendHunt branding (small icon + text, muted) → not clickable, subtle

**User flow:**
1. Sign in → sidebar shows company logo if profile exists, or user avatar if no profile
2. Click company header → navigates to /settings
3. On Settings, upload new logo → navigate back → sidebar logo updates (no refresh)
4. Click nav items → works as before
5. Click credit balance → popover opens as before

**State sync:**
- Logo upload on Settings triggers profile-updated event
- SidebarCompanyHeader listens for event and updates display
- No polling, no full reload needed
- Event-driven refresh feels instant

**Edge cases:**
- No profile: Clerk user fallback (avatar + name)
- No logo: company initials fallback
- Broken logo URL: initials fallback (no broken image)
- Loading state: skeleton during initial fetch
- Multiple logo uploads: each triggers update correctly

**Compare to user decision:**
- ✓ Header: user's company logo (rounded square, ~32px, Slack-style)
- ✓ Clicking header navigates to Settings
- ✓ Footer: CreditBalance first, then TendHunt branding below
- ✓ Fallback: Clerk user name + initials avatar if no profile
- ✓ TendHunt branding: small Crosshair icon + text, muted, subtle
</verification>

<success_criteria>
- Sidebar header replaced: TendHunt logo moved to footer, company logo at top
- SidebarCompanyHeader displays company logo (32px, rounded square) + company name
- Company header links to /settings when clicked
- Fallback to Clerk user avatar + name if no CompanyProfile exists
- SidebarFooter shows CreditBalance first, TendHunt branding below
- TendHunt branding is subtle: small icon, muted text, not clickable
- Logo updates in sidebar when changed on Settings page (event-driven)
- No polling or page refresh needed for logo sync
- All existing sidebar functionality preserved (nav, credits, active states)
- Edge cases handled: no profile, no logo, broken URLs, loading state
- Visual hierarchy matches user decision: company identity prominent, TendHunt attribution subtle
</success_criteria>

<output>
After completion, create `.planning/phases/12-settings-profile/12-03-SUMMARY.md` documenting:
- Sidebar restructure from TendHunt-centric to user-centric
- Company header component with logo, name, Settings link, Clerk fallback
- Footer component with credits and subtle TendHunt branding
- Event-driven logo refresh pattern (profile-updated custom event)
- Slack-style workspace switcher design (rounded square logo, clickable)
- Visual hierarchy shift: company identity top, TendHunt branding bottom
- All existing functionality preserved and working
- Edge case handling (no profile, no logo, broken URLs, loading)
</output>
