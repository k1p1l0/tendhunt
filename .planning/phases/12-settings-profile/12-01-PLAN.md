---
phase: 12-settings-profile
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/components/ui/sonner.tsx
  - src/app/layout.tsx
  - src/app/api/profile/route.ts
  - src/app/api/profile/logo/route.ts
  - src/app/api/profile/logo-extract/route.ts
  - src/app/api/profile/documents/route.ts
autonomous: true

must_haves:
  truths:
    - "Toast notifications appear on screen when profile is saved"
    - "Profile data can be fetched via GET /api/profile"
    - "Individual profile fields can be updated via PATCH /api/profile"
    - "Logo can be uploaded via POST /api/profile/logo with presigned URL flow"
    - "Logo can be re-extracted from website via POST /api/profile/logo-extract"
    - "Documents can be deleted from R2 and MongoDB via DELETE /api/profile/documents"
  artifacts:
    - path: "src/components/ui/sonner.tsx"
      provides: "Sonner toast component from shadcn/ui"
      min_lines: 10
    - path: "src/app/layout.tsx"
      provides: "Toaster component in root layout"
      contains: "<Toaster />"
    - path: "src/app/api/profile/route.ts"
      provides: "GET and PATCH endpoints for profile"
      exports: ["GET", "PATCH"]
    - path: "src/app/api/profile/logo/route.ts"
      provides: "Logo upload presigned URL generation"
      exports: ["POST"]
    - path: "src/app/api/profile/logo-extract/route.ts"
      provides: "Logo re-extraction from website"
      exports: ["POST"]
    - path: "src/app/api/profile/documents/route.ts"
      provides: "Document deletion from R2 and MongoDB"
      exports: ["DELETE"]
  key_links:
    - from: "src/app/api/profile/route.ts"
      to: "CompanyProfile model"
      via: "findOne and findOneAndUpdate"
      pattern: "CompanyProfile\\.findOne.*userId"
    - from: "src/app/api/profile/documents/route.ts"
      to: "r2Client"
      via: "DeleteObjectCommand"
      pattern: "DeleteObjectCommand.*Key.*key"
    - from: "src/app/api/profile/logo-extract/route.ts"
      to: "fetchWebContentWithOgImage"
      via: "import and call"
      pattern: "fetchWebContentWithOgImage\\(profile\\.website\\)"
---

<objective>
Create API infrastructure and toast notification system for Settings page auto-save functionality

Purpose: Provide the backend endpoints and user feedback mechanisms needed for field-level auto-save, logo management, and document deletion in the Settings page. This foundation enables Plans 02-03 to build the UI without worrying about data persistence or notification patterns.

Output: 6 API routes (GET/PATCH profile, POST logo upload, POST logo re-extract, DELETE document) and sonner toast notifications integrated into root layout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-settings-profile/12-CONTEXT.md
@.planning/phases/12-settings-profile/12-RESEARCH.md

# Existing patterns to reuse
@src/models/company-profile.ts
@src/lib/r2.ts
@src/lib/fetch-web-content.ts
@src/lib/linkedin-scraper.ts
@src/app/api/upload/presigned/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install sonner, add Toaster to root layout, create profile GET/PATCH API</name>
  <files>
package.json
src/components/ui/sonner.tsx
src/app/layout.tsx
src/app/api/profile/route.ts
  </files>
  <action>
Install sonner toast library via shadcn CLI:
```bash
npx shadcn@latest add sonner
npm install next-themes
```

Add Toaster component to root layout (src/app/layout.tsx) before closing body tag, after {children}. Import from @/components/ui/sonner.

Create GET and PATCH endpoints at src/app/api/profile/route.ts:

**GET /api/profile:**
- Auth with Clerk auth() from @clerk/nextjs/server
- Return 401 if no userId
- Call dbConnect(), find CompanyProfile by userId
- Return { profile } or { profile: null } if not found
- Return 200 with JSON

**PATCH /api/profile:**
- Auth with Clerk auth()
- Return 401 if no userId
- Parse request body as JSON
- Validate: only allow updating companyName, website, address, linkedinUrl, summary, sectors, capabilities, keywords, certifications, idealContractDescription, companySize, regions fields (whitelist approach, reject logoUrl, documentKeys, userId, etc.)
- Call dbConnect(), findOneAndUpdate with { userId }, { $set: validatedFields, lastEditedAt: new Date() }, { new: true }
- If profile not found, create new profile with userId and fields
- Return { profile } with updated document
- Return 200 with JSON

Use existing patterns from src/app/api/contracts/route.ts for auth and DB connection.
  </action>
  <verify>
Run dev server and test endpoints:
```bash
curl http://localhost:3000/api/profile -H "Cookie: __session=..." # Should return profile or null
curl -X PATCH http://localhost:3000/api/profile -H "Cookie: __session=..." -H "Content-Type: application/json" -d '{"companyName":"Test Co"}' # Should update and return profile
```

Check browser console for sonner toast component availability (no errors).
  </verify>
  <done>
- sonner and next-themes installed in package.json
- Toaster component exists at src/components/ui/sonner.tsx
- Toaster rendered in src/app/layout.tsx before closing body
- GET /api/profile returns current user's profile or null (200 status)
- PATCH /api/profile updates whitelisted fields, sets lastEditedAt, returns updated profile (200 status)
- Unauthorized requests return 401
  </done>
</task>

<task type="auto">
  <name>Task 2: Create logo upload, logo re-extract, and document delete APIs</name>
  <files>
src/app/api/profile/logo/route.ts
src/app/api/profile/logo-extract/route.ts
src/app/api/profile/documents/route.ts
  </files>
  <action>
Create three API routes following R2 and profile update patterns:

**src/app/api/profile/logo/route.ts - POST:**
- Auth with Clerk auth()
- Return 401 if no userId
- Parse body: { filename: string, contentType: string }
- Validate contentType is image/* (jpeg, png, svg, webp, gif)
- Generate presigned PUT URL for R2 using @aws-sdk/s3-request-presigner getSignedUrl and PutObjectCommand
- Use key pattern: `logos/${userId}/${nanoid()}-${filename}`
- Set expiry: 300 seconds
- Return { url: presignedUrl, key: objectKey }
- Use existing /api/upload/presigned as reference pattern

**src/app/api/profile/logo-extract/route.ts - POST:**
- Auth with Clerk auth()
- Return 401 if no userId
- Call dbConnect(), find CompanyProfile by userId
- Return 404 if profile not found
- Re-run logo extraction logic from src/app/api/profile/generate/route.ts:
  - Promise.allSettled with fetchWebContentWithOgImage(profile.website) and scrapeLinkedInCompany(profile.linkedinUrl)
  - Prioritize LinkedIn logoUrl over og:image
- If no logo found, return { error: "No logo found" }, 404
- If logo found, update profile: findOneAndUpdate({ userId }, { logoUrl, lastEditedAt: new Date() }, { new: true })
- Return { logoUrl } with 200
- Import fetchWebContentWithOgImage from @/lib/fetch-web-content, scrapeLinkedInCompany from @/lib/linkedin-scraper

**src/app/api/profile/documents/route.ts - DELETE:**
- Auth with Clerk auth()
- Return 401 if no userId
- Parse body: { key: string }
- Validate key is non-empty string, return 400 if invalid
- Delete from R2 first (idempotent): r2Client.send(new DeleteObjectCommand({ Bucket: process.env.R2_BUCKET_NAME!, Key: key }))
- Then remove from MongoDB: CompanyProfile.findOneAndUpdate({ userId }, { $pull: { documentKeys: key }, lastEditedAt: new Date() })
- Return { success: true } with 200
- Import r2Client from @/lib/r2, DeleteObjectCommand from @aws-sdk/client-s3

Use nanoid() for unique key generation in logo upload. Import from nanoid package.
  </action>
  <verify>
Test each endpoint with curl:

Logo upload:
```bash
curl -X POST http://localhost:3000/api/profile/logo -H "Cookie: __session=..." -H "Content-Type: application/json" -d '{"filename":"test.png","contentType":"image/png"}' # Should return { url, key }
```

Logo re-extract (requires profile with website or linkedinUrl):
```bash
curl -X POST http://localhost:3000/api/profile/logo-extract -H "Cookie: __session=..." # Should return { logoUrl } or 404
```

Document delete (requires existing documentKey):
```bash
curl -X DELETE http://localhost:3000/api/profile/documents -H "Cookie: __session=..." -H "Content-Type: application/json" -d '{"key":"documents/test-key"}' # Should return { success: true }
```

Check MongoDB to verify documentKeys array updated after delete.
  </verify>
  <done>
- POST /api/profile/logo generates presigned PUT URL for image uploads with user-scoped key
- POST /api/profile/logo-extract re-runs logo extraction from website/LinkedIn, updates profile, returns logoUrl or 404
- DELETE /api/profile/documents removes object from R2 and key from CompanyProfile.documentKeys array
- All endpoints return 401 for unauthorized requests
- Logo upload validates image content types only
- Document delete is idempotent (safe to retry)
  </done>
</task>

</tasks>

<verification>
Run verification suite:

1. Sonner installation: Check node_modules/sonner exists, src/components/ui/sonner.tsx created
2. Root layout: Grep for `<Toaster />` in src/app/layout.tsx
3. Profile endpoints: GET and PATCH functional with valid auth cookies
4. Logo endpoints: POST logo returns presigned URL, POST logo-extract returns logoUrl or 404
5. Document delete: DELETE removes from R2 and MongoDB atomically
6. Auth guard: All endpoints return 401 without valid Clerk session

Test complete flow:
- Start dev server
- Sign in via Clerk
- Call GET /api/profile → returns profile or null
- Call PATCH /api/profile with { companyName: "Updated" } → returns updated profile
- Call POST /api/profile/logo → returns presigned URL
- Call POST /api/profile/logo-extract (if profile has website) → returns logoUrl
- Call DELETE /api/profile/documents with existing key → returns success
</verification>

<success_criteria>
- Sonner toast library installed and Toaster component rendered in root layout
- toast() function can be imported and called from any client component
- GET /api/profile fetches current user's CompanyProfile by userId
- PATCH /api/profile updates whitelisted profile fields with field-level granularity
- POST /api/profile/logo generates presigned R2 URLs for logo image uploads
- POST /api/profile/logo-extract re-runs auto-extraction from website/LinkedIn
- DELETE /api/profile/documents atomically removes files from R2 and MongoDB
- All endpoints protected by Clerk auth, return 401 for unauthorized requests
- API routes follow existing patterns from onboarding and contracts endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/12-settings-profile/12-01-SUMMARY.md` documenting:
- API endpoints created (6 total: GET/PATCH profile, POST logo, POST logo-extract, DELETE documents)
- Sonner integration in root layout
- Key patterns established (field-level PATCH, presigned logo upload, idempotent R2 delete)
- Files created and modified
- Next phase readiness (APIs ready for Settings page UI in Plan 02, sidebar in Plan 03)
</output>
