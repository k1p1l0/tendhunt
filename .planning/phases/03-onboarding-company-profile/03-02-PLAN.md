---
phase: 03-onboarding-company-profile
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/extract-text.ts
  - src/app/api/profile/generate/route.ts
  - src/components/onboarding/profile-review.tsx
  - src/components/onboarding/onboarding-wizard.tsx
  - src/app/onboarding/_actions.ts
autonomous: true

must_haves:
  truths:
    - "AI analyzes uploaded documents and generates a structured company profile with sectors, capabilities, keywords, certifications, ideal contract description"
    - "User can review the AI-generated profile in an editable form"
    - "User can edit any field of the AI-generated profile before saving"
    - "User can skip document upload and manually fill in their profile"
    - "New user receives 10 free credits on signup, visible via CreditAccount record"
    - "After completing onboarding, user is redirected to /dashboard and middleware no longer redirects to /onboarding"
  artifacts:
    - path: "src/lib/extract-text.ts"
      provides: "PDF/DOCX/TXT text extraction utilities"
      contains: "extractTextFromBuffer"
    - path: "src/app/api/profile/generate/route.ts"
      provides: "AI profile generation endpoint using Claude Haiku 4.5"
      exports: ["POST"]
    - path: "src/components/onboarding/profile-review.tsx"
      provides: "Editable company profile review form"
      contains: "ProfileReview"
    - path: "src/app/onboarding/_actions.ts"
      provides: "Server action to complete onboarding (save profile, create credits, update Clerk metadata)"
      contains: "completeOnboarding"
    - path: "src/components/onboarding/onboarding-wizard.tsx"
      provides: "Complete 3-step wizard with AI generation and review/edit"
      contains: "OnboardingWizard"
  key_links:
    - from: "src/app/api/profile/generate/route.ts"
      to: "src/lib/extract-text.ts"
      via: "downloads files from R2, extracts text, sends to Claude"
      pattern: "extractTextFromBuffer"
    - from: "src/app/api/profile/generate/route.ts"
      to: "src/lib/anthropic.ts"
      via: "calls Claude Haiku 4.5 with output_config structured JSON"
      pattern: "anthropic\\.messages\\.create"
    - from: "src/components/onboarding/onboarding-wizard.tsx"
      to: "/api/profile/generate"
      via: "fetch POST with document keys to trigger AI profile generation"
      pattern: "fetch.*api/profile/generate"
    - from: "src/components/onboarding/onboarding-wizard.tsx"
      to: "src/app/onboarding/_actions.ts"
      via: "calls completeOnboarding server action to save and finalize"
      pattern: "completeOnboarding"
    - from: "src/app/onboarding/_actions.ts"
      to: "src/models/company-profile.ts"
      via: "upserts CompanyProfile document"
      pattern: "CompanyProfile\\.findOneAndUpdate"
    - from: "src/app/onboarding/_actions.ts"
      to: "src/models/credit.ts"
      via: "creates CreditAccount + SIGNUP_BONUS transaction (idempotent)"
      pattern: "CreditAccount\\.create"
---

<objective>
Implement AI company profile generation from uploaded documents, the profile review/edit form, and the onboarding completion flow with signup credit bonus, completing the full onboarding wizard.

Purpose: AUTH-03 (AI profile generation), AUTH-04 (profile review/edit), and AUTH-06 (10 free credits) require the AI analysis pipeline, editable form, and credit creation. This plan takes the upload infrastructure from Plan 01 and adds the intelligence layer and completion flow.

Output: Complete 3-step onboarding wizard: Upload -> AI Generate -> Review/Edit/Save. On completion: profile saved, 10 credits granted, Clerk metadata updated, user redirected to dashboard.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-onboarding-company-profile/03-RESEARCH.md
@.planning/phases/03-onboarding-company-profile/03-01-SUMMARY.md
@src/lib/r2.ts
@src/lib/anthropic.ts
@src/lib/env.ts
@src/models/company-profile.ts
@src/models/credit.ts
@src/proxy.ts
@src/components/onboarding/onboarding-wizard.tsx
@src/components/onboarding/document-dropzone.tsx
@src/app/onboarding/page.tsx
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Text extraction utility and AI profile generation API route</name>
  <files>
    src/lib/extract-text.ts
    src/app/api/profile/generate/route.ts
  </files>
  <action>
1. Create `src/lib/extract-text.ts` -- Text extraction from PDF, DOCX, TXT buffers:
   - Export `extractTextFromBuffer(buffer: Buffer, mimeType: string): Promise<string>`
   - For `application/pdf`:
     - Use pdf-parse v3 class-based API: `import { PDFParse } from "pdf-parse"`
     - `const parser = new PDFParse({ data: buffer }); const result = await parser.getText(); await parser.destroy(); return result.text;`
     - If result text is empty/whitespace, return empty string (scanned PDF fallback -- handled gracefully in caller)
   - For `application/vnd.openxmlformats-officedocument.wordprocessingml.document` and `application/msword`:
     - Dynamic import officeparser v6: `const { parseOffice } = await import("officeparser")`
     - `const ast = await parseOffice(buffer); return ast.toText();`
     - NOTE: officeparser v6 API may differ from research. If `parseOffice` is not the correct export, check the module. Fallback: `import officeparser from "officeparser"` then `officeparser.parseOffice(buffer)` or `officeparser.parseOfficeAsync(buffer)`. The key is to get text output.
   - For `text/plain`: `return buffer.toString("utf-8")`
   - For unknown types: throw `Error("Unsupported file type: ${mimeType}")`
   - Export `MAX_TEXT_LENGTH = 32000` (truncation limit for AI input, ~8000 tokens)

2. Create `src/app/api/profile/generate/route.ts` -- AI profile generation endpoint:
   - Authenticate with `await auth()`, return 401 if no userId
   - Accept JSON body: `{ documentKeys: string[] }`
   - Validate documentKeys is non-empty array of strings
   - For each documentKey:
     a. Download file from R2 using `GetObjectCommand` with `r2Client`
     b. Convert response body to Buffer
     c. Determine mimeType from the key extension (.pdf -> application/pdf, .docx -> application/vnd..., .doc -> application/msword, .txt -> text/plain)
     d. Call `extractTextFromBuffer(buffer, mimeType)`
     e. If extracted text is empty, skip this file (log warning)
   - Concatenate all extracted texts with `\n\n---\n\n` separator
   - Truncate to MAX_TEXT_LENGTH characters
   - If ALL documents yielded empty text, return `{ profile: null, warning: "No text could be extracted from the uploaded documents. They may be scanned images." }`
   - Call `anthropic.messages.create()` with:
     - model: `"claude-haiku-4-5-20251001"`
     - max_tokens: 2048
     - System prompt: "You are an expert at analyzing company documents for UK government procurement. Extract structured company intelligence from the provided documents."
     - User message: prompt asking to analyze documents and extract structured profile (company name, summary of 2-3 sentences, sectors, capabilities, keywords, certifications, ideal contract description, company size estimate, UK regions they operate in)
     - `output_config`: `{ format: { type: "json_schema", schema: { ... } } }`
     - JSON schema with properties: companyName (string), summary (string), sectors (array of strings), capabilities (array of strings), keywords (array of strings), certifications (array of strings), idealContractDescription (string), companySize (string), regions (array of strings)
     - Required: summary, sectors, capabilities, keywords, idealContractDescription
     - additionalProperties: false
   - IMPORTANT: Do NOT use zodOutputFormat or any Zod helpers from the Anthropic SDK -- use raw JSON schema to avoid Zod 4 compatibility issues (per research pitfall 7)
   - Parse the response: `const content = response.content[0]; if (content.type === "text") JSON.parse(content.text)`
   - Return `{ profile: parsedProfile }`
   - Wrap everything in try/catch, return 500 with error message on failure
  </action>
  <verify>
    Run `npm run build` -- should compile without errors. Verify:
    1. `src/lib/extract-text.ts` exports `extractTextFromBuffer` and `MAX_TEXT_LENGTH`
    2. `src/app/api/profile/generate/route.ts` exports POST handler
    3. Grep for "claude-haiku-4-5-20251001" in generate route
    4. Grep for "output_config" in generate route (structured output, not tool_choice)
    5. No imports of zodOutputFormat or zodToJsonSchema
  </verify>
  <done>
    Text extraction handles PDF (pdf-parse v3), DOCX (officeparser v6), and TXT with graceful fallback for empty/scanned documents. AI profile generation calls Claude Haiku 4.5 with structured JSON output, truncating input to ~8000 tokens. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Profile review/edit form, complete onboarding server action, and full wizard integration</name>
  <files>
    src/components/onboarding/profile-review.tsx
    src/components/onboarding/onboarding-wizard.tsx
    src/app/onboarding/_actions.ts
  </files>
  <action>
1. Create `src/app/onboarding/_actions.ts` -- Server action to complete onboarding:
   - "use server" directive
   - Import: auth and clerkClient from @clerk/nextjs/server, dbConnect from @/lib/mongodb, CompanyProfile from @/models/company-profile, CreditAccount and CreditTransaction from @/models/credit
   - Export `completeOnboarding(profileData: {...})`:
     - profileData shape: { companyName, summary, sectors, capabilities, keywords, certifications, idealContractDescription, companySize, regions, documentKeys, isAIGenerated }
     - Authenticate: `const { userId } = await auth()`, return `{ error: "Not authenticated" }` if no userId
     - `await dbConnect()`
     - Upsert CompanyProfile: `CompanyProfile.findOneAndUpdate({ userId }, { ...profileData, lastEditedAt: new Date() }, { upsert: true, new: true })`
     - Create credit account with signup bonus (IDEMPOTENT):
       ```
       const existing = await CreditAccount.findOne({ userId });
       if (!existing) {
         await CreditAccount.create({ userId, balance: 10, totalEarned: 10, totalSpent: 0 });
         await CreditTransaction.create({ userId, type: "SIGNUP_BONUS", amount: 10, description: "Welcome to TendHunt! 10 free credits.", balanceAfter: 10 });
       }
       ```
     - Mark onboarding complete in Clerk:
       ```
       const client = await clerkClient();
       await client.users.updateUser(userId, { publicMetadata: { onboardingComplete: true } });
       ```
     - Return `{ success: true }`
     - Wrap in try/catch, return `{ error: message }` on failure

2. Create `src/components/onboarding/profile-review.tsx` -- Editable profile form:
   - "use client" component
   - Props: `{ initialProfile: ProfileData, onSave: (data: ProfileData) => void, isSaving: boolean }`
   - ProfileData type: { companyName, summary, sectors, capabilities, keywords, certifications, idealContractDescription, companySize, regions }
   - Use local state initialized from initialProfile
   - Form fields (all editable):
     - Company Name: shadcn Input
     - Summary: shadcn Textarea (3 rows)
     - Sectors: Tag-style input (comma-separated, displayed as badges). Use a simple pattern: Input for typing, on Enter/comma add to array, display as Badge components with X to remove
     - Capabilities: Same tag-style input as sectors
     - Keywords: Same tag-style input
     - Certifications: Same tag-style input
     - Ideal Contract Description: shadcn Textarea (4 rows)
     - Company Size: shadcn Select or Input (e.g., "1-10", "11-50", "51-200", "201-1000", "1000+")
     - Regions: Same tag-style input
   - "Save & Continue to Dashboard" button at bottom (calls onSave with current form state, disabled when isSaving)
   - Show "(AI-generated)" badge next to section title if profile was AI-generated
   - Clean, professional layout with proper labels and spacing using shadcn form patterns

3. Update `src/components/onboarding/onboarding-wizard.tsx` -- Complete 3-step wizard:
   - Replace placeholder steps 2 and 3 with real implementations:
   - State additions: `isGenerating: boolean`, `profileData: ProfileData | null`, `isSaving: boolean`, `error: string | null`, `isAIGenerated: boolean`
   - Step 1 (Upload) -- already built in Plan 01, keep as-is:
     - DocumentDropzone with "Continue" and "Skip" buttons
     - "Continue" moves to step 2 (triggers AI generation)
     - "Skip" moves to step 3 with null profileData (empty form)
   - Step 2 (AI Generation):
     - On entering step 2, immediately call `/api/profile/generate` with documentKeys
     - Show loading state: centered Loader2 animate-spin icon, "Analyzing your documents..." text, maybe a subtle progress message
     - On success: set profileData from response, set isAIGenerated=true, auto-advance to step 3
     - On error or empty profile: show warning message, provide "Continue with empty profile" button to go to step 3
   - Step 3 (Review & Edit):
     - Render ProfileReview component with profileData (or empty defaults if null/skipped)
     - On save: call completeOnboarding server action with profile data + documentKeys + isAIGenerated flag
     - On success: call `window.location.href = "/dashboard"` to force full page reload (ensures Clerk session token refresh with updated publicMetadata)
       - NOTE: Do NOT use Next.js router.push() -- the Clerk session token with onboardingComplete metadata needs a full page load to refresh. The research explicitly calls out this pitfall (Pitfall 4). A full navigation forces the middleware to read the fresh token.
       - ALTERNATIVE: If using `useUser()` from Clerk, call `user.reload()` first, then `router.push("/dashboard")`. But `window.location.href` is simpler and guaranteed to work.
     - On error: show error toast or inline error message
   - Step indicator: update to reflect current step visually (filled circle for completed, outlined for current, dimmed for future)
  </action>
  <verify>
    Run `npm run build` -- should compile without errors. Verify:
    1. `src/app/onboarding/_actions.ts` exports `completeOnboarding`
    2. Grep for "SIGNUP_BONUS" in _actions.ts (credit creation)
    3. Grep for "publicMetadata" in _actions.ts (Clerk metadata update)
    4. Grep for "onboardingComplete" in _actions.ts
    5. `src/components/onboarding/profile-review.tsx` has form fields for all profile properties
    6. `src/components/onboarding/onboarding-wizard.tsx` handles all 3 steps
    7. Grep for "api/profile/generate" in onboarding-wizard.tsx (AI generation call)
    8. Grep for "completeOnboarding" in onboarding-wizard.tsx (server action call)
    9. Build passes with all routes
  </verify>
  <done>
    Complete 3-step onboarding wizard works end-to-end: (1) Upload documents via drag-and-drop to R2, (2) AI generates structured company profile via Claude Haiku 4.5, (3) User reviews/edits profile and saves. On save: CompanyProfile stored in MongoDB, 10 SIGNUP_BONUS credits created idempotently, Clerk publicMetadata updated with onboardingComplete=true, user redirected to dashboard. Skip flow allows manual profile entry without documents.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. Full onboarding flow: Upload -> Generate -> Review/Edit -> Save -> Dashboard redirect
3. AI profile generation uses Claude Haiku 4.5 with structured JSON output (output_config, not tool_choice)
4. Text extraction handles PDF, DOCX, TXT with graceful empty-document fallback
5. Credit bonus: CreditAccount with balance=10 and SIGNUP_BONUS transaction created idempotently
6. Clerk publicMetadata updated with onboardingComplete=true after save
7. Skip flow: user can skip upload and manually fill profile
8. All profile fields editable in review step
</verification>

<success_criteria>
- Documents uploaded in Plan 01 are downloaded from R2, text extracted, and sent to Claude Haiku 4.5
- AI returns structured profile matching the CompanyProfile schema
- Profile review form shows all fields pre-filled and editable
- Tag-style inputs work for array fields (sectors, capabilities, keywords, certifications, regions)
- completeOnboarding server action saves profile, creates credits, updates Clerk metadata
- Idempotent credit creation prevents duplicate signup bonuses
- After onboarding completion, middleware no longer redirects to /onboarding
- Skip upload flow produces empty profile form for manual entry
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-onboarding-company-profile/03-02-SUMMARY.md`
</output>
