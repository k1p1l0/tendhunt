---
phase: 03-onboarding-company-profile
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/r2.ts
  - src/lib/anthropic.ts
  - src/lib/env.ts
  - src/models/company-profile.ts
  - src/types/globals.d.ts
  - src/app/api/upload/presigned/route.ts
  - src/proxy.ts
  - src/app/onboarding/layout.tsx
  - src/app/onboarding/page.tsx
  - src/components/onboarding/document-dropzone.tsx
  - src/components/onboarding/upload-progress.tsx
  - src/components/onboarding/onboarding-wizard.tsx
  - .env.example
autonomous: true
user_setup:
  - service: cloudflare-r2
    why: "File storage for uploaded company documents"
    env_vars:
      - name: R2_ENDPOINT
        source: "Cloudflare Dashboard -> R2 -> Overview -> S3 API endpoint"
      - name: R2_ACCESS_KEY_ID
        source: "Cloudflare Dashboard -> R2 -> Manage R2 API Tokens -> Create API token"
      - name: R2_SECRET_ACCESS_KEY
        source: "Same token creation as R2_ACCESS_KEY_ID"
      - name: R2_BUCKET_NAME
        source: "Cloudflare Dashboard -> R2 -> Create bucket (name: tendhunt-documents)"
    dashboard_config:
      - task: "Create R2 bucket named 'tendhunt-documents'"
        location: "Cloudflare Dashboard -> R2 -> Create bucket"
      - task: "Configure CORS: AllowedOrigins [https://app.tendhunt.com, http://localhost:3000], AllowedMethods [GET, PUT], AllowedHeaders [Content-Type], ExposeHeaders [ETag]"
        location: "Cloudflare Dashboard -> R2 -> tendhunt-documents -> Settings -> CORS Policy"
  - service: anthropic
    why: "Claude Haiku 4.5 for AI company profile generation"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys -> Create Key"

must_haves:
  truths:
    - "User is redirected to /onboarding after signup if onboarding is not complete"
    - "User can drag-and-drop PDF, DOCX, DOC, TXT files onto a dropzone during onboarding"
    - "Uploaded files are stored in Cloudflare R2 via presigned URLs (server never handles file bytes)"
    - "Upload progress is visible for each file"
    - "User can see list of uploaded files with remove option"
  artifacts:
    - path: "src/lib/r2.ts"
      provides: "R2 S3-compatible client singleton"
      contains: "S3Client"
    - path: "src/lib/anthropic.ts"
      provides: "Anthropic client singleton"
      contains: "Anthropic"
    - path: "src/models/company-profile.ts"
      provides: "CompanyProfile Mongoose schema"
      contains: "companyProfileSchema"
    - path: "src/app/api/upload/presigned/route.ts"
      provides: "Presigned URL generation endpoint"
      exports: ["POST"]
    - path: "src/proxy.ts"
      provides: "Updated middleware with onboarding gate"
      contains: "onboardingComplete"
    - path: "src/components/onboarding/document-dropzone.tsx"
      provides: "Drag-and-drop file upload component"
      contains: "useDropzone"
    - path: "src/components/onboarding/onboarding-wizard.tsx"
      provides: "Multi-step onboarding wizard shell"
      contains: "step"
  key_links:
    - from: "src/components/onboarding/document-dropzone.tsx"
      to: "/api/upload/presigned"
      via: "fetch POST to get presigned URL, then PUT to R2"
      pattern: "fetch.*api/upload/presigned"
    - from: "src/proxy.ts"
      to: "/onboarding"
      via: "redirect if onboardingComplete is falsy"
      pattern: "onboardingComplete.*redirect.*onboarding"
    - from: "src/app/onboarding/page.tsx"
      to: "src/components/onboarding/onboarding-wizard.tsx"
      via: "renders wizard component"
      pattern: "OnboardingWizard"
---

<objective>
Set up the document upload infrastructure and onboarding gate so new users are routed to a multi-step onboarding wizard where they can drag-and-drop company documents that upload directly to Cloudflare R2.

Purpose: AUTH-02 requires document upload during onboarding. This plan builds the complete upload pipeline (R2 client, presigned URLs, dropzone UI) and the onboarding gate (middleware redirect, wizard shell) that Plan 02 will extend with AI profile generation and credit bonus.

Output: Working presigned URL upload flow with drag-and-drop UI inside an onboarding wizard, gated by Clerk middleware.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-onboarding-company-profile/03-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@src/proxy.ts
@src/lib/env.ts
@src/models/credit.ts
@src/app/(dashboard)/layout.tsx
@src/app/layout.tsx
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, create R2 + Anthropic clients, CompanyProfile model, env validation, session claims types</name>
  <files>
    package.json
    src/lib/r2.ts
    src/lib/anthropic.ts
    src/lib/env.ts
    src/models/company-profile.ts
    src/types/globals.d.ts
    .env.example
  </files>
  <action>
1. Install new dependencies:
   ```bash
   npm install react-dropzone @aws-sdk/client-s3 @aws-sdk/s3-request-presigner @anthropic-ai/sdk pdf-parse officeparser nanoid
   ```
   NOTE: `pdf-parse` v3 uses class-based API (`new PDFParse({ data: buffer })`). `officeparser` v6 returns AST (call `.toText()`).

2. Create `src/lib/r2.ts` -- R2 S3-compatible client singleton:
   ```typescript
   import { S3Client } from "@aws-sdk/client-s3";

   export const r2Client = new S3Client({
     region: "auto",
     endpoint: process.env.R2_ENDPOINT!,
     credentials: {
       accessKeyId: process.env.R2_ACCESS_KEY_ID!,
       secretAccessKey: process.env.R2_SECRET_ACCESS_KEY!,
     },
   });
   ```

3. Create `src/lib/anthropic.ts` -- Anthropic client singleton:
   ```typescript
   import Anthropic from "@anthropic-ai/sdk";

   export const anthropic = new Anthropic({
     apiKey: process.env.ANTHROPIC_API_KEY!,
   });
   ```

4. Update `src/lib/env.ts` -- Add R2 and Anthropic env vars to server schema:
   Add to `serverEnvSchema`:
   - `R2_ENDPOINT`: `z.string().url()` (must be a URL)
   - `R2_ACCESS_KEY_ID`: `z.string().min(1)`
   - `R2_SECRET_ACCESS_KEY`: `z.string().min(1)`
   - `R2_BUCKET_NAME`: `z.string().min(1)`
   - `ANTHROPIC_API_KEY`: `z.string().min(1)`

   Add these to the `serverEnv` parse block too. Add `NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL` default expectation to be `/onboarding`.

5. Create `src/models/company-profile.ts` -- CompanyProfile Mongoose schema:
   - `userId`: String, required, unique, indexed (Clerk user ID)
   - `companyName`: String, default ""
   - `summary`: String, default ""
   - `sectors`: [String]
   - `capabilities`: [String]
   - `keywords`: [String]
   - `certifications`: [String]
   - `idealContractDescription`: String, default ""
   - `companySize`: String, default ""
   - `regions`: [String]
   - `documentKeys`: [String] (R2 object keys)
   - `generatedAt`: Date
   - `lastEditedAt`: Date
   - `isAIGenerated`: Boolean, default false
   - timestamps: true
   - Export type `ICompanyProfile` via `InferSchemaType`
   - Use `mongoose.models.CompanyProfile || mongoose.model()` pattern for hot-reload safety

6. Create/update `src/types/globals.d.ts` -- Clerk session claims type:
   ```typescript
   declare global {
     interface CustomJwtSessionClaims {
       metadata: {
         onboardingComplete?: boolean;
       };
     }
   }
   export {};
   ```

7. Update `.env.example` -- Add new env vars with placeholder comments:
   ```
   # Cloudflare R2 Storage
   R2_ENDPOINT=https://ACCOUNT_ID.r2.cloudflarestorage.com
   R2_ACCESS_KEY_ID=
   R2_SECRET_ACCESS_KEY=
   R2_BUCKET_NAME=tendhunt-documents
   # Anthropic Claude API
   ANTHROPIC_API_KEY=
   ```
  </action>
  <verify>
    Run `npm run build` -- should compile without errors (R2/Anthropic clients are server-only, tree-shaken from client bundles). Verify CompanyProfile model file exists and has correct schema fields. Verify globals.d.ts has CustomJwtSessionClaims interface.
  </verify>
  <done>
    6 new npm packages installed. R2 client, Anthropic client, CompanyProfile model, session claims types, and updated env validation all exist. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Presigned URL API route, middleware onboarding gate, onboarding wizard with document dropzone</name>
  <files>
    src/app/api/upload/presigned/route.ts
    src/proxy.ts
    src/app/onboarding/layout.tsx
    src/app/onboarding/page.tsx
    src/components/onboarding/document-dropzone.tsx
    src/components/onboarding/upload-progress.tsx
    src/components/onboarding/onboarding-wizard.tsx
  </files>
  <action>
1. Create `src/app/api/upload/presigned/route.ts` -- Presigned URL generation endpoint:
   - Authenticate with `await auth()`, return 401 if no userId
   - Accept JSON body: `{ filename: string, contentType: string }`
   - Validate contentType is one of: application/pdf, application/vnd.openxmlformats-officedocument.wordprocessingml.document, application/msword, text/plain
   - Generate unique key: `documents/${userId}/${nanoid()}-${filename}`
   - Create presigned PUT URL using `getSignedUrl(r2Client, new PutObjectCommand({...}), { expiresIn: 3600 })`
   - Return `{ url, key }` as JSON

2. Update `src/proxy.ts` -- Add onboarding gate:
   - Add `isOnboardingRoute` matcher for `/onboarding(.*)`
   - Change logic from simple `auth.protect()` to:
     a. Public routes: pass through (no change)
     b. Get `{ userId, sessionClaims }` from `await auth()`
     c. Not authenticated on protected route: `return (await auth()).redirectToSignIn({ returnBackUrl: request.url })`
     d. On onboarding route: allow through (return NextResponse.next() or just return)
     e. Check `sessionClaims?.metadata?.onboardingComplete` -- if falsy, redirect to `/onboarding`
     f. Otherwise: pass through
   - CRITICAL: Import `NextResponse` from `next/server`
   - CRITICAL: The auth() call pattern in Clerk middleware is `const { userId, sessionClaims } = await auth()` then if not userId, call `const authObj = await auth(); return authObj.redirectToSignIn(...)` -- check Clerk docs pattern for exact redirect approach

3. Create `src/app/onboarding/layout.tsx` -- Onboarding layout:
   - Server component
   - Authenticate with `await auth()`, redirect to `/sign-in` if no userId
   - Check if `sessionClaims?.metadata?.onboardingComplete === true` -- if so, redirect to `/dashboard`
   - Render minimal layout: centered container, max-w-2xl, with TendHunt branding header
   - No sidebar (onboarding is separate from dashboard)

4. Create `src/components/onboarding/document-dropzone.tsx` -- Drag-and-drop upload:
   - "use client" component
   - Use `useDropzone` from react-dropzone
   - Accept: PDF (.pdf), DOCX (.docx), DOC (.doc), TXT (.txt)
   - maxFiles: 10, maxSize: 10MB (10 * 1024 * 1024)
   - On drop: for each file, fetch presigned URL from `/api/upload/presigned`, then PUT file to R2
   - Track upload state per file: { file, key, status: "pending" | "uploading" | "done" | "error", progress: number }
   - Use XMLHttpRequest for upload to track progress via `xhr.upload.onprogress`
   - Show dropzone area with dashed border, icon (Upload from lucide-react), and helper text
   - When isDragActive: change border color and text
   - Display uploaded files list below dropzone using UploadProgress component
   - Props: `onFilesChange: (keys: string[]) => void` -- called whenever the list of successfully uploaded file keys changes
   - Support file removal: remove from list and call onFilesChange with updated keys

5. Create `src/components/onboarding/upload-progress.tsx` -- Per-file progress display:
   - "use client" component
   - Props: `files: UploadedFile[]`, `onRemove: (index: number) => void`
   - For each file: show filename, file size (human readable), progress bar (shadcn Progress or custom), status icon (CheckCircle2 for done, AlertCircle for error, Loader2 animate-spin for uploading)
   - Remove button (X icon) only shown when status is "done" or "error"

6. Create `src/components/onboarding/onboarding-wizard.tsx` -- Multi-step wizard shell:
   - "use client" component
   - State: `step` (1 | 2 | 3), `documentKeys` (string[]), `isGenerating` (boolean), `profileData` (null or profile object)
   - Step 1: Upload Documents
     - Render DocumentDropzone
     - "Continue" button (enabled when at least 1 file uploaded)
     - "Skip" button (allows proceeding without documents)
   - Step 2: placeholder div with text "Generating profile..." (Plan 02 will implement)
   - Step 3: placeholder div with text "Review profile" (Plan 02 will implement)
   - Step indicator at top: 3 circles/dots showing current step with labels ("Upload", "Generate", "Review")
   - Use shadcn Card component for the wizard container
   - Use shadcn Button for navigation

7. Create `src/app/onboarding/page.tsx` -- Onboarding page:
   - Server component that renders OnboardingWizard client component
   - Simple wrapper: `<OnboardingWizard />`
  </action>
  <verify>
    Run `npm run build` -- should compile without errors. Verify:
    1. `/api/upload/presigned` route file exists with POST export
    2. `proxy.ts` has onboarding gate logic with `onboardingComplete` check
    3. `/onboarding` page renders the wizard
    4. DocumentDropzone has react-dropzone integration
    5. Build output shows /onboarding route in pages list
  </verify>
  <done>
    Presigned URL API route generates R2 upload URLs. Middleware redirects unauthenticated users to sign-in and non-onboarded users to /onboarding. Onboarding wizard shell renders step 1 (document upload) with drag-and-drop dropzone, per-file progress tracking, and file removal. Steps 2-3 are placeholder shells ready for Plan 02.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. New route `/api/upload/presigned` appears in build output
3. New route `/onboarding` appears in build output
4. `src/proxy.ts` contains onboarding gate logic (grep for "onboardingComplete")
5. `src/models/company-profile.ts` has all required schema fields (grep for "companyProfileSchema")
6. `src/components/onboarding/document-dropzone.tsx` uses react-dropzone (grep for "useDropzone")
7. `.env.example` has R2 and Anthropic placeholders
</verification>

<success_criteria>
- All 6 new npm packages installed (react-dropzone, @aws-sdk/client-s3, @aws-sdk/s3-request-presigner, @anthropic-ai/sdk, pdf-parse, officeparser, nanoid)
- R2 and Anthropic client singletons exist
- CompanyProfile Mongoose model defined with all fields from research
- Environment variables validated for R2 and Anthropic
- Presigned URL endpoint generates valid PUT URLs for R2
- Middleware gates unauthenticated users to /sign-in and non-onboarded users to /onboarding
- Onboarding wizard shows step indicator and document upload dropzone
- Document dropzone accepts PDF, DOCX, DOC, TXT with 10MB limit
- Upload progress visible per file
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-onboarding-company-profile/03-01-SUMMARY.md`
</output>
