---
phase: 03-onboarding-company-profile
plan: 03
type: execute
wave: 1
depends_on: ["03-01", "03-02"]
files_modified:
  - src/models/company-profile.ts
  - src/lib/fetch-web-content.ts
  - src/lib/extract-web-info.ts
  - src/app/api/profile/generate/route.ts
  - src/components/onboarding/company-info-form.tsx
  - src/components/onboarding/onboarding-wizard.tsx
  - src/components/onboarding/profile-review.tsx
  - src/app/onboarding/_actions.ts
autonomous: true
---

<objective>
Add company info fields (name, website, address, social links) to onboarding step 1 and enrich AI profile generation by fetching/parsing web content via Claude API.

Purpose: Currently step 1 only has a document dropzone. Adding company info fields lets users provide their website and social links, which the AI generation endpoint fetches, parses via Claude Haiku, and includes as additional context — producing a much richer profile even without document uploads.

Output: Step 1 shows company info form above dropzone. AI generation fetches website/social content, extracts via Claude, and combines with document text for profile generation. New fields (website, address, socialLinks) saved to CompanyProfile.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-onboarding-company-profile/03-01-SUMMARY.md
@.planning/phases/03-onboarding-company-profile/03-02-SUMMARY.md
@src/models/company-profile.ts
@src/lib/anthropic.ts
@src/lib/extract-text.ts
@src/app/api/profile/generate/route.ts
@src/components/onboarding/onboarding-wizard.tsx
@src/components/onboarding/document-dropzone.tsx
@src/components/onboarding/profile-review.tsx
@src/app/onboarding/_actions.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema update, web content fetching, Claude-based extraction, and API route enrichment</name>
  <files>
    src/models/company-profile.ts
    src/lib/fetch-web-content.ts
    src/lib/extract-web-info.ts
    src/app/api/profile/generate/route.ts
    src/app/onboarding/_actions.ts
  </files>
  <action>
1. Update `src/models/company-profile.ts` -- Add 3 new fields after `companyName`:
   - `website`: { type: String, default: "" }
   - `address`: { type: String, default: "" }
   - `socialLinks`: [{ platform: { type: String, enum: ["linkedin", "twitter", "facebook", "instagram", "other"] }, url: { type: String } }]
   - Add these to the ICompanyProfile type via InferSchemaType (already auto-inferred)

2. Create `src/lib/fetch-web-content.ts` -- Server-side URL fetcher with HTML cleaning:
   - `MAX_HTML_SIZE = 500_000` (500KB limit)
   - `FETCH_TIMEOUT_MS = 5_000` (5 second timeout)
   - Export `fetchWebContent(url: string): Promise<string | null>`
     - Use native `fetch` with AbortController timeout
     - Set `User-Agent: "TendHunt-Bot/1.0"` and `Accept: "text/html"` headers
     - Return null on any failure (4xx/5xx, timeout, size exceeded)
     - Call `stripHtmlNoise(html)` to clean content
   - `stripHtmlNoise(html: string): string` -- local function
     - Remove `<script>`, `<style>`, `<nav>`, `<footer>` blocks via regex
     - Remove HTML comments
     - Strip remaining HTML tags
     - Collapse whitespace
     - Trim result

3. Create `src/lib/extract-web-info.ts` -- Claude-based web content extraction:
   - `MAX_WEB_CONTENT_LENGTH = 15_000` (truncation limit for extraction input)
   - Export `extractWebInfo(content: string, sourceLabel: string): Promise<string | null>`
     - Return null if content is empty or < 50 chars
     - Truncate content to MAX_WEB_CONTENT_LENGTH
     - Call `anthropic.messages.create()` with:
       - model: "claude-haiku-4-5-20251001"
       - max_tokens: 1024
       - system: "You extract concise company information from web content. Output only the relevant company facts, services, and capabilities. Be brief and factual."
       - user message: "Extract key company information from this {sourceLabel} content. Focus on: what the company does, services offered, industries served, certifications, locations, and team size. Ignore navigation, ads, and boilerplate.\n\nContent:\n{truncated}"
     - Return the text response if > 20 chars, else null
     - Wrap in try/catch, return null on failure (log warning)
   - NOTE: This returns plain text (not JSON) because it feeds into the main profile generation prompt as additional context

4. Update `src/app/api/profile/generate/route.ts` -- Major update to accept companyInfo and fetch web content:
   - Extend request body type: `{ documentKeys?: string[], companyInfo?: { companyName?: string, website?: string, address?: string, socialLinks?: Array<{ platform: string, url: string }> } }`
   - Relax validation: require either documentKeys (non-empty) OR companyInfo with at least companyName or website
   - After document text extraction, run web content fetching/extraction IN PARALLEL:
     - If companyInfo.website provided: fetchWebContent(website) → extractWebInfo(result, "company website")
     - For each social link with a URL: fetchWebContent(url) → extractWebInfo(result, "{platform} profile")
     - Use Promise.allSettled for resilience
   - Build combined context string from parts:
     a. Company metadata (name, address) if provided
     b. Document text (existing logic)
     c. Web extractions (website + social profiles)
   - Enforce MAX_TEXT_LENGTH on the combined context
   - Update the Claude user prompt to mention it may include documents, website content, and social profiles
   - Add `website`, `address`, `socialLinks` to the output_config JSON schema:
     - website: { type: "string" }
     - address: { type: "string" }
     - socialLinks: { type: "array", items: { type: "object", properties: { platform: { type: "string" }, url: { type: "string" } }, required: ["platform", "url"] } }
   - Handle edge case: if ALL sources yield no content, return { profile: null, warning: "..." }

5. Update `src/app/onboarding/_actions.ts` -- Extend the profileData parameter type to include:
   - website: string
   - address: string
   - socialLinks: Array<{ platform: string; url: string }>
   - The existing findOneAndUpdate spread already handles persistence
  </action>
  <verify>
    Run `npm run build` -- should compile without errors. Verify:
    1. CompanyProfile schema has website, address, socialLinks fields
    2. fetch-web-content.ts exports fetchWebContent
    3. extract-web-info.ts exports extractWebInfo with Claude Haiku call
    4. /api/profile/generate accepts companyInfo and handles web fetching
    5. No imports of zodOutputFormat (use raw JSON schema only)
  </verify>
  <done>
    CompanyProfile schema extended. Web content fetching and Claude-based extraction utilities created. AI profile generation endpoint accepts company info, fetches website/social content in parallel, and includes enriched context in Claude prompt. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Company info form component, wizard integration, and profile review extension</name>
  <files>
    src/components/onboarding/company-info-form.tsx
    src/components/onboarding/onboarding-wizard.tsx
    src/components/onboarding/profile-review.tsx
  </files>
  <action>
1. Create `src/components/onboarding/company-info-form.tsx` -- Company info form component:
   - "use client" component
   - Export `CompanyInfo` interface: { companyName: string, website: string, address: string, socialLinks: Array<{ platform: string, url: string }> }
   - Export `CompanyInfoForm` component with props: { value: CompanyInfo, onChange: (v: CompanyInfo) => void }
   - Platform options: LinkedIn, X / Twitter, Facebook, Instagram, Other
   - Layout:
     - Company Name: Label + Input (full width)
     - Website URL: Label + Input type="url" placeholder="https://yourcompany.com" (full width)
     - Address: Label + Input placeholder="Company address" (full width)
     - Social Links section: Label + dynamic rows
       - Each row: platform Select (1/3 width) + URL Input (2/3 width) + X remove button
       - "Add social link" button below (max 5 links)
   - Use shadcn components: Input, Label, Button, Select, SelectContent, SelectItem, SelectTrigger, SelectValue
   - Use lucide-react icons: Plus, X
   - Clean spacing with space-y-4 between fields

2. Update `src/components/onboarding/onboarding-wizard.tsx` -- Add company info state and restructure step 1:
   - Import CompanyInfoForm and CompanyInfo type
   - Add state: `const [companyInfo, setCompanyInfo] = useState<CompanyInfo>({ companyName: "", website: "", address: "", socialLinks: [] })`
   - Step 1 restructure:
     - Change card title to "Tell Us About Your Company"
     - Update description to mention both company info and documents
     - Render CompanyInfoForm above the dropzone
     - Add a visual separator (Separator component or hr with text) between form and dropzone
     - Add small text above dropzone: "Upload documents for additional AI analysis (optional)"
     - "Continue" button: enabled if documentKeys.length > 0 OR companyInfo.companyName.trim() OR companyInfo.website.trim()
   - Step 2 (AI generation):
     - Update fetch body: `{ documentKeys, companyInfo: { companyName: companyInfo.companyName, website: companyInfo.website, address: companyInfo.address, socialLinks: companyInfo.socialLinks.filter(sl => sl.url.trim()) } }`
     - Update useEffect condition: allow generation when step === 2 and (documentKeys.length > 0 or companyInfo has content) -- not just when documents exist
     - Update loading text: "Analyzing your documents and company information..." or "Analyzing your company information..." if no documents
   - Step 3 (profile data mapping):
     - When receiving API response, merge new fields: website from response or companyInfo.website, address from response or companyInfo.address, socialLinks from response or companyInfo.socialLinks
   - handleSave: include website, address, socialLinks in the data passed to completeOnboarding
   - Update EMPTY_PROFILE constant to include: website: "", address: "", socialLinks: []

3. Update `src/components/onboarding/profile-review.tsx` -- Extend with new fields:
   - Extend ProfileData interface: add website: string, address: string, socialLinks: Array<{ platform: string, url: string }>
   - Add form fields after Company Name in the review form:
     - Website URL: Label + Input type="url"
     - Address: Label + Input
     - Social Links: dynamic rows with platform Select + URL Input + remove/add (same pattern as company-info-form but in review context)
   - Update default/empty profile handling to include new fields
  </action>
  <verify>
    Run `npm run build` -- should compile without errors. Verify:
    1. company-info-form.tsx exports CompanyInfoForm and CompanyInfo
    2. onboarding-wizard.tsx has companyInfo state and passes it to API
    3. Step 1 renders CompanyInfoForm above DocumentDropzone
    4. "Continue" button works with just company name/website (no documents)
    5. profile-review.tsx has website, address, socialLinks fields
    6. Build output shows all onboarding routes
  </verify>
  <done>
    Company info form with name, website, address, and dynamic social links renders above the document dropzone in step 1. Wizard passes company info to AI generation endpoint. Profile review shows and allows editing all new fields. "Continue" works with either documents or company info. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. Step 1 shows company info fields (name, website, address, social links) above document dropzone
3. "Continue" button enabled with just company name or website (no documents needed)
4. AI generation endpoint accepts companyInfo, fetches website content, parses via Claude
5. Generated profile includes website, address, socialLinks from AI analysis
6. Profile review form shows and allows editing website, address, social links
7. CompanyProfile in MongoDB has new fields after save
</verification>

<success_criteria>
- Company info form with 4 field types (text, url, text, dynamic social rows) renders cleanly in step 1
- Web content fetcher handles timeouts, errors, and oversized pages gracefully
- Claude extraction produces concise company summaries from webpage content
- AI profile generation combines document text + web extractions + company metadata
- Social media fetch failures are silent (LinkedIn/X login walls expected)
- Profile review form editable for all new fields
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-onboarding-company-profile/03-03-SUMMARY.md`
</output>
