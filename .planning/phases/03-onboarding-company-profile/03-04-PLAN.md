---
phase: 03-onboarding-company-profile
plan: 04
type: execute
wave: 1
depends_on: ["03-03"]
files_modified:
  - src/lib/linkedin-scraper.ts
  - src/app/api/profile/generate/route.ts
  - src/components/onboarding/company-info-form.tsx
  - src/components/onboarding/onboarding-wizard.tsx
  - src/components/onboarding/profile-review.tsx
  - src/models/company-profile.ts
autonomous: true
---

<objective>
Replace generic social links with LinkedIn-only input and use Apify actors to scrape LinkedIn company profile data + recent posts, feeding both into the AI profile generation prompt.

Purpose: LinkedIn blocks server-side fetches (login walls), so the current fetchWebContent returns null for LinkedIn URLs. Using Apify actors provides reliable access to company description, industry, employee count, specialties AND recent post content â€” giving Claude much richer context for profile generation.

Output: Onboarding step 1 has a single "LinkedIn Company URL" field (instead of multi-platform social links). When provided, the API route calls two Apify actors in parallel: dev_fusion/Linkedin-Company-Scraper (company profile) and harvestapi/linkedin-company-posts (last 5 posts). Both results are included in the Claude profile generation prompt.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-onboarding-company-profile/03-03-SUMMARY.md
@src/app/api/profile/generate/route.ts
@src/lib/fetch-web-content.ts
@src/lib/extract-web-info.ts
@src/components/onboarding/company-info-form.tsx
@src/components/onboarding/onboarding-wizard.tsx
@src/components/onboarding/profile-review.tsx
@src/models/company-profile.ts
@src/app/onboarding/_actions.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: LinkedIn scraper utility using Apify actors and API route update</name>
  <files>
    src/lib/linkedin-scraper.ts
    src/app/api/profile/generate/route.ts
    src/models/company-profile.ts
    src/lib/env.ts
    src/app/onboarding/_actions.ts
    .env.example
  </files>
  <action>
1. Update `.env.example` -- Add Apify API token:
   ```
   # Apify (LinkedIn scraping)
   APIFY_API_TOKEN=
   ```

2. Update `src/lib/env.ts` -- Add `APIFY_API_TOKEN` to server env schema:
   - `APIFY_API_TOKEN`: `z.string().min(1)` (required for LinkedIn scraping)

3. Update `src/models/company-profile.ts` -- Replace `socialLinks` array with `linkedinUrl`:
   - Remove `socialLinks` field entirely
   - Add `linkedinUrl`: { type: String, default: "" }
   - Keep `website` and `address` as-is

4. Update `src/app/onboarding/_actions.ts` -- Update ProfileData type:
   - Remove `socialLinks` field
   - Add `linkedinUrl: string`

5. Create `src/lib/linkedin-scraper.ts` -- LinkedIn data extraction via Apify:
   - Export interface `LinkedInCompanyData`:
     ```typescript
     export interface LinkedInCompanyData {
       profile: string | null;  // formatted company profile text
       posts: string | null;    // formatted recent posts text
     }
     ```
   - Export `scrapeLinkedInCompany(linkedinUrl: string): Promise<LinkedInCompanyData>`
   - Implementation:
     a. Validate URL contains "linkedin.com/company/"
     b. Call TWO Apify actors in parallel via their HTTP API:

     **Actor 1: Company Profile** (`dev_fusion/Linkedin-Company-Scraper`)
     ```
     POST https://api.apify.com/v2/acts/dev_fusion~Linkedin-Company-Scraper/run-sync-get-dataset-items
     Headers: { Authorization: Bearer APIFY_API_TOKEN, Content-Type: application/json }
     Body: { "profileUrls": [linkedinUrl] }
     Timeout: 30 seconds (these actors can take 10-20s)
     ```
     - Parse response: extract companyName, industry, description, specialities, employeeCount, website, headquartersLocation, foundedYear, followerCount
     - Format as readable text block:
       ```
       Company: {name}
       Industry: {industry}
       Employees: {employeeCount}
       Founded: {foundedYear}
       HQ: {headquartersLocation}
       Followers: {followerCount}
       Website: {website}
       Specialties: {specialities}
       Description: {description}
       ```

     **Actor 2: Recent Posts** (`harvestapi/linkedin-company-posts`)
     ```
     POST https://api.apify.com/v2/acts/harvestapi~linkedin-company-posts/run-sync-get-dataset-items
     Headers: { Authorization: Bearer APIFY_API_TOKEN, Content-Type: application/json }
     Body: { "targetUrls": [linkedinUrl], "maxPosts": 5, "scrapeReactions": false, "scrapeComments": false }
     Timeout: 30 seconds
     ```
     - Parse response: extract content, engagement (likes, comments, shares), postedAt from each post
     - Format as readable text block:
       ```
       Recent LinkedIn Posts:

       Post 1 ({date}): {content} [Likes: {likes}, Comments: {comments}]
       Post 2 ({date}): {content} [Likes: {likes}, Comments: {comments}]
       ...
       ```
     - Truncate each post content to 500 chars max

     c. Use Promise.allSettled for both calls -- if one fails, the other still provides data
     d. Return { profile, posts } -- each is a formatted text string or null on failure
     e. Wrap everything in try/catch, log warnings on failure, never throw

6. Update `src/app/api/profile/generate/route.ts` -- Replace social links fetching with LinkedIn scraping:
   - Update CompanyInfo interface: remove `socialLinks`, add `linkedinUrl?: string`
   - Update request body validation: accept `linkedinUrl` instead of `socialLinks`
   - Replace the social links web fetching block with LinkedIn scraping:
     - If `companyInfo.linkedinUrl` is provided:
       ```typescript
       const linkedInData = await scrapeLinkedInCompany(companyInfo.linkedinUrl);
       ```
     - Add LinkedIn profile data to contextParts if available:
       ```typescript
       if (linkedInData.profile) {
         contextParts.push(`--- LinkedIn Company Profile ---\n${linkedInData.profile}`);
       }
       if (linkedInData.posts) {
         contextParts.push(`--- LinkedIn Recent Activity ---\n${linkedInData.posts}`);
       }
       ```
   - Keep the website fetching via fetchWebContent (unchanged)
   - Remove the social links iteration loop entirely
   - Update the output_config JSON schema: remove `socialLinks`, add `linkedinUrl: { type: "string" }`
   - Update the Claude prompt to mention LinkedIn profile and posts as data sources
  </action>
  <verify>
    Run `npm run build` -- should compile without errors. Verify:
    1. linkedin-scraper.ts exports scrapeLinkedInCompany
    2. /api/profile/generate accepts linkedinUrl instead of socialLinks
    3. CompanyProfile schema has linkedinUrl instead of socialLinks
    4. No references to socialLinks remain in the API route or models
    5. output_config schema has linkedinUrl, no socialLinks
  </verify>
  <done>
    LinkedIn scraper utility calls two Apify actors in parallel (company profile + recent posts). API route uses LinkedIn data instead of generic social link fetching. CompanyProfile schema simplified to linkedinUrl string field. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Simplify onboarding UI to LinkedIn-only and update profile review</name>
  <files>
    src/components/onboarding/company-info-form.tsx
    src/components/onboarding/onboarding-wizard.tsx
    src/components/onboarding/profile-review.tsx
  </files>
  <action>
1. Update `src/components/onboarding/company-info-form.tsx` -- Replace social links with LinkedIn URL:
   - Update CompanyInfo interface:
     - Remove `socialLinks: Array<{ platform: string; url: string }>`
     - Add `linkedinUrl: string`
   - Remove all social links UI (platform Select, dynamic rows, add/remove buttons)
   - Remove PLATFORMS constant
   - Remove Select, SelectContent, SelectItem, SelectTrigger, SelectValue imports
   - Add a single LinkedIn URL input field after Address:
     - Label: "LinkedIn Company Page"
     - Input type="url" placeholder="https://linkedin.com/company/your-company"
     - Full width, same pattern as Website URL field
   - Keep Company Name, Website URL, Address fields unchanged
   - The form should now have exactly 4 fields: Company Name, Website URL, Address, LinkedIn URL

2. Update `src/components/onboarding/onboarding-wizard.tsx` -- Update state and API call:
   - Update companyInfo state initial value:
     - Remove `socialLinks: []`
     - Add `linkedinUrl: ""`
   - Update EMPTY_PROFILE:
     - Remove `socialLinks: []`
     - Add `linkedinUrl: ""`
   - Update the fetch body in step 2:
     - Remove `socialLinks` from companyInfo payload
     - Add `linkedinUrl: companyInfo.linkedinUrl`
   - Update profile data mapping in step 3:
     - Map `linkedinUrl` from response or companyInfo
     - Remove socialLinks mapping
   - Update canContinue check (should already work since it checks companyName/website)

3. Update `src/components/onboarding/profile-review.tsx` -- Replace socialLinks with linkedinUrl:
   - Update ProfileData interface:
     - Remove `socialLinks: Array<{ platform: string; url: string }>`
     - Add `linkedinUrl: string`
   - Remove the social links dynamic rows UI from the review form
   - Add a single LinkedIn URL input field (Label + Input type="url") after Address
   - Same pattern as Website URL field in the review form
   - Update any default/empty profile handling
  </action>
  <verify>
    Run `npm run build` -- should compile without errors. Verify:
    1. company-info-form.tsx exports CompanyInfo with linkedinUrl (no socialLinks)
    2. company-info-form.tsx has exactly 4 fields: Company Name, Website URL, Address, LinkedIn URL
    3. onboarding-wizard.tsx passes linkedinUrl to API (no socialLinks)
    4. profile-review.tsx has linkedinUrl field (no socialLinks)
    5. No references to socialLinks remain in any onboarding component
    6. Build output shows /onboarding route
  </verify>
  <done>
    Onboarding step 1 shows 4 clean fields: Company Name, Website URL, Address, LinkedIn Company URL. Profile review has matching editable LinkedIn URL field. Social links dynamic rows removed entirely. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. Step 1 shows: Company Name, Website URL, Address, LinkedIn Company URL (no social links)
3. When LinkedIn URL is provided, API calls Apify actors for company profile + posts
4. AI generation includes LinkedIn data in Claude prompt
5. Profile review shows editable LinkedIn URL
6. CompanyProfile in MongoDB has linkedinUrl field
7. No references to socialLinks remain anywhere
</verification>

<success_criteria>
- Apify actors called in parallel with 30s timeout and graceful failure handling
- LinkedIn company profile data (description, industry, size, specialties) included in Claude prompt
- Recent posts (last 5, content + engagement) included in Claude prompt
- Single LinkedIn URL input replaces multi-platform social links
- Both Apify actor failures handled silently (website content still works as fallback)
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-onboarding-company-profile/03-04-SUMMARY.md`
</output>
