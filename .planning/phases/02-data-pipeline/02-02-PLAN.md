---
phase: 02-data-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - scripts/ingest-cf.ts
autonomous: true

must_haves:
  truths:
    - "Contracts Finder notices are ingested and normalized to the same unified Contract schema as Find a Tender"
    - "Each ingested Contracts Finder contract has source set to CONTRACTS_FINDER with a valid sourceUrl"
    - "Running the ingestion script again does not create duplicate records (idempotent upsert)"
    - "The contracts collection contains records from BOTH sources after both scripts have run"
  artifacts:
    - path: "scripts/ingest-cf.ts"
      provides: "Contracts Finder OCDS API ingestion script"
      min_lines: 40
  key_links:
    - from: "scripts/ingest-cf.ts"
      to: "scripts/lib/ocds-mapper.ts"
      via: "mapOcdsToContract import (same mapper as FaT)"
      pattern: "import.*mapOcdsToContract.*from"
    - from: "scripts/ingest-cf.ts"
      to: "scripts/lib/api-client.ts"
      via: "fetchAllReleases import (same client as FaT)"
      pattern: "import.*fetchAllReleases.*from"
    - from: "scripts/ingest-cf.ts"
      to: "src/models/contract.ts"
      via: "Contract model for bulkWrite upsert"
      pattern: "Contract\\.bulkWrite"
---

<objective>
Create the Contracts Finder OCDS API ingestion script that fetches UK below-threshold procurement contract notices and upserts them into MongoDB using the shared library from Plan 02-01.

Purpose: Contracts Finder is the second UK procurement data source, covering below-threshold procurements that Find a Tender misses. Using the same OCDS mapper ensures a unified schema across both sources, fulfilling DATA-02 and DATA-06.
Output: Runnable `npm run ingest:cf` that populates the contracts collection with Contracts Finder data alongside existing Find a Tender data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-pipeline/02-RESEARCH.md
@.planning/phases/02-data-pipeline/02-01-SUMMARY.md
@src/models/contract.ts
@scripts/lib/db.ts
@scripts/lib/api-client.ts
@scripts/lib/ocds-mapper.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Contracts Finder ingestion script</name>
  <files>
    scripts/ingest-cf.ts
  </files>
  <action>
**scripts/ingest-cf.ts** -- Contracts Finder OCDS API ingestion:
- Import `connectDB`, `disconnectDB` from `./lib/db`
- Import `fetchAllReleases` from `./lib/api-client`
- Import `mapOcdsToContract` from `./lib/ocds-mapper`
- Import `Contract` from `../../src/models/contract` (relative path, not @/)
- Main function flow:
  1. Call `connectDB()`
  2. Set `baseUrl = "https://www.contractsfinder.service.gov.uk/Published/Notices/OCDS/Search"`
  3. Set params: `stages: "tender,award"`, `publishedFrom: 60 days ago in ISO format (YYYY-MM-DDTHH:MM:SS)`, `publishedTo: now in ISO format`
  4. Call `fetchAllReleases(baseUrl, params, 300)` to get up to 300 releases
     - Note: Use 60-day window (wider than FaT's 30 days) because Contracts Finder has more below-threshold notices and a wider date range may be needed to get 200+ results
  5. Map each release through `mapOcdsToContract(release, "CONTRACTS_FINDER")`
  6. Filter out contracts where title is missing or "Untitled" AND description is empty
  7. Build `bulkWrite` operations array with `updateOne` + `upsert: true`, filter by `{ source: doc.source, noticeId: doc.noticeId }`
  8. Execute `Contract.bulkWrite(ops, { ordered: false })`
  9. Log summary: `Fetched: X releases, Mapped: Y contracts, Upserted: Z, Updated: W`
  10. Call `disconnectDB()`
- Wrap everything in try/catch with finally for disconnectDB
- Add timing with console.time/timeEnd

**Key differences from ingest-fat.ts:**
- Different base URL (Contracts Finder vs Find a Tender)
- Date params use `publishedFrom`/`publishedTo` (not `updatedFrom`/`updatedTo`)
- 60-day lookback window (Contracts Finder needs a wider window for sufficient volume)
- Stages include `"tender,award"` (Contracts Finder has more award notices worth capturing)
- Source is `"CONTRACTS_FINDER"`
- Rate limit handling: Contracts Finder returns 403 with no Retry-After header -- the api-client.ts from Plan 02-01 should already handle this with a 300s default. If it does not, update api-client.ts to default to 300s when Retry-After is missing on 403.

**Contracts Finder OCDS data quality handling:**
- Contracts Finder has documented issues: empty buyer names, missing classifications, unrealistic dates
- The mapper from Plan 02-01 already handles these with fallbacks ("Unknown" buyer, empty CPV array, etc.)
- If the response format differs from expected OCDS structure (e.g., releases are nested differently), adapt the parsing. Log the first response to inspect structure before bulk processing.
- Log a warning for any releases that fail to map (catch per-release errors, don't let one bad record kill the batch)

**CRITICAL: Test the script:**
1. Run `npm run ingest:cf`
2. Verify it connects, fetches, and upserts
3. Check MongoDB: count contracts with `source: "CONTRACTS_FINDER"`
4. Verify total collection now has contracts from BOTH sources
5. Run again to verify idempotency
  </action>
  <verify>
`npm run ingest:cf` completes successfully. MongoDB contracts collection contains documents with `source: "CONTRACTS_FINDER"`. The collection also retains existing `source: "FIND_A_TENDER"` documents. Running again is idempotent. Each CF contract has title, buyerName, noticeId, sourceUrl.
  </verify>
  <done>
Contracts Finder ingestion works end-to-end: fetches real below-threshold procurement notices, normalizes them to the same Contract schema as Find a Tender, and upserts idempotently. The contracts collection now has data from both UK procurement sources with proper source attribution.
  </done>
</task>

</tasks>

<verification>
After task completes:
1. `ls scripts/` shows ingest-cf.ts
2. `npm run ingest:cf` fetches and upserts contracts from Contracts Finder
3. MongoDB contracts collection has documents with BOTH source="FIND_A_TENDER" AND source="CONTRACTS_FINDER"
4. Total contract count is 200-500+ across both sources
5. Re-running either script is idempotent
</verification>

<success_criteria>
- Contracts Finder notices ingested and normalized to same unified Contract schema
- Each CF contract has source="CONTRACTS_FINDER" and valid sourceUrl
- Both sources coexist in the contracts collection
- Script is idempotent (safe to re-run)
- Combined contract count meets the 200-500 target
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-pipeline/02-02-SUMMARY.md`
</output>
