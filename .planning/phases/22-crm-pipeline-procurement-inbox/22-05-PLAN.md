---
phase: 22-crm-pipeline-procurement-inbox
plan: 05
type: execute
wave: 3
depends_on: ["22-02"]
files_modified:
  - apps/web/src/models/auto-send-rule.ts
  - apps/web/src/app/api/inbox/auto-rules/route.ts
  - apps/web/src/app/api/inbox/auto-rules/[id]/route.ts
  - apps/web/src/components/inbox/auto-rules-dialog.tsx
  - apps/web/src/components/scanners/grid/header-menu.tsx
  - apps/web/src/app/api/scanners/[id]/score-column/route.ts
autonomous: true

must_haves:
  truths:
    - "User can configure auto-send rules per AI column in scanner header menu"
    - "Auto-send rules specify a score threshold above which entities auto-create inbox cards"
    - "Scoring endpoint checks auto-send rules after each entity is scored and creates cards for qualifying scores"
    - "User can view, toggle, and delete existing auto-send rules"
    - "Auto-created cards have addedBy='auto_rule' attribution on the inbox board"
  artifacts:
    - path: "apps/web/src/models/auto-send-rule.ts"
      provides: "AutoSendRule Mongoose model"
      contains: "autoSendRuleSchema"
    - path: "apps/web/src/app/api/inbox/auto-rules/route.ts"
      provides: "GET list rules, POST create rule"
      exports: ["GET", "POST"]
    - path: "apps/web/src/components/inbox/auto-rules-dialog.tsx"
      provides: "Dialog for configuring auto-send rules"
      exports: ["AutoRulesDialog"]
  key_links:
    - from: "apps/web/src/app/api/scanners/[id]/score-column/route.ts"
      to: "apps/web/src/models/auto-send-rule.ts"
      via: "Check rules after scoring each entity"
      pattern: "AutoSendRule\\.find"
    - from: "apps/web/src/app/api/scanners/[id]/score-column/route.ts"
      to: "apps/web/src/models/pipeline-card.ts"
      via: "Auto-create cards via findOneAndUpdate upsert"
      pattern: "PipelineCard\\.findOneAndUpdate"
---

<objective>
Implement scanner auto-send rules that automatically create inbox cards when AI column scores exceed configurable thresholds.

Purpose: Delivers CRM-05 (auto-send rules from scanners). Users configure threshold-based rules per AI column, and qualifying entities are automatically added to their inbox pipeline without manual action. This is the automation layer that makes the CRM proactive.
Output: AutoSendRule model, CRUD API, configuration dialog in scanner header menu, integration with scoring endpoint.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/22-crm-pipeline-procurement-inbox/22-RESEARCH.md
@.planning/phases/22-crm-pipeline-procurement-inbox/22-01-SUMMARY.md
@.planning/phases/22-crm-pipeline-procurement-inbox/22-02-SUMMARY.md

Reference existing patterns:
@apps/web/src/app/api/scanners/[id]/score-column/route.ts (scoring endpoint)
@apps/web/src/components/scanners/grid/header-menu.tsx (column header menu)
@apps/web/src/models/scanner.ts (model pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AutoSendRule model and API routes</name>
  <files>
    apps/web/src/models/auto-send-rule.ts
    apps/web/src/app/api/inbox/auto-rules/route.ts
    apps/web/src/app/api/inbox/auto-rules/[id]/route.ts
  </files>
  <action>
**1. `apps/web/src/models/auto-send-rule.ts`** — AutoSendRule Mongoose model:
- Schema fields: `userId` (String, required, indexed), `scannerId` (ObjectId, ref "Scanner", required), `scannerName` (String, for display), `columnId` (String, required — the AI column ID), `columnName` (String, for display), `threshold` (Number, required, min 0, max 10 — score must be >= this to trigger), `stage` (String, enum ["NEW", "QUALIFIED"], default "NEW" — which stage cards get created in), `isActive` (Boolean, default true)
- Enable timestamps: true
- Compound index: `{ userId: 1, scannerId: 1, columnId: 1 }` (unique — one rule per column per scanner per user)
- Follow existing model pattern: `mongoose.models.AutoSendRule || mongoose.model(...)`

**2. `apps/web/src/app/api/inbox/auto-rules/route.ts`** — List + Create:
- `GET`: Auth check. Find all rules for user `{ userId }`, optionally filter by `scannerId` query param. Sort by createdAt desc. Return `{ rules }`.
- `POST`: Auth check. Parse body `{ scannerId, scannerName, columnId, columnName, threshold, stage? }`. Validate threshold 0-10. Upsert via `findOneAndUpdate` with filter `{ userId, scannerId, columnId }` and `$set` for all fields. Return `{ rule }` with status 201.

**3. `apps/web/src/app/api/inbox/auto-rules/[id]/route.ts`** — Update + Delete:
- `PATCH`: Auth check. Whitelist fields: `threshold`, `stage`, `isActive`. Update with `findOneAndUpdate({ _id: id, userId }, { $set: updates }, { new: true })`. Return `{ rule }`.
- `DELETE`: Auth check. `deleteOne({ _id: id, userId })`. Return `{ success: true }`.
  </action>
  <verify>
`cd apps/web && npx tsc --noEmit --pretty 2>&1 | head -30` passes.
  </verify>
  <done>
AutoSendRule model stores per-column threshold rules with scanner/column references. CRUD API supports list (filterable by scanner), create/upsert, update (threshold/toggle), and delete.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build auto-rules dialog and integrate with scoring endpoint</name>
  <files>
    apps/web/src/components/inbox/auto-rules-dialog.tsx
    apps/web/src/components/scanners/grid/header-menu.tsx
    apps/web/src/app/api/scanners/[id]/score-column/route.ts
  </files>
  <action>
**1. `apps/web/src/components/inbox/auto-rules-dialog.tsx`** — Configuration dialog:
- Props: `open: boolean`, `onOpenChange: (open: boolean) => void`, `scannerId: string`, `scannerName: string`, `columnId: string`, `columnName: string`
- On open: fetch existing rule for this column via `GET /api/inbox/auto-rules?scannerId=${scannerId}` and filter client-side by columnId
- Form: threshold number input (0-10, step 0.1, default 7), stage select (New or Qualified, default New), active toggle
- Save: POST to `/api/inbox/auto-rules` with all fields. Show toast on success.
- If rule exists: show current settings pre-filled, allow update (PATCH) or delete. Show "Active"/"Paused" toggle.
- If no rule: show create form.
- Delete button with confirmation: DELETE `/api/inbox/auto-rules/${ruleId}`
- Use shadcn Dialog, Input (type=number), Select, Switch components

**2. Update `apps/web/src/components/scanners/grid/header-menu.tsx`**:
- Read the existing file to understand the header menu structure (it likely has sort, rename, edit prompt, delete options)
- Add a new menu item: "Auto-send to Inbox" with Inbox icon from lucide-react
- This item only appears for AI columns (not data columns) — check column type
- On click: open `<AutoRulesDialog>` with the column's scannerId, scannerName, columnId, columnName
- If an active auto-rule exists for this column, show a small indicator dot on the menu item

**3. Update `apps/web/src/app/api/scanners/[id]/score-column/route.ts`**:
- Read the existing file to understand the scoring loop structure
- AFTER each entity is scored (when score result is available), add an auto-send check:
  - Load active auto-send rules for this scanner + column: `AutoSendRule.find({ userId, scannerId, columnId, isActive: true })`
  - Cache the rules query (fetch once at the start of the scoring run, not per entity)
  - For each rule, if `score >= rule.threshold`:
    - Determine entityType from scanner type (rfps → "contract", buyers → "buyer", meetings → "signal")
    - Build entity display data from the entity record (title, buyerName, value, etc.)
    - Upsert pipeline card: `PipelineCard.findOneAndUpdate({ userId, entityType, entityId }, { $setOnInsert: { ...displayFields, stage: rule.stage, addedBy: "auto_rule", autoRuleId: rule._id, position: await getNextPosition() } }, { upsert: true })`
  - This runs in the background (don't block the SSE stream) — use `void checkAutoSendRules(...)` or run after enqueue
- Import PipelineCard and AutoSendRule models at top of file
  </action>
  <verify>
`cd apps/web && npx tsc --noEmit --pretty 2>&1 | head -30` passes. `cd apps/web && bun run lint 2>&1 | head -30` passes.
  </verify>
  <done>
Auto-rules dialog configurable from scanner AI column header menu. Scoring endpoint checks rules after each entity is scored and auto-creates inbox cards for qualifying scores. Cards created with addedBy="auto_rule" attribution.
  </done>
</task>

</tasks>

<verification>
1. `cd apps/web && npx tsc --noEmit` passes
2. `cd apps/web && bun run lint` passes
3. Scanner header menu shows "Auto-send to Inbox" option for AI columns
4. Auto-rules dialog allows configuring threshold and target stage
5. Rules can be toggled active/inactive and deleted
6. Scoring endpoint creates inbox cards when score >= threshold
7. Auto-created cards appear on inbox board with "auto" attribution
</verification>

<success_criteria>
- AutoSendRule model with CRUD API
- Configuration UI accessible from scanner column header menu
- Scoring endpoint integrates auto-send check (non-blocking)
- Cards auto-created with correct entity type, display fields, and auto_rule attribution
- Unique constraint prevents duplicate auto-send rules per column
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-crm-pipeline-procurement-inbox/22-05-SUMMARY.md`
</output>
