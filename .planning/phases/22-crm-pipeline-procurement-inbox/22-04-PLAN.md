---
phase: 22-crm-pipeline-procurement-inbox
plan: 04
type: execute
wave: 3
depends_on: ["22-02"]
files_modified:
  - apps/web/src/components/inbox/card-detail-sheet.tsx
  - apps/web/src/components/inbox/card-notes.tsx
  - apps/web/src/components/inbox/kanban-card.tsx
  - apps/web/src/components/inbox/kanban-board.tsx
  - apps/web/src/app/(dashboard)/inbox/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can click a card on the board to open a detail sheet"
    - "Detail sheet shows full card info: title, entity summary, stage, priority, timestamps, source link"
    - "User can add notes/comments to a card from the detail sheet"
    - "User can change card priority from the detail sheet"
    - "User can archive or delete a card from the detail sheet"
    - "Link back to source entity navigates to the original contract/buyer/signal page"
  artifacts:
    - path: "apps/web/src/components/inbox/card-detail-sheet.tsx"
      provides: "Side sheet with full card details, actions, and notes"
      exports: ["CardDetailSheet"]
    - path: "apps/web/src/components/inbox/card-notes.tsx"
      provides: "Notes list with add form"
      exports: ["CardNotes"]
  key_links:
    - from: "apps/web/src/components/inbox/card-detail-sheet.tsx"
      to: "/api/inbox/[id]"
      via: "PATCH for updates, DELETE for removal"
      pattern: "fetch.*api/inbox"
    - from: "apps/web/src/components/inbox/card-notes.tsx"
      to: "/api/inbox/[id]/notes"
      via: "GET to load, POST to create"
      pattern: "fetch.*notes"
    - from: "apps/web/src/components/inbox/card-detail-sheet.tsx"
      to: "entity detail pages"
      via: "Link href to /contracts/[id], /buyers/[id]"
      pattern: "href=.*/(contracts|buyers|signals)/"
---

<objective>
Build the card detail sheet and notes/comments system. When a user clicks a card on the Kanban board, a side sheet opens showing full details, notes, priority controls, archive/delete actions, and a link back to the source entity.

Purpose: Delivers CRM-07 (notes/comments), CRM-08 (link back to source entity), and enriches CRM-06 (full card details beyond the summary shown on the board).
Output: Card detail sheet component with notes, priority, archive/delete, and source entity link.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/22-crm-pipeline-procurement-inbox/22-RESEARCH.md
@.planning/phases/22-crm-pipeline-procurement-inbox/22-01-SUMMARY.md
@.planning/phases/22-crm-pipeline-procurement-inbox/22-02-SUMMARY.md

Reference existing patterns:
@apps/web/src/components/scanners/entity-detail-sheet.tsx (existing sheet pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build card detail sheet with notes and actions</name>
  <files>
    apps/web/src/components/inbox/card-detail-sheet.tsx
    apps/web/src/components/inbox/card-notes.tsx
  </files>
  <action>
**1. `apps/web/src/components/inbox/card-notes.tsx`** — Notes section component:
- Props: `cardId: string`
- State: `notes: PipelineNoteData[]`, `isLoading`, `newNote: string`, `isSaving`
- On mount: fetch notes via `GET /api/inbox/${cardId}/notes`, set state
- Add note form: textarea (placeholder "Add a note...") + send button. On submit, POST to `/api/inbox/${cardId}/notes` with `{ content: newNote }`. On success, prepend new note to list, clear textarea, toast success.
- Notes list: map notes showing content, relative timestamp (use `formatDistanceToNow` from date-fns or manual calc), and a small user avatar placeholder.
- Empty state: "No notes yet. Add one above."
- Textarea: auto-resize up to 4 rows. Max 2000 chars with character count indicator when > 1800.
- Use `AnimatePresence` + `motion.div` for new note enter animation (fade in + slide down)

**2. `apps/web/src/components/inbox/card-detail-sheet.tsx`** — Side sheet:
- Props: `card: PipelineCardData | null`, `open: boolean`, `onOpenChange: (open: boolean) => void`, `onCardUpdate: (id: string, updates: Partial<PipelineCardData>) => void`, `onCardDelete: (id: string) => void`
- Use shadcn `Sheet` with `SheetContent` side="right", width ~420px
- Layout sections (top to bottom):
  1. **Header**: Entity type badge (colored by type: contract=blue, buyer=green, signal=purple) + title (font-semibold, text-lg). If `deadlineDate`, show deadline with CalendarDays icon. Close button.
  2. **Source link**: "View original {entityType}" link that navigates to the source entity page. Compute href: `entityType === "contract" ? `/contracts/${entityId}` : entityType === "buyer" ? `/buyers/${entityId}` : `/scanners` (signals don't have standalone pages)`. Use `<Link>` with ExternalLink icon. This implements CRM-08.
  3. **Details section**: Buyer name (if present), value formatted as GBP, sector badge, "Added" relative date, "Stage changed" relative date.
  4. **Priority selector**: 3-button group (Low/Medium/High) with colored indicators. On click, PATCH `/api/inbox/${card._id}` with `{ priority }`. Optimistic update via `onCardUpdate`.
  5. **Stage display**: Current stage badge (read-only here, stage changes via drag on board).
  6. **Notes section**: Render `<CardNotes cardId={card._id} />`
  7. **Actions footer**: "Archive" button (Archive icon, outline variant) — calls PATCH with `{ isArchived: true }`, removes card from board via `onCardUpdate`. "Delete" button (Trash2 icon, destructive variant) — confirmation dialog first, then DELETE `/api/inbox/${card._id}`, removes card via `onCardDelete`.

- All PATCH/DELETE calls: optimistically update local state via callbacks, show toast on success/error.
- Animate sheet content entrance with `motion.div` (fade + slide from right, 200ms)
  </action>
  <verify>
`cd apps/web && npx tsc --noEmit --pretty 2>&1 | head -30` passes. `cd apps/web && bun run lint 2>&1 | head -30` passes.
  </verify>
  <done>
CardDetailSheet shows full card details, source entity link, priority selector, notes section, and archive/delete actions. CardNotes fetches and displays notes with add-note form.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire card click to open detail sheet on board</name>
  <files>
    apps/web/src/components/inbox/kanban-card.tsx
    apps/web/src/components/inbox/kanban-board.tsx
    apps/web/src/app/(dashboard)/inbox/page.tsx
  </files>
  <action>
**1. Update `kanban-card.tsx`**:
- Add `onCardClick?: (card: PipelineCardData) => void` prop
- Attach onClick handler to card div that calls `onCardClick(card)` — this works because PointerSensor's `activationConstraint: { distance: 8 }` means clicks (no mouse movement) won't trigger drag

**2. Update `kanban-column.tsx`** (if needed):
- Thread `onCardClick` prop down to each `<KanbanCard>`

**3. Update `kanban-board.tsx`**:
- Add `onCardClick?: (card: PipelineCardData) => void` prop
- Thread it through columns to cards

**4. Update `inbox/page.tsx`**:
- Add state: `selectedCard: PipelineCardData | null`, `isSheetOpen: boolean`
- On card click: set `selectedCard`, open sheet
- Render `<CardDetailSheet>` with:
  - `card={selectedCard}`, `open={isSheetOpen}`, `onOpenChange={setIsSheetOpen}`
  - `onCardUpdate`: update card in inbox store, update `selectedCard` if it's the same card
  - `onCardDelete`: remove card from inbox store, close sheet
  </action>
  <verify>
`cd apps/web && npx tsc --noEmit --pretty 2>&1 | head -30` passes. `cd apps/web && bun run lint 2>&1 | head -30` passes.
  </verify>
  <done>
Clicking a card on the Kanban board opens a detail sheet on the right side showing full details, notes, priority controls, source link, and archive/delete actions. Changes propagate back to the board in real-time.
  </done>
</task>

</tasks>

<verification>
1. `cd apps/web && npx tsc --noEmit` passes
2. `cd apps/web && bun run lint` passes
3. Clicking a card opens the detail sheet
4. Notes can be added and appear in the list
5. Priority can be changed via button group
6. "View original" link navigates to source entity page
7. Archive removes card from board
8. Delete removes card permanently after confirmation
</verification>

<success_criteria>
- Card detail sheet opens on card click with full entity information
- Notes/comments can be added and listed per card
- Priority can be changed from the sheet
- Source entity link navigates to /contracts/[id] or /buyers/[id]
- Archive and delete work with confirmation and toast feedback
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-crm-pipeline-procurement-inbox/22-04-SUMMARY.md`
</output>
