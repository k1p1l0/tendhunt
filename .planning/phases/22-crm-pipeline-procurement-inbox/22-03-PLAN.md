---
phase: 22-crm-pipeline-procurement-inbox
plan: 03
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - apps/web/src/components/inbox/send-to-inbox-button.tsx
  - apps/web/src/app/(dashboard)/contracts/[id]/page.tsx
  - apps/web/src/app/(dashboard)/buyers/[id]/page.tsx
  - apps/web/src/components/scanners/entity-detail-sheet.tsx
autonomous: true

must_haves:
  truths:
    - "User can click 'Send to Inbox' on contract detail page to create a CRM card"
    - "User can click 'Send to Inbox' on buyer detail page to create a CRM card"
    - "User can click 'Send to Inbox' in scanner entity detail sheet to create a CRM card"
    - "Button shows 'In Inbox' state after sending and prevents duplicate sends"
    - "Toast notification confirms successful add to inbox"
  artifacts:
    - path: "apps/web/src/components/inbox/send-to-inbox-button.tsx"
      provides: "Reusable SendToInboxButton component"
      exports: ["SendToInboxButton"]
    - path: "apps/web/src/app/(dashboard)/contracts/[id]/page.tsx"
      provides: "Contract detail with Send to Inbox button"
      contains: "SendToInboxButton"
    - path: "apps/web/src/app/(dashboard)/buyers/[id]/page.tsx"
      provides: "Buyer detail with Send to Inbox button"
      contains: "SendToInboxButton"
  key_links:
    - from: "apps/web/src/components/inbox/send-to-inbox-button.tsx"
      to: "/api/inbox"
      via: "fetch POST to create card"
      pattern: "fetch.*api/inbox"
---

<objective>
Create the "Send to Inbox" button component and integrate it into contract detail, buyer detail, and scanner entity detail sheet pages.

Purpose: Enables CRM-04 (manual card creation from entity pages). Users can add any entity to their pipeline from where they discover it. The button is self-contained and reusable across all entity types.
Output: 1 reusable button component integrated into 3 entity pages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/22-crm-pipeline-procurement-inbox/22-RESEARCH.md
@.planning/phases/22-crm-pipeline-procurement-inbox/22-01-SUMMARY.md

Reference existing patterns:
@apps/web/src/app/(dashboard)/contracts/[id]/page.tsx (contract detail action buttons)
@apps/web/src/app/(dashboard)/buyers/[id]/page.tsx (buyer detail page)
@apps/web/src/components/scanners/entity-detail-sheet.tsx (scanner entity sheet)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SendToInboxButton component</name>
  <files>
    apps/web/src/components/inbox/send-to-inbox-button.tsx
  </files>
  <action>
Create `apps/web/src/components/inbox/send-to-inbox-button.tsx` as a client component:

- Props interface `SendToInboxButtonProps`:
  - `entityType: "contract" | "buyer" | "signal"` (required)
  - `entityId: string` (required)
  - `title: string` (required)
  - `subtitle?: string`
  - `value?: number`
  - `deadlineDate?: string`
  - `sector?: string`
  - `buyerName?: string`
  - `logoUrl?: string`
  - `className?: string`

- State: `isSending` (boolean), `isInInbox` (boolean)
- On mount: optionally check if entity is already in inbox via a lightweight HEAD or GET query (or skip this for simplicity and just handle 409/duplicate from the POST endpoint gracefully)
- `handleSend`: set `isSending(true)`, POST to `/api/inbox` with all props as body. If response ok (201), `setIsInInbox(true)`, show `toast.success("Added to Inbox")` using sonner. If response indicates duplicate (upsert returns existing), also set `isInInbox(true)` but show `toast.info("Already in Inbox")`. On error, show `toast.error("Failed to add")`. Finally `setIsSending(false)`.

- Render: `<Button>` from shadcn with `variant="outline"`, `size="sm"`. Icon: `<Inbox />` when not in inbox, `<Check />` when in inbox. Text: "Send to Inbox" / "In Inbox". Disabled when `isSending || isInInbox`. Loading spinner (Loader2 with animate-spin) when sending.
- Animation: `active:scale-[0.97]` transition on button per existing contract page pattern
- Use `motion/react` for icon swap animation: `AnimatePresence` with `motion.span` for smooth icon transition
  </action>
  <verify>
`cd apps/web && npx tsc --noEmit --pretty 2>&1 | head -30` passes.
  </verify>
  <done>
SendToInboxButton is a reusable client component that posts entity data to /api/inbox, shows loading/success states, prevents duplicates, and displays toast notifications.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate SendToInboxButton into entity pages</name>
  <files>
    apps/web/src/app/(dashboard)/contracts/[id]/page.tsx
    apps/web/src/app/(dashboard)/buyers/[id]/page.tsx
    apps/web/src/components/scanners/entity-detail-sheet.tsx
  </files>
  <action>
**1. Contract detail page** (`apps/web/src/app/(dashboard)/contracts/[id]/page.tsx`):
- The contract detail is a server component. The action buttons area (currently has Share and Bookmark) needs the SendToInboxButton.
- Since SendToInboxButton is a client component, it can be rendered directly in the server component JSX.
- Replace the existing "Bookmark" button with `<SendToInboxButton>` passing: `entityType="contract"`, `entityId={String(contract._id)}`, `title={contract.title}`, `buyerName={contract.buyerName}`, `value={contract.valueMax ?? contract.valueMin}`, `deadlineDate={contract.closingDate?.toISOString()}`, `sector={contract.sector}`
- Keep the Share button as-is.

**2. Buyer detail page** (`apps/web/src/app/(dashboard)/buyers/[id]/page.tsx`):
- Read the current file to understand the layout structure. The buyer detail likely has a header section with action buttons.
- Add `<SendToInboxButton>` in the action buttons area passing: `entityType="buyer"`, `entityId={String(buyer._id)}`, `title={buyer.name}`, `subtitle={buyer.orgType || buyer.sector}`, `buyerName={buyer.name}`, `logoUrl={buyer.logoUrl}`, `sector={buyer.sector}`

**3. Scanner entity detail sheet** (`apps/web/src/components/scanners/entity-detail-sheet.tsx`):
- Read the current file to understand the sheet header layout.
- Add `<SendToInboxButton>` in the sheet header area.
- The scanner entity sheet displays contract/buyer/signal data depending on scanner type. Determine `entityType` from the scanner type or the entity data.
- Pass appropriate props based on the entity being viewed: `entityType`, `entityId`, `title`, and whatever display fields are available from the entity data.
  </action>
  <verify>
`cd apps/web && npx tsc --noEmit --pretty 2>&1 | head -30` passes. `cd apps/web && bun run lint 2>&1 | head -30` passes.
  </verify>
  <done>
"Send to Inbox" button appears on contract detail page (replaces Bookmark), buyer detail page (new button in actions), and scanner entity detail sheet (in sheet header). All three pass entity-appropriate data to create CRM cards.
  </done>
</task>

</tasks>

<verification>
1. `cd apps/web && npx tsc --noEmit` passes
2. `cd apps/web && bun run lint` passes
3. Contract detail page shows "Send to Inbox" button in header actions
4. Buyer detail page shows "Send to Inbox" button
5. Scanner entity sheet shows "Send to Inbox" button
6. Button transitions to "In Inbox" state after sending
</verification>

<success_criteria>
- SendToInboxButton component is reusable across all entity types
- Integrated into 3 entity detail views (contract, buyer, scanner sheet)
- Creates PipelineCard via POST /api/inbox with correct entity data
- Shows loading, success, and duplicate states
- Toast notifications on success/error
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-crm-pipeline-procurement-inbox/22-03-SUMMARY.md`
</output>
