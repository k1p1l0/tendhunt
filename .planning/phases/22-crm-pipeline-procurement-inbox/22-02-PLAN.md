---
phase: 22-crm-pipeline-procurement-inbox
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - apps/web/src/stores/inbox-store.ts
  - apps/web/src/components/inbox/kanban-board.tsx
  - apps/web/src/components/inbox/kanban-column.tsx
  - apps/web/src/components/inbox/kanban-card.tsx
  - apps/web/src/components/inbox/kanban-card-content.tsx
  - apps/web/src/components/inbox/kanban-card-preview.tsx
  - apps/web/src/components/inbox/column-header.tsx
  - apps/web/src/app/(dashboard)/inbox/page.tsx
  - apps/web/src/app/(dashboard)/inbox/breadcrumb.tsx
  - apps/web/src/components/layout/app-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /inbox from sidebar and see a Kanban board with 6 columns"
    - "User can drag cards between columns and within columns to reorder"
    - "Drag state shows a preview overlay of the card being dragged"
    - "Board persists position changes to server via API on drag-end"
    - "Optimistic updates render immediately; rollback on server error"
  artifacts:
    - path: "apps/web/src/stores/inbox-store.ts"
      provides: "Zustand store for inbox board state"
      exports: ["useInboxStore"]
    - path: "apps/web/src/components/inbox/kanban-board.tsx"
      provides: "DndContext + DragOverlay + column layout"
      contains: "DndContext"
    - path: "apps/web/src/components/inbox/kanban-column.tsx"
      provides: "Droppable column with SortableContext"
      contains: "useDroppable"
    - path: "apps/web/src/components/inbox/kanban-card.tsx"
      provides: "Sortable card wrapper with useSortable"
      contains: "useSortable"
    - path: "apps/web/src/app/(dashboard)/inbox/page.tsx"
      provides: "Inbox page with server-side data fetch"
      exports: ["default"]
    - path: "apps/web/src/components/layout/app-sidebar.tsx"
      provides: "Updated sidebar with Inbox nav item"
      contains: "Inbox"
  key_links:
    - from: "apps/web/src/components/inbox/kanban-board.tsx"
      to: "/api/inbox/reorder"
      via: "fetch PATCH on handleDragEnd"
      pattern: "fetch.*inbox/reorder"
    - from: "apps/web/src/app/(dashboard)/inbox/page.tsx"
      to: "/api/inbox"
      via: "server-side fetch on mount"
      pattern: "fetch.*api/inbox"
---

<objective>
Build the Kanban board UI with @dnd-kit drag-and-drop, Zustand state management, sidebar navigation, and the inbox page.

Purpose: Delivers the core visual experience -- users see and interact with the procurement pipeline board. This is the primary interface for CRM-01 (Kanban board), CRM-03 (drag-and-drop), and CRM-06 (card summary display).
Output: Kanban board page with 6 columns, draggable cards, optimistic reorder, sidebar nav item, breadcrumb.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/22-crm-pipeline-procurement-inbox/22-RESEARCH.md
@.planning/phases/22-crm-pipeline-procurement-inbox/22-01-SUMMARY.md

Reference existing patterns:
@apps/web/src/stores/scanner-store.ts (Zustand store pattern)
@apps/web/src/app/(dashboard)/contracts/breadcrumb.tsx (breadcrumb pattern)
@apps/web/src/components/layout/app-sidebar.tsx (sidebar nav pattern)
@apps/web/src/app/(dashboard)/scanners/[id]/page.tsx (page with data fetch)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand inbox store, sidebar nav, breadcrumb, and inbox page</name>
  <files>
    apps/web/src/stores/inbox-store.ts
    apps/web/src/app/(dashboard)/inbox/page.tsx
    apps/web/src/app/(dashboard)/inbox/breadcrumb.tsx
    apps/web/src/components/layout/app-sidebar.tsx
  </files>
  <action>
**1. `apps/web/src/stores/inbox-store.ts`** — Zustand store for board state:
- State: `cards: PipelineCardData[]`, `isLoading: boolean`, `error: string | null`
- Actions: `fetchCards()` — GET /api/inbox, set cards. `setCards(cards)` — direct setter for optimistic updates. `addCard(card)` — append to cards array. `updateCard(id, updates)` — merge updates into matching card. `removeCard(id)` — filter out card. `setLoading(v)`. `setError(v)`.
- Import type `PipelineCardData` from `@/types/inbox`.
- Follow existing store pattern from scanner-store.ts (create with Zustand, export `useInboxStore`).

**2. `apps/web/src/app/(dashboard)/inbox/breadcrumb.tsx`** — Client component:
- Follow exact pattern from contracts/breadcrumb.tsx
- Set breadcrumb text to "Inbox"
- Clean up on unmount

**3. `apps/web/src/components/layout/app-sidebar.tsx`** — Add Inbox nav item:
- Import `Inbox` icon from lucide-react
- Add to navItems array AFTER Scanners: `{ title: "Inbox", href: "/inbox", icon: Inbox }`

**4. `apps/web/src/app/(dashboard)/inbox/page.tsx`** — Inbox page (client component since it manages DnD state):
- `"use client"` at top
- On mount, call `useInboxStore().fetchCards()`
- Render `<InboxBreadcrumb />` + loading skeleton while fetching + `<KanbanBoard />` when loaded
- Use `AgentContextSetter` with `context={{ page: "inbox" }}`
- Full height layout: `h-[calc(100vh-4rem)]` with overflow-x-auto for horizontal scrolling
  </action>
  <verify>
`cd apps/web && npx tsc --noEmit --pretty 2>&1 | head -30` passes. Sidebar shows "Inbox" nav item.
  </verify>
  <done>
Zustand inbox store manages card state with fetch/add/update/remove actions. Inbox page renders at /inbox with breadcrumb. Sidebar shows Inbox nav item with Inbox icon after Scanners.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Kanban board components with @dnd-kit drag-and-drop</name>
  <files>
    apps/web/src/components/inbox/kanban-board.tsx
    apps/web/src/components/inbox/kanban-column.tsx
    apps/web/src/components/inbox/kanban-card.tsx
    apps/web/src/components/inbox/kanban-card-content.tsx
    apps/web/src/components/inbox/kanban-card-preview.tsx
    apps/web/src/components/inbox/column-header.tsx
  </files>
  <action>
First install dnd-kit: `cd apps/web && bun add @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities`

**1. `apps/web/src/components/inbox/column-header.tsx`** — Column header component:
- Props: `stage: PipelineStage`, `count: number`
- Look up stage config from `PIPELINE_STAGES[stage]` for label, color
- Render: colored left border accent (4px), stage label text, count badge (muted background with count number)
- Use `memo` for performance

**2. `apps/web/src/components/inbox/kanban-card-content.tsx`** — Card display (the visible card UI):
- Props: `card: PipelineCardData`
- Display: title (truncated, font-medium), buyerName or subtitle below (text-sm text-muted-foreground), source type badge (entity type: contract/buyer/signal with appropriate icon and color), value formatted as GBP if present, deadline date formatted relative or short date if present
- Priority indicator: colored dot (LOW=gray, MEDIUM=amber, HIGH=red) at top-right
- Source attribution: small badge showing `addedBy` ("manual" or "auto")
- Link icon (small ExternalLink icon) at bottom for CRM-08 link back to source
- Use `memo` for performance
- Card has subtle border, rounded-lg, bg-card, shadow-sm, hover:shadow-md transition
- Follow CLAUDE.md animation rules: use CSS transitions for hover, 100-150ms ease

**3. `apps/web/src/components/inbox/kanban-card.tsx`** — Sortable card wrapper:
- Props: `card: PipelineCardData`, `isDragOverlay?: boolean`
- Use `useSortable({ id: card._id })` from @dnd-kit/sortable
- Apply `attributes`, `listeners`, `setNodeRef` from useSortable
- When dragging (`isDragging` from useSortable): reduce opacity to 0.4
- Render `<KanbanCardContent card={card} />`
- onClick handler: will be used later for card detail sheet (no-op for now, but don't attach listeners to the click area to allow future click handling)
- Per research Pitfall 6: activation distance handles click vs drag separation

**4. `apps/web/src/components/inbox/kanban-card-preview.tsx`** — Drag overlay preview:
- Props: `card: PipelineCardData`
- Render `<KanbanCardContent card={card} />` with elevated shadow (shadow-lg), slight rotation (transform: rotate(3deg)), and scale(1.02)
- No sortable hooks — this is just a visual preview for DragOverlay

**5. `apps/web/src/components/inbox/kanban-column.tsx`** — Droppable column:
- Props: `stage: PipelineStage`, `cards: PipelineCardData[]`, `activeId: string | null`
- Use `useDroppable({ id: stage })` from @dnd-kit/core
- Wrap cards in `SortableContext` with `items={cards.map(c => c._id)}` and `verticalListSortingStrategy`
- Layout: flex flex-col, fixed width (280px), min-height full, bg-muted/30 rounded-xl
- Render `<ColumnHeader />` at top, then scrollable card list area
- Empty state: dashed border placeholder text "Drag cards here" when no cards
- When `isOver` from useDroppable: show subtle highlight (ring-2 ring-primary/20)
- Use `motion.div` from `motion/react` for card enter animations (`AnimatePresence` + `motion.div` with `layout` prop)

**6. `apps/web/src/components/inbox/kanban-board.tsx`** — Main board component:
- Uses `useInboxStore()` to get cards
- Sensors: `useSensors(useSensor(PointerSensor, { activationConstraint: { distance: 8 } }))` per research
- Group cards by stage: compute `cardsByStage` record from cards array
- Track `activeId` state for DragOverlay
- **handleDragStart**: set activeId from `event.active.id`
- **handleDragOver**: when dragging over a different column, optimistically move card to new column in local state (update stage + position). Use `setCards()` on the store.
- **handleDragEnd**: compute final positions for affected columns. Optimistic update via store. Call `fetch("/api/inbox/reorder", { method: "PATCH", body: JSON.stringify(reorderPayload) })`. On error, re-fetch cards to rollback. Follow Getmany isPending pattern from research.
- **handleDragCancel**: re-fetch cards to reset state
- Render: horizontal flex container with gap-3, px-4 padding. Map `STAGE_ORDER` to `<KanbanColumn>` components. `<DragOverlay>` with `<KanbanCardPreview>` when activeId is set.
- Collision detection: use `closestCorners` from @dnd-kit/core for accurate cross-column detection
- Use `useCallback` for all handlers to avoid unnecessary re-renders
  </action>
  <verify>
`cd apps/web && npx tsc --noEmit --pretty 2>&1 | head -30` passes. `cd apps/web && bun run lint 2>&1 | head -30` passes (no React compiler violations).
  </verify>
  <done>
Kanban board renders 6 columns (New, Qualified, Preparing Bid, Submitted, Won, Lost) with drag-and-drop card movement using @dnd-kit. Optimistic reorder persists to server. DragOverlay shows card preview during drag. Cards display entity summary with title, buyer, value, source badge.
  </done>
</task>

</tasks>

<verification>
1. `cd apps/web && npx tsc --noEmit` passes
2. `cd apps/web && bun run lint` passes (React compiler rules)
3. @dnd-kit packages installed in apps/web/package.json
4. Sidebar shows "Inbox" between "Scanners" and nothing else
5. /inbox page renders KanbanBoard with 6 columns
6. Cards can be dragged between columns (visual + API call)
</verification>

<success_criteria>
- Kanban board at /inbox with 6 procurement stage columns
- Cards display entity summary (title, buyer, value, source badge, priority)
- Drag-and-drop works within and across columns with optimistic updates
- DragOverlay shows elevated card preview during drag
- Empty columns show "Drag cards here" placeholder
- Sidebar has Inbox nav item
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-crm-pipeline-procurement-inbox/22-02-SUMMARY.md`
</output>
