---
phase: 30-sculptor-ai-homepage-floating-assistant
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/lib/dashboard.ts
  - apps/web/src/components/sculptor/sculptor-hero-input.tsx
autonomous: true

must_haves:
  truths:
    - "Server-side getRecentConversations returns up to 5 recent conversations sorted by lastMessageAt desc"
    - "RecentConversation type includes _id, title, lastMessageAt, messageCount, and optional context"
    - "SculptorHeroInput is a visually distinct large centered chat input with rounded-2xl border"
    - "SculptorHeroInput calls onSend callback on Enter (not Shift+Enter)"
    - "SculptorHeroInput has no auto-focus on mount (user clicks to focus)"
  artifacts:
    - path: "apps/web/src/lib/dashboard.ts"
      provides: "getRecentConversations server function"
      exports: ["getRecentConversations", "RecentConversation"]
    - path: "apps/web/src/components/sculptor/sculptor-hero-input.tsx"
      provides: "Large hero chat input component"
      exports: ["SculptorHeroInput"]
  key_links:
    - from: "apps/web/src/lib/dashboard.ts"
      to: "apps/web/src/models/chat-conversation.ts"
      via: "ChatConversation.find query"
      pattern: "ChatConversation\\.find"
---

<objective>
Create the server-side recent conversations query function and the SculptorHeroInput component -- the two data/UI building blocks needed by the homepage.

Purpose: These are independent building blocks that the SculptorHomepage (Plan 03) will compose. Fetching conversations server-side avoids client waterfall loading. The hero input provides the prominent AI-first entry point.

Output: getRecentConversations function in dashboard.ts, SculptorHeroInput client component.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@apps/web/src/lib/dashboard.ts (existing getUserScanners/getTopScores pattern)
@apps/web/src/models/chat-conversation.ts (MongoDB schema)
@apps/web/src/components/agent/agent-input.tsx (existing input component for reference)
@apps/web/src/lib/mongodb.ts (dbConnect)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getRecentConversations to dashboard.ts</name>
  <files>apps/web/src/lib/dashboard.ts</files>
  <action>
    Add to `apps/web/src/lib/dashboard.ts`:

    1. Import `ChatConversation` from `@/models/chat-conversation` (default import).

    2. Export `RecentConversation` interface:
       ```typescript
       export interface RecentConversation {
         _id: string;
         title: string;
         lastMessageAt: Date;
         messageCount: number;
         context?: { page: string };
       }
       ```

    3. Export `getRecentConversations` async function:
       - Parameters: `userId: string`, `limit = 5`
       - Returns: `Promise<RecentConversation[]>`
       - Calls `await dbConnect()` first (same pattern as getUserScanners)
       - Queries `ChatConversation.find({ userId }).sort({ lastMessageAt: -1 }).limit(limit).select("title lastMessageAt messages context").lean()`
       - Maps results: `_id` → `String(c._id)`, `title` → `c.title || "New conversation"`, `messageCount` → `c.messages?.length ?? 0`, `context` cast to `{ page: string } | undefined`
       - The `lastMessageAt` field should be serialized: `new Date(c.lastMessageAt)` for safe server→client prop passing.

    Keep separate import statements for the type import pattern required by the project style.
  </action>
  <verify>
    Run `pnpm typecheck` to verify no TypeScript errors. Verify the function signature matches existing patterns in dashboard.ts.
  </verify>
  <done>
    getRecentConversations function exists in dashboard.ts, queries ChatConversation sorted by lastMessageAt desc, returns typed RecentConversation array.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SculptorHeroInput component</name>
  <files>apps/web/src/components/sculptor/sculptor-hero-input.tsx</files>
  <action>
    Create `apps/web/src/components/sculptor/sculptor-hero-input.tsx`:
    - "use client" component
    - Props: `onSend: (content: string) => void`, `isStreaming?: boolean`
    - Internal state: `value` string via useState
    - Renders a large, centered textarea-based input:
      - Outer container: `w-full` div
      - Input wrapper: `flex items-end gap-3 rounded-2xl border bg-background px-4 py-3 shadow-sm transition-all duration-150 focus-within:border-ring focus-within:shadow-md`
      - Textarea element:
        - rows={1}, resizable up to 3 rows (max-h-[4.5rem])
        - `text-base` (larger than panel input's text-sm)
        - `resize-none bg-transparent w-full outline-none leading-relaxed py-1`
        - placeholder: "Ask Sculptor anything about procurement..."
        - NO auto-focus (per research pitfall #2 -- user clicks to focus)
        - `aria-label="Ask Sculptor"`
        - `disabled={isStreaming}`
      - Send button: same pattern as AgentInput -- rounded-full, ArrowUp icon, uses motion whileTap
        - Show as primary when `canSend` (value non-empty and not streaming)
        - Show as secondary when disabled
        - `min-h-[44px] min-w-[44px]` for mobile tap target
        - `aria-label="Send message"`
    - Enter key (without Shift) sends the message (same handleKeyDown pattern as AgentInput)
    - On send: calls `onSend(trimmed)`, resets value to "", resets textarea height
    - Auto-resize textarea on input (same handleInput pattern as AgentInput: set height to auto then scrollHeight capped at 72px)

    Import icons from lucide-react (ArrowUp). Import motion from motion/react. Import Button from @/components/ui/button.
  </action>
  <verify>
    Run `pnpm typecheck` to verify no TypeScript errors. Verify the component follows the same patterns as AgentInput.
  </verify>
  <done>
    SculptorHeroInput component renders a large rounded-2xl chat input with send button, Enter-to-send behavior, auto-resize, and no auto-focus. Accepts onSend callback.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with no errors
2. getRecentConversations is exported from dashboard.ts
3. RecentConversation interface is exported from dashboard.ts
4. SculptorHeroInput is exported from sculptor-hero-input.tsx
5. No lint errors in modified files
</verification>

<success_criteria>
- getRecentConversations queries ChatConversation model with correct sort and limit
- SculptorHeroInput provides a visually prominent input with Enter-to-send
- Both components follow existing codebase patterns (dbConnect, useState, motion, etc.)
- No typecheck or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/30-sculptor-ai-homepage-floating-assistant/30-02-SUMMARY.md`
</output>
