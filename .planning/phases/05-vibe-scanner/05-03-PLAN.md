---
phase: 05-vibe-scanner
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/components/vibe-scanner/threshold-controls.tsx
  - src/components/vibe-scanner/scored-contract-feed.tsx
  - src/app/api/vibe-scanner/score/route.ts
  - src/app/(dashboard)/vibe-scanner/page.tsx
  - src/stores/vibe-store.ts
autonomous: true

must_haves:
  truths:
    - "User can adjust a score threshold slider from 1 to 10 with 0.1 increments"
    - "Contracts below the threshold appear with reduced opacity or are hidden based on a toggle"
    - "A visual divider separates above-threshold and below-threshold contracts in the feed"
    - "AI also scores buyer organizations for relevance to the company profile"
  artifacts:
    - path: "src/components/vibe-scanner/threshold-controls.tsx"
      provides: "Slider with 0.1 step + hide/dim Switch toggle"
    - path: "src/components/vibe-scanner/scored-contract-feed.tsx"
      provides: "Updated feed with threshold filtering, opacity, and score divider"
  key_links:
    - from: "src/components/vibe-scanner/threshold-controls.tsx"
      to: "src/stores/vibe-store.ts"
      via: "useVibeStore for threshold and hideBelow state"
      pattern: "useVibeStore"
    - from: "src/components/vibe-scanner/scored-contract-feed.tsx"
      to: "src/stores/vibe-store.ts"
      via: "useVibeStore to read threshold, hideBelow, and scores"
      pattern: "useVibeStore.*threshold"
    - from: "src/app/api/vibe-scanner/score/route.ts"
      to: "Buyer model"
      via: "scoreOneBuyer function + buyer scoring loop"
      pattern: "Buyer\\.find"
---

<objective>
Add interactive threshold controls (slider + hide/dim toggle), a visual score divider in the contract feed, and buyer organization scoring to complete all Vibe Scanner requirements.

Purpose: Threshold controls let users tune signal-to-noise ratio, making the scoring engine practically useful. Buyer scoring extends the AI evaluation to organizations, not just contracts.

Output: Fully functional Vibe Scanner with all 11 VIBE requirements satisfied.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-vibe-scanner/05-RESEARCH.md
@.planning/phases/05-vibe-scanner/05-01-SUMMARY.md
@.planning/phases/05-vibe-scanner/05-02-SUMMARY.md

# Key source files
@src/stores/vibe-store.ts                # Zustand store (from Plan 02)
@src/components/vibe-scanner/scored-contract-feed.tsx  # Scored feed (from Plan 02)
@src/app/api/vibe-scanner/score/route.ts # Scoring SSE endpoint (from Plan 02)
@src/app/(dashboard)/vibe-scanner/page.tsx # Vibe Scanner page (from Plans 01+02)
@src/models/buyer.ts                     # Buyer model with vibeScore placeholder
@src/models/vibe-scanner.ts              # VibeScanner model with buyerScores array
</context>

<tasks>

<task type="auto">
  <name>Task 1: Threshold controls with slider, toggle, and score divider in feed</name>
  <files>src/components/vibe-scanner/threshold-controls.tsx, src/components/vibe-scanner/scored-contract-feed.tsx, src/app/(dashboard)/vibe-scanner/page.tsx, src/stores/vibe-store.ts</files>
  <action>
**1. Install shadcn Slider and Switch** -- Run `npx shadcn@latest add slider switch` (skip if already present, check `src/components/ui/slider.tsx` and `src/components/ui/switch.tsx` first).

**2. Create ThresholdControls component** at `src/components/vibe-scanner/threshold-controls.tsx`:

Client component ("use client"). Reads from `useVibeStore`: threshold, setThreshold, hideBelow, setHideBelow.

Layout (horizontal flex on desktop, stack on mobile):
- **Slider section:**
  - Label: "Minimum Score Threshold: {threshold.toFixed(1)}"
  - shadcn `Slider` with `value={[threshold]}`, `onValueChange={([v]) => setThreshold(v)}`, `min={1}`, `max={10}`, `step={0.1}`
  - Below slider: subtle marks or text showing "1" on left and "10" on right

- **Toggle section:**
  - shadcn `Switch` with `checked={hideBelow}`, `onCheckedChange={setHideBelow}`
  - Label next to switch: `{hideBelow ? "Hide below threshold" : "Dim below threshold"}`

- **Stats section:**
  - Calculate from store: count of contracts above threshold, total scored
  - Display: "{aboveCount} of {totalScored} contracts above threshold"

Wrap in a Card or bordered container with subtle background for visual separation.

**3. Update ScoredContractFeed** at `src/components/vibe-scanner/scored-contract-feed.tsx`:

Modify to apply threshold logic:

- Read `threshold`, `hideBelow`, `scores` from `useVibeStore`
- Sort all scored contracts by score descending
- Split into two arrays: `aboveThreshold` (score >= threshold) and `belowThreshold` (score < threshold)
- Render `aboveThreshold` contracts normally
- Between the two groups, render a **Score Divider**:
  - Horizontal line with centered text: "--- Below threshold ({threshold.toFixed(1)}) ---"
  - Style: relative container with absolute centered span over a Separator (reuse pattern from onboarding wizard)
  - Use red/muted color for the divider text

- Render `belowThreshold` contracts:
  - If `hideBelow` is true: don't render them at all (or show a collapsed "N contracts hidden" text)
  - If `hideBelow` is false: render with `opacity-40` class on the card container
  - Ensure hidden count text says "X contracts below threshold hidden"

- Only show divider and below section when there ARE below-threshold contracts

**4. Update zustand store** at `src/stores/vibe-store.ts`:

Add `buyerScores: Record<string, { score: number; reasoning: string }>` to the store interface. Add `setBuyerScore` and `loadBuyerScores` actions mirroring the contract score pattern.

**5. Wire ThresholdControls into Vibe Scanner page** at `src/app/(dashboard)/vibe-scanner/page.tsx`:

- Import ThresholdControls component
- Place it between the ScoreProgress and ScoredContractFeed components
- Only show threshold controls when scores exist (Object.keys(scores).length > 0)
  </action>
  <verify>
Run `npx next build` to verify no TypeScript errors. Verify slider, switch, and divider render correctly. Check that threshold filtering works with both hide and dim modes.
  </verify>
  <done>
Threshold slider adjusts from 1-10 in 0.1 increments. Toggle switches between hide and dim modes. Score divider separates above/below threshold contracts. Below-threshold contracts are either hidden (with count text) or shown at 40% opacity. Stats show above-threshold count. VIBE-06, VIBE-07, VIBE-08 requirements satisfied. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Buyer organization scoring in the batch scoring flow</name>
  <files>src/app/api/vibe-scanner/score/route.ts, src/components/vibe-scanner/scored-contract-feed.tsx, src/app/(dashboard)/vibe-scanner/page.tsx</files>
  <action>
**1. Add buyer scoring to SSE endpoint** at `src/app/api/vibe-scanner/score/route.ts`:

After the contract scoring loop completes and before the final "complete" event:

- Load all buyers with minimal fields: `Buyer.find({}).select('name sector region description contractCount').lean()`
- Send a new SSE event: `{ type: 'buyer_start', total: buyers.length }`
- Score each buyer using the same concurrency pattern (p-limit(5)):

```typescript
async function scoreOneBuyer(buyer: any, scoringPrompt: string) {
  const response = await anthropic.messages.create({
    model: "claude-haiku-4-5-20251001",
    max_tokens: 256,
    system: [
      {
        type: "text",
        text: scoringPrompt,
        cache_control: { type: "ephemeral" }
      }
    ],
    messages: [
      {
        role: "user",
        content: `Score this buyer organization for relevance to the company profile:\n\nOrganization: ${buyer.name}\nSector: ${buyer.sector || 'Unknown'}\nRegion: ${buyer.region || 'Unknown'}\nDescription: ${(buyer.description || '').substring(0, 1000)}\nContract Count: ${buyer.contractCount || 0}`
      }
    ],
    output_config: {
      format: {
        type: "json_schema" as const,
        schema: {
          type: "object" as const,
          properties: {
            score: { type: "number" as const },
            reasoning: { type: "string" as const }
          },
          required: ["score", "reasoning"],
          additionalProperties: false
        }
      }
    }
  });

  const content = response.content[0];
  if (content.type === 'text') {
    return JSON.parse(content.text) as { score: number; reasoning: string };
  }
  return { score: 0, reasoning: 'Failed to parse response' };
}
```

- Send progress events: `{ type: 'buyer_progress', scored: buyerScored, total: buyers.length, buyerId, score, reasoning }`
- After all buyers scored, persist to VibeScanner.buyerScores and update Buyer documents (bulkWrite with vibeScore + vibeReasoning)
- Send `{ type: 'buyer_complete', scored: buyerScored }`
- Then send the final `{ type: 'complete' }` event

**2. Update SSE client consumer** in the Vibe Scanner page to handle buyer events:

In `startScoring()`, add handlers for `buyer_start`, `buyer_progress`, `buyer_complete`:
- Track buyer scoring progress separately (add `buyerScoringProgress` to zustand store or use local state)
- Update `setBuyerScore` in the store for each buyer scored
- Update progress text: "Scoring buyers... X of Y"

**3. Update ScoredContractFeed** to show buyer scores section:

After the contract feed, add a "Scored Buyers" section:
- Heading: "Buyer Organizations" with count
- Simple list/grid of buyer cards showing: name, sector, region, score badge (same color coding), reasoning (line-clamp-2)
- Sorted by score descending
- Apply the same threshold filtering (hide/dim based on threshold slider)
- If no buyer scores, show "Buyers will be scored after contracts."

**4. Update the complete event handling** to set `isScoring(false)` only after BOTH contracts AND buyers are scored.
  </action>
  <verify>
Run `npx next build` to verify no TypeScript errors. Verify buyer scoring events appear in the SSE stream after contract scoring. Check that buyer scores display in the feed with threshold filtering applied.
  </verify>
  <done>
Buyer organizations are scored in a second pass after contracts, using the same scoring prompt with prompt caching. Progress events stream for both contracts and buyers. Buyer scores display in a separate section of the feed with the same color-coded badges, reasoning, and threshold filtering. Scores persist to both VibeScanner.buyerScores and Buyer.vibeScore/vibeReasoning. VIBE-11 requirement satisfied. All 11 VIBE requirements complete. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npx next build` succeeds with no errors
2. Slider adjusts threshold 1-10 with 0.1 step increments
3. Switch toggles between hide and dim modes for below-threshold items
4. Score divider visually separates above/below threshold contracts
5. Buyer organizations receive scores with the same prompt
6. Buyer scores display alongside contracts with threshold filtering
7. All 11 VIBE requirements (VIBE-01 through VIBE-11) are satisfied
</verification>

<success_criteria>
- Threshold slider controls are visible and functional (1-10, 0.1 steps)
- Toggle between "hide" and "dim" for below-threshold contracts works
- Score divider line separates above/below threshold contracts
- Buyer organizations receive AI scores in the same scoring run
- Buyer scores display with color-coded badges and reasoning
- Threshold filtering applies to both contracts and buyers
- All 11 VIBE requirements are satisfied end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/05-vibe-scanner/05-03-SUMMARY.md`
</output>
