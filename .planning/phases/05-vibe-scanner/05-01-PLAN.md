---
phase: 05-vibe-scanner
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/vibe-scanner.ts
  - src/lib/vibe-scanner.ts
  - src/app/api/vibe-scanner/route.ts
  - src/app/api/vibe-scanner/create/route.ts
  - src/app/(dashboard)/vibe-scanner/page.tsx
  - src/components/vibe-scanner/prompt-editor.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a Vibe Scanner from their existing company profile with one click"
    - "System generates a scoring prompt from the company profile fields (sectors, capabilities, keywords, regions, certifications, idealContractDescription)"
    - "User can view the generated scoring prompt in a textarea and edit it"
  artifacts:
    - path: "src/models/vibe-scanner.ts"
      provides: "VibeScanner Mongoose model with userId, scoringPrompt, contractScores, buyerScores, threshold"
      contains: "vibeScannerSchema"
    - path: "src/lib/vibe-scanner.ts"
      provides: "generateScoringPrompt() from CompanyProfile, getOrCreateScanner(), updateScoringPrompt()"
      exports: ["generateScoringPrompt", "getOrCreateScanner", "updateScoringPrompt"]
    - path: "src/app/api/vibe-scanner/create/route.ts"
      provides: "POST endpoint that creates a VibeScanner from user's CompanyProfile"
      exports: ["POST"]
    - path: "src/app/api/vibe-scanner/route.ts"
      provides: "GET endpoint returning user's scanner, PATCH for updating prompt"
      exports: ["GET", "PATCH"]
    - path: "src/app/(dashboard)/vibe-scanner/page.tsx"
      provides: "Vibe Scanner page with prompt editor"
    - path: "src/components/vibe-scanner/prompt-editor.tsx"
      provides: "Textarea component for viewing/editing scoring prompt"
  key_links:
    - from: "src/app/api/vibe-scanner/create/route.ts"
      to: "src/lib/vibe-scanner.ts"
      via: "generateScoringPrompt + getOrCreateScanner"
      pattern: "generateScoringPrompt.*getOrCreateScanner"
    - from: "src/app/(dashboard)/vibe-scanner/page.tsx"
      to: "/api/vibe-scanner"
      via: "fetch in useEffect or server component"
      pattern: "api/vibe-scanner"
    - from: "src/lib/vibe-scanner.ts"
      to: "src/models/vibe-scanner.ts"
      via: "Mongoose model operations"
      pattern: "VibeScanner\\."
---

<objective>
Create the VibeScanner Mongoose model, scoring prompt generation from CompanyProfile, scanner creation/retrieval APIs, and the Vibe Scanner page with an editable prompt editor.

Purpose: Establishes the data model and prompt generation that all subsequent scoring, threshold, and buyer scoring features depend on. Users need to see their scoring prompt before triggering batch scoring.

Output: VibeScanner model in MongoDB, API endpoints for create/get/update, and a Vibe Scanner page where users can view and edit their scoring prompt.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-vibe-scanner/05-RESEARCH.md

# Key source files to reference
@src/models/company-profile.ts           # CompanyProfile schema (sectors, capabilities, keywords, etc.)
@src/models/contract.ts                  # Contract schema (vibeScore, vibeReasoning placeholders)
@src/models/buyer.ts                     # Buyer schema (vibeScore, vibeReasoning placeholders)
@src/lib/anthropic.ts                    # Anthropic client singleton
@src/lib/contracts.ts                    # Data access layer pattern (fetchContracts, dbConnect)
@src/app/api/profile/generate/route.ts   # Claude API call pattern (auth, structured output, error handling)
@src/app/(dashboard)/contracts/page.tsx  # Server component page pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: VibeScanner model and scoring prompt generation library</name>
  <files>src/models/vibe-scanner.ts, src/lib/vibe-scanner.ts</files>
  <action>
**1. Create VibeScanner Mongoose model** at `src/models/vibe-scanner.ts`:

Follow the pattern from `src/models/contract.ts` (mongoose.models.X || mongoose.model()). Schema:
- `userId`: String, required, unique, index (Clerk user ID)
- `companyProfileId`: Schema.Types.ObjectId, ref "CompanyProfile"
- `scoringPrompt`: String, required (the full scoring rubric text)
- `isDefault`: Boolean, default true (system-generated vs user-edited)
- `lastScoredAt`: Date
- `contractScores`: Array of embedded subdocuments with `{ contractId: ObjectId ref Contract, score: Number min 0 max 10, reasoning: String }` -- use `_id: false` on subdoc schema
- `buyerScores`: Array of embedded subdocuments with `{ buyerId: ObjectId ref Buyer, score: Number min 0 max 10, reasoning: String }` -- use `_id: false` on subdoc schema
- `threshold`: Number, default 5.0, min 0, max 10
- timestamps: true

Add compound indexes: `{ userId: 1, "contractScores.contractId": 1 }` and `{ userId: 1, "contractScores.score": -1 }`.

Export `IVibeScanner` type via `InferSchemaType`.

**2. Create vibe-scanner library** at `src/lib/vibe-scanner.ts`:

Import `dbConnect` from `@/lib/mongodb`, CompanyProfile model, VibeScanner model.

`generateScoringPrompt(profile: ICompanyProfile): string` -- Pure function that transforms a CompanyProfile into a scoring prompt string. Include:
- Company name, summary, sectors (joined), capabilities (joined), keywords (joined), certifications (joined), idealContractDescription, regions (joined), companySize
- Scoring criteria rubric: 9-10 perfect match, 7-8 strong, 5-6 moderate, 3-4 weak, 1-2 no match
- Instructions to provide a score (1-10, one decimal place) and brief reasoning (1-2 sentences)
- Pad with detailed UK procurement context and sector-specific guidance to ensure the prompt exceeds 4096 tokens (Haiku 4.5 prompt caching minimum). Include common CPV divisions, UK regions, and procurement terminology.

`getOrCreateScanner(userId: string): Promise<IVibeScanner>` -- Finds existing VibeScanner by userId, or creates one by loading the user's CompanyProfile and generating a scoring prompt. Calls dbConnect(). If no CompanyProfile exists, throw an error with a clear message.

`updateScoringPrompt(userId: string, newPrompt: string): Promise<IVibeScanner>` -- Updates the scoringPrompt field, sets isDefault to false, and returns the updated scanner. Calls dbConnect().
  </action>
  <verify>
Run `npx next build` to verify no TypeScript errors. Check that the model file exports correctly and the library functions have proper types.
  </verify>
  <done>
VibeScanner model file exists with correct schema, indexes, and type export. Library exports generateScoringPrompt, getOrCreateScanner, and updateScoringPrompt with proper CompanyProfile integration. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Scanner API endpoints and Vibe Scanner page with prompt editor</name>
  <files>src/app/api/vibe-scanner/create/route.ts, src/app/api/vibe-scanner/route.ts, src/app/(dashboard)/vibe-scanner/page.tsx, src/components/vibe-scanner/prompt-editor.tsx</files>
  <action>
**1. Create scanner creation endpoint** at `src/app/api/vibe-scanner/create/route.ts`:

POST handler following the pattern from `src/app/api/profile/generate/route.ts`:
- `auth()` for userId, return 401 if not authenticated
- Call `getOrCreateScanner(userId)` from `src/lib/vibe-scanner.ts`
- Return `{ scanner: { _id, scoringPrompt, isDefault, threshold, contractScores: [], buyerScores: [] } }`
- Catch errors, return 500 with error message. If error message indicates no CompanyProfile, return 400.

**2. Create scanner retrieval/update endpoint** at `src/app/api/vibe-scanner/route.ts`:

GET handler:
- `auth()` for userId, return 401 if not authenticated
- `dbConnect()`, then `VibeScanner.findOne({ userId }).lean()`
- Return `{ scanner }` (null if none exists)

PATCH handler:
- `auth()` for userId, return 401 if not authenticated
- Parse body `{ scoringPrompt: string }`
- Validate scoringPrompt is a non-empty string, return 400 otherwise
- Call `updateScoringPrompt(userId, scoringPrompt)`
- Return `{ scanner: updated }`

**3. Create PromptEditor component** at `src/components/vibe-scanner/prompt-editor.tsx`:

Client component ("use client"). Props: `{ prompt: string; isDefault: boolean; onPromptChange: (prompt: string) => void; onApplyScore: () => void; isScoring: boolean }`.

UI:
- Textarea (from `@/components/ui/textarea`) displaying the scoring prompt, full width, min-height ~300px, font-mono for readability
- Below textarea: two buttons in a flex row:
  - "Reset to Default" button (outline variant, only shown when `!isDefault`): calls API to regenerate default prompt
  - "Apply & Score" button (default variant, with Sparkles icon from lucide-react): triggers `onApplyScore`. Disabled when `isScoring`. Shows "Scoring..." text when scoring is active.
- Above textarea: label "Scoring Prompt" and a muted description: "This prompt is used to score contracts against your company profile. Edit it to adjust how contracts are evaluated."

**4. Create Vibe Scanner page** at `src/app/(dashboard)/vibe-scanner/page.tsx`:

Client component ("use client") since it manages scanner state, prompt editing, and will later handle scoring.

On mount:
- Fetch GET `/api/vibe-scanner` to check for existing scanner
- If no scanner exists, show a "Create Vibe Scanner" card with description explaining what it does and a button that POSTs to `/api/vibe-scanner/create`
- If scanner exists, show the PromptEditor with the scanner's scoringPrompt

State:
- `scanner` (the full scanner object or null)
- `prompt` (current textarea value, initialized from scanner.scoringPrompt)
- `isLoading` (for initial load)
- `isCreating` (for scanner creation)
- `isScoring` (placeholder for Plan 02)

When user edits the prompt textarea, update local `prompt` state. When user clicks "Apply & Score", first PATCH the prompt to save it, then (in Plan 02) trigger scoring.

Page layout:
- Header: "Vibe Scanner" title with "AI-powered contract scoring" subtitle
- If no scanner: centered Card with Sparkles icon, title "Create Your Vibe Scanner", description about AI scoring, and "Create Scanner" button
- If scanner exists: PromptEditor component, then a placeholder div for the scored contract feed (Plan 02 will add it)
  </action>
  <verify>
Run `npx next build` to verify no TypeScript errors. Verify all 4 files exist with correct exports. Check that the page renders at /vibe-scanner route.
  </verify>
  <done>
POST /api/vibe-scanner/create creates a scanner from CompanyProfile and returns it. GET /api/vibe-scanner retrieves existing scanner. PATCH /api/vibe-scanner updates the scoring prompt. Vibe Scanner page shows create flow when no scanner exists and prompt editor when scanner exists. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npx next build` succeeds with no errors
2. VibeScanner model file exports the model and IVibeScanner type
3. Library generates a scoring prompt from CompanyProfile fields (>4096 tokens for caching)
4. API endpoints handle auth, create, get, and update operations
5. Vibe Scanner page is accessible at /vibe-scanner and shows prompt editor
</verification>

<success_criteria>
- User can navigate to /vibe-scanner and create a Vibe Scanner from their company profile
- Generated scoring prompt includes company sectors, capabilities, keywords, and scoring rubric
- User can edit the scoring prompt in the textarea
- VIBE-01, VIBE-02, VIBE-03 requirements are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-vibe-scanner/05-01-SUMMARY.md`
</output>
