---
phase: 05-vibe-scanner
plan: 06
type: execute
wave: 5
depends_on: ["05-05"]
files_modified:
  - src/components/scanners/threshold-controls.tsx
  - src/components/scanners/ai-cell-drawer.tsx
  - src/components/scanners/scanner-table.tsx
  - src/app/(dashboard)/scanners/[id]/page.tsx
  - src/components/scanners/score-progress-bar.tsx
autonomous: true

must_haves:
  truths:
    - "User can adjust a score threshold slider from 1 to 10 with 0.1 increments"
    - "Contracts below the threshold appear with reduced opacity or are hidden based on a toggle"
    - "A visual divider separates above-threshold and below-threshold rows in the table"
    - "Clicking an AI cell opens a side drawer with full response, reasoning, and metadata"
    - "Scoring progress is displayed above the table during batch scoring"
  artifacts:
    - path: "src/components/scanners/threshold-controls.tsx"
      provides: "Slider with 0.1 step, hide/dim Switch toggle, and threshold stats"
    - path: "src/components/scanners/ai-cell-drawer.tsx"
      provides: "Side drawer showing full AI response, reasoning, score, and metadata"
    - path: "src/components/scanners/score-progress-bar.tsx"
      provides: "Progress bar component for scanning status with column-aware progress"
  key_links:
    - from: "src/components/scanners/threshold-controls.tsx"
      to: "src/stores/scanner-store.ts"
      via: "useScannerStore for threshold and hideBelow state"
      pattern: "useScannerStore"
    - from: "src/components/scanners/ai-cell-drawer.tsx"
      to: "src/stores/scanner-store.ts"
      via: "useScannerStore to read score entry for selected cell"
      pattern: "useScannerStore"
    - from: "src/components/scanners/scanner-table.tsx"
      to: "src/components/scanners/ai-cell-drawer.tsx"
      via: "AI cell click triggers drawer open with cell details"
      pattern: "onAiCellClick|setDrawerCell"
---

<objective>
Add threshold controls (slider + hide/dim toggle), a side drawer for AI cell details, a scoring progress bar, and visual polish to complete all Vibe Scanner requirements.

Purpose: These are the interactive controls that make the scanner usable -- threshold tuning for signal-to-noise, the drawer for deep-dive analysis, and progress feedback during scoring. This plan completes all 11 VIBE requirements.

Output: Fully functional scanner experience with threshold controls, side drawer, progress bar, and visual divider.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-vibe-scanner/05-CONTEXT.md
@.planning/phases/05-vibe-scanner/05-05-SUMMARY.md

# Key source files
@src/stores/scanner-store.ts                    # Scanner store (from Plan 03)
@src/components/scanners/scanner-table.tsx       # Table component (from Plans 03+05)
@src/app/(dashboard)/scanners/[id]/page.tsx     # Scanner detail page (from Plans 03+05)
@src/components/scanners/scanner-header.tsx      # Header with toolbar (from Plan 03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Threshold controls with slider, toggle, stats, and table divider</name>
  <files>src/components/scanners/threshold-controls.tsx, src/components/scanners/scanner-table.tsx, src/components/scanners/score-progress-bar.tsx</files>
  <action>
**1. Install shadcn Slider and Switch** -- Run `npx shadcn@latest add slider switch` (skip if already present, check `src/components/ui/slider.tsx` and `src/components/ui/switch.tsx` first).

**2. Create ThresholdControls component** at `src/components/scanners/threshold-controls.tsx`:

Client component ("use client"). Reads from `useScannerStore`: threshold, setThreshold, hideBelow, setHideBelow, scores.

Layout (single row with flex, wrapped in a Card with compact padding):

- **Slider section** (flex-1, min-w-[200px]):
  - Label: "Threshold: {threshold.toFixed(1)}"
  - shadcn `Slider` with `value={[threshold]}`, `onValueChange={([v]) => setThreshold(v)}`, `min={1}`, `max={10}`, `step={0.1}`
  - Scale markers: "1" left, "10" right (text-xs, text-muted-foreground)

- **Toggle section** (flex items-center gap-2):
  - shadcn `Switch` with `checked={hideBelow}`, `onCheckedChange={setHideBelow}`
  - Label: `{hideBelow ? "Hide" : "Dim"}` (text-sm)

- **Stats section** (text-right, text-sm, text-muted-foreground):
  - Calculate from store: count entries where the first AI column's score >= threshold
  - Display: "{aboveCount}/{totalScored} above"

Only render when scores exist (totalScored > 0).

**3. Create ScoreProgressBar component** at `src/components/scanners/score-progress-bar.tsx`:

Client component. Reads from `useScannerStore`: isScoring, scoringProgress.

Display:
- Only visible when isScoring is true or scoringProgress.total > 0
- shadcn `Progress` component with value = `(scored / total) * 100`
- Text: If scoringProgress.columnId is set, show "Scoring [column name]... {scored}/{total}" else "Scoring... {scored}/{total}"
- When complete (!isScoring && scored === total && total > 0): show "Scoring complete! {scored} items scored." with a CheckCircle2 icon
- Compact layout in a rounded border card (similar to existing score-progress.tsx pattern)

**4. Update ScannerTable for threshold divider** at `src/components/scanners/scanner-table.tsx`:

Add threshold-aware rendering:

- Read `threshold`, `hideBelow` from useScannerStore
- When rendering rows, determine each row's primary score (first AI column)
- Split rows into `aboveThreshold` and `belowThreshold` arrays
- Render `aboveThreshold` rows normally
- Between the two groups, insert a **table divider row**:
  - Full-width `<TableRow>` with a single `<TableCell colSpan={columns.length}>`
  - Inside: a horizontal Separator with centered text: "Below threshold ({threshold.toFixed(1)})"
  - Style: bg-muted/50, text-xs, text-muted-foreground, py-1
  - Use the established separator pattern (relative container + absolute centered span)
- Render `belowThreshold` rows:
  - If `hideBelow` true: render a collapsed summary row: "{N} rows below threshold" with text-muted-foreground. Clicking expands to show them.
  - If `hideBelow` false: render with `opacity-40` class on each TableRow
- Only show divider when both above and below groups have entries
  </action>
  <verify>
Run `npx next build` to verify no TypeScript errors. Verify slider renders with 0.1 step increments. Check that toggle switches between hide and dim modes. Verify table divider appears between threshold groups.
  </verify>
  <done>
Threshold slider adjusts from 1-10 in 0.1 increments. Toggle switches between hide and dim modes. Score divider row separates above/below threshold in the table. Stats show above-threshold count. Progress bar tracks scoring status with column awareness. VIBE-06, VIBE-07, VIBE-08, VIBE-10 requirements satisfied. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: AI cell side drawer and final page integration</name>
  <files>src/components/scanners/ai-cell-drawer.tsx, src/app/(dashboard)/scanners/[id]/page.tsx</files>
  <action>
**1. Install shadcn Sheet** (if not already present) -- `npx shadcn@latest add sheet` (Sheet is the shadcn side drawer component).

**2. Create AiCellDrawer component** at `src/components/scanners/ai-cell-drawer.tsx`:

Client component ("use client"). Props: `{ open: boolean; onOpenChange: (open: boolean) => void; columnId: string | null; entityId: string | null; columnName: string; entityName: string; scannerType: ScannerType }`.

Uses shadcn `Sheet` (opens from right side).

Layout inside the Sheet:
- **SheetHeader:**
  - SheetTitle: column name (e.g., "Vibe Score" or custom column name)
  - SheetDescription: entity name (e.g., the contract title or buyer name)

- **Score display section** (if numeric score exists):
  - Large score number (text-4xl, font-bold)
  - Color-coded background circle (green >= 7, yellow >= 4, red < 4)
  - Score label: "out of 10"

- **Reasoning section:**
  - Heading: "Reasoning" (text-sm, font-medium)
  - Full reasoning text (text-sm, text-muted-foreground, no truncation)

- **Full Response section:**
  - Heading: "Full Response" (text-sm, font-medium)
  - Full response text (text-sm, whitespace-pre-wrap for formatting)
  - If response differs from reasoning, show it. If same, hide this section.

- **Metadata section** (bottom, text-xs, text-muted-foreground):
  - "Column type:" default or custom
  - "Last scored:" formatted date from scoredAt
  - "Scanner type:" badge

Read the score entry from useScannerStore using the composite key `${columnId}:${entityId}`.

If no score entry exists, show empty state: "Not yet scored. Click 'Score All' to analyze this item."

**3. Final page integration** at `src/app/(dashboard)/scanners/[id]/page.tsx`:

Wire all remaining components:

- **Add ThresholdControls** between the ScoreProgressBar and the table
- **Add ScoreProgressBar** between the header and threshold controls
- **Add AiCellDrawer** controlled by local state `drawerCell: { columnId: string; entityId: string } | null`
- **Wire AI cell click in table:**
  - ScannerTable's onAiCellClick callback sets `drawerCell` to `{ columnId, entityId }`
  - When drawerCell is set, open the AiCellDrawer with the cell details
  - Lookup the entity name from the rows array by entityId
  - Lookup the column name from scanner.aiColumns by columnId

**Complete page layout (top to bottom):**
1. ScannerHeader (name, type badge, description, Score All, Add Column, Edit buttons)
2. ScoreProgressBar (visible during scoring)
3. ThresholdControls (visible when scores exist)
4. ScannerTable (entity data + AI columns with click handlers)
5. AiCellDrawer (slide-over from right when AI cell is clicked)

**Ensure the old /vibe-scanner page redirects:**
- If the old `/vibe-scanner` route still exists, add a redirect to `/scanners` in the page or remove the old page entirely. The sidebar already points to /scanners from Plan 02.

**Final cleanup:**
- Remove or mark as deprecated: `src/app/(dashboard)/vibe-scanner/page.tsx` (old single scanner page)
- The old `src/stores/vibe-store.ts` can remain for now (it's not imported by anything in the new architecture)
- The old `src/app/api/vibe-scanner/*` routes can remain for backward compatibility
  </action>
  <verify>
Run `npx next build` to verify no TypeScript errors. Verify clicking an AI cell opens the side drawer. Verify all components are wired correctly on the scanner detail page. Check that the complete layout renders: header, progress, threshold, table, drawer.
  </verify>
  <done>
AI cell side drawer opens on click showing full response, reasoning, score with color-coded display, and metadata. All components integrated on scanner detail page in correct order. Threshold controls, progress bar, and drawer all functional. Old vibe-scanner page redirected or removed. All 11 VIBE requirements satisfied end-to-end. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npx next build` succeeds with no errors
2. Slider adjusts threshold 1-10 with 0.1 step increments
3. Switch toggles between hide and dim for below-threshold rows
4. Score divider row in table separates above/below threshold
5. Clicking AI cell opens side drawer with full response + reasoning
6. Progress bar tracks scoring with column-level granularity
7. Complete page layout: header -> progress -> threshold -> table -> drawer
8. All 11 VIBE requirements (VIBE-01 through VIBE-11) are satisfied
</verification>

<success_criteria>
- Threshold slider controls are visible and functional (1-10, 0.1 steps)
- Toggle between "hide" and "dim" for below-threshold rows works
- Score divider row separates above/below threshold in table
- AI cell click opens Starbridge-style side drawer with full analysis
- Progress bar shows column-aware scoring progress
- All VIBE requirements are satisfied end-to-end:
  - VIBE-01: Create scanner from profile (Plan 01-02)
  - VIBE-02: Generate scoring query (Plan 01-02)
  - VIBE-03: View/edit scoring query (Plan 02)
  - VIBE-04: Batch scoring with Claude Haiku (Plan 04-05)
  - VIBE-05: Score display with reasoning (Plan 03-05)
  - VIBE-06: Threshold slider (Plan 06)
  - VIBE-07: Below-threshold dim/hide (Plan 06)
  - VIBE-08: Score divider (Plan 06)
  - VIBE-09: Re-score after edit (Plan 05)
  - VIBE-10: Scoring progress (Plan 06)
  - VIBE-11: Buyer scoring (Plans 01+04 -- buyers scanner type scores orgs)
</success_criteria>

<output>
After completion, create `.planning/phases/05-vibe-scanner/05-06-SUMMARY.md`
</output>
