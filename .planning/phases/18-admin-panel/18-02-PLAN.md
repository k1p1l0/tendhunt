---
phase: 18-admin-panel
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - apps/admin/src/app/(dashboard)/page.tsx
  - apps/admin/src/app/(dashboard)/workers/page.tsx
  - apps/admin/src/app/api/workers/status/route.ts
  - apps/admin/src/app/api/stats/route.ts
  - apps/admin/src/components/dashboard/worker-status-card.tsx
  - apps/admin/src/components/dashboard/stats-cards.tsx
  - apps/admin/src/components/dashboard/recent-activity.tsx
  - apps/admin/src/lib/workers.ts
  - apps/admin/src/lib/stats.ts
autonomous: true

must_haves:
  truths:
    - "Admin can see health status of all 3 workers (data-sync, enrichment, spend-ingest) with last run time, processed count, and error count"
    - "Worker cards show running/complete/error status with color-coded badges"
    - "Overview page shows aggregate platform stats (total contracts, buyers, signals, users)"
    - "Data auto-refreshes every 15 seconds via polling without page reload"
    - "Recent activity feed shows latest ingested items across all collections"
  artifacts:
    - path: "apps/admin/src/app/api/workers/status/route.ts"
      provides: "Worker status API endpoint"
      exports: ["GET"]
    - path: "apps/admin/src/components/dashboard/worker-status-card.tsx"
      provides: "Worker health status card component"
      contains: "WorkerStatusCard"
    - path: "apps/admin/src/app/(dashboard)/page.tsx"
      provides: "Overview dashboard with stats and workers"
      contains: "useEffect"
    - path: "apps/admin/src/app/(dashboard)/workers/page.tsx"
      provides: "Workers detail page"
      contains: "WorkerStatusCard"
  key_links:
    - from: "apps/admin/src/app/(dashboard)/page.tsx"
      to: "/api/workers/status"
      via: "polling fetch every 15s"
      pattern: "setInterval.*fetch.*workers/status"
    - from: "apps/admin/src/app/api/workers/status/route.ts"
      to: "MongoDB syncJobs + enrichmentjobs + spendingestjobs"
      via: "database queries"
      pattern: "collection.*syncJobs|enrichmentjobs|spendingestjobs"
---

<objective>
Build the overview dashboard and workers monitoring page. The overview shows aggregate platform stats, worker health summary cards, and a recent activity feed. The workers page shows detailed status for each of the 3 workers with stage-level progress, error counts, and last run times. All data auto-refreshes via 15-second polling.

Purpose: ADMIN-01 (worker health monitoring) and ADMIN-04 (data pipeline visibility) are the core admin requirements.
Output: Working overview dashboard + workers detail page with live-polling data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-admin-panel/18-01-SUMMARY.md
@apps/workers/data-sync/src/types.ts
@apps/workers/spend-ingest/src/types.ts
@apps/web/src/models/enrichment-job.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Worker status API + stats API + data access functions</name>
  <files>
    apps/admin/src/app/api/workers/status/route.ts
    apps/admin/src/app/api/stats/route.ts
    apps/admin/src/lib/workers.ts
    apps/admin/src/lib/stats.ts
  </files>
  <action>
    1. **lib/workers.ts** — Data access functions for worker job status:
       - `fetchAllWorkerStatus()`: Queries 3 MongoDB collections in parallel using Promise.all:
         - `syncJobs` collection: find all docs (data-sync worker has 2 jobs: FIND_A_TENDER, CONTRACTS_FINDER). Fields: source, status, totalFetched, lastRunAt, lastRunFetched, lastRunErrors, errorLog (last 5 only).
         - `enrichmentjobs` collection: find all docs (enrichment worker has 6 stage jobs: classify, governance_urls, moderngov, scrape, personnel, score). Fields: stage, status, totalProcessed, totalErrors, lastRunAt, errorLog (last 5 only).
         - `spendingestjobs` collection: find all docs (spend-ingest worker has 4 stage jobs: discover, extract_links, download_parse, aggregate). Fields: stage, status, totalProcessed, totalErrors, lastRunAt, errorLog (last 5 only).
       - Each worker type returns: workerName, overall status (derive from job statuses: if any "running" -> running, any "error" -> error, all "complete" -> complete, else idle), lastRunAt (most recent across all jobs), totalProcessed (sum), totalErrors (sum), stages/jobs array with per-stage details.
       - Use native MongoDB driver via mongoose.connection.db (not Mongoose models — the admin app shouldn't duplicate model definitions). Import dbConnect from `@/lib/mongodb`.
       - Return typed `WorkerStatus[]` interface.

    2. **lib/stats.ts** — Aggregate platform statistics:
       - `fetchPlatformStats()`: Queries collection counts in parallel using Promise.all with estimatedDocumentCount pattern (same as apps/web dashboard):
         - contracts count
         - buyers count
         - signals count
         - users count (from `users` collection)
         - companyprofiles count
         - creditaccounts count
         - spendtransactions count
         - boarddocuments count
         - keypersonnel count
       - Also fetch 10 most recent items across contracts, buyers, signals (sort by createdAt desc, project only _id, title/name, createdAt, source/type).
       - Return typed `PlatformStats` interface.

    3. **API route /api/workers/status** (GET):
       - Require auth via `await auth()`, return 401 if no userId
       - Call `fetchAllWorkerStatus()`, return JSON
       - Include `Cache-Control: no-store` header (polling must always be fresh)

    4. **API route /api/stats** (GET):
       - Require auth via `await auth()`, return 401 if no userId
       - Call `fetchPlatformStats()`, return JSON
       - Include `Cache-Control: no-store` header
  </action>
  <verify>
    Run `bun run --cwd apps/admin typecheck` — must pass.
    Curl test: `curl http://localhost:3001/api/workers/status` returns JSON array of 3 worker statuses.
    Curl test: `curl http://localhost:3001/api/stats` returns JSON with collection counts.
  </verify>
  <done>API routes return worker health data from all 3 job collections and aggregate platform stats from 9 collections.</done>
</task>

<task type="auto">
  <name>Task 2: Overview dashboard + workers page with polling UI</name>
  <files>
    apps/admin/src/app/(dashboard)/page.tsx
    apps/admin/src/app/(dashboard)/workers/page.tsx
    apps/admin/src/components/dashboard/worker-status-card.tsx
    apps/admin/src/components/dashboard/stats-cards.tsx
    apps/admin/src/components/dashboard/recent-activity.tsx
  </files>
  <action>
    1. **WorkerStatusCard** component (`"use client"`):
       - Card showing: worker name, status badge (color-coded: green=complete, yellow=running, red=error, gray=idle), last run time (relative using date-fns `formatDistanceToNow`), total processed count, total errors count.
       - Stage breakdown: small list of stages with their individual status dots (green/yellow/red) and processed counts.
       - For data-sync: show 2 sources (Find a Tender, Contracts Finder) with their individual totalFetched.
       - For enrichment: show 6 stages with progress.
       - For spend-ingest: show 4 stages with progress.
       - Use shadcn Card, Badge, Separator components.
       - Animate status badge with subtle pulse when "running" (Tailwind `animate-pulse`).
       - Motion: use `tw-animate-css` fade-in on mount (matching project convention from Phase 9 — no framer-motion).

    2. **StatsCards** component:
       - Grid of stat cards (4 columns on lg, 2 on md, 1 on sm).
       - Show: Total Contracts, Total Buyers, Total Signals, Total Users.
       - Each card: icon + count + label. Use shadcn Card.
       - Secondary row: Spend Transactions, Board Documents, Key Personnel, Company Profiles.
       - Skeleton loading state while data fetches.

    3. **RecentActivity** component:
       - Simple list of 10 most recent items (contracts + buyers + signals mixed, sorted by createdAt desc).
       - Each row: icon by type (FileText for contract, Building2 for buyer, Zap for signal), title/name, relative time, type badge.
       - Use shadcn Table or simple list.

    4. **Overview page** (`"use client"` for polling):
       - Heading: "Platform Overview" with last-refreshed timestamp.
       - Manual refresh button (RefreshCw icon) that re-fetches immediately.
       - Auto-refresh: `useEffect` with `setInterval` at 15 seconds. Fetch both `/api/workers/status` and `/api/stats` in parallel.
       - Layout: StatsCards at top, then 3 WorkerStatusCards in a row, then RecentActivity below.
       - Loading: Skeleton states on initial load, no skeleton on subsequent polls (just update data).

    5. **Workers page** (`"use client"` for polling):
       - Heading: "Worker Health" with last-refreshed timestamp + refresh button.
       - 3 larger WorkerStatusCards in a single column (more detail than overview cards).
       - Each card shows: full stage breakdown table (stage name, status, processed, errors, last run), last 5 error log entries (collapsible), overall timing info.
       - Same 15-second polling pattern.
       - When all stages show "complete", display a green "All Healthy" banner.
       - When any stage shows "error", display a red "Attention Required" banner with affected worker name.
  </action>
  <verify>
    Run `bun run --cwd apps/admin typecheck` — must pass.
    Visually: Overview page shows 8 stat cards, 3 worker cards, recent activity list.
    Visually: Workers page shows 3 detailed worker cards with stage breakdowns.
    Polling: Data updates every 15 seconds without page reload (check Network tab).
  </verify>
  <done>Overview dashboard displays platform stats, worker health summary, and recent activity. Workers page shows detailed per-stage health. Both auto-refresh via 15-second polling.</done>
</task>

</tasks>

<verification>
1. `bun run --cwd apps/admin typecheck` passes
2. `/api/workers/status` returns JSON with 3 worker entries (data-sync, enrichment, spend-ingest)
3. `/api/stats` returns JSON with counts for all 9 collections
4. Overview page renders 8 stat cards, 3 worker cards, and recent activity
5. Workers page renders 3 detailed cards with stage breakdowns
6. Auto-polling works every 15 seconds (visible in Network tab)
7. Status badges correctly color-coded (green/yellow/red)
</verification>

<success_criteria>
- Admin sees all 3 workers' health at a glance on the overview page
- Workers page shows per-stage progress for enrichment (6 stages), spend-ingest (4 stages), and data-sync (2 sources)
- Error counts and last 5 error messages visible per worker
- Data refreshes automatically every 15 seconds via polling
- Skeleton loading states on initial load
</success_criteria>

<output>
After completion, create `.planning/phases/18-admin-panel/18-02-SUMMARY.md`
</output>
