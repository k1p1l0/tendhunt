---
phase: 18-admin-panel
plan: 04
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - apps/admin/src/app/(dashboard)/users/page.tsx
  - apps/admin/src/app/api/users/route.ts
  - apps/admin/src/components/users/user-table.tsx
  - apps/admin/src/lib/users.ts
autonomous: true

must_haves:
  truths:
    - "Admin can see a list of all platform users with email, name, signup date, and last sign-in"
    - "Each user row shows their company name and credit balance from MongoDB"
    - "User list shows total registered user count"
    - "Users are sorted by most recently signed up first"
  artifacts:
    - path: "apps/admin/src/app/api/users/route.ts"
      provides: "Users API endpoint enriched with MongoDB data"
      exports: ["GET"]
    - path: "apps/admin/src/app/(dashboard)/users/page.tsx"
      provides: "Users management page"
      contains: "UserTable"
    - path: "apps/admin/src/lib/users.ts"
      provides: "User data access with Clerk + MongoDB enrichment"
      contains: "fetchEnrichedUsers"
  key_links:
    - from: "apps/admin/src/app/api/users/route.ts"
      to: "Clerk API + MongoDB companyprofiles + creditaccounts"
      via: "clerkClient + db.collection"
      pattern: "clerkClient.*getUserList|collection.*companyprofiles"
    - from: "apps/admin/src/app/(dashboard)/users/page.tsx"
      to: "/api/users"
      via: "fetch on mount"
      pattern: "fetch.*api/users"
---

<objective>
Build the user management page showing all platform users sourced from Clerk, enriched with MongoDB data (company profile, credit balance, scanner count). Provides ADMIN-05 (user visibility with key metrics).

Purpose: Admin needs to see who is using the platform, when they signed up, what company they created, and their credit usage.
Output: Users page with enriched user table and user count.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-admin-panel/18-01-SUMMARY.md
@apps/web/src/models/user.ts
@apps/web/src/models/company-profile.ts
@apps/web/src/models/credit.ts
@apps/web/src/models/scanner.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Users API route with Clerk + MongoDB enrichment</name>
  <files>
    apps/admin/src/app/api/users/route.ts
    apps/admin/src/lib/users.ts
  </files>
  <action>
    1. **lib/users.ts** — User data access layer:

       - `fetchEnrichedUsers()`:
         - Fetch all users from Clerk via `clerkClient().users.getUserList({ limit: 100, orderBy: "-created_at" })`. Import `clerkClient` from `@clerk/nextjs/server`.
         - Get MongoDB database handle via `dbConnect()` then `mongoose.connection.db`.
         - Batch-fetch MongoDB data for all users in 2 parallel queries:
           - `companyprofiles` collection: `find({ userId: { $in: clerkIds } })` — get companyName, logoUrl, sectors for each user.
           - `creditaccounts` collection: `find({ userId: { $in: clerkIds } })` — get balance, totalSpent for each user.
         - Build lookup maps (userId -> profile, userId -> credits) for O(1) enrichment.
         - Merge Clerk data with MongoDB data into enriched user objects:
           ```
           {
             id: clerk.id,
             email: clerk.emailAddresses[0]?.emailAddress,
             firstName: clerk.firstName,
             lastName: clerk.lastName,
             imageUrl: clerk.imageUrl,
             createdAt: clerk.createdAt,
             lastSignInAt: clerk.lastSignInAt,
             role: clerk.publicMetadata?.role || "user",
             onboardingComplete: clerk.publicMetadata?.onboardingComplete || false,
             companyName: profile?.companyName || null,
             companyLogo: profile?.logoUrl || null,
             creditBalance: credits?.balance || 0,
             totalCreditsSpent: credits?.totalSpent || 0,
           }
           ```
         - Return `{ users: EnrichedUser[], total: number }`.

       - Define `EnrichedUser` TypeScript interface in the same file.

    2. **API route /api/users** (GET):
       - Require auth via `await auth()`, return 401 if no userId.
       - Double-check admin role: fetch current user from Clerk, verify `publicMetadata.role === "admin"`. Return 403 if not admin. This is a defense-in-depth check beyond middleware (middleware already checks, but sensitive user data warrants extra validation).
       - Call `fetchEnrichedUsers()`, return JSON.
       - `Cache-Control: no-store`.
  </action>
  <verify>
    Run `bun run --cwd apps/admin typecheck` — must pass.
    Curl test: `/api/users` returns JSON with users array containing Clerk + MongoDB enriched data.
  </verify>
  <done>Users API returns Clerk user list enriched with company profiles, credit balances, and role metadata.</done>
</task>

<task type="auto">
  <name>Task 2: Users page with enriched user table</name>
  <files>
    apps/admin/src/app/(dashboard)/users/page.tsx
    apps/admin/src/components/users/user-table.tsx
  </files>
  <action>
    1. **UserTable component** (`"use client"`):
       - Table using shadcn Table components.
       - Columns:
         - User: Avatar (imageUrl or initials fallback) + full name + email below in muted text
         - Company: Company name or "—" if not set
         - Role: Badge showing "admin" (purple) or "user" (default)
         - Onboarding: Green checkmark or yellow "Pending" text
         - Credits: Balance number + total spent in muted text below (e.g., "8 credits" / "2 spent")
         - Signed Up: Relative time (date-fns formatDistanceToNow)
         - Last Active: Relative time from lastSignInAt, or "Never" if null
       - Props: `users: EnrichedUser[]`, `loading: boolean`
       - Loading: 5 skeleton rows.
       - Empty state: "No users found" message.
       - Row hover effect with subtle background transition.

    2. **Users page** (`"use client"`):
       - Heading: "Users" with total count badge.
       - Refresh button + auto-refresh every 30 seconds (same pattern as data pages).
       - Fetch from `/api/users` on mount and interval.
       - Render UserTable with fetched data.
       - Summary stats row above table: total users, admin count, onboarded count, total credits in circulation (sum of all balances).
  </action>
  <verify>
    Run `bun run --cwd apps/admin typecheck` — must pass.
    Visually: Users page shows table with user avatars, company names, credit balances, and role badges.
    Summary stats show aggregated user metrics above the table.
  </verify>
  <done>Users page displays all platform users with Clerk data + MongoDB enrichment (company, credits, role), summary stats, and auto-refresh.</done>
</task>

</tasks>

<verification>
1. `bun run --cwd apps/admin typecheck` passes
2. `/api/users` returns JSON with enriched user data (Clerk fields + company + credits)
3. Users page renders table with 7 columns (User, Company, Role, Onboarding, Credits, Signed Up, Last Active)
4. Admin role badge shows purple, user role shows default
5. Credit balance and total spent visible per user
6. Summary stats correct (total users, admin count, onboarded %, total credits)
7. Auto-refresh works every 30 seconds
</verification>

<success_criteria>
- Admin can see every platform user with their key metrics
- Company association visible (from CompanyProfile collection)
- Credit balance and spending visible (from CreditAccount collection)
- Role and onboarding status visible (from Clerk metadata)
- Data refreshes automatically
</success_criteria>

<output>
After completion, create `.planning/phases/18-admin-panel/18-04-SUMMARY.md`
</output>
