---
phase: 18-admin-panel
plan: 03
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - apps/admin/src/app/(dashboard)/data/contracts/page.tsx
  - apps/admin/src/app/(dashboard)/data/buyers/page.tsx
  - apps/admin/src/app/(dashboard)/data/signals/page.tsx
  - apps/admin/src/app/api/data/contracts/route.ts
  - apps/admin/src/app/api/data/buyers/route.ts
  - apps/admin/src/app/api/data/signals/route.ts
  - apps/admin/src/components/data-tables/data-table.tsx
  - apps/admin/src/components/data-tables/columns.tsx
  - apps/admin/src/lib/data.ts
autonomous: true

must_haves:
  truths:
    - "Admin can see the 100 most recently added contracts with title, buyer, value, status, source, and date"
    - "Admin can see the 100 most recently added buyers with name, orgType, enrichment score, and region"
    - "Admin can see the 100 most recently added signals with organization, type, title, and date"
    - "Each data table shows total collection count and displays when each item was created"
    - "Tables are sortable by date and show source attribution"
  artifacts:
    - path: "apps/admin/src/app/api/data/contracts/route.ts"
      provides: "Recent contracts API"
      exports: ["GET"]
    - path: "apps/admin/src/app/api/data/buyers/route.ts"
      provides: "Recent buyers API"
      exports: ["GET"]
    - path: "apps/admin/src/app/api/data/signals/route.ts"
      provides: "Recent signals API"
      exports: ["GET"]
    - path: "apps/admin/src/components/data-tables/data-table.tsx"
      provides: "Reusable data table component"
      contains: "DataTable"
  key_links:
    - from: "apps/admin/src/app/(dashboard)/data/contracts/page.tsx"
      to: "/api/data/contracts"
      via: "fetch with polling"
      pattern: "fetch.*api/data/contracts"
    - from: "apps/admin/src/app/api/data/contracts/route.ts"
      to: "MongoDB contracts collection"
      via: "aggregation pipeline"
      pattern: "collection.*contracts.*aggregate"
---

<objective>
Build data explorer pages for contracts, buyers, and signals. Each page shows a sortable table of the 100 most recently ingested items with key fields, collection count header, and auto-refreshing data. This provides visibility into what information is being parsed and saved (ADMIN-02, ADMIN-03).

Purpose: Admin needs to see what data is flowing into the platform — recently added contracts, buyers, and signals with their key attributes and timestamps.
Output: Three data pages with tables showing recent data, plus 3 API routes serving the data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-admin-panel/18-01-SUMMARY.md
@apps/web/src/models/contract.ts
@apps/web/src/models/buyer.ts
@apps/web/src/models/signal.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Data API routes for recent contracts, buyers, signals</name>
  <files>
    apps/admin/src/app/api/data/contracts/route.ts
    apps/admin/src/app/api/data/buyers/route.ts
    apps/admin/src/app/api/data/signals/route.ts
    apps/admin/src/lib/data.ts
  </files>
  <action>
    1. **lib/data.ts** — Shared data access functions using native MongoDB driver (via mongoose.connection.db):

       - `fetchRecentContracts(limit = 100)`: MongoDB aggregation pipeline:
         - Sort by `createdAt: -1`
         - Limit to `limit`
         - Project: `_id`, `title`, `buyerName`, `status`, `source`, `sector`, `valueMin`, `valueMax`, `currency`, `publishedDate`, `deadlineDate`, `createdAt`, `updatedAt`
         - Also return total count via `estimatedDocumentCount()`

       - `fetchRecentBuyers(limit = 100)`: MongoDB aggregation pipeline:
         - Sort by `createdAt: -1`
         - Limit to `limit`
         - Project: `_id`, `name`, `orgType`, `sector`, `region`, `website`, `enrichmentScore`, `contractCount`, `createdAt`, `updatedAt`, `lastEnrichedAt`
         - Also return total count

       - `fetchRecentSignals(limit = 100)`: MongoDB aggregation pipeline:
         - Sort by `createdAt: -1`
         - Limit to `limit`
         - Project: `_id`, `organizationName`, `signalType`, `title`, `insight`, `source`, `sourceDate`, `sector`, `confidence`, `createdAt`
         - Also return total count

       All functions return `{ items: T[], total: number }`.

    2. **API route /api/data/contracts** (GET):
       - Require auth via `await auth()`, return 401 if no userId
       - Accept optional `limit` query param (default 100, max 500)
       - Call `fetchRecentContracts(limit)`, return JSON
       - `Cache-Control: no-store`

    3. **API route /api/data/buyers** (GET):
       - Same pattern as contracts
       - Call `fetchRecentBuyers(limit)`, return JSON

    4. **API route /api/data/signals** (GET):
       - Same pattern as contracts
       - Call `fetchRecentSignals(limit)`, return JSON
  </action>
  <verify>
    Run `bun run --cwd apps/admin typecheck` — must pass.
    Curl test: each endpoint returns JSON with `items` array and `total` count.
  </verify>
  <done>Three API routes return recent data from contracts, buyers, and signals collections with total counts.</done>
</task>

<task type="auto">
  <name>Task 2: Data table component + contracts, buyers, signals pages</name>
  <files>
    apps/admin/src/components/data-tables/data-table.tsx
    apps/admin/src/components/data-tables/columns.tsx
    apps/admin/src/app/(dashboard)/data/contracts/page.tsx
    apps/admin/src/app/(dashboard)/data/buyers/page.tsx
    apps/admin/src/app/(dashboard)/data/signals/page.tsx
  </files>
  <action>
    1. **DataTable component** (`"use client"`):
       - Generic reusable table using shadcn Table components (NOT @tanstack/react-table — keep it simple with shadcn Table, TableHeader, TableRow, TableCell, TableBody).
       - Props: `columns: ColumnDef[]` (array of {key, label, render?}), `data: T[]`, `loading: boolean`.
       - Loading state: Skeleton rows (5 rows of skeleton cells).
       - Sticky header row.
       - Alternating row backgrounds for readability.
       - "No data" empty state.
       - Simple sort by clicking column header (client-side sort for the 100 items).

    2. **columns.tsx** — Column definitions for each data type:
       - `contractColumns`: Title (truncated to 60 chars), Buyer Name, Status (badge), Source (badge: FaT blue, CF green), Value (formatted GBP), Published Date, Created At (relative time).
       - `buyerColumns`: Name, Org Type (badge), Sector, Region, Enrichment Score (colored number: green>=70, yellow>=40, red<40), Contract Count, Created At (relative time).
       - `signalColumns`: Organization, Signal Type (colored badge per type), Title (truncated), Sector, Confidence (percentage), Source Date, Created At (relative time).
       - Use date-fns `formatDistanceToNow` for relative times.
       - Status/type badges use shadcn Badge with variant colors.

    3. **Contracts page** (`"use client"`):
       - Heading: "Recent Contracts" with total count badge (e.g., "12,345 total").
       - Refresh button + auto-refresh every 30 seconds.
       - DataTable with contractColumns and fetched data.
       - Fetch from `/api/data/contracts` on mount and on interval.

    4. **Buyers page** (`"use client"`):
       - Heading: "Recent Buyers" with total count.
       - Same pattern as contracts page.
       - DataTable with buyerColumns.

    5. **Signals page** (`"use client"`):
       - Heading: "Recent Signals" with total count.
       - Same pattern as contracts page.
       - DataTable with signalColumns.

    All pages follow same pattern: fetch on mount, auto-refresh 30s, show total count, skeleton on initial load, no skeleton on poll updates.
  </action>
  <verify>
    Run `bun run --cwd apps/admin typecheck` — must pass.
    Visually: Each data page renders a table with correct columns and real data.
    Tables show correct column count: contracts (7 columns), buyers (7 columns), signals (7 columns).
    Relative timestamps render correctly (e.g., "2 hours ago").
  </verify>
  <done>Three data explorer pages show sortable tables of recent contracts, buyers, and signals with total counts, color-coded badges, and auto-refreshing data.</done>
</task>

</tasks>

<verification>
1. `bun run --cwd apps/admin typecheck` passes
2. `/api/data/contracts` returns JSON with items array and total count
3. `/api/data/buyers` returns JSON with items array and total count
4. `/api/data/signals` returns JSON with items array and total count
5. Contracts page shows 7-column table with status and source badges
6. Buyers page shows 7-column table with enrichment score colors
7. Signals page shows 7-column table with signal type badges
8. All pages auto-refresh every 30 seconds
9. Total counts shown in page headers
</verification>

<success_criteria>
- Admin can browse the 100 most recently ingested contracts, buyers, and signals
- Each item shows when it was created (relative time) for freshness visibility
- Source attribution visible on contracts (FaT vs CF)
- Enrichment scores visible on buyers
- Signal types color-coded for quick scanning
- Data auto-refreshes every 30 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/18-admin-panel/18-03-SUMMARY.md`
</output>
