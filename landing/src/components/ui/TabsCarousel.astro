---
// TabsCarousel.astro
// Reusable web component: desktop numbered tabs with lime accent progress bar,
// mobile scroll-snap carousel. Content via named slots.
// Custom element: <tabbed-carousel>

interface Props {
  labels: string[];
  class?: string;
}

const { labels, class: className = '' } = Astro.props;
---

<tabbed-carousel class:list={['tc-root', className]}>
  <!-- Tabs nav — hidden below md -->
  <nav class="tc-tabs" role="tablist" aria-label="Feature tabs">
    {labels.map((label, i) => (
      <button
        class:list={['tc-tab', { 'tc-tab--active': i === 0 }]}
        role="tab"
        aria-selected={i === 0 ? 'true' : 'false'}
        aria-controls={`tc-panel-${i}`}
        id={`tc-tab-${i}`}
        data-index={i}
        type="button"
      >
        <span class="tc-tab__number">{String(i + 1).padStart(2, '0')}</span>
        <span class="tc-tab__label">{label}</span>
        <span class="tc-tab__bar"></span>
      </button>
    ))}
  </nav>

  <!-- Panels container — scroll-snap on mobile, switched on desktop -->
  <div class="tc-panels" role="presentation">
    <div class="tc-panel tc-panel--active" role="tabpanel" id="tc-panel-0" aria-labelledby="tc-tab-0" tabindex="0">
      <slot name="panel-0" />
    </div>
    <div class="tc-panel" role="tabpanel" id="tc-panel-1" aria-labelledby="tc-tab-1" tabindex="0">
      <slot name="panel-1" />
    </div>
    <div class="tc-panel" role="tabpanel" id="tc-panel-2" aria-labelledby="tc-tab-2" tabindex="0">
      <slot name="panel-2" />
    </div>
  </div>
</tabbed-carousel>

<script>
  class TabbedCarousel extends HTMLElement {
    private tabs: HTMLButtonElement[] = [];
    private panels: HTMLElement[] = [];
    private panelsContainer: HTMLElement | null = null;
    private currentIndex = 0;
    private scrollTimeout: ReturnType<typeof setTimeout> | null = null;

    connectedCallback() {
      this.tabs = Array.from(this.querySelectorAll<HTMLButtonElement>('.tc-tab'));
      this.panels = Array.from(this.querySelectorAll<HTMLElement>('.tc-panel'));
      this.panelsContainer = this.querySelector('.tc-panels');

      // Tab click listeners
      this.tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          const index = Number(tab.dataset.index);
          this.activate(index);
        });
      });

      // Keyboard navigation for tabs
      this.tabs.forEach((tab) => {
        tab.addEventListener('keydown', (e: KeyboardEvent) => {
          let newIndex = this.currentIndex;
          if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
            e.preventDefault();
            newIndex = (this.currentIndex + 1) % this.tabs.length;
          } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
            e.preventDefault();
            newIndex = (this.currentIndex - 1 + this.tabs.length) % this.tabs.length;
          } else if (e.key === 'Home') {
            e.preventDefault();
            newIndex = 0;
          } else if (e.key === 'End') {
            e.preventDefault();
            newIndex = this.tabs.length - 1;
          }
          if (newIndex !== this.currentIndex) {
            this.activate(newIndex);
            this.tabs[newIndex].focus();
          }
        });
      });

      // Mobile scroll-snap: update active tab on scroll
      if (this.panelsContainer) {
        this.panelsContainer.addEventListener('scroll', () => {
          if (this.scrollTimeout) clearTimeout(this.scrollTimeout);
          this.scrollTimeout = setTimeout(() => this.onScroll(), 80);
        }, { passive: true });
      }
    }

    private activate(index: number) {
      this.currentIndex = index;

      // Update tabs
      this.tabs.forEach((tab, i) => {
        const isActive = i === index;
        tab.classList.toggle('tc-tab--active', isActive);
        tab.setAttribute('aria-selected', String(isActive));
        tab.setAttribute('tabindex', isActive ? '0' : '-1');
      });

      // Update panels
      this.panels.forEach((panel, i) => {
        const isActive = i === index;
        panel.classList.toggle('tc-panel--active', isActive);
      });

      // On mobile, scroll to the panel
      if (this.panelsContainer && window.innerWidth < 768) {
        const targetPanel = this.panels[index];
        if (targetPanel) {
          this.panelsContainer.scrollTo({
            left: targetPanel.offsetLeft - this.panelsContainer.offsetLeft,
            behavior: 'smooth',
          });
        }
      }
    }

    private onScroll() {
      if (!this.panelsContainer) return;
      const scrollLeft = this.panelsContainer.scrollLeft;
      const containerWidth = this.panelsContainer.offsetWidth;

      // Find the panel closest to the center of the viewport
      let closestIndex = 0;
      let closestDistance = Infinity;

      this.panels.forEach((panel, i) => {
        const panelCenter = panel.offsetLeft - this.panelsContainer!.offsetLeft + panel.offsetWidth / 2;
        const viewCenter = scrollLeft + containerWidth / 2;
        const distance = Math.abs(panelCenter - viewCenter);
        if (distance < closestDistance) {
          closestDistance = distance;
          closestIndex = i;
        }
      });

      if (closestIndex !== this.currentIndex) {
        this.activate(closestIndex);
      }
    }
  }

  customElements.define('tabbed-carousel', TabbedCarousel);
</script>

<style>
  /* Root */
  .tc-root {
    display: block;
    width: 100%;
  }

  /* ===== Tabs nav ===== */
  .tc-tabs {
    display: none;
    gap: 0;
    border-bottom: 1px solid var(--color-border);
    margin-bottom: 2.5rem;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }

  .tc-tabs::-webkit-scrollbar {
    display: none;
  }

  @media (min-width: 768px) {
    .tc-tabs {
      display: flex;
    }
  }

  .tc-tab {
    position: relative;
    flex: 1;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 0;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--color-text-secondary);
    font-family: var(--font-heading);
    font-size: 0.9375rem;
    font-weight: 500;
    transition: color 0.25s ease;
    text-align: left;
  }

  .tc-tab:hover {
    color: var(--color-text-primary);
  }

  .tc-tab:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
    border-radius: 4px;
  }

  .tc-tab--active {
    color: var(--color-text-primary);
  }

  .tc-tab__number {
    font-family: var(--font-heading);
    font-size: 0.8125rem;
    font-weight: 700;
    color: var(--color-accent);
    opacity: 0.6;
    transition: opacity 0.25s ease;
  }

  .tc-tab--active .tc-tab__number {
    opacity: 1;
  }

  .tc-tab__label {
    white-space: nowrap;
  }

  /* Accent underline bar */
  .tc-tab__bar {
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 100%;
    height: 2px;
    background: var(--color-accent);
    transform: scaleX(0);
    transform-origin: left center;
    transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
  }

  .tc-tab--active .tc-tab__bar {
    transform: scaleX(1);
  }

  /* ===== Panels container ===== */
  .tc-panels {
    position: relative;
    width: 100%;
  }

  /* Mobile: horizontal scroll-snap carousel */
  @media (max-width: 767px) {
    .tc-panels {
      display: flex;
      overflow-x: scroll;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      gap: 0;
    }

    .tc-panels::-webkit-scrollbar {
      display: none;
    }

    .tc-panel {
      flex: 0 0 100%;
      scroll-snap-align: start;
      min-width: 100%;
    }
  }

  /* Desktop: show/hide panels */
  @media (min-width: 768px) {
    .tc-panel {
      display: none;
    }

    .tc-panel--active {
      display: block;
      animation: tcFadeIn 0.35s ease-out;
    }
  }

  .tc-panel:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 4px;
    border-radius: 8px;
  }

  @keyframes tcFadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .tc-tab__bar {
      transition: none;
    }

    .tc-panel--active {
      animation: none;
    }
  }
</style>
