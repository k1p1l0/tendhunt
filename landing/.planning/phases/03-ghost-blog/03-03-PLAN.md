---
phase: 03-ghost-blog
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - landing/workers/blog-proxy/src/index.ts
  - landing/workers/blog-proxy/wrangler.toml
  - landing/workers/blog-proxy/package.json
  - landing/workers/blog-proxy/tsconfig.json
autonomous: true

must_haves:
  truths:
    - "Visitors can access blog at tendhunt.com/blog (not ghost-admin.tendhunt.com)"
    - "Blog posts load at tendhunt.com/blog/{slug} with correct styling"
    - "Canonical URLs in blog HTML reference tendhunt.com/blog/... (not subdomain)"
    - "Sitemap at tendhunt.com/blog/sitemap.xml lists tendhunt.com/blog/... URLs"
    - "RSS feed at tendhunt.com/blog/rss/ contains tendhunt.com/blog/... links"
    - "Blog asset URLs (CSS, JS, images) load from tendhunt.com/blog/... (not subdomain)"
    - "Admin route tendhunt.com/blog/ghost redirects or blocks (not accessible on main domain)"
  artifacts:
    - path: "landing/workers/blog-proxy/src/index.ts"
      provides: "Cloudflare Worker with HTMLRewriter for subdirectory proxy"
      min_lines: 80
    - path: "landing/workers/blog-proxy/wrangler.toml"
      provides: "Wrangler config with route patterns for /blog/*"
      contains: "route ="
    - path: "landing/workers/blog-proxy/package.json"
      provides: "Worker dependencies (TypeScript, Cloudflare Workers types)"
      exports: ["deploy"]
  key_links:
    - from: "Cloudflare Worker route tendhunt.com/blog/*"
      to: "Ghost origin https://ghost-admin.tendhunt.com"
      via: "fetch(ghostUrl) in Worker"
      pattern: "fetch.*ghost-admin\\.tendhunt\\.com"
    - from: "HTMLRewriter selector a[href]"
      to: "Rewritten href attribute"
      via: "AttributeRewriter class"
      pattern: "new HTMLRewriter.*\\.on\\(.*a\\[href\\]"
    - from: "Sitemap XML text content"
      to: "Rewritten URLs"
      via: "String replace (not HTMLRewriter)"
      pattern: "\\.replace\\(.*ghost-admin.*blog"
---

<objective>
Deploy a Cloudflare Worker that proxies tendhunt.com/blog/* requests to Ghost at ghost-admin.tendhunt.com, rewrites all URLs (HTML, sitemap, RSS) to subdirectory paths, and validates end-to-end blog functionality including SEO meta tags.

Purpose: Make the Ghost blog accessible at tendhunt.com/blog for SEO benefits (subdirectory inherits domain authority). Ensure all URLs, canonical tags, and sitemaps reference the public domain, not the admin subdomain.

Output: A production-deployed Worker with blog accessible at tendhunt.com/blog, all verification checks passing.
</objective>

<execution_context>
@/Users/kirillkozak/Projects/tendhunt.com/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kirillkozak/Projects/tendhunt.com/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/kirillkozak/Projects/tendhunt.com/landing/.planning/PROJECT.md
@/Users/kirillkozak/Projects/tendhunt.com/landing/.planning/ROADMAP.md
@/Users/kirillkozak/Projects/tendhunt.com/landing/.planning/phases/03-ghost-blog/03-CONTEXT.md
@/Users/kirillkozak/Projects/tendhunt.com/landing/.planning/phases/03-ghost-blog/03-RESEARCH.md
@/Users/kirillkozak/Projects/tendhunt.com/landing/.planning/phases/03-ghost-blog/03-01-SUMMARY.md
@/Users/kirillkozak/Projects/tendhunt.com/landing/.planning/phases/03-ghost-blog/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create Cloudflare Worker project for blog reverse proxy</name>
  <files>
    landing/workers/blog-proxy/src/index.ts
    landing/workers/blog-proxy/wrangler.toml
    landing/workers/blog-proxy/package.json
    landing/workers/blog-proxy/tsconfig.json
  </files>
  <action>
In the landing project directory (local machine, NOT VPS), create the Worker project:

**1. Create directory structure:**

```bash
cd /Users/kirillkozak/Projects/tendhunt.com/landing
mkdir -p workers/blog-proxy/src
cd workers/blog-proxy
```

**2. Create package.json:**

```json
{
  "name": "tendhunt-blog-proxy",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "deploy": "wrangler deploy",
    "dev": "wrangler dev",
    "tail": "wrangler tail"
  },
  "devDependencies": {
    "@cloudflare/workers-types": "^4.20250104.0",
    "typescript": "^5.3.3",
    "wrangler": "^3.96.0"
  }
}
```

**3. Install dependencies:**

```bash
npm install
```

**4. Create tsconfig.json:**

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ES2022",
    "lib": ["ES2022"],
    "types": ["@cloudflare/workers-types"],
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "allowSyntheticDefaultImports": true,
    "strict": true,
    "skipLibCheck": true
  },
  "include": ["src/**/*.ts"]
}
```

**5. Create wrangler.toml:**

```toml
name = "tendhunt-blog-proxy"
main = "src/index.ts"
compatibility_date = "2026-02-11"

# Route configuration (will be updated after worker is created)
# Uncomment and update zone_id after first deploy
# routes = [
#   { pattern = "tendhunt.com/blog*", zone_id = "<ZONE_ID>" }
# ]

# Environment variables
[vars]
GHOST_SUBDOMAIN = "ghost-admin.tendhunt.com"
PUBLIC_DOMAIN = "tendhunt.com"
BLOG_PATH = "/blog"
```

**Note:** The `zone_id` will be added after confirming the Cloudflare zone. Get it via:
```bash
wrangler zones list
```

**6. Create src/index.ts** (Worker code with HTMLRewriter):

```typescript
export interface Env {
  GHOST_SUBDOMAIN: string;
  PUBLIC_DOMAIN: string;
  BLOG_PATH: string;
}

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const url = new URL(request.url);

    const GHOST_SUBDOMAIN = env.GHOST_SUBDOMAIN || "ghost-admin.tendhunt.com";
    const PUBLIC_DOMAIN = env.PUBLIC_DOMAIN || "tendhunt.com";
    const BLOG_PATH = env.BLOG_PATH || "/blog";

    // Route 1: Proxy /blog/* requests to Ghost
    if (url.pathname.startsWith(BLOG_PATH)) {
      // Block admin access on public domain
      if (url.pathname.startsWith(`${BLOG_PATH}/ghost`)) {
        return new Response("Admin access not available on this domain. Use ghost-admin.tendhunt.com/ghost", {
          status: 403,
          headers: { "Content-Type": "text/plain" },
        });
      }

      // Construct Ghost origin URL
      const ghostPath = url.pathname.replace(BLOG_PATH, "");
      const ghostUrl = `https://${GHOST_SUBDOMAIN}${ghostPath}${url.search}`;

      // Fetch from Ghost
      const ghostResponse = await fetch(ghostUrl, {
        headers: request.headers,
        method: request.method,
        body: request.body,
        redirect: "manual",
      });

      // Handle redirects
      if (ghostResponse.status >= 300 && ghostResponse.status < 400) {
        const location = ghostResponse.headers.get("Location");
        if (location) {
          const rewrittenLocation = location.replace(
            `https://${GHOST_SUBDOMAIN}`,
            `https://${PUBLIC_DOMAIN}${BLOG_PATH}`
          );
          return new Response(ghostResponse.body, {
            status: ghostResponse.status,
            headers: {
              ...Object.fromEntries(ghostResponse.headers),
              Location: rewrittenLocation,
            },
          });
        }
      }

      // Pass-through binary assets (images, fonts, etc.)
      const contentType = ghostResponse.headers.get("Content-Type") || "";
      if (
        contentType.startsWith("image/") ||
        contentType.startsWith("font/") ||
        contentType.includes("woff") ||
        url.pathname.includes("/assets/built/") ||
        url.pathname.includes("/assets/fonts/")
      ) {
        return new Response(ghostResponse.body, {
          status: ghostResponse.status,
          headers: ghostResponse.headers,
        });
      }

      // Handle XML feeds (sitemap, RSS) - text-based rewriting
      if (
        url.pathname.includes("sitemap") ||
        url.pathname.includes("/rss/") ||
        contentType.includes("xml")
      ) {
        let xml = await ghostResponse.text();
        xml = xml.replace(
          new RegExp(`https://${GHOST_SUBDOMAIN.replace(".", "\\.")}`, "g"),
          `https://${PUBLIC_DOMAIN}${BLOG_PATH}`
        );
        return new Response(xml, {
          status: ghostResponse.status,
          headers: {
            "Content-Type": contentType,
            "Cache-Control": "public, max-age=3600",
          },
        });
      }

      // Rewrite HTML content with HTMLRewriter
      if (contentType.includes("text/html")) {
        return new HTMLRewriter()
          .on("a[href]", new AttributeRewriter("href", GHOST_SUBDOMAIN, `${PUBLIC_DOMAIN}${BLOG_PATH}`))
          .on("link[href]", new AttributeRewriter("href", GHOST_SUBDOMAIN, `${PUBLIC_DOMAIN}${BLOG_PATH}`))
          .on("img[src]", new AttributeRewriter("src", GHOST_SUBDOMAIN, `${PUBLIC_DOMAIN}${BLOG_PATH}`))
          .on("script[src]", new AttributeRewriter("src", GHOST_SUBDOMAIN, `${PUBLIC_DOMAIN}${BLOG_PATH}`))
          .on('meta[property="og:url"]', new AttributeRewriter("content", GHOST_SUBDOMAIN, `${PUBLIC_DOMAIN}${BLOG_PATH}`))
          .on('meta[property="og:image"]', new AttributeRewriter("content", GHOST_SUBDOMAIN, `${PUBLIC_DOMAIN}${BLOG_PATH}`))
          .on('link[rel="canonical"]', new AttributeRewriter("href", GHOST_SUBDOMAIN, `${PUBLIC_DOMAIN}${BLOG_PATH}`))
          .transform(ghostResponse);
      }

      // Default: return as-is
      return ghostResponse;
    }

    // Route 2: Pass through all other requests (landing page, assets, etc.)
    return fetch(request);
  },
};

// HTMLRewriter attribute rewriter class
class AttributeRewriter {
  private attribute: string;
  private from: string;
  private to: string;

  constructor(attribute: string, from: string, to: string) {
    this.attribute = attribute;
    this.from = from;
    this.to = to;
  }

  element(element: Element) {
    const value = element.getAttribute(this.attribute);
    if (value) {
      // Rewrite absolute URLs
      if (value.includes(this.from)) {
        const rewritten = value.replace(
          `https://${this.from}`,
          `https://${this.to}`
        ).replace(
          `http://${this.from}`,
          `https://${this.to}`
        );
        element.setAttribute(this.attribute, rewritten);
      }
      // Rewrite root-relative URLs (e.g., /assets/... → /blog/assets/...)
      else if (value.startsWith("/") && !value.startsWith(this.to.split(".")[1])) {
        // Only rewrite if it's a Ghost asset path
        if (
          value.startsWith("/assets/") ||
          value.startsWith("/content/") ||
          value.startsWith("/public/") ||
          value.match(/^\/[a-z0-9-]+\/$/) // post URLs like /post-slug/
        ) {
          const blogPath = this.to.replace(`${this.to.split("/")[0]}//${this.to.split("/")[2]}`, "");
          element.setAttribute(this.attribute, `${blogPath}${value}`);
        }
      }
    }
  }
}
```

  </action>
  <verify>
1. Check Worker files exist:
   ```bash
   ls -la /Users/kirillkozak/Projects/tendhunt.com/landing/workers/blog-proxy/
   ```
   Should show: src/, package.json, wrangler.toml, node_modules/

2. Verify TypeScript compiles:
   ```bash
   cd /Users/kirillkozak/Projects/tendhunt.com/landing/workers/blog-proxy
   npx tsc --noEmit
   ```
   Should output nothing (no compilation errors)

3. Check wrangler config syntax:
   ```bash
   npx wrangler --version
   ```
   Should output version number (verifies wrangler is installed)
  </verify>
  <done>
Worker project created with TypeScript source, wrangler config, and HTMLRewriter implementation for URL rewriting. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Deploy Worker to Cloudflare and configure routes</name>
  <files>
    landing/workers/blog-proxy/wrangler.toml
  </files>
  <action>
**1. Authenticate with Cloudflare (if not already logged in):**

```bash
cd /Users/kirillkozak/Projects/tendhunt.com/landing/workers/blog-proxy
npx wrangler login
```

Follow the browser prompt to authorize Wrangler.

**2. Verify Cloudflare zone access (pre-deployment check):**

Before deploying the Worker, ensure your Cloudflare account can access the tendhunt.com zone:

```bash
npx wrangler zones list | grep tendhunt.com
```

Expected output: Shows `tendhunt.com` with its `zone_id` (32-character hex string).

If no results, verify:
- Your Cloudflare API token has "Zones:Edit" permissions
- The tendhunt.com domain is added to your Cloudflare account
- You have access to the correct Cloudflare organization/team

**3. Get Cloudflare zone ID for tendhunt.com:**

```bash
npx wrangler zones list | grep tendhunt.com
```

Copy the `zone_id` (format: 32-character hex string).

**3. Update wrangler.toml with zone ID:**

Edit `wrangler.toml` and uncomment/update the routes section:

```toml
routes = [
  { pattern = "tendhunt.com/blog*", zone_id = "<PASTE_ZONE_ID_HERE>" }
]
```

**4. Deploy the Worker:**

```bash
npx wrangler deploy
```

Expected output:
```
Total Upload: XX.XX KiB / gzip: XX.XX KiB
Uploaded tendhunt-blog-proxy (X.XX sec)
Published tendhunt-blog-proxy (X.XX sec)
  https://tendhunt-blog-proxy.<subdomain>.workers.dev
  tendhunt.com/blog*
```

**5. Verify Worker is active:**

```bash
npx wrangler deployments list
```

Should show the most recent deployment as "Active".

**Critical pitfall to avoid:**
- If Cloudflare Pages is already deployed to `tendhunt.com`, the Worker route MUST be more specific than the Pages route. Worker routes take precedence when patterns are equal, but Pages routes catch-all `/*` can interfere. Verify in Cloudflare Dashboard → Workers & Pages → Routes that the `/blog*` route exists and is listed ABOVE any `/*` catch-all.

**6. Update Cloudflare SSL/TLS settings (if not already set):**

- Go to Cloudflare Dashboard → SSL/TLS
- Set mode to **Full** (not Flexible, not Full (Strict) unless VPS has valid cert for subdomain)
- This prevents redirect loops between Cloudflare and Ghost origin
  </action>
  <verify>
1. Check Worker deployment status:
   ```bash
   npx wrangler deployments list
   ```
   Should show latest deployment as "Active"

2. Verify route is configured:
   - Visit: https://dash.cloudflare.com
   - Navigate to: Workers & Pages → Overview
   - Find "tendhunt-blog-proxy" worker
   - Check "Routes" section shows: `tendhunt.com/blog*`

3. Test Worker responds to /blog requests:
   ```bash
   curl -I https://tendhunt.com/blog
   ```
   Should return HTTP 200 (or 301/302 redirect), NOT 404 or 522 (origin error)

4. Check Worker logs for errors:
   ```bash
   npx wrangler tail
   ```
   Then visit https://tendhunt.com/blog in browser. Logs should show request processing, not errors.
  </verify>
  <done>
Worker deployed to Cloudflare with route configured for tendhunt.com/blog*. Worker is active and responding to requests. SSL/TLS mode verified as Full.
  </done>
</task>

<task type="auto">
  <name>End-to-end verification of blog proxy, URL rewriting, and SEO meta</name>
  <files>
    landing/.planning/phases/03-ghost-blog/03-03-VERIFICATION.md
  </files>
  <action>
Run the following verification checks and document results:

**1. Blog homepage loads via subdirectory:**
```bash
curl -L https://tendhunt.com/blog
```
Expected: HTML response with status 200, contains TendHunt theme styling.

**2. Canonical URL verification:**
```bash
curl -s https://tendhunt.com/blog | grep -i 'rel="canonical"'
```
Expected output should contain: `<link rel="canonical" href="https://tendhunt.com/blog" />`
Should NOT contain: `ghost-admin.tendhunt.com`

**3. Open Graph URL verification:**
```bash
curl -s https://tendhunt.com/blog | grep -i 'og:url'
```
Expected: `<meta property="og:url" content="https://tendhunt.com/blog" />`
Should NOT contain: `ghost-admin.tendhunt.com`

**4. Sitemap URL rewriting:**
```bash
curl -s https://tendhunt.com/blog/sitemap.xml | grep -o 'https://[^<]*' | head -5
```
Expected: All URLs should start with `https://tendhunt.com/blog/`
Should NOT contain: `ghost-admin.tendhunt.com`

**5. RSS feed URL rewriting:**
```bash
curl -s https://tendhunt.com/blog/rss/ | grep -o 'https://[^<]*' | head -5
```
Expected: All `<link>` URLs should reference `https://tendhunt.com/blog/`
Should NOT contain: `ghost-admin.tendhunt.com`

**6. Blog asset loading (CSS, fonts):**
Open browser DevTools Network tab and visit https://tendhunt.com/blog
Check for:
- `/blog/assets/built/index.css` loads (status 200, not 404)
- `/blog/assets/fonts/*.woff2` load (status 200)
- No CORS errors in console
- All assets served from `tendhunt.com/blog/...`, not `ghost-admin.tendhunt.com`

**7. Admin route blocking:**
```bash
curl -I https://tendhunt.com/blog/ghost
```
Expected: HTTP 403 Forbidden with message "Admin access not available on this domain"

**8. Navigation links to landing page:**
Open https://tendhunt.com/blog in browser, click "Features" link in header.
Expected: Navigates to `https://tendhunt.com/#features` (landing page, not blog)

**9. Post URL structure (if test post exists):**
```bash
curl -I https://tendhunt.com/blog/test-post/
```
Expected: HTTP 200, HTML response

**10. Create verification report:**

Document all results in `landing/.planning/phases/03-ghost-blog/03-03-VERIFICATION.md`:

```markdown
# Phase 3: Ghost Blog Setup - Verification

**Verified:** 2026-02-11
**Verifier:** Claude (automated checks)
**Status:** [PASS/FAIL]

## Verification Results

| Check | Expected | Actual | Status |
|-------|----------|--------|--------|
| Blog homepage loads | HTTP 200 | [result] | [✓/✗] |
| Canonical URL | tendhunt.com/blog | [result] | [✓/✗] |
| OG URL meta tag | tendhunt.com/blog | [result] | [✓/✗] |
| Sitemap URLs | tendhunt.com/blog/* | [result] | [✓/✗] |
| RSS feed URLs | tendhunt.com/blog/* | [result] | [✓/✗] |
| CSS loads | /blog/assets/built/index.css 200 | [result] | [✓/✗] |
| Fonts load | /blog/assets/fonts/*.woff2 200 | [result] | [✓/✗] |
| Admin route blocked | 403 Forbidden | [result] | [✓/✗] |
| Header nav to landing | /#features works | [result] | [✓/✗] |
| Post URLs | /blog/{slug}/ 200 | [result] | [✓/✗] |

## Issues Found

[List any failures or unexpected behavior]

## Phase Goal Validation

From ROADMAP.md success criteria:

1. ✓ Ghost 5.x instance running and admin panel accessible
2. ✓ Cloudflare Worker proxies /blog/* to Ghost with HTMLRewriter URL rewriting
3. ✓ Canonical URLs, OG tags, and sitemap all reference tendhunt.com/blog/...
4. ✓ Blog navigation links back to landing page
5. ✓ Admin route (/blog/ghost) blocked on main domain

**Phase 3 Status:** COMPLETE
```

  </action>
  <verify>
1. Check verification report exists:
   ```bash
   cat /Users/kirillkozak/Projects/tendhunt.com/landing/.planning/phases/03-ghost-blog/03-03-VERIFICATION.md
   ```
   Should show completed verification table with all checks

2. Verify at least 8/10 checks pass (allow for minor issues like missing test post)

3. Confirm critical SEO checks pass:
   - Canonical URLs rewritten ✓
   - Sitemap URLs rewritten ✓
   - RSS URLs rewritten ✓
  </verify>
  <done>
All verification checks completed and documented. Blog accessible at tendhunt.com/blog with correct URL rewriting for SEO (canonical, sitemap, RSS). Admin route blocked on public domain. Phase 3 goal criteria validated.
  </done>
</task>

</tasks>

<verification>
1. Blog homepage loads at https://tendhunt.com/blog (HTTP 200, not 404 or 522)
2. Blog posts accessible at https://tendhunt.com/blog/{slug}/ with correct styling
3. Canonical URLs in HTML reference tendhunt.com/blog/... (not ghost-admin subdomain)
4. Open Graph og:url meta tags reference tendhunt.com/blog/... (not ghost-admin subdomain)
5. Sitemap XML at https://tendhunt.com/blog/sitemap.xml lists tendhunt.com/blog/... URLs
6. RSS feed at https://tendhunt.com/blog/rss/ contains tendhunt.com/blog/... links
7. Blog CSS loads from /blog/assets/built/index.css (status 200, not 404)
8. Blog fonts load from /blog/assets/fonts/*.woff2 (status 200, no CORS errors)
9. Admin route https://tendhunt.com/blog/ghost returns 403 Forbidden
10. Header navigation "Features" link navigates to tendhunt.com/#features (landing page)
11. Cloudflare Worker deployed and active (wrangler deployments list shows "Active")
12. Worker route tendhunt.com/blog* configured in Cloudflare Dashboard
</verification>

<success_criteria>
- Cloudflare Worker deployed and proxying /blog/* requests to ghost-admin.tendhunt.com
- HTMLRewriter rewrites all HTML URLs (links, images, scripts, canonical, OG tags) to subdirectory
- Sitemap XML and RSS XML rewritten via text replacement (not HTMLRewriter)
- Blog accessible at tendhunt.com/blog with correct SEO meta tags
- Admin route blocked on public domain (403 response)
- All verification checks documented in 03-03-VERIFICATION.md
- Phase 3 success criteria from ROADMAP.md validated
</success_criteria>

<output>
After completion, create `landing/.planning/phases/03-ghost-blog/03-03-SUMMARY.md` with:
- Worker deployment details (URL, routes, environment variables)
- HTMLRewriter implementation approach (selectors used, attribute rewriting logic)
- Sitemap/RSS text-based rewriting approach
- Verification results summary (all checks passed/failed)
- Any deviations from research recommendations
- Known limitations or edge cases (e.g., admin route handling, asset caching)
</output>
