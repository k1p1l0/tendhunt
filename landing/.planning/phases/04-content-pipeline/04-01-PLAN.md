---
phase: 04-content-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - landing/content-pipeline/config.py
  - landing/content-pipeline/.env.example
  - landing/content-pipeline/requirements.txt
  - landing/content-pipeline/generate_articles.py
  - landing/content-pipeline/generate_thumbnails.py
  - landing/content-pipeline/publish_to_ghost.py
  - landing/content-pipeline/pipeline.py
  - landing/content-pipeline/templates/article_prompt.txt
autonomous: false
user_setup:
  - service: ghost-admin-api
    why: "Publishing articles via Ghost Admin API requires an integration key"
    env_vars:
      - name: GHOST_ADMIN_KEY
        source: "ghost-admin.tendhunt.com/ghost/#/settings/integrations -> Add custom integration -> Copy Admin API Key (format: id:secret)"
    dashboard_config:
      - task: "Create custom integration named 'Content Pipeline'"
        location: "ghost-admin.tendhunt.com/ghost/#/settings/integrations"

must_haves:
  truths:
    - "Python pipeline scripts exist and can be invoked from CLI"
    - "Article generator calls OpenAI GPT-4o and outputs markdown with YAML frontmatter"
    - "Thumbnail generator creates branded 1200x630 PNG images using Pillow"
    - "Publisher uploads images and creates Ghost draft posts via Admin API with ?source=html"
    - "Pipeline orchestrator runs all 3 stages in sequence for a given topic"
  artifacts:
    - path: "landing/content-pipeline/config.py"
      provides: "Shared configuration (Ghost URL, brand colors, font paths)"
    - path: "landing/content-pipeline/generate_articles.py"
      provides: "AI article generation via OpenAI GPT-4o"
      contains: "client.chat.completions.create"
    - path: "landing/content-pipeline/generate_thumbnails.py"
      provides: "Pillow-based branded thumbnail generation"
      contains: "Image.new"
    - path: "landing/content-pipeline/publish_to_ghost.py"
      provides: "Ghost Admin API integration (JWT auth, image upload, post creation)"
      contains: "source=html"
    - path: "landing/content-pipeline/pipeline.py"
      provides: "End-to-end pipeline orchestrator"
      contains: "run_pipeline"
    - path: "landing/content-pipeline/requirements.txt"
      provides: "Python dependency manifest"
    - path: "landing/content-pipeline/templates/article_prompt.txt"
      provides: "System prompt for UK procurement article generation"
  key_links:
    - from: "landing/content-pipeline/generate_articles.py"
      to: "OpenAI API"
      via: "openai Python SDK chat.completions.create"
      pattern: "client\\.chat\\.completions\\.create"
    - from: "landing/content-pipeline/generate_thumbnails.py"
      to: "landing/content-pipeline/fonts/"
      via: "ImageFont.truetype loading TTF fonts"
      pattern: "ImageFont\\.truetype"
    - from: "landing/content-pipeline/publish_to_ghost.py"
      to: "Ghost Admin API"
      via: "requests.post with JWT auth and ?source=html"
      pattern: "source=html"
    - from: "landing/content-pipeline/pipeline.py"
      to: "generate_articles, generate_thumbnails, publish_to_ghost"
      via: "Python imports and sequential invocation"
      pattern: "from generate_"
---

<objective>
Build the complete Python content pipeline: AI article generation (OpenAI GPT-4o), branded thumbnail generation (Pillow), and Ghost Admin API publishing with Lexical conversion via ?source=html and kg-card wrapper.

Purpose: This pipeline automates the article creation workflow so 5-10 SEO articles can be generated, branded, and published to Ghost as drafts for review.
Output: Working Python scripts in landing/content-pipeline/ that can generate an article, create its thumbnail, and publish it to Ghost as a draft.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@landing/.planning/PROJECT.md
@landing/.planning/ROADMAP.md
@landing/.planning/STATE.md
@landing/.planning/phases/04-content-pipeline/04-RESEARCH.md
@landing/.planning/phases/03-ghost-blog/03-01-SUMMARY.md
@landing/.planning/phases/03-ghost-blog/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Python pipeline scripts (article generator, thumbnail generator, Ghost publisher, orchestrator)</name>
  <files>
    landing/content-pipeline/config.py
    landing/content-pipeline/.env.example
    landing/content-pipeline/requirements.txt
    landing/content-pipeline/generate_articles.py
    landing/content-pipeline/generate_thumbnails.py
    landing/content-pipeline/publish_to_ghost.py
    landing/content-pipeline/pipeline.py
    landing/content-pipeline/templates/article_prompt.txt
    landing/content-pipeline/.gitignore
  </files>
  <action>
    Create the landing/content-pipeline/ directory structure with all pipeline scripts.

    **config.py:** Shared constants and configuration.
    - Load env vars via python-dotenv (GHOST_URL, GHOST_ADMIN_KEY, OPENAI_API_KEY)
    - GHOST_URL = "https://ghost-admin.tendhunt.com"
    - Brand constants: BG_COLOR (#0A0A0A), ACCENT_COLOR (#E5FF00), TEXT_COLOR (white), SECONDARY_TEXT (#A1A1A1)
    - Image dimensions: 1200x630
    - Paths for articles/, thumbnails/, output/, fonts/ directories

    **.env.example:** Template showing required env vars (no actual secrets).
    ```
    GHOST_URL=https://ghost-admin.tendhunt.com
    GHOST_ADMIN_KEY=your_id:your_secret
    OPENAI_API_KEY=sk-proj-your-key-here
    ```

    **requirements.txt:** Pin major versions.
    ```
    openai>=1.68
    Pillow>=11.0
    requests>=2.32
    PyJWT>=2.9
    markdown>=3.7
    python-frontmatter>=1.1
    python-slugify>=8.0
    python-dotenv>=1.0
    beautifulsoup4>=4.12
    ```

    **generate_articles.py:**
    - Function `generate_article(topic: str, keywords: list[str], tags: list[str]) -> str`
    - Uses OpenAI GPT-4o (model="gpt-4o") via chat.completions.create
    - System prompt loaded from templates/article_prompt.txt
    - User prompt includes topic, keywords, and instruction for 1500-2500 word articles
    - temperature=0.7, max_tokens=4000
    - Returns full markdown string with YAML frontmatter (title, slug, meta_description, excerpt, tags)
    - Validates output has frontmatter (starts with "---"), regenerates once if missing
    - CLI mode: `python generate_articles.py "topic" "kw1,kw2" "tag1,tag2"` writes to articles/{slug}.md

    **templates/article_prompt.txt:** System prompt for GPT-4o.
    - Expert UK procurement content writer persona
    - 1500-2500 words requirement
    - Include UK procurement statistics, Procurement Act 2023 references
    - Clear H2/H3 heading structure, actionable advice
    - Professional analytical tone (not salesy), British English spelling
    - Output format: YAML frontmatter (title, slug, meta_description 155 chars, excerpt, tags) followed by markdown body
    - Include compelling intro and clear conclusion with CTA mentioning TendHunt

    **generate_thumbnails.py:**
    - Function `generate_thumbnail(title: str, tag: str, output_path: str) -> None`
    - Uses Pillow (PIL) to create 1200x630 PNG images
    - Dark background (#0A0A0A) with subtle grid lines (#141414, 40px spacing)
    - 6px accent bar (#E5FF00) at top
    - Tag pill: rounded rectangle with #E5FF00 bg, dark text, uppercase, 20px font
    - Title: white text, bold font, 48-52px, wrapped to max 3 lines using textwrap.fill(width=28)
    - Brand mark: "TendHunt" in #E5FF00 bottom-left, "tendhunt.com/blog" in #A1A1A1 next to it
    - Accent dot: #E5FF00 ellipse bottom-right corner
    - CRITICAL: Use TTF fonts, NOT woff2 (Pillow cannot load woff2). Try loading from fonts/ dir, fall back to ImageFont.load_default() with size parameter if TTF files not found.
    - Download TTF fonts: Add a `setup_fonts()` helper function that downloads Space Grotesk Bold TTF and Inter Regular TTF from Google Fonts if fonts/ dir is empty. Download from https://fonts.google.com/download?family=Space+Grotesk (zip), extract TTF files. Use zipfile module to extract.
    - CLI mode: `python generate_thumbnails.py "Article Title" "Tag Name" output.png`

    **publish_to_ghost.py:**
    - Function `get_ghost_jwt(admin_api_key: str) -> str` -- generates HS256 JWT with kid in header, /admin/ audience, 5-min expiry. Uses PyJWT.
    - Function `ghost_headers(admin_api_key: str) -> dict` -- returns Authorization (Ghost {token}), Content-Type (application/json), Accept-Version (v5.0). CRITICAL: Generate fresh JWT per call (not cached) to avoid expiry during batch operations.
    - Function `markdown_to_ghost_html(md_content: str) -> str` -- converts markdown to HTML using markdown library with extensions=['tables', 'fenced_code', 'codehilite', 'toc', 'attr_list'], then wraps in `<!--kg-card-begin: html-->` and `<!--kg-card-end: html-->` for lossless Lexical conversion.
    - Function `upload_image(filepath: str, admin_api_key: str) -> str` -- POST to {GHOST_URL}/ghost/api/admin/images/upload/ with multipart form, returns image URL from response.
    - Function `create_post(title, html, feature_image_url, tags, meta_description, custom_excerpt, slug, admin_api_key, status="draft") -> dict` -- POST to {GHOST_URL}/ghost/api/admin/posts/?source=html with full post body. Returns created post dict.
    - Function `publish_article(article_path: str, thumbnail_path: str, admin_api_key: str) -> dict` -- reads markdown file with python-frontmatter, converts to HTML, uploads thumbnail, creates post. Returns post dict.
    - CLI mode: `python publish_to_ghost.py articles/slug.md thumbnails/slug.png`

    **pipeline.py:**
    - Define TOPICS list with 10 SEO article configs (from research: topic, keywords, tags for each).
    - Topics (from 04-RESEARCH.md):
      1. Complete Guide to the Procurement Act 2023 for Suppliers
      2. How to Find UK Government Tenders in 2026
      3. 8 Public Sector Tender Portals Every Supplier Must Track
      4. Understanding UK Government Procurement Frameworks
      5. How Small Businesses Can Win Government Contracts
      6. What is Buyer Intelligence in Public Procurement?
      7. UK Public Procurement Statistics: Market Size and Trends
      8. How to Write a Winning Tender Response
      9. CPV Codes Explained: How to Find the Right Procurement Category
      10. Procurement Act 2023 Timeline: What Changed and When
    - Function `run_pipeline(topics=None, generate_only=False, publish_only=False)`:
      - If topics is None, use all TOPICS
      - For each topic: generate article markdown, save to articles/{slug}.md, generate thumbnail to thumbnails/{slug}.png
      - If not generate_only: publish each to Ghost as draft via publish_to_ghost
      - Save metadata to output/published.json (list of {slug, ghost_id, ghost_url, status})
      - Print progress for each article
    - CLI: `python pipeline.py` (full run), `python pipeline.py --generate-only` (just articles + thumbs), `python pipeline.py --publish-only` (just publish existing files)

    **.gitignore:**
    ```
    .env
    .venv/
    __pycache__/
    articles/
    thumbnails/
    output/
    fonts/*.ttf
    ```

    **Install dependencies:** Create venv and install.
    ```bash
    cd landing/content-pipeline
    python3 -m venv .venv
    source .venv/bin/activate
    pip install -r requirements.txt
    ```
  </action>
  <verify>
    1. All files exist: config.py, generate_articles.py, generate_thumbnails.py, publish_to_ghost.py, pipeline.py, templates/article_prompt.txt, requirements.txt, .env.example, .gitignore
    2. `cd landing/content-pipeline && python3 -m venv .venv && source .venv/bin/activate && pip install -r requirements.txt` succeeds
    3. `python -c "from config import GHOST_URL, BG_COLOR, ACCENT_COLOR; print('config OK')"` prints "config OK"
    4. `python -c "from generate_articles import generate_article; print('generate OK')"` imports without error
    5. `python -c "from generate_thumbnails import generate_thumbnail; print('thumbnail OK')"` imports without error
    6. `python -c "from publish_to_ghost import get_ghost_jwt, markdown_to_ghost_html, create_post; print('publish OK')"` imports without error
    7. Test thumbnail generation (no API needed): `python generate_thumbnails.py "Test Article Title" "UK Procurement" thumbnails/test.png` creates a PNG file
    8. Verify test thumbnail dimensions: `python -c "from PIL import Image; img=Image.open('thumbnails/test.png'); print(img.size)"` outputs (1200, 630)
  </verify>
  <done>
    All 8 pipeline scripts/files exist in landing/content-pipeline/. Dependencies install successfully. Thumbnail generation works standalone without API keys. All modules import cleanly. Test thumbnail is 1200x630 PNG with TendHunt branding (dark bg, accent bar, tag pill, title text, brand mark).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify pipeline setup and Ghost Admin API key</name>
  <files>landing/content-pipeline/.env</files>
  <action>
    CHECKPOINT: User must create Ghost Admin API integration and configure .env file. This cannot be automated because Ghost Admin integration creation requires browser-based authentication to the Ghost admin panel.

    Present the following instructions to the user:

    1. Check the test thumbnail at `landing/content-pipeline/thumbnails/test.png`
    2. Create Ghost Admin API integration at ghost-admin.tendhunt.com/ghost/#/settings/integrations
    3. Create .env from .env.example and fill in GHOST_ADMIN_KEY and OPENAI_API_KEY
    4. Test Ghost API connectivity with the provided verification script
  </action>
  <verify>
    User confirms: test thumbnail looks correct, Ghost API key configured, API connectivity test returns status 200 with site title.
  </verify>
  <done>
    Ghost Admin API key is configured in .env, API connectivity verified (status 200), and user has approved the thumbnail design. Pipeline is ready for article generation in Plan 04-02.
  </done>
</task>

</tasks>

<verification>
- All pipeline Python files exist in landing/content-pipeline/
- Python venv created and dependencies installed
- Thumbnail generation works standalone (test.png is 1200x630)
- All modules import without errors
- Ghost Admin API key configured and connectivity verified (after checkpoint)
</verification>

<success_criteria>
1. landing/content-pipeline/ contains config.py, generate_articles.py, generate_thumbnails.py, publish_to_ghost.py, pipeline.py, templates/article_prompt.txt, requirements.txt
2. `pip install -r requirements.txt` succeeds in venv
3. Test thumbnail generates correctly (1200x630 PNG with branding)
4. Ghost Admin API key is configured and API responds with 200
5. All Python modules import without errors
</success_criteria>

<output>
After completion, create `landing/.planning/phases/04-content-pipeline/04-01-SUMMARY.md`
</output>
