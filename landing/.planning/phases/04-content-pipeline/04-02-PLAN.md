---
phase: 04-content-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - landing/content-pipeline/articles/*.md
  - landing/content-pipeline/thumbnails/*.png
  - landing/content-pipeline/output/published.json
  - landing/content-pipeline/add_internal_links.py
autonomous: false

must_haves:
  truths:
    - "5-10 SEO articles exist as drafts in Ghost targeting UK procurement keywords"
    - "Each article has a branded featured image (1200x630)"
    - "Each article has a meta description, excerpt, and relevant tags"
    - "Articles contain internal links to other articles and the landing page"
    - "Articles are accessible at tendhunt.com/blog/{slug} after publishing"
  artifacts:
    - path: "landing/content-pipeline/articles/"
      provides: "5-10 markdown article files with YAML frontmatter"
    - path: "landing/content-pipeline/thumbnails/"
      provides: "5-10 branded PNG thumbnails at 1200x630"
    - path: "landing/content-pipeline/output/published.json"
      provides: "Metadata of all published Ghost posts (id, slug, url, status)"
    - path: "landing/content-pipeline/add_internal_links.py"
      provides: "Post-processing script to inject internal links between articles"
  key_links:
    - from: "landing/content-pipeline/pipeline.py"
      to: "Ghost Admin API"
      via: "publish_to_ghost.create_post with ?source=html"
      pattern: "create_post"
    - from: "landing/content-pipeline/add_internal_links.py"
      to: "Ghost Admin API"
      via: "Update existing posts with internal links via PUT request"
      pattern: "ghost/api/admin/posts"
    - from: "tendhunt.com/blog/{slug}"
      to: "Ghost origin"
      via: "Cloudflare Worker reverse proxy (from Phase 3)"
      pattern: "tendhunt.com/blog/"
---

<objective>
Generate 10 SEO-optimized articles about UK procurement using the pipeline, create branded thumbnails, publish all as drafts to Ghost, add internal links between articles, then publish after user review.

Purpose: Populate the blog with high-quality SEO content targeting UK procurement keywords, establishing TendHunt's authority and driving organic traffic.
Output: 5-10 live articles at tendhunt.com/blog/{slug}, each with featured image, meta description, tags, and internal links.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@landing/.planning/PROJECT.md
@landing/.planning/ROADMAP.md
@landing/.planning/STATE.md
@landing/.planning/phases/04-content-pipeline/04-RESEARCH.md
@landing/.planning/phases/04-content-pipeline/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate all articles and thumbnails, publish as drafts to Ghost</name>
  <files>
    landing/content-pipeline/articles/*.md
    landing/content-pipeline/thumbnails/*.png
    landing/content-pipeline/output/published.json
  </files>
  <action>
    Run the pipeline to generate all 10 articles and their thumbnails, then publish to Ghost as drafts.

    **Step 1: Generate articles and thumbnails (full pipeline run)**
    ```bash
    cd landing/content-pipeline
    source .venv/bin/activate
    python pipeline.py
    ```

    This will iterate through all 10 topics defined in pipeline.py:
    1. Call OpenAI GPT-4o to generate article markdown with frontmatter
    2. Save to articles/{slug}.md
    3. Generate Pillow thumbnail to thumbnails/{slug}.png
    4. Upload thumbnail to Ghost via /admin/images/upload/
    5. Convert markdown to HTML, wrap in kg-card, POST to Ghost /admin/posts/?source=html as draft
    6. Save metadata to output/published.json

    **Step 2: Verify all articles were created**
    - Count files in articles/ (should be 10 .md files)
    - Count files in thumbnails/ (should be 10 .png files)
    - Check output/published.json has 10 entries, all with status "draft"
    - Verify each article has: title, slug, meta_description, excerpt, tags in frontmatter
    - Verify each article body is 1500+ words

    **Step 3: Validate articles in Ghost**
    - Use Ghost Admin API to list all draft posts
    - Verify each has feature_image set
    - Verify each has meta_description set
    - Verify each has at least 2 tags

    **Error handling during pipeline run:**
    - If OpenAI API returns error (rate limit, etc.), wait 10 seconds and retry once
    - If Ghost API returns 401, re-check JWT generation (fresh token per call)
    - If any article fails, continue with remaining topics, log failures
    - After pipeline completes, report any failures and retry individually if needed

    **Word count validation:**
    After generation, check each article's word count. If any article is under 1200 words, regenerate it with a modified prompt emphasizing length requirement.
  </action>
  <verify>
    1. `ls landing/content-pipeline/articles/ | wc -l` shows 10 (or close to 10) .md files
    2. `ls landing/content-pipeline/thumbnails/ | wc -l` shows matching number of .png files
    3. `cat landing/content-pipeline/output/published.json | python -m json.tool` shows array of objects with ghost_id, slug, ghost_url, status fields
    4. `cd landing/content-pipeline && source .venv/bin/activate && python -c "
    import frontmatter, os
    for f in os.listdir('articles'):
        if f.endswith('.md'):
            post = frontmatter.load(f'articles/{f}')
            words = len(post.content.split())
            has_meta = 'meta_description' in post.metadata
            has_tags = 'tags' in post.metadata and len(post.metadata['tags']) >= 2
            print(f'{f}: {words} words, meta={has_meta}, tags={has_tags}')
    "` shows all articles have 1200+ words, meta_description, and 2+ tags
    5. `curl -s https://tendhunt.com/blog/ | grep -c '<article'` returns at least 5 (if articles visible on blog homepage -- depends on Ghost settings for drafts; drafts won't show on public blog until published)
  </verify>
  <done>
    10 article markdown files exist in articles/ with proper frontmatter (title, slug, meta_description, excerpt, tags). 10 branded thumbnail PNGs exist in thumbnails/. All articles published as drafts in Ghost with feature images. output/published.json contains metadata for all published drafts. Each article is 1200+ words with UK procurement content.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add internal links between articles and create publish script</name>
  <files>
    landing/content-pipeline/add_internal_links.py
  </files>
  <action>
    Create a post-processing script that adds internal links between the generated articles.

    **add_internal_links.py:**
    - Function `add_internal_links()`:
      1. Load output/published.json to get all article slugs, titles, tags
      2. For each article markdown file in articles/:
         a. Parse with python-frontmatter
         b. Identify 2-3 related articles by matching tags (articles sharing the most tags are most related)
         c. Add an "## Related Articles" section at the bottom of the markdown body with links:
            ```
            ## Related Articles
            - [Article Title](/blog/article-slug/)
            - [Article Title 2](/blog/article-slug-2/)
            ```
         d. Also add 1-2 contextual inline links within the article body where topic keywords match other article titles (use regex to find first mention of a relevant keyword and wrap it in a link)
         e. Add a CTA paragraph at the end: "Discover how TendHunt helps suppliers find and win UK government contracts. [Join the waitlist](/)" linking back to the landing page
         f. Save updated markdown file
      3. For each updated article:
         a. Re-convert markdown to HTML with kg-card wrapper
         b. Update the Ghost post via PUT /admin/posts/{id}/?source=html (requires post's `updated_at` for collision detection)
         c. Log success/failure
    - Function `publish_all_drafts()`:
      1. Load output/published.json
      2. For each draft: PUT /admin/posts/{id}/ with status="published" and updated_at from current post state
      3. Update published.json with new status
    - CLI: `python add_internal_links.py` (add links), `python add_internal_links.py --publish` (also publish all drafts)

    **Ghost post update pattern (critical):**
    ```python
    # Must GET the post first to get current updated_at (Ghost uses it for collision detection)
    resp = requests.get(f"{GHOST_URL}/ghost/api/admin/posts/{post_id}/", headers=ghost_headers(key))
    current_post = resp.json()['posts'][0]

    # Then PUT with the updated_at value
    body = {"posts": [{"html": new_html, "updated_at": current_post['updated_at']}]}
    resp = requests.put(f"{GHOST_URL}/ghost/api/admin/posts/{post_id}/?source=html", headers=ghost_headers(key), json=body)
    ```

    **Run the internal links script:**
    ```bash
    cd landing/content-pipeline
    source .venv/bin/activate
    python add_internal_links.py
    ```
  </action>
  <verify>
    1. landing/content-pipeline/add_internal_links.py exists
    2. `cd landing/content-pipeline && source .venv/bin/activate && python add_internal_links.py` completes without errors
    3. Check that updated articles contain "Related Articles" section: `grep -l "Related Articles" articles/*.md | wc -l` shows 10
    4. Check that articles contain TendHunt CTA: `grep -l "TendHunt" articles/*.md | wc -l` shows 10
    5. Verify Ghost posts were updated (check one): `python -c "
    from publish_to_ghost import ghost_headers
    from config import GHOST_URL, GHOST_ADMIN_KEY
    import requests, json
    published = json.load(open('output/published.json'))
    post_id = published[0]['ghost_id']
    resp = requests.get(f'{GHOST_URL}/ghost/api/admin/posts/{post_id}/?formats=html', headers=ghost_headers(GHOST_ADMIN_KEY))
    html = resp.json()['posts'][0]['html']
    print('Has related links:', 'Related Articles' in html or '/blog/' in html)
    "` prints True
  </verify>
  <done>
    add_internal_links.py exists and runs successfully. All 10 articles now contain a "Related Articles" section linking to 2-3 related articles, contextual inline links where keywords match, and a TendHunt CTA paragraph. Ghost draft posts have been updated with the linked content via PUT API.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Review drafts in Ghost and publish</name>
  <files>landing/content-pipeline/output/published.json</files>
  <action>
    CHECKPOINT: User reviews the 10 draft articles in Ghost admin for content quality, formatting, featured images, and internal links. Then publishes all approved drafts either via the bulk publish script or manually in Ghost editor.

    Steps for the user:
    1. Review drafts at ghost-admin.tendhunt.com/ghost/#/posts?type=draft
    2. Spot-check 2-3 articles for content quality and formatting
    3. Publish approved drafts via `python add_internal_links.py --publish` or manually
    4. Verify articles appear at tendhunt.com/blog/
    5. Check SEO meta tags in page source
  </action>
  <verify>
    User confirms: articles reviewed, quality acceptable, published successfully, accessible at tendhunt.com/blog/{slug} with correct SEO meta tags and featured images.
  </verify>
  <done>
    5-10 SEO articles are published and live at tendhunt.com/blog/, each with featured image, meta description, tags, internal links, and correct SEO metadata. Blog homepage shows published articles.
  </done>
</task>

</tasks>

<verification>
- 10 article markdown files in landing/content-pipeline/articles/
- 10 thumbnail PNGs in landing/content-pipeline/thumbnails/
- output/published.json with 10 entries
- All articles have featured images, meta descriptions, tags, internal links
- Articles accessible at tendhunt.com/blog/{slug} after publishing
- Ghost admin shows correct content and formatting
</verification>

<success_criteria>
1. 5-10 SEO articles published (status=published) in Ghost
2. Each article has branded featured image visible on the blog
3. Each article has meta_description and 2+ tags
4. Internal links between articles work (clicking navigates to correct post)
5. Articles accessible at tendhunt.com/blog/{slug}
6. Blog homepage at tendhunt.com/blog/ shows published articles
</success_criteria>

<output>
After completion, create `landing/.planning/phases/04-content-pipeline/04-02-SUMMARY.md`
</output>
